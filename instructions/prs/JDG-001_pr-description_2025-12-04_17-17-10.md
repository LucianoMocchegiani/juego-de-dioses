# feat(terrain): Reglas de construcción de terrenos y límites de dimensión

## Resumen

Implementa sistema de partículas límite indestructibles y transparentes que definen los límites del mundo, junto con validación de límites al crear partículas, sistema de plantillas de árboles con troncos de grosor variable y raíces, y documentación detallada de ejemplos de construcción de terrenos (biomas, zonas subterráneas y acuíferos). Incluye seed demo optimizado que genera bioma bosque de 40m x 40m con acuífero subterráneo.

## Motivación

Se necesitaban reglas claras para la construcción de terrenos y límites del mundo. Los dioses (IA) no tenían referencias de cómo estructurar terrenos complejos ni cómo respetar los límites de las dimensiones. Este PR establece partículas límite indestructibles que actúan como barreras del mundo y proporciona ejemplos documentados para guiar la creación de diferentes tipos de terrenos.

## Criterios de Aceptación

### Feature: Reglas de construcción de terrenos
- [x] Existe un tipo de partícula `límite` en la base de datos
- [x] Las partículas `límite` son indestructibles (no pueden ser extraídas)
- [x] Las partículas `límite` son transparentes (opacity: 0.0)
- [x] Al crear una dimensión, se genera automáticamente una capa de partículas `límite` en `z = profundidad_maxima`
- [x] La capa de partículas `límite` cubre todo el área horizontal de la dimensión
- [x] El sistema valida que no se puedan crear partículas fuera de los límites definidos
- [x] El frontend renderiza las partículas `límite` como transparentes (o no las renderiza si son invisibles)

### Feature: Ejemplos de creación de terrenos
- [x] Existe carpeta `instructions/examples/terrenos/` con archivos de ejemplos
- [x] Existe al menos un ejemplo de bioma (bosque)
- [x] Existe al menos un ejemplo de zona subterránea (cueva)
- [x] Existe al menos un ejemplo de acuífero o napa subterránea
- [x] Cada ejemplo incluye estructura de capas, distribución espacial, propiedades de partículas y reglas de generación paso a paso
- [x] Los ejemplos están escritos con suficiente nivel de detalle para ser replicables

## Cambios Técnicos

### Backend
- Agregado tipo de partícula `límite` en `database/init/02-seed-data.sql` con categoría "sistema", densidad alta (999999.0) y estilos transparentes (opacity: 0.0)
- Creado módulo `backend/src/database/terrain_builder.py` con función `create_boundary_layer()` para crear automáticamente capa de partículas límite al crear dimensiones
- Agregada constante `INDESTRUCTIBLE_TYPES` y función `is_indestructible()` en `backend/src/api/routes/particles.py` para validar partículas indestructibles
- Agregada función `validate_particle_position()` en `backend/src/api/routes/particles.py` para validar límites de dimensión al crear partículas
- Creado módulo `backend/src/database/tree_templates.py` con sistema de plantillas de árboles:
  - 4 tipos de árboles predefinidos (pequeño, mediano, grande, muy grande)
  - Troncos con grosor variable (1x1, 2x2, 3x3 celdas)
  - Raíces bajo tierra que se extienden desde el tronco según el tamaño del árbol
  - Copas de diferentes tamaños según el tipo de árbol
  - Sistema extensible para agregar nuevos tipos de árboles
- Modificado `backend/src/database/seed_demo.py`:
  - Crea bioma bosque de 40m x 40m (160x160 celdas) con acuífero subterráneo
  - Usa plantillas de árboles para generar árboles con troncos de grosor variable y raíces
  - Optimizado con inserción en batches de 10,000 partículas para mejor rendimiento
  - Crea automáticamente capa límite después de crear dimensión demo

### Frontend
- Modificado `frontend/src/scene.js`:
  - Función `parseStyle()` ahora extrae `opacity` de `tipoEstilos.visual.opacity`
  - Función `createMaterial()` ahora maneja transparencia basada en opacidad
  - Función `createParticleMesh()` retorna `null` si opacity es 0.0 (optimización)
  - Función `renderParticles()` filtra partículas invisibles antes de renderizar
- Actualizado `frontend/src/types.js` para incluir `visual.opacity` en tipo `TipoEstilosBD`

### Base de Datos
- Agregado INSERT para tipo de partícula `límite` en `database/init/02-seed-data.sql`:
  - Categoría: "sistema"
  - Densidad: 999999.0
  - Estilos: color transparente con opacity: 0.0

### Documentación
- Creada carpeta `instructions/examples/terrenos/` con:
  - `README.md`: Documentación de la carpeta, estructura de ejemplos, convenciones y guía de uso
  - `_template.md`: Plantilla reutilizable para crear nuevos ejemplos
  - `bioma-bosque.md`: Ejemplo completo de construcción de bosque con estructura de capas, distribución espacial, propiedades y reglas de generación paso a paso
  - `zona-subterranea-cueva.md`: Ejemplo completo de construcción de cueva con entrada, pasadizos, cámaras y recursos
  - `acuifero-napa-subterranea.md`: Ejemplo completo de construcción de acuífero con nivel freático, capas impermeables y manantiales

## Testing

- Probado localmente con Docker Compose
- Verificado que las partículas límite se crean automáticamente al crear dimensión demo
- Verificado que las partículas límite no se renderizan en frontend (opacity: 0.0)
- Verificado que la validación de límites funciona correctamente
- Verificado que la función `is_indestructible()` identifica correctamente partículas límite
- Verificado creación de bioma bosque 40m x 40m con 438,151 partículas (incluyendo acuífero y árboles)
- Verificado que los árboles se crean con troncos de grosor variable (1x1, 2x2, 3x3 celdas)
- Verificado que las raíces se extienden bajo tierra según el tamaño del árbol
- Endpoints probados manualmente verificando creación de partículas límite

## Screenshots/Demo

No aplica - cambios principalmente en backend y documentación. Las partículas límite son invisibles por diseño.

## Referencias

- Ticket: JDG-001
- Plan de acción: `instructions/tasks/JDG-001-action-plan_2025-12-04_16-34-50.md`
- PR relacionado: JDG-002 (estilos en base de datos - base para estilos de partículas límite)

## Deployment

### Cambios Requeridos
- [x] Rebuild Docker images (cambios en backend y frontend)
- [x] Ejecutar scripts de inicialización de base de datos (nuevo tipo de partícula `límite`)
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment
- [ ] Verificar que el tipo de partícula `límite` existe en la base de datos
- [ ] Verificar que al crear una nueva dimensión se generan automáticamente partículas límite
- [ ] Verificar que las partículas límite no se renderizan en frontend
- [ ] Verificar que no se pueden extraer partículas límite (endpoint de extracción)
- [ ] Verificar logs de Docker para errores

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Si las partículas límite no se crean correctamente, las dimensiones nuevas no tendrán límites definidos
- Si la validación de límites falla, se podrían crear partículas fuera de los límites válidos
- Si el renderizado transparente falla, las partículas límite podrían ser visibles y afectar la experiencia visual

**Plan de rollback:**
1. Revertir commits del PR
2. Ejecutar script SQL para eliminar tipo de partícula `límite` (si es necesario)
3. Rebuild Docker images con versión anterior
4. Reiniciar servicios Docker

**Mitigación:**
- Las partículas límite se crean automáticamente pero no afectan dimensiones existentes
- La validación de límites es defensiva y no debería romper funcionalidad existente
- El renderizado transparente es una optimización que no afecta la lógica de negocio

## Notas Adicionales

- Las partículas límite se crean automáticamente solo para dimensiones nuevas. Las dimensiones existentes no se modifican automáticamente.
- La función `validate_particle_position()` está lista para usarse cuando se implemente el endpoint POST para crear partículas.
- Los ejemplos de terrenos están diseñados para ser guías de referencia para los dioses (IA) que crean el mundo. Incluyen pseudocódigo y valores reales para facilitar la implementación.
- La transparencia de partículas límite se maneja completamente en el frontend. Si opacity es 0.0, el mesh no se crea para optimizar rendimiento.
- Sistema de plantillas de árboles permite crear árboles con diferentes tamaños y características. Fácilmente extensible para agregar nuevos tipos.
- Los árboles ahora tienen troncos con grosor variable (múltiples partículas formando el grosor) y raíces que se extienden bajo tierra según el tamaño del árbol.
- El seed demo crea un bioma bosque completo de 40m x 40m con acuífero subterráneo, demostrando la integración de todas las características implementadas.
- Optimizaciones de inserción en batches mejoran significativamente el rendimiento para dimensiones grandes (40m x 40m = ~500,000 partículas).

