# feat(rendering): Optimizar visualización de árboles altos y rendimiento del frontend

## Resumen

Este PR optimiza la visualización de árboles altos (hasta z=32) y mejora el rendimiento del frontend mediante:
- Aumento de altura máxima de dimensiones (10 → 40)
- Aumento de límite de viewport (500k → 1M celdas)
- Ajuste de cálculo de viewport para priorizar altura sobre profundidad
- Eliminación de gaps visuales entre troncos y hojas
- Optimización de generación de hojas con densidad variable
- División de InstancedMeshes grandes en el frontend

## Motivación

Después de aumentar las alturas de los árboles por 5x, se identificaron problemas:
1. Las copas de árboles altos (hasta z=32) se cortaban porque el viewport estaba limitado
2. Gaps visuales entre troncos y hojas hacían que las hojas parecieran "levitar"
3. El rendimiento degradaba con el aumento de partículas de hojas

Este PR resuelve estos problemas optimizando tanto la generación como el renderizado.

## Criterios de Aceptación

- [x] Dimensión demo se crea con `altura_maxima = 40`
- [x] Backend acepta viewports de hasta 1,000,000 celdas
- [x] Frontend calcula viewport priorizando altura (3/4 del rango hacia arriba)
- [x] Copas se generan sin gaps (hojas incluyen posiciones del tronco)
- [x] Hojas se generan con densidad variable (100% centro, 90% media, 70% bordes)
- [x] Frontend divide grupos grandes en múltiples InstancedMeshes (máx 50k)
- [x] Árboles hasta z=32 se visualizan completamente
- [x] Rendimiento mejora o se mantiene estable
- [x] No hay gaps visuales entre troncos y hojas

## Cambios Técnicos

### Backend

- **`backend/src/database/seed_demo.py`**: Aumentar `altura_maxima` de dimensión demo de 10 a 40 para acomodar árboles hasta z=32
- **`backend/src/models/schemas.py`**: Aumentar `MAX_VIEWPORT_CELLS` de 500,000 a 1,000,000 celdas
- **`backend/src/database/tree_templates.py`**: 
  - Modificar `get_posiciones_copa` para incluir posiciones del tronco (eliminar gaps)
  - Implementar densidad variable de hojas: 100% centro, 90% zona media, 70% bordes, reduciendo 15% por nivel superior

### Frontend

- **`frontend/src/main.js`**: 
  - Actualizar límite de viewport a 1M celdas
  - Ajustar cálculo de viewport para priorizar altura (3/4 del rango hacia arriba, 1/4 hacia abajo)
  - Asegurar que zMax pueda llegar al menos a 35 para ver copas completas
- **`frontend/src/scene.js`**: 
  - Dividir grupos grandes de partículas en múltiples InstancedMeshes
  - Reducir límite de instancias por mesh de 100k a 50k para mejor rendimiento
  - Crear múltiples meshes automáticamente cuando un grupo excede 50k partículas

## Testing

- [x] Probado localmente con Docker Compose
- [x] Verificada altura de dimensión = 40 en base de datos
- [x] Verificado viewport grande (160x160x40) aceptado por backend
- [x] Verificada visualización completa de árboles hasta z=32
- [x] Verificada ausencia de gaps visuales entre troncos y hojas
- [x] Verificada densidad variable de hojas (más densas en centro)
- [x] Verificada división de InstancedMeshes grandes en consola del navegador
- [x] Verificado rendimiento mejorado o estable

## Screenshots/Demo

Los cambios son visibles al regenerar la seed demo y cargar el frontend. Los árboles ahora se muestran completamente sin cortes en las copas y sin gaps entre troncos y hojas.

## Referencias

- Ticket: JDG-004
- PRs relacionados: #xxx (JDG-003 - Optimizaciones de frontend y viewport)
- Documentación relacionada: 
  - `instructions/examples/terrenos/bioma-bosque.md`
  - `instructions/RELACION-PARTICULAS-METROS.md`

## Deployment

### Cambios Requeridos

- [x] Rebuild Docker images (backend y frontend)
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica)
- [x] Reiniciar servicios Docker
- [x] Regenerar seed demo para aplicar cambios

### Verificación Post-Deployment

- [ ] Verificar endpoints con curl/Postman (no aplica)
- [x] Verificar frontend en navegador
- [x] Verificar logs de Docker
- [ ] Verificar conexión a PostgreSQL y Redis (no aplica directamente)

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- El aumento del límite de viewport a 1M celdas puede causar consultas más lentas en casos extremos
- La densidad variable de hojas puede hacer que algunos árboles se vean menos frondosos en los bordes
- La división de InstancedMeshes aumenta el número de draw calls, pero mejora el rendimiento general

**Plan de rollback:**
1. Revertir commits relacionados con este PR
2. Rebuild Docker images
3. Regenerar seed demo con configuración anterior
4. Verificar que todo funcione correctamente

**Mitigación:**
- El límite de 1M celdas es suficiente para 160x160x40, pero no permite terrenos mucho más grandes
- La densidad variable es configurable y puede ajustarse si es necesario
- La división de InstancedMeshes es transparente y no afecta la funcionalidad

## Notas Adicionales

- Los cambios en `tree_templates.py` requieren regenerar la seed demo para aplicarse
- El aumento del límite de viewport es retrocompatible con dimensiones existentes
- La optimización de densidad de hojas reduce el número total de partículas, mejorando el rendimiento sin sacrificar demasiado la apariencia visual
- La división de InstancedMeshes en el frontend es automática y transparente para el usuario final

