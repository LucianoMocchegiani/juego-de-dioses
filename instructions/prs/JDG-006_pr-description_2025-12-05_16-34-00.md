# refactor(frontend): Componentización del Frontend y Sistema de Formas Geométricas

## Resumen

Refactorización completa del frontend de estructura monolítica a arquitectura modular escalable, implementación de sistema de formas geométricas almacenadas en base de datos, y preparación de infraestructura para agrupaciones. El frontend ahora interpreta formas geométricas desde la BD y las renderiza dinámicamente, manteniendo el mismo resultado visual pero con código más mantenible y extensible.

## Motivación

El frontend tenía una estructura monolítica que no escalaba para agregar nuevas funcionalidades. Todos los archivos mezclaban responsabilidades y las partículas se renderizaban como cubos genéricos sin diferenciación visual. Se necesitaba una arquitectura modular que permitiera agregar renderizadores especializados, componentes UI, y sistemas de gestión de estado sin modificar código existente.

## Criterios de Aceptación

- [x] Existe estructura de carpetas modular (`core/`, `renderers/`, `components/`, `state/`, `utils/`, `api/`, `managers/`)
- [x] Renderizado genérico separado de renderizado especializado
- [x] Sistema de formas geométricas implementado (tipos de partículas con geometría en BD)
- [x] Frontend interpreta y renderiza formas desde BD
- [x] Sistema de gestión de estado centralizado implementado
- [x] Componentes UI reutilizables creados (button, panel, loading, info-panel)
- [x] Separación clara de responsabilidades entre módulos
- [x] El frontend funciona igual que antes (mismo resultado visual)
- [x] Agregar nuevo tipo de renderizador solo requiere crear nuevo archivo
- [x] Documentación completa (READMEs en cada módulo)
- [x] Sistema preparado para agrupaciones (implementación básica completada)
- [x] Orden de renderizado corregido (profundidad y transparencia)

## Cambios Técnicos

### Backend

- Extendidos schemas Pydantic para formas geométricas:
  - `GeometriaParametros`: Parámetros relativos a `tamano_celda` (box, sphere, cylinder, cone, torus)
  - `GeometriaVisual`: Tipo y parámetros de geometría para tipos de partículas
  - `GeometriaAgrupacion`: Geometría para agrupaciones con soporte de partes
  - `VisualProperties`: Actualizado para incluir campo `geometria` (deprecado `modelo`)
  - `AgrupacionResponse`: Actualizado para incluir `geometria_agrupacion`
- Implementadas agrupaciones básicas en builders:
  - `BaseBuilder`: Agregados métodos `create_agrupacion()` y `get_agrupacion_metadata()`
  - `TreeBuilder`: Implementada creación de agrupaciones para árboles
  - `EntityCreator`: Gestiona creación de agrupaciones antes de crear partículas
- Actualizados READMEs de `builders/` y `creators/` con información de agrupaciones

### Frontend

- Creada estructura modular completa:
  - `core/`: Escena, cámara, controles, renderizador, luces, helpers (módulos separados)
  - `renderers/`: Sistema de renderizadores con soporte de formas geométricas
    - `base-renderer.js`: Clase base abstracta con resolución de geometría
    - `particle-renderer.js`: Renderizador genérico con instanced rendering
    - `geometries/registry.js`: Registry para crear geometrías Three.js desde definiciones BD
  - `api/`: Cliente API modular
    - `client.js`: Cliente base genérico
    - `endpoints/`: Endpoints específicos (dimensions, particles, agrupaciones)
  - `managers/`: Gestores de alto nivel
    - `viewport-manager.js`: Cálculo dinámico de viewport
    - `style-manager.js`: Cache y parsing de estilos desde BD
    - `entity-manager.js`: Gestión de entidades y selección de renderizadores
  - `state/`: Gestión de estado centralizada
    - `store.js`: Store simple con suscripciones
    - `actions.js`: Acciones para modificar estado
    - `selectors.js`: Selectores para acceder a estado
  - `components/ui/`: Componentes UI reutilizables (button, panel, loading, info-panel)
  - `utils/`: Utilidades organizadas (colors, geometry, math, helpers)
- Refactorizado `main.js`: Ahora es punto de entrada mínimo que delega a `app.js`
- Creado `app.js`: Orquestador principal que inicializa todos los módulos
- Implementado orden de renderizado correcto:
  - Partículas ordenadas por profundidad (`celda_z`)
  - Separación de grupos opacos y transparentes
  - Renderizado primero opacos, luego transparentes
  - Configuración correcta de `depthWrite` y `depthTest` en materiales
- Actualizado `scene.js`: Usa nuevos módulos core manteniendo compatibilidad temporal

### Base de Datos

- Agregado campo `geometria_agrupacion` JSONB a tabla `agrupaciones`:
  - Campo JSONB con estructura: `{ tipo: string, parametros: object, partes?: object }`
  - Índice GIN para búsquedas eficientes
  - Comentario documentando estructura
- Actualizados tipos de partículas con formas geométricas:
  - `madera`: cylinder (radiusTop: 0.4, radiusBottom: 0.5, height: 1.0)
  - `hojas`: sphere (radius: 0.5, segments: 16)
  - `piedra`: box (width: 0.9, height: 0.85, depth: 0.95)
  - `agua`: box (width: 1.0, height: 1.0, depth: 1.0) con opacity: 0.7
  - `hierba`: box (width: 0.8, height: 0.6, depth: 0.8)
  - `tierra`: box (width: 1.0, height: 1.0, depth: 1.0)
- Actualizado script `02-seed-data.sql` para incluir formas geométricas y transparencia del agua

## Testing

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador (Chrome/Firefox)
- [x] Verificado renderizado de partículas con formas geométricas correctas
- [x] Verificado orden de renderizado (agua no se ve a través de capas opacas)
- [x] Verificado que controles de cámara funcionan correctamente
- [x] Verificado que viewport dinámico funciona
- [x] Verificado creación de agrupaciones (782 árboles con agrupaciones)
- [x] Verificado que partículas se vinculan correctamente a agrupaciones (192,793 partículas)
- [x] Verificado que no hay errores en consola del navegador
- [x] Verificado que no hay errores en logs del backend
- [x] Verificado rendimiento (similar o mejor que antes)

## Referencias

- Ticket: JDG-006
- Análisis de arquitectura: `instructions/analysis/JDG-006-architecture-analysis_2025-12-05_11-51-20.md`
- Análisis de formas geométricas: `instructions/analysis/JDG-006-architecture-analysis_2025-12-05_12-07-10.md`
- Análisis de agrupaciones: `instructions/analysis/JDG-006-agrupaciones-architecture-analysis_2025-12-05_12-30-20.md`
- Plan de acción: `instructions/tasks/JDG-006-action-plan_2025-12-05_12-49-59.md`
- PR relacionado: #JDG-005 (Componentización del backend)

## Deployment

### Cambios Requeridos

- [x] Rebuild Docker images (no requerido, cambios en código fuente)
- [x] Ejecutar migraciones de base de datos (campo `geometria_agrupacion` agregado)
- [ ] Actualizar variables de entorno (no aplica)
- [ ] Reiniciar servicios Docker (se reinician automáticamente con docker-compose up)

### Verificación Post-Deployment

- [x] Verificar endpoints con curl/Postman (probado)
- [x] Verificar frontend en navegador (probado)
- [x] Verificar logs de Docker (sin errores)
- [x] Verificar conexión a PostgreSQL y Redis (funcionando)

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Bajo riesgo: Refactorización mantiene funcionalidad existente
- Cambios en BD son aditivos (campo nuevo, no modifica existentes)
- Frontend mantiene compatibilidad temporal con `scene.js` antiguo

**Plan de rollback:**
- Si hay problemas críticos, revertir commit y restaurar backup de BD (si se hizo)
- El campo `geometria_agrupacion` es opcional, no rompe funcionalidad existente
- Frontend puede funcionar sin formas geométricas (usa BoxGeometry por defecto)

## Notas Adicionales

- La estructura modular permite agregar nuevos renderizadores sin modificar código existente
- El sistema de formas geométricas es extensible: nuevos tipos pueden agregarse a la BD
- Los parámetros de geometría son relativos a `tamano_celda`, permitiendo escalado automático
- La implementación de agrupaciones es básica (Nivel 2), preparada para extensión futura con partes (Nivel 3)
- Documentación completa en READMEs de cada módulo siguiendo práctica establecida

## Anexo: Cambios Fuera del Plan

### Corrección de Orden de Renderizado

**Archivos modificados:**
- `frontend/src/renderers/particle-renderer.js`

**Problema:**
- Las partículas se renderizaban sin orden por profundidad, causando que el agua (transparente) se viera a través de capas opacas superiores
- El agua aparecía visualmente encima de la hierba y tierra, aunque estaba en niveles más profundos (z=-7 a z=-9)

**Solución:**
- Implementado ordenamiento de partículas por `celda_z` (profundidad) antes de renderizar
- Separación de grupos opacos y transparentes
- Renderizado primero grupos opacos, luego transparentes (ambos ordenados por profundidad)
- Configuración correcta de `depthWrite: false` para materiales transparentes
- Configuración de `depthTest: true` para todos los materiales

**Impacto:**
- Crítico para visualización correcta del terreno
- Mejora significativa en la calidad visual del renderizado

### Transparencia del Agua

**Archivos modificados:**
- `database/init/02-seed-data.sql`
- Base de datos (actualización manual)

**Cambio:**
- Agregada `opacity: 0.7` al tipo de partícula "agua" en la base de datos
- El agua ahora se renderiza como transparente en lugar de opaca

**Razón:**
- Necesario para visualización correcta del acuífero
- Permite ver las capas de tierra y piedra a través del agua

**Impacto:**
- Mejora visual del renderizado del acuífero
- Requiere recarga del frontend para ver cambios

### Campo geometria_agrupacion en BD Existente

**Archivos modificados:**
- Base de datos (ALTER TABLE ejecutado manualmente)

**Cambio:**
- Agregado campo `geometria_agrupacion` a tabla `agrupaciones` en base de datos existente
- Creado índice GIN para búsquedas eficientes

**Razón:**
- El campo estaba definido en `01-init-schema.sql` pero no existía en la BD actual
- Necesario para futuras funcionalidades de geometría de agrupaciones

**Impacto:**
- Bajo: Campo opcional, no afecta funcionalidad existente
- Preparación para futuras mejoras

