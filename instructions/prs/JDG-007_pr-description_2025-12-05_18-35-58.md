# perf(frontend): Optimización de Rendimiento del Frontend - Frustum Culling, LOD y Limitación de Partículas

## Resumen

Implementa optimizaciones de rendimiento en el frontend para mejorar FPS en terrenos grandes (40x40m con ~400k partículas). Incluye frustum culling para filtrar partículas fuera del campo de visión, Level of Detail (LOD) para reducir detalle de partículas lejanas, optimización de ordenamiento, material pooling, limitación agresiva de partículas y sistema de profiling de performance.

## Motivación

El frontend tenía FPS muy bajos (~14-20 FPS) al renderizar terrenos grandes con ~400k partículas. Se renderizaban todas las partículas del viewport sin filtrado, incluso las fuera del campo de visión, causando sobrecarga en el renderizado. Se necesitaban optimizaciones para alcanzar 60 FPS estables.

## Criterios de Aceptación

- [x] Frustum culling implementado: solo se renderizan partículas visibles por la cámara
- [x] LOD básico implementado: partículas lejanas usan geometrías simplificadas
- [x] Optimización de ordenamiento: ordenamiento más eficiente (una sola vez)
- [x] Reducción de draw calls: material pooling y aumento de MAX_INSTANCES_PER_MESH
- [x] Geometrías optimizadas: esferas con menos segments cuando están lejos
- [x] Performance profiling: se puede medir FPS y draw calls en tiempo real
- [x] Limitación agresiva de partículas: prioriza partículas cercanas a la cámara
- [x] Sin degradación visual significativa: la calidad visual se mantiene aceptable
- [ ] FPS mínimo de 60 en demo 40x40m (~400k partículas) - **Parcialmente alcanzado (27-31 FPS)**
- [ ] FPS mínimo de 60 en demo 20x20m (~100k partículas)

## Cambios Técnicos

### Frontend

**Nuevos módulos de optimización:**
- `frontend/src/utils/culling.js`: Utilidades de frustum culling con cache
- `frontend/src/utils/sorting.js`: Ordenamiento optimizado de partículas
- `frontend/src/renderers/optimizations/lod-manager.js`: Gestión de Level of Detail
- `frontend/src/renderers/optimizations/particle-limiter.js`: Limitación agresiva de partículas
- `frontend/src/managers/geometry-cache.js`: Cache de geometrías LOD
- `frontend/src/managers/performance-manager.js`: Sistema de profiling de performance

**Modificaciones en módulos existentes:**
- `frontend/src/core/camera.js`: Métodos para exponer frustum y detectar movimiento de cámara
- `frontend/src/core/scene.js`: Integración de Performance Manager en loop de animación
- `frontend/src/renderers/particle-renderer.js`: 
  - Integración de frustum culling, LOD y limitación de partículas
  - Material pooling para reutilización de materiales
  - Ordenamiento optimizado (una sola vez)
  - Aumento de MAX_INSTANCES_PER_MESH de 50k a 100k
- `frontend/src/app.js`: 
  - Integración de Performance Manager
  - Ajuste de orden de renderizado (cámara centrada antes de renderizar)
  - Deshabilitación temporal de frustum culling en renderizado inicial

**Documentación:**
- Actualización de READMEs en módulos afectados
- Guía de verificación en `instructions/verification/JDG-007-verification-guide.md`

## Testing

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador (Chrome/Edge)
- [x] Verificado frustum culling (rotar cámara, verificar reducción de partículas)
- [x] Verificado LOD (acercar/alejar cámara, verificar cambio de detalle)
- [x] Verificado limitación de partículas (logs en consola)
- [x] Verificado profiling de FPS (métricas en consola cada segundo)
- [x] Verificado que no hay degradación visual significativa
- [x] Medición de FPS: 27-31 FPS en demo 40x40m (mejora desde 14-20 FPS)

## Screenshots/Demo

El demo 40x40m se carga correctamente y muestra los 40x40 metros completos. Los logs de performance aparecen en la consola del navegador cada segundo con formato: `Performance: FPS: [número], Draw Calls: [número]`.

## Referencias

- Ticket: JDG-007
- Análisis de arquitectura: `instructions/analysis/JDG-007-architecture-analysis_2025-12-05_16-59-18.md`
- Plan de acción: `instructions/tasks/JDG-007-action-plan_2025-12-05_17-15-31.md`
- Guía de verificación: `instructions/verification/JDG-007-verification-guide.md`

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (no necesario, solo archivos estáticos)
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica)
- [x] Reiniciar servicios Docker (frontend reiniciado durante desarrollo)

### Verificación Post-Deployment

- [x] Verificar frontend en navegador
- [x] Verificar logs de performance en consola
- [x] Verificar que frustum culling funciona (rotar cámara)
- [x] Verificar que LOD funciona (acercar/alejar cámara)
- [x] Verificar que limitación de partículas funciona (logs en consola)

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Frustum culling podría ocultar partículas visibles si el cálculo es incorrecto (mitigado con deshabilitación en renderizado inicial)
- LOD podría causar "pop-in" visible si los umbrales son muy agresivos (no observado)
- Limitación de partículas podría ocultar terreno importante si el límite es muy bajo (configurable, actualmente 150k)

**Plan de rollback:**
- Revertir commit y rebuild frontend
- Las optimizaciones son configurables (flags `enableFrustumCulling`, `enableLOD`, `enableParticleLimiting`)
- Se pueden deshabilitar individualmente sin afectar funcionalidad base

## Notas Adicionales

- FPS mejoró de 14-20 a 27-31 FPS, pero aún no alcanza el objetivo de 60 FPS
- Se requiere trabajo adicional en optimizaciones (ver ticket futuro para mejorar ParticleLimiter)
- El frustum culling se deshabilita en el renderizado inicial para mostrar todo el terreno al cargar
- El Performance Manager muestra métricas cada segundo en consola

## Anexo: Cambios Fuera del Plan

### Ajuste de Cámara y Renderizado Inicial
- **Archivo:** `frontend/src/app.js`
- **Problema:** El frustum culling se aplicaba antes de centrar la cámara, limitando la vista inicial
- **Solución:** Reordenar renderizado para centrar cámara primero y deshabilitar frustum culling en renderizado inicial
- **Impacto:** Permite ver todo el terreno 40x40m al cargar

### Corrección de Logs de Performance
- **Archivo:** `frontend/src/app.js`, `frontend/src/managers/performance-manager.js`
- **Problema:** Los logs de FPS no aparecían en consola
- **Solución:** Eliminar verificación redundante en callback de suscripción y agregar log inicial
- **Impacto:** Métricas de performance ahora visibles en consola

