# feat(frontend): Implementar Sistema ECS y Primer Personaje Jugable

## Resumen

Implementa un sistema ECS (Entity Component System) completo y el primer personaje jugable del juego. El personaje puede moverse, correr, saltar, agacharse, y es controlado mediante teclado y mouse. Incluye sistema de física, colisiones con partículas sólidas, cámara en tercera persona con rotación por mouse, y animaciones básicas.

## Motivación

El juego actualmente solo permite visualizar el terreno desde una cámara orbital. Se requiere un personaje jugable que pueda interactuar con el mundo, moverse, y realizar acciones básicas. Este PR establece la base del sistema de entidades jugables usando arquitectura ECS.

## Criterios de Aceptación

- [x] El personaje se renderiza correctamente en la escena 3D del terreno de prueba
- [x] El personaje puede moverse en 4 direcciones usando WASD o flechas
- [x] El personaje puede correr manteniendo Shift + dirección de movimiento
- [x] El personaje puede saltar presionando Espacio (solo si está en el suelo)
- [x] El personaje puede agacharse manteniendo Ctrl o C
- [x] El personaje no atraviesa partículas sólidas del terreno
- [x] El personaje tiene gravedad y cae si no hay suelo debajo
- [x] El personaje puede golpear con click izquierdo (visual y funcional)
- [x] El personaje puede agarrar/interactuar con click derecho o E
- [x] La cámara sigue al personaje (tercera persona con rotación por mouse)
- [x] El personaje se orienta según la rotación de la cámara
- [x] Las animaciones básicas funcionan (idle, caminar, correr, saltar, agacharse)
- [x] El sistema de colisiones detecta correctamente las partículas sólidas
- [x] El personaje puede interactuar con el terreno de prueba (JDG-009)

## Cambios Técnicos

### Frontend

**Sistema ECS:**
- Creado `frontend/src/ecs/manager.js` - ECSManager con gestión de entidades, componentes y sistemas
- Creado `frontend/src/ecs/system.js` - Clase base System con sistema de prioridades
- Implementado sistema de queries con cache para optimización

**Componentes:**
- Creado `frontend/src/ecs/components/position.js` - PositionComponent (coordenadas en celdas)
- Creado `frontend/src/ecs/components/physics.js` - PhysicsComponent (velocidad, aceleración, gravedad, fricción)
- Creado `frontend/src/ecs/components/render.js` - RenderComponent (mesh Three.js, visibilidad, escalado para agacharse)
- Creado `frontend/src/ecs/components/input.js` - InputComponent (estado de teclas, acciones, dirección de movimiento)
- Creado `frontend/src/ecs/components/animation.js` - AnimationComponent (estado de animación actual)

**Sistemas:**
- Creado `frontend/src/ecs/systems/input-system.js` - Procesa input del InputManager y calcula movimiento relativo a cámara
- Creado `frontend/src/ecs/systems/physics-system.js` - Aplica física con timestep fijo (gravedad, velocidad, aceleración, fricción)
- Creado `frontend/src/ecs/systems/render-system.js` - Actualiza posición y rotación de meshes Three.js
- Creado `frontend/src/ecs/systems/collision-system.js` - Detecta y resuelve colisiones con partículas sólidas
- Creado `frontend/src/ecs/systems/animation-system.js` - Determina estado de animación según input y física

**Factories:**
- Creado `frontend/src/ecs/factories/player-factory.js` - Factory para crear entidad de jugador completa

**Sistemas Globales:**
- Creado `frontend/src/systems/input-manager.js` - Gestor centralizado de input (teclado y mouse)
- Creado `frontend/src/systems/collision-detector.js` - Detector de colisiones con cache para partículas sólidas
- Creado `frontend/src/systems/camera-controller.js` - Controlador de cámara en tercera persona con rotación por mouse

**Integración:**
- Modificado `frontend/src/app.js` - Integrado ECS, sistemas, creación de jugador, y loop de animación
- Modificado `frontend/index.html` - Agregado `tabindex="0"` al contenedor para capturar eventos de teclado
- Modificado `frontend/src/main.js` - Agregado `container.focus()` para asegurar captura de eventos

**Documentación:**
- Creado `frontend/src/ecs/README.md` - Documentación completa del sistema ECS
- Actualizado `frontend/src/systems/README.md` - Documentación de InputManager, CollisionDetector y CameraController
- Actualizado `frontend/src/README.md` - Agregada información sobre módulos ECS y Systems

**Core:**
- Modificado `frontend/src/core/controls.js` - Agregado método `setEnabled()` para habilitar/deshabilitar OrbitControls

## Testing

Funcionalidad probada localmente con Docker Compose:
- [x] Movimiento básico (WASD) funciona correctamente
- [x] Correr (Shift + WASD) aumenta velocidad
- [x] Salto (Espacio) funciona solo cuando está en el suelo
- [x] Agacharse (Ctrl/C) reduce altura visualmente
- [x] Colisiones con partículas sólidas funcionan
- [x] Gravedad aplica correctamente
- [x] Cámara sigue al personaje suavemente
- [x] Rotación de cámara con click derecho + mouse funciona
- [x] Orientación del personaje sigue la rotación de la cámara
- [x] Animaciones básicas funcionan (idle, walk, run, jump, crouch)
- [x] Personaje no atraviesa partículas sólidas
- [x] Personaje se mantiene sobre el suelo cuando hay partículas sólidas debajo

## Screenshots/Demo

El personaje se renderiza como un modelo simple (cilindro para cuerpo, esfera para cabeza) en la escena 3D. La cámara sigue al personaje en modo tercera persona y puede rotarse con click derecho + mouse.

## Referencias

- Ticket: JDG-010
- Plan de acción: `instructions/tasks/JDG-010-action-plan_2025-12-06_10-40-04.md`
- Documentación ECS: `frontend/src/ecs/README.md`
- Documentación Systems: `frontend/src/systems/README.md`

## Deployment

### Cambios Requeridos

- [ ] Reiniciar servicios Docker (frontend)
- [ ] No requiere rebuild de imágenes Docker
- [ ] No requiere migraciones de base de datos
- [ ] No requiere cambios en variables de entorno

### Verificación Post-Deployment

- [x] Verificar que el jugador se renderiza en la escena
- [x] Verificar que el jugador responde a input (WASD)
- [x] Verificar que el jugador tiene física (gravedad, colisiones)
- [x] Verificar que el jugador puede saltar
- [x] Verificar que el jugador puede agacharse
- [x] Verificar que la cámara sigue al jugador
- [x] Verificar que no hay errores en consola
- [x] Verificar que el FPS se mantiene estable (50-60 FPS)

## Riesgos y Plan de Rollback

**Riesgos:**
- El sistema ECS es nuevo y puede tener bugs no detectados
- Las colisiones dependen de la API de partículas, puede fallar si el backend no responde
- La cámara puede tener problemas de rendimiento si hay muchas entidades

**Plan de Rollback:**
- Revertir commit del PR
- El código anterior (solo visualización) seguirá funcionando
- No hay cambios en base de datos que requieran rollback

## Notas Adicionales

- El sistema de coordenadas usa: X = izquierda/derecha, Y = adelante/atrás, Z = arriba/abajo
- La velocidad de movimiento es configurable (actualmente 15 celdas/segundo caminando, 30 corriendo)
- La sensibilidad de rotación de cámara es configurable (actualmente 0.005)
- El sistema de colisiones usa cache para optimizar consultas a la API
- Las animaciones son básicas (rotación, escalado) y pueden mejorarse en el futuro con modelos 3D

## Anexo: Cambios Fuera del Plan

### Correcciones de Bugs Durante Implementación

**Corrección de mapeo de ejes:**
- **Archivo:** `frontend/src/ecs/systems/input-system.js`, `frontend/src/ecs/systems/physics-system.js`, `frontend/src/ecs/systems/collision-system.js`
- **Problema:** Confusión inicial entre ejes Y y Z para movimiento horizontal vs vertical
- **Solución:** Establecido sistema consistente: X = izquierda/derecha, Y = adelante/atrás, Z = arriba/abajo
- **Impacto:** Crítico para funcionamiento correcto del movimiento

**Corrección de detección de suelo:**
- **Archivo:** `frontend/src/ecs/systems/collision-system.js`
- **Problema:** Personaje caía infinitamente porque no detectaba suelo correctamente
- **Solución:** Mejorada búsqueda de suelo (hasta 10 celdas abajo) y ajuste de posición
- **Impacto:** Crítico para evitar caída infinita

**Corrección de movimiento relativo a cámara:**
- **Archivo:** `frontend/src/ecs/systems/input-system.js`
- **Problema:** Movimiento no era relativo a la dirección de la cámara
- **Solución:** Implementado rotación de vector de movimiento según rotación de cámara
- **Impacto:** Importante para experiencia de juego natural

**Corrección de orientación del personaje:**
- **Archivo:** `frontend/src/ecs/systems/render-system.js`, `frontend/src/systems/camera-controller.js`
- **Problema:** Personaje rotaba cada vez que se presionaba una tecla, causando vibración
- **Solución:** Personaje solo rota cuando se mueve la cámara, no cuando se presionan teclas
- **Impacto:** Importante para experiencia de juego fluida

**Mejoras de velocidad:**
- **Archivo:** `frontend/src/ecs/systems/input-system.js`
- **Cambio:** Velocidad aumentada de 1.5/3 a 15/30 celdas por segundo (caminar/correr)
- **Razón:** Velocidad inicial era demasiado lenta según feedback del usuario

**Mejora de sensibilidad de cámara:**
- **Archivo:** `frontend/src/systems/camera-controller.js`
- **Cambio:** Sensibilidad aumentada de 0.002 a 0.005
- **Razón:** Rotación de cámara era demasiado lenta según feedback del usuario

