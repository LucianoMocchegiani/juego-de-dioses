# feat(database): Sistema de Personajes desde Base de Datos - Solo Mesh sin Partículas Físicas

## Resumen

Implementa un sistema completo para crear personajes jugables (bípedos) desde la base de datos usando el patrón templates/builders/creators, similar al sistema existente para árboles. Los personajes se definen en el backend, se almacenan como **agrupaciones con geometría detallada (sin partículas físicas)**, y se renderizan dinámicamente en el frontend desde la API.

**Arquitectura clave:** Los personajes NO se crean como partículas físicas en la BD. Solo existen como agrupaciones con `geometria_agrupacion`, y el mesh se renderiza completamente desde el frontend. Esto evita problemas de desincronización y mejora el rendimiento.

## Motivación

1. **Centralización:** El personaje se creaba directamente en el frontend con primitivos hardcodeados. Se requiere centralizar la definición en la BD para permitir múltiples tipos/razas.
2. **Extensibilidad:** Facilitar la extensión del sistema para agregar nuevos tipos de personajes.
3. **Rendimiento:** Los personajes son entidades dinámicas que se mueven constantemente. Crear partículas físicas sería ineficiente (requeriría actualizar ~19 partículas por cada movimiento).
4. **Arquitectura:** Separación clara entre objetos estáticos (partículas en BD) y entidades dinámicas (meshes en frontend).

## Problema Resuelto

**Problema inicial:** El personaje tenía dos representaciones que se desincronizaban:
1. Partículas físicas en BD (19 bloques fijos) - Se renderizaban como voxels
2. Mesh del personaje (esfera + cilindros) - Se movía con el ECS

**Causa:** Las partículas estaban almacenadas en posiciones fijas en la BD, mientras que el mesh se movía según `PositionComponent` del ECS. Cuando el personaje se movía, solo se actualizaba `PositionComponent`, pero las partículas en BD NO se movían.

**Solución:** Eliminar la creación de partículas físicas para personajes. Los personajes ahora solo existen como agrupaciones con `geometria_agrupacion`, y el mesh se renderiza completamente desde el frontend.

## Criterios de Aceptación

- [x] Existe sistema de templates para bípedos en `backend/src/database/templates/bipedos/`
- [x] Existe `BipedTemplate` como clase base que extiende `BaseTemplate`
- [x] Existe template `HumanoTemplate` con estructura básica (cabeza, torso, brazos, piernas)
- [x] Existe `BipedBuilder` que crea agrupaciones con `geometria_agrupacion` (NO crea partículas físicas)
- [x] `EntityCreator` puede crear bípedos usando `create_entity()` con template de bípedo
- [x] Los bípedos se crean como agrupaciones en la BD con `geometria_agrupacion` definida
- [x] Los bípedos NO se crean como partículas físicas en la BD
- [x] Existe endpoint de API `/api/v1/dimensions/{dimension_id}/characters/{character_id}` para obtener información de personaje
- [x] Existe endpoint para listar personajes y crear personajes desde templates
- [x] El frontend puede cargar la forma del personaje desde la API
- [x] `PlayerFactory` crea el mesh del personaje basándose en `geometria_agrupacion` de la BD
- [x] El personaje renderizado coincide con la definición en la BD
- [x] Todas las partes del personaje se posicionan correctamente (cabeza, torso, brazos, piernas)
- [x] El personaje se mueve sin desincronización
- [x] No hay partículas físicas visibles en el mapa para personajes
- [x] Se puede crear un personaje usando `EntityCreator` desde un script de seed
- [x] Script de limpieza elimina partículas antiguas de personajes existentes
- [x] Código limpio: sin métodos o variables no usadas

## Cambios Técnicos

### Backend

**Templates de Bípedos:**
- Creado `backend/src/database/templates/bipedos/base.py` - Clase base `BipedTemplate` que extiende `BaseTemplate`
- Creado `backend/src/database/templates/bipedos/humano.py` - Template específico para humanos con estructura completa (cabeza, torso, brazos, piernas)
- Creado `backend/src/database/templates/bipedos/registry.py` - Registry pattern para descubrimiento dinámico de templates
- Creado `backend/src/database/templates/bipedos/README.md` - Documentación del módulo

**Builder:**
- Creado `backend/src/database/builders/biped_builder.py` - `BipedBuilder` que:
  - ✅ `create_at_position()` retorna lista vacía (NO crea partículas físicas)
  - ✅ `create_agrupacion()` crea agrupación con `geometria_agrupacion` completa
  - ✅ Construye estructura JSON de `geometria_agrupacion` con definiciones de geometría Three.js para cada parte
  - ✅ Eliminado método `_determinar_parte()` (no se usa)
  - ✅ `get_particle_type_ids()` retorna `{}` con documentación (no se usa)
  - ✅ `get_matter_state_name()` con nota de que no se usa

**Creator:**
- Modificado `backend/src/database/creators/entity_creator.py` - Agregado soporte para categoría 'biped' en `_get_builder()`

**API Endpoints:**
- Creado `backend/src/api/routes/characters.py` - Endpoints REST para personajes:
  - `GET /api/v1/dimensions/{dimension_id}/characters` - Listar personajes
  - `GET /api/v1/dimensions/{dimension_id}/characters/{character_id}` - Obtener personaje por ID
  - `POST /api/v1/dimensions/{dimension_id}/characters` - Crear personaje desde template
- ✅ Endpoints actualizados para usar `posicion_x/y/z` de agrupación (no buscar partículas)
- ✅ Todos los endpoints retornan `particulas_count: 0` (los bípedos no tienen partículas físicas)
- Modificado `backend/src/main.py` - Registrado router de characters
- Modificado `backend/src/api/__init__.py` - Exportado módulo characters

**Schemas:**
- Modificado `backend/src/models/schemas.py` - Agregados schemas Pydantic:
  - `BipedGeometryPart` - Parte individual de geometría
  - `BipedGeometry` - Geometría completa del bípedo
  - `CharacterResponse` - Respuesta con información completa del personaje
  - `CharacterCreate` - Request para crear personaje

**Scripts:**
- Creado `backend/src/database/seed_character_test.py` - Script para crear personaje de prueba en dimensión de prueba
- Creado `backend/src/database/cleanup_character_particles.py` - Script para limpiar partículas antiguas de personajes existentes

**Documentación:**
- Actualizado `backend/src/database/README.md` - Reflejado que bípedos están implementados
- Actualizado `backend/src/database/templates/README.md` - Agregada sección sobre cómo agregar templates de bípedos
- Creado `backend/src/api/routes/README.md` - Documentación de todos los endpoints de API

### Frontend

**API Client:**
- Creado `frontend/src/api/endpoints/characters.js` - Cliente API para interactuar con endpoints de personajes
- Modificado `frontend/src/api/endpoints/__init__.js` - Exportado módulo characters

**Player Factory:**
- Modificado `frontend/src/ecs/factories/player-factory.js`:
  - Agregada función `buildMeshFromGeometry()` - Construye mesh Three.js desde `geometria_agrupacion`
  - ✅ Corregido cálculo de offsets para que sean relativos a la posición base del personaje
  - ✅ Los offsets ahora se calculan correctamente desde el suelo del personaje
  - ✅ Todas las partes del personaje se posicionan correctamente (cabeza, torso, brazos, piernas)
  - Agregada función `createDefaultMesh()` - Fallback si no hay geometría disponible
  - Modificado `createPlayer()` - Ahora es `async` y carga personaje desde API
  - Soporta crear personaje desde `characterId` existente o desde `templateId` nuevo
  - Usa `GeometryRegistry` para crear geometrías específicas (sphere, cylinder) según definición de BD
  - Manejo de errores mejorado: si una parte falla al crear su geometría, se omite y se continúa con las demás

**App:**
- Modificado `frontend/src/app.js`:
  - Inicializado `CharactersApi` y actualizado llamada a `PlayerFactory.createPlayer()` con `await` y parámetros `templateId` y `dimensionId`
  - ✅ Ya filtra partículas de agrupaciones tipo "biped" (implementado anteriormente)
  - ✅ El mesh se renderiza desde `geometria_agrupacion` (implementado anteriormente)

## Arquitectura Final

**Separación de responsabilidades:**
- **BD (Partículas)**: Mundo estático y persistente (terreno, árboles, rocas)
- **Frontend (Meshes)**: Entidades dinámicas y temporales (personajes, NPCs)

**Ventajas:**
- ✅ **Rendimiento**: 0 queries SQL para movimiento (solo frontend)
- ✅ **Simplicidad**: Un solo sistema de renderizado (mesh)
- ✅ **Escalabilidad**: Fácil agregar múltiples personajes
- ✅ **Mantenibilidad**: Menos código, menos bugs

**¿Por qué no partículas físicas?**
- Los personajes se mueven constantemente (60 FPS)
- Actualizar 19 partículas por movimiento sería ineficiente (~19 queries SQL por movimiento)
- El mesh ya representa el personaje visualmente
- Las partículas en BD son para objetos estáticos (terreno, árboles)

## Testing

Funcionalidad probada localmente con Docker Compose:
- [x] Script de seed crea personaje correctamente en BD (solo agrupación, sin partículas)
- [x] Endpoints de API responden correctamente (GET, POST)
- [x] Frontend carga personaje desde API
- [x] Mesh renderizado coincide con definición de BD
- [x] Todas las partes del personaje se posicionan correctamente
- [x] Sistema ECS funciona con personaje desde BD
- [x] El personaje se mueve sin desincronización
- [x] No hay partículas físicas visibles en el mapa
- [x] Fallback funciona si API falla o no hay geometría
- [x] Script de limpieza elimina partículas antiguas correctamente

**Scripts de prueba:**
- Ejecutar seed de personaje: `docker-compose exec backend python -m src.database.seed_character_test`
- Ejecutar limpieza de partículas: `docker-compose exec backend python src/database/cleanup_character_particles.py`
- Probar endpoints con curl/Postman según documentación en `backend/src/api/routes/README.md`

## Screenshots/Demo

El personaje se renderiza dinámicamente desde la base de datos. Cada parte del cuerpo (cabeza, torso, brazos, piernas) se crea según la definición en `geometria_agrupacion`, permitiendo diferentes formas y tamaños según el template usado. El personaje se mueve fluidamente sin desincronización, ya que solo existe como mesh en el frontend.

## Referencias

- Ticket: JDG-011
- Plan de acción: `instructions/tasks/JDG-011-action-plan_2025-12-06_15-54-56.md`
- Análisis de arquitectura original: `instructions/analysis/JDG-011-architecture-analysis_2025-12-06_15-45-30.md`
- Análisis de posicionamiento: `instructions/analysis/JDG-011-character-positioning-analysis_2025-12-06_17-48-03.md`
- Análisis de renderizado: `instructions/analysis/JDG-011-character-rendering-architecture_2025-12-06_20-21-53.md`
- Documentación templates: `backend/src/database/templates/bipedos/README.md`
- Documentación API: `backend/src/api/routes/README.md`

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (backend)
- [ ] No requiere migraciones de base de datos (usa estructura existente)
- [ ] No requiere cambios en variables de entorno
- [ ] Reiniciar servicios Docker (backend y frontend)
- [ ] **Ejecutar script de limpieza** para bases de datos existentes: `docker-compose exec backend python src/database/cleanup_character_particles.py`

### Verificación Post-Deployment

- [ ] Verificar endpoints con curl/Postman:
  - `GET /api/v1/dimensions/{dimension_id}/characters`
  - `GET /api/v1/dimensions/{dimension_id}/characters/{character_id}`
  - `POST /api/v1/dimensions/{dimension_id}/characters`
- [ ] Ejecutar script de seed: `docker-compose exec backend python -m src.database.seed_character_test`
- [ ] Ejecutar script de limpieza: `docker-compose exec backend python src/database/cleanup_character_particles.py`
- [ ] Verificar frontend en navegador - personaje debe renderizarse correctamente
- [ ] Verificar que NO hay partículas físicas visibles en el mapa para personajes
- [ ] Verificar logs de Docker para errores
- [ ] Verificar que personaje se mueve y funciona con sistema ECS sin desincronización

## Migración

**Para bases de datos existentes:**
- Ejecutar script de limpieza: `docker-compose exec backend python src/database/cleanup_character_particles.py`
- Esto elimina partículas físicas antiguas de personajes existentes
- Los personajes seguirán funcionando correctamente (solo como agrupaciones)

## Riesgos y Plan de Rollback

**Riesgos:**
- El sistema depende de la API para cargar personajes - si falla, el frontend usa fallback
- Cambios en estructura de `geometria_agrupacion` pueden romper renderizado en frontend
- El sistema de templates es nuevo y puede tener bugs no detectados
- Si hay partículas antiguas en BD, pueden causar confusión (resuelto con script de limpieza)

**Plan de Rollback:**
- Revertir commit del PR
- El código anterior (personaje hardcodeado) seguirá funcionando si se revierte completamente
- No hay cambios en base de datos que requieran rollback (usa estructura existente)
- Si solo se revierte backend, el frontend usará fallback automáticamente

## Notas Adicionales

- Los parámetros de geometría en `geometria_agrupacion` son relativos a `tamano_celda` y se escalan en el frontend
- El sistema permite agregar nuevos templates de bípedos fácilmente siguiendo el patrón establecido
- El fallback a mesh por defecto asegura que el juego funcione incluso si la API falla
- La estructura de `geometria_agrupacion` sigue el formato usado por otros sistemas (árboles) para consistencia
- Los métodos `get_particle_type_ids()` y `get_matter_state_name()` se mantienen por compatibilidad con `EntityCreator`, pero retornan valores que no se usan (documentado en código)

## Anexo: Cambios Fuera del Plan

### Mejoras de Manejo de Errores

**Manejo de errores en creación de geometrías:**
- **Archivo:** `frontend/src/ecs/factories/player-factory.js`
- **Cambio:** Agregado try-catch al crear geometrías individuales en `buildMeshFromGeometry()`
- **Razón:** Si una parte falla al crear su geometría, se omite y se continúa con las demás partes
- **Impacto:** Mejora robustez del renderizado

**Validación de coordenadas:**
- **Archivo:** `backend/src/api/routes/characters.py`
- **Cambio:** Agregada validación de coordenadas (x, y >= 0) en endpoint `create_character`
- **Razón:** Prevenir creación de personajes en coordenadas inválidas
- **Impacto:** Mejora validación de entrada

**Mensajes de error mejorados:**
- **Archivo:** `backend/src/api/routes/characters.py`
- **Cambio:** Mensaje de error cuando template no existe ahora incluye lista de templates disponibles
- **Razón:** Facilitar debugging y uso de la API
- **Impacto:** Mejora experiencia de desarrollo

### Correcciones de Arquitectura

**Eliminación de partículas físicas:**
- **Archivo:** `backend/src/database/builders/biped_builder.py`
- **Cambio:** `create_at_position()` ahora retorna lista vacía (no crea partículas)
- **Razón:** Los personajes son entidades dinámicas, no estáticas. Las partículas en BD son para objetos estáticos.
- **Impacto:** Mejora rendimiento y elimina problemas de desincronización

**Corrección de posicionamiento:**
- **Archivo:** `frontend/src/ecs/factories/player-factory.js`
- **Cambio:** Corregido cálculo de offsets para que sean relativos a la posición base del personaje
- **Razón:** Los offsets estaban en coordenadas absolutas, causando posicionamiento incorrecto
- **Impacto:** Todas las partes del personaje se posicionan correctamente

**Limpieza de código:**
- **Archivo:** `backend/src/database/builders/biped_builder.py`
- **Cambio:** Eliminado método `_determinar_parte()` que no se usa
- **Razón:** Código muerto que no tiene efecto
- **Impacto:** Código más limpio y mantenible

