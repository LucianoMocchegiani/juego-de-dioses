# feat(characters): Sistema de Modelos 3D para Personajes

## Resumen

Implementa un sistema completo para almacenar, cargar y renderizar modelos 3D (GLTF/GLB) para personajes. El sistema utiliza almacenamiento local en el backend (preparado para migrar a S3 mediante Strategy pattern), sirve modelos a través de API estática, y los renderiza en el frontend usando Three.js GLTFLoader. Mantiene compatibilidad con el sistema actual de primitivas como fallback.

## Motivación

Actualmente los personajes se renderizan usando geometrías primitivas (esfera, cilindros) definidas en `geometria_agrupacion`, lo que limita la representación visual a formas geométricas simples. Se requiere soporte para modelos 3D reales con texturas, materiales y mayor detalle visual para mejorar la experiencia del juego.

## Criterios de Aceptación

- [x] Existe sistema para almacenar modelos 3D en el backend (sistema de archivos local)
- [x] Los modelos se pueden asociar a personajes en la agrupación (campo `modelo_3d` JSONB)
- [x] Existe endpoint de API para obtener modelo 3D de un personaje
- [x] Existe endpoint de API para servir archivos estáticos de modelos
- [x] El frontend puede cargar modelos GLTF/GLB desde la API
- [x] El modelo se renderiza correctamente en Three.js
- [x] El sistema mantiene compatibilidad con primitivas (fallback si no hay modelo)
- [x] Los modelos pueden tener texturas y materiales
- [x] El sistema maneja errores correctamente (modelo no encontrado, formato no soportado, etc.)
- [x] Los modelos se cachean en el frontend para evitar recargas innecesarias
- [x] La posición, escala y rotación del modelo se respetan según configuración
- [x] Sistema de almacenamiento preparado para migrar a S3 (Strategy pattern)

## Cambios Técnicos

### Backend

- Creado sistema de almacenamiento con Strategy pattern (`storage/storage_interface.py`, `storage/local_file_storage.py`) para facilitar migración futura a S3
- Agregado campo `modelo_3d` JSONB a tabla `agrupaciones` con índice GIN para búsquedas eficientes
- Creados schemas Pydantic `Model3D`, `Model3DOffset`, `Model3DRotation` para validación de datos
- Modificado `BipedBuilder` para aceptar `modelo_3d` opcional al crear agrupaciones
- Actualizado `CharacterResponse` schema para incluir campo `modelo_3d`
- Agregado endpoint `GET /dimensions/{id}/characters/{id}/model` para obtener metadatos del modelo
- Configurado FastAPI para servir archivos estáticos desde `/static/models/`
- Creados scripts de utilidad para descargar modelos de prueba (`download_test_model.py`, `seed_character_with_model.py`)

### Frontend

- Creado `ModelLoader` con Factory pattern para soportar múltiples formatos (GLTF/GLB)
- Implementado `ModelCache` con Registry pattern y Singleton para cachear modelos cargados
- Creada función `loadModel3D()` en `model-utils.js` para cargar modelos y aplicar transformaciones (escala, offset, rotación)
- Modificado `PlayerFactory` para priorizar `modelo_3d` > `geometria_agrupacion` > default con fallback robusto
- Agregado método `getCharacterModel()` en `CharactersApi` (opcional, para debugging)
- Implementado cache-busting mediante timestamp en URLs para forzar actualización de modelos
- Mejorado manejo de errores con fallback automático a primitivas

### Base de Datos

- Migración SQL: `ALTER TABLE juego_dioses.agrupaciones ADD COLUMN modelo_3d JSONB`
- Índice GIN: `CREATE INDEX idx_agrupaciones_modelo_3d ON juego_dioses.agrupaciones USING GIN (modelo_3d)`
- Estructura JSONB del campo `modelo_3d`:
  ```json
  {
    "tipo": "glb",
    "ruta": "characters/humano_test.glb",
    "escala": 1.0,
    "offset": {"x": 0, "y": 0, "z": 0},
    "rotacion": {"x": 0, "y": 0, "z": 0}
  }
  ```

### Docker/Infraestructura

- Creada estructura de directorios `backend/static/models/characters/` para almacenar modelos
- Agregado `.gitkeep` para mantener estructura en git
- Configurado nginx para servir archivos estáticos (ya existente)

## Testing

- Probado localmente con Docker Compose
- Verificado carga de modelos GLB (Duck, BrainStem, Avocado, BarramundiFish)
- Verificado fallback a primitivas cuando no hay modelo 3D
- Verificado cache de modelos (múltiples personajes con mismo modelo)
- Verificado aplicación de transformaciones (escala, offset, rotación)
- Verificado manejo de errores (modelo no encontrado, formato inválido)
- Endpoints probados con curl y navegador
- Frontend probado en navegador con Three.js

## Screenshots/Demo

Los modelos de prueba están disponibles en `backend/static/models/characters/`:
- `duck.glb` - Modelo de pato (recomendado para pruebas)
- `brainstem.glb` - Modelo de cerebro
- `avocado.glb` - Modelo de aguacate
- `barramundi.glb` - Modelo de pez
- `humano_test.glb` - Modelo humano de prueba

## Referencias

- Ticket: JDG-012
- Plan de acción: `instructions/tasks/JDG-012-action-plan_2025-12-06_21-06-03.md`
- Análisis de arquitectura: `instructions/analysis/JDG-012-architecture-analysis_2025-12-06_20-59-54.md`
- Plan de testing: `instructions/testing/JDG-012-testing-plan_2025-12-06_22-45-00.md`
- Documentación relacionada:
  - `backend/src/storage/README.md` - Sistema de almacenamiento
  - `frontend/src/renderers/models/README.md` - Sistema de carga de modelos
  - `INSTRUCCIONES-DESCARGAR-MODELO.md` - Guía para agregar modelos

## Deployment

### Cambios Requeridos

- [x] Rebuild Docker images
- [x] Ejecutar migraciones de base de datos (agregar campo `modelo_3d`)
- [ ] Actualizar variables de entorno (no requerido, usa defaults)
- [x] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar que directorio `static/models/` existe y es accesible
- [ ] Verificar endpoint `/static/models/{ruta}` sirve archivos correctamente
- [ ] Verificar endpoint `/api/v1/dimensions/{id}/characters/{id}/model` funciona
- [ ] Crear personaje con modelo de prueba usando `seed_character_with_model.py`
- [ ] Verificar que modelo se carga en frontend
- [ ] Verificar que fallback funciona si modelo no existe
- [ ] Verificar logs de Docker para errores
- [ ] Verificar que cache funciona (múltiples personajes con mismo modelo)

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Modelos grandes pueden afectar rendimiento (mitigado con cache y lazy loading)
- Cambio en schema de BD requiere migración (campo opcional, backward compatible)
- Cache del navegador puede servir modelos antiguos (mitigado con cache-busting)

**Plan de Rollback:**
1. Revertir commit del PR
2. Ejecutar migración inversa: `ALTER TABLE juego_dioses.agrupaciones DROP COLUMN modelo_3d`
3. Eliminar índice: `DROP INDEX IF EXISTS idx_agrupaciones_modelo_3d`
4. Rebuild Docker images y reiniciar servicios
5. Los personajes existentes seguirán funcionando con primitivas (campo opcional)

## Notas Adicionales

- El sistema está preparado para migrar a S3 en el futuro mediante Strategy pattern sin modificar código existente
- Los modelos se cachean en memoria del frontend para evitar recargas innecesarias
- El sistema mantiene compatibilidad total con personajes existentes (campo `modelo_3d` es opcional)
- Se incluyen scripts de utilidad para descargar modelos de prueba desde URLs públicas
- Se agregó documentación completa en READMEs para facilitar mantenimiento y extensión

## Anexo: Cambios Fuera del Plan

### Limpieza de Código

- **Archivos modificados:** Múltiples archivos del frontend
- **Cambio:** Eliminados/comentados ~40 `console.log`, `console.warn`, `console.error` para limpiar salida de consola
- **Razón:** Mejorar experiencia de desarrollo y reducir ruido en logs
- **Archivos afectados:**
  - `frontend/src/renderers/models/model-utils.js`
  - `frontend/src/ecs/factories/player-factory.js`
  - `frontend/src/ecs/systems/render-system.js`
  - `frontend/src/ecs/components/render.js`
  - `frontend/src/api/endpoints/characters.js`
  - `frontend/src/app.js`
  - `frontend/src/main.js`
  - `frontend/src/ecs/systems/collision-system.js`
  - `frontend/src/systems/collision-detector.js`
  - `frontend/src/renderers/particle-renderer.js`
  - `frontend/src/renderers/geometries/registry.js`
- **Impacto:** Bajo, solo afecta debugging (logs comentados, no eliminados)

### Mejora de Cache

- **Archivo:** `frontend/src/renderers/models/model-utils.js`
- **Cambio:** Corregida lógica redundante de cache que limpiaba todo el cache innecesariamente
- **Razón:** Optimizar uso de memoria y evitar recargas innecesarias
- **Impacto:** Positivo, mejora rendimiento

### Scripts de Utilidad Adicionales

- **Archivos:** `backend/src/database/download_test_model.py`, `backend/src/database/seed_character_with_model.py`
- **Cambio:** Scripts para facilitar testing y desarrollo con modelos de prueba
- **Razón:** Agilizar proceso de testing y desarrollo
- **Impacto:** Positivo, facilita trabajo futuro

