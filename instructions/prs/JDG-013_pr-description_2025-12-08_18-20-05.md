# feat(characters): Reemplazar Modelo de Personaje con Human.glb

## Resumen

Reemplaza los modelos de prueba (duck.glb, humano_test.glb) con el modelo `Human.glb` como modelo principal para personajes humanos. El modelo incluye vertex groups preparados para el sistema de daño por partes (JDG-014) y se configura con escala, offset y rotación apropiadas para renderizado correcto en el juego.

## Motivación

Se ha creado un modelo humanoide optimizado (`Human.glb`) con estilo voxel/low-poly que incluye vertex groups para el sistema de daño por partes. Este modelo debe reemplazar los modelos de prueba actuales para ser usado como personaje principal en el juego, preparando el terreno para la implementación del sistema de daño por partes del cuerpo.

## Criterios de Aceptación

- [x] El modelo `Human.glb` está disponible en `backend/static/models/characters/`
- [x] Se puede crear un personaje con `Human.glb` usando el script de seed
- [x] El modelo se carga correctamente en el frontend
- [x] El modelo se renderiza correctamente en Three.js con escala y posición adecuadas
- [x] Los vertex groups están presentes en el modelo cargado (verificación en Three.js)
- [x] El modelo reemplaza los modelos de prueba como modelo principal
- [x] El script `seed_character_with_model.py` usa `Human.glb` por defecto
- [x] El modelo tiene escala apropiada (6.0, tamaño humano normal)
- [x] El modelo mantiene el estilo voxel/low-poly del mundo

## Cambios Técnicos

### Backend

- **`seed_character_with_model.py`**: Actualizado para usar `Human.glb` como modelo principal por defecto
  - Cambiado `model_path` de `humano_test.glb` a `characters/Human.glb`
  - Configurado `escala=6.0` para tamaño humano apropiado
  - Configurado `offset.z=0.9` para posicionar correctamente sobre el terreno
  - Configurado `rotacion.z=180` (mapeado a Y de Three.js) para orientación correcta
  - Implementado cálculo dinámico de altura del terreno usando `get_terrain_height_area`
  - Personaje se posiciona en `terrain_height + 1` para estar sobre el terreno

- **`update_human_scale.py`**: Script de utilidad para ajustar escala, offset y rotación del modelo `Human.glb`
  - Permite actualizar `escala`, `offset.z` y `rotacion.z` en la base de datos
  - Limpia `rotacion.y` anterior si existe
  - Útil para ajustes iterativos durante desarrollo

- **`utils/terrain_utils.py`**: Utilidades para obtener altura del terreno
  - `get_terrain_height()`: Obtiene altura Z de partícula más alta en posición (x, y)
  - `get_terrain_height_area()`: Obtiene altura Z en un área con radio (para terrenos irregulares)
  - Usado para posicionar personajes dinámicamente según el terreno

- **`check_character_position.py`**: Script de verificación para inspeccionar posición y modelo de personajes

### Frontend

- **`renderers/models/model-utils.js`**: Mejoras en manejo de transformaciones
  - Corregido mapeo de rotación: `rotacion.z` del juego se mapea a `rotation.y` de Three.js (rotación horizontal)
  - Almacenamiento de `modelOffset` y `modelRotation` en `userData` para preservar transformaciones iniciales
  - Actualizado comentario sobre offset (ya no se sobrescribe, se suma)

- **`ecs/systems/render-system.js`**: Corrección de rotación del modelo
  - Suma `modelRotation` del modelo a la rotación del personaje en lugar de sobrescribirla
  - Preserva rotación inicial del modelo (180° en Y) mientras permite rotación del personaje
  - Eliminado código muerto `_scaleDebugLogged`

- **`ecs/factories/player-factory.js`**: Verificación de vertex groups
  - Agregada verificación de vertex groups después de cargar modelo 3D
  - Almacena `vertexGroups` y `vertexGroupsList` en `mesh.userData` para futura implementación de JDG-014

- **`renderers/models/vertex-groups-utils.js`**: Utilidades para vertex groups (ya existente, usado en esta implementación)
  - `getVertexGroups()`: Extrae vertex groups del modelo
  - `listVertexGroups()`: Lista nombres de vertex groups disponibles
  - `hasVertexGroups()`: Verifica si el modelo tiene vertex groups
  - `getPartMesh()`: Obtiene mesh de una parte específica del cuerpo

### Base de Datos

- No se requieren migraciones (usa campo `modelo_3d` JSONB existente de JDG-012)

### Docker/Infraestructura

- No se requieren cambios (modelo estático en `backend/static/models/`)

## Testing

- Probado localmente con Docker Compose
- Verificado que el modelo se carga correctamente desde la API
- Verificado que el modelo se renderiza en Three.js con escala, posición y rotación correctas
- Verificado que los vertex groups están disponibles en el modelo cargado
- Verificado posicionamiento dinámico basado en altura del terreno
- Ajustes iterativos de escala (de 10.0 a 6.0) y offset (de 1.0 a 0.9) hasta encontrar valores óptimos
- Verificado que la rotación del modelo se preserva correctamente (180° en Y para mirar de espaldas a la cámara)

## Screenshots/Demo

El modelo `Human.glb` se renderiza correctamente en el juego con:
- Tamaño humano apropiado (escala 6.0)
- Posición correcta sobre el terreno (offset Z 0.9m)
- Orientación correcta (rotación Y 180° para mirar de espaldas a la cámara)
- Vertex groups disponibles para futura implementación de sistema de daño por partes

## Referencias

- Ticket: JDG-013
- PR relacionado: JDG-012 (Sistema de Modelos 3D para Personajes)
- Bloquea: JDG-014 (Sistema de Daño por Partes del Cuerpo)
- Documentación relacionada:
  - `GUIA-CREAR-MODELOS-PARTES-CRITICAS.md`
  - `PROMPTS-IA-MODELOS-VOXEL.md`
  - `frontend/src/renderers/models/README.md`

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (no requerido, solo archivo estático)
- [ ] Ejecutar migraciones de base de datos (no requerido)
- [ ] Actualizar variables de entorno (no requerido)
- [ ] Reiniciar servicios Docker (no requerido, modelo estático)

### Verificación Post-Deployment

- [ ] Verificar que el modelo está accesible en `/static/models/characters/Human.glb`
- [ ] Crear personaje con script de seed: `python src/database/seed_character_with_model.py`
- [ ] Verificar que el modelo se carga en frontend
- [ ] Verificar que el modelo se renderiza correctamente con escala y posición adecuadas
- [ ] Verificar logs de Docker para errores

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo riesgo: Solo se agrega un archivo estático y se actualiza configuración de modelos
- Personajes existentes con otros modelos no se ven afectados (compatibilidad mantenida)
- Si el modelo no se carga, el sistema hace fallback a primitivas (ya implementado en JDG-012)

**Plan de Rollback:**
- Revertir cambios en `seed_character_with_model.py` para usar modelo anterior
- Actualizar `modelo_3d` en base de datos para personajes existentes si es necesario
- El modelo estático puede permanecer sin afectar funcionalidad

## Notas Adicionales

- El modelo `Human.glb` fue creado usando Meshy AI y optimizado en Blender (de 246k a 905 caras)
- Los vertex groups fueron creados manualmente en Blender: head, torso, left_arm, right_arm, left_leg, right_leg
- El modelo tiene estilo voxel/low-poly que coincide con el mundo de partículas
- Este PR prepara el terreno para JDG-014 (sistema de daño por partes)

## Anexo: Cambios Fuera del Plan

### Corrección de Mapeo de Rotación

- **Archivo:** `frontend/src/renderers/models/model-utils.js`, `frontend/src/ecs/systems/render-system.js`
- **Problema:** El modelo se renderizaba mirando hacia la cámara en lugar de de espaldas
- **Causa:** Mapeo incorrecto de ejes de rotación (`rotacion.y` del juego se mapeaba a `rotation.z` de Three.js en lugar de `rotation.y`)
- **Solución:** 
  - Corregido mapeo: `rotacion.z` del juego → `rotation.y` de Three.js (rotación horizontal)
  - Implementado almacenamiento de `modelRotation` en `userData` para preservar rotación inicial
  - `RenderSystem` ahora suma la rotación inicial del modelo a la rotación del personaje
- **Impacto:** Crítico para orientación correcta del personaje

### Limpieza de Código

- **Archivos:** `frontend/src/renderers/models/model-utils.js`, `frontend/src/ecs/systems/render-system.js`, `backend/src/database/seed_character_with_model.py`
- **Cambios:**
  - Eliminado código muerto `_scaleDebugLogged` en `render-system.js`
  - Actualizado comentario obsoleto sobre offset en `model-utils.js`
  - Eliminados comentarios sobre escalas de modelos obsoletos (Duck, BrainStem, etc.) en `seed_character_with_model.py`
- **Razón:** Mantener código limpio y sin redundancias según regla de calidad de código
- **Impacto:** Mejora mantenibilidad del código

### Utilidades de Terreno

- **Archivo:** `backend/src/database/utils/terrain_utils.py` (nuevo)
- **Cambio:** Creado módulo de utilidades para obtener altura del terreno
- **Razón:** Permitir posicionamiento dinámico de personajes basado en altura del terreno
- **Impacto:** Mejora experiencia de usuario (personajes no aparecen enterrados o flotando)

### Scripts de Utilidad

- **Archivos:** `backend/src/database/update_human_scale.py`, `backend/src/database/check_character_position.py` (nuevos)
- **Cambio:** Creados scripts de utilidad para ajustar y verificar propiedades del modelo
- **Razón:** Facilitar ajustes iterativos durante desarrollo y debugging
- **Impacto:** Mejora productividad del desarrollo

