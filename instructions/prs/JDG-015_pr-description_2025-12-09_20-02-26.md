# feat(frontend): Sistema de Animaciones con GLB usando AnimationMixer

## Resumen

Implementa sistema de animaciones para personajes usando Three.js AnimationMixer con archivos GLB de animaciones pre-renderizadas. El sistema carga animaciones desde archivos separados, las aplica al modelo del personaje, y gestiona transiciones suaves entre estados de animación (idle, walk, run, attack, combat_stance).

## Motivación

El personaje humano se mostraba en T-pose estático sin animaciones. Se necesitaba implementar animaciones básicas que representaran el estado del personaje (caminar, correr, atacar). En lugar de animaciones procedurales, se optó por usar animaciones pre-renderizadas en formato GLB generadas con IA (Meshy) para mayor calidad y naturalidad.

## Criterios de Aceptación

- [x] El sistema carga animaciones desde archivos GLB separados
- [x] Las animaciones se reproducen correctamente según el estado del personaje
- [x] Las animaciones de caminar y correr funcionan correctamente
- [x] La animación de ataque se reproduce cuando el usuario hace click izquierdo
- [x] La animación de combat_stance se muestra cuando el personaje está idle
- [x] Las transiciones entre animaciones son suaves (fadeOut/fadeIn)
- [x] El sistema maneja correctamente el ciclo de vida de las animaciones (inicio, loop, fin)
- [x] El sistema preserva las transformaciones del modelo original (posición, rotación, escala)
- [x] El sistema funciona con el modelo Character_output.glb y sus animaciones de Meshy

## Cambios Técnicos

### Frontend

**Nuevos archivos:**
- `frontend/src/ecs/systems/animation-mixer-system.js` - Sistema que reproduce animaciones usando AnimationMixer de Three.js
- `frontend/src/renderers/models/bones-utils.js` - Utilidades para trabajar con bones/esqueleto del modelo

**Archivos modificados:**
- `frontend/src/ecs/systems/index.js` - Exporta AnimationMixerSystem
- `frontend/src/app.js` - Registra AnimationMixerSystem en el ECS
- `frontend/src/ecs/components/animation.js` - Agregado flag `isAttacking` para controlar estado de ataque
- `frontend/src/ecs/systems/animation-system.js` - Agregada lógica para detectar estado de ataque
- `frontend/src/ecs/factories/player-factory.js` - Actualizado para usar bones en lugar de vertex groups
- `frontend/src/renderers/models/model-loader.js` - Limpieza de logs

**Características implementadas:**
- Carga de animaciones desde archivos GLB separados con sistema de cache
- Inicialización de AnimationMixer para cada entidad
- Reemplazo del modelo base con el modelo del archivo de animación (para compatibilidad de esqueleto)
- Preservación de transformaciones originales (posición, rotación, escala, userData)
- Mapeo de estados de juego a animaciones (idle → combat_stance, walk → walk, run → run, attack → attack)
- Sistema de transiciones con fadeOut/fadeIn entre animaciones
- Manejo especial de animación de ataque (LoopOnce, transición a combat_stance al finalizar)
- Sistema para prevenir que combat_stance interrumpa otras animaciones activas
- Detección manual de finalización de animación de ataque para transición suave

### Backend

**Archivos nuevos:**
- `backend/static/models/animations/Animation_Walking_withSkin.glb`
- `backend/static/models/animations/Animation_Running_withSkin.glb`
- `backend/static/models/animations/Animation_Combat_Stance_withSkin.glb`
- `backend/static/models/animations/Animation_Left_Slash_withSkin.glb`

**Archivos modificados:**
- `backend/src/database/seed_character_with_model.py` - Actualizado para usar Character_output.glb con escala 5.0
- `backend/src/database/update_human_scale.py` - Actualizado para usar Character_output.glb

**Limpieza:**
- Eliminados modelos no utilizados: `duck.glb`, `avocado.glb`, `brainstem.glb`, `barramundi.glb`, `humano_test.glb`, `Human.glb`

## Testing

Se probó localmente en el navegador:
- [x] Animación de caminar se reproduce cuando el personaje se mueve
- [x] Animación de correr se reproduce cuando el personaje corre (Shift + movimiento)
- [x] Animación de combat_stance se reproduce cuando el personaje está idle
- [x] Animación de ataque se reproduce cuando se hace click izquierdo
- [x] Transición de ataque a combat_stance es suave sin T-pose
- [x] Transiciones entre walk/run y combat_stance funcionan correctamente
- [x] El modelo mantiene su posición y escala correctas
- [x] Las animaciones no afectan negativamente el rendimiento (mantiene 60 FPS)
- [x] El sistema maneja correctamente múltiples inicializaciones simultáneas

## Screenshots/Demo

Las animaciones son visibles en el juego cuando el personaje se mueve, corre, ataca o está idle. La animación de combat_stance se muestra como estado base cuando no hay acción activa.

## Referencias

- Ticket: JDG-015
- PRs relacionados: JDG-013 (reemplazo de modelo de personaje)
- Documentación relacionada: 
  - Three.js AnimationMixer: https://threejs.org/docs/#api/en/animation/AnimationMixer
  - Three.js GLTFLoader: https://threejs.org/docs/#examples/en/loaders/GLTFLoader

## Deployment

### Cambios Requeridos

- [x] Los archivos GLB de animaciones deben estar en `backend/static/models/animations/`
- [x] Rebuild Docker images (frontend requiere nuevos archivos JavaScript)
- [ ] Verificar que los archivos estáticos se sirven correctamente desde `/static/models/`

### Verificación Post-Deployment

- [ ] Verificar que las animaciones se cargan correctamente (revisar Network tab en DevTools)
- [ ] Verificar que el personaje muestra animaciones al moverse
- [ ] Verificar que la animación de ataque funciona correctamente
- [ ] Verificar logs de consola para errores de carga de animaciones
- [ ] Verificar que el modelo mantiene escala y posición correctas

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Si los archivos GLB no se cargan correctamente, el personaje puede quedarse sin animaciones o mostrar errores en consola
- Si el modelo base y las animaciones tienen esqueletos incompatibles, pueden aparecer deformaciones
- Cambios en el sistema pueden afectar otras entidades que usen animaciones en el futuro

**Plan de rollback:**
- Revertir commits relacionados con AnimationMixerSystem
- Remover registro de AnimationMixerSystem en app.js
- El sistema anterior (solo AnimationSystem sin reproducción visual) seguirá funcionando
- Los archivos GLB pueden permanecer sin afectar funcionalidad si no se usan

## Notas Adicionales

- Las animaciones fueron generadas usando Meshy (IA) y vienen con su propio modelo/esqueleto
- El sistema usa el modelo del archivo de animación como base para garantizar compatibilidad de esqueleto
- Se reemplazó el uso de vertex groups por bones para mejor compatibilidad con animaciones
- El sistema está preparado para agregar más animaciones en el futuro (solo requiere agregar archivos GLB y mapeo en ANIMATION_FILES)
- Se implementó sistema de cache para evitar recargar animaciones múltiples veces
- El sistema previene múltiples inicializaciones simultáneas del AnimationMixer

## Anexo: Cambios Fuera del Plan

### Cambio de Enfoque: Animaciones Pre-renderizadas vs Procedurales

**Plan original:** Implementar animaciones procedurales usando vertex groups y funciones matemáticas (seno/coseno) para mover partes del cuerpo.

**Implementación real:** Se optó por usar animaciones pre-renderizadas en formato GLB generadas con IA (Meshy) por las siguientes razones:
- Mayor calidad y naturalidad de las animaciones
- Menos tiempo de desarrollo (no requiere tuning fino de valores)
- Mejor compatibilidad con futuras mejoras (animaciones más complejas)
- Animaciones incluyen información de esqueleto completa

**Archivos afectados:** Todo el sistema de animaciones fue implementado de forma diferente al plan original.

### Migración de Vertex Groups a Bones

**Cambio:** Se reemplazó el sistema de vertex groups por bones/esqueleto para mejor compatibilidad con animaciones GLB.

**Archivos afectados:**
- `frontend/src/ecs/factories/player-factory.js` - Ahora usa `mapBonesToBodyParts` en lugar de vertex groups
- `frontend/src/renderers/models/bones-utils.js` - Nuevo archivo con utilidades para bones

**Razón:** Las animaciones GLB requieren un esqueleto consistente, y bones son más apropiados para este propósito que vertex groups.

### Limpieza de Modelos No Utilizados

**Archivos eliminados:**
- `backend/static/models/characters/duck.glb`
- `backend/static/models/characters/avocado.glb`
- `backend/static/models/characters/brainstem.glb`
- `backend/static/models/characters/barramundi.glb`
- `backend/static/models/characters/humano_test.glb`
- `backend/static/models/characters/Human.glb`

**Razón:** Estos modelos ya no se utilizan y fueron reemplazados por `Character_output.glb` con animaciones.

### Mejoras en Sistema de Ataque

**Cambio:** Se implementó sistema robusto para manejar animación de ataque con flags y detección manual de finalización.

**Archivos afectados:**
- `frontend/src/ecs/components/animation.js` - Agregado flag `isAttacking`
- `frontend/src/ecs/systems/animation-mixer-system.js` - Lógica compleja para transiciones de ataque

**Razón:** La animación de ataque tiene comportamiento especial (reproducir una vez, transicionar a combat_stance) que requiere manejo específico.

