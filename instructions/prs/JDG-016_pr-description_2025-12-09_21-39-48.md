# refactor(frontend): Sistema de Animaciones Escalable con State Machine

## Resumen

Refactoriza el sistema de animaciones del frontend para hacerlo escalable mediante una arquitectura basada en máquina de estados finita (FSM) con configuración declarativa. Reemplaza las cadenas de `if/else` hardcodeadas por un sistema configurable que permite agregar nuevas animaciones solo modificando configuración, sin tocar código. Implementa patrones State Machine, Configuration, Strategy, Registry y Factory para separar lógica de datos.

## Motivación

El sistema de animaciones actual tiene limitaciones de escalabilidad. Cada nueva acción (block, dodge, cast_spell, etc.) requiere modificar múltiples archivos: agregar `if/else` en `AnimationSystem`, mapeos en `AnimationMixerSystem`, actualizar constantes y componentes. Esto dificulta el mantenimiento y escalabilidad conforme se agreguen más acciones al juego. El nuevo sistema permite agregar nuevas animaciones solo modificando un archivo de configuración.

## Criterios de Aceptación

- [x] Se puede agregar una nueva acción solo modificando un archivo de configuración
- [x] Las prioridades de estados están definidas como números y se ordenan automáticamente
- [x] El sistema de estados utiliza una máquina de estados finita (FSM) con configuración declarativa
- [x] El mapeo estado → animación está declarado en configuración, no hardcodeado
- [x] Agregar un nuevo estado requiere cambios mínimos (< 5 líneas) en código existente
- [x] Cambiar prioridades entre estados existentes solo requiere modificar configuración
- [x] El sistema mantiene compatibilidad con las animaciones y estados actuales
- [x] Las transiciones entre estados son explícitas y configurables
- [x] El código es más testeable (condiciones y prioridades independientes)
- [x] La documentación explica cómo agregar nuevas acciones y estados

## Cambios Técnicos

### Frontend

#### Nuevos Archivos Creados

**Sistema de Configuración:**
- `frontend/src/ecs/animation/config/animation-config.js` - Configuración declarativa de estados, prioridades, condiciones y animaciones

**Sistema de Condiciones:**
- `frontend/src/ecs/animation/conditions/base-condition.js` - Clase base abstracta para condiciones
- `frontend/src/ecs/animation/conditions/input-condition.js` - Evalúa propiedades de InputComponent
- `frontend/src/ecs/animation/conditions/physics-condition.js` - Evalúa propiedades de PhysicsComponent
- `frontend/src/ecs/animation/conditions/movement-condition.js` - Evalúa movimiento basado en InputComponent
- `frontend/src/ecs/animation/conditions/condition-factory.js` - Factory para crear condiciones desde configuración
- `frontend/src/ecs/animation/conditions/index.js` - Exports del módulo de condiciones

**Sistema de Estados:**
- `frontend/src/ecs/animation/states/state-config.js` - Clase que representa configuración de un estado individual
- `frontend/src/ecs/animation/states/state-registry.js` - Registry que gestiona estados y determina el estado activo
- `frontend/src/ecs/animation/states/index.js` - Exports del módulo de estados

**Sistema ECS:**
- `frontend/src/ecs/systems/animation-state-system.js` - Nuevo sistema ECS que determina estados usando FSM
- `frontend/src/ecs/animation/index.js` - Exports principales del módulo de animaciones

**Documentación:**
- `frontend/src/ecs/animation/README.md` - Documentación completa del sistema de animaciones escalable

#### Archivos Modificados

- `frontend/src/ecs/systems/animation-mixer-system.js` - Refactorizado para usar configuración declarativa en lugar de mapeos hardcodeados. Elimina lógica manual de mapeo estado → animación.
- `frontend/src/app.js` - Integra `AnimationStateSystem`, elimina referencia a `AnimationSystem` antiguo
- `frontend/src/ecs/systems/index.js` - Actualiza exports: remueve `AnimationSystem`, agrega `AnimationStateSystem`
- `frontend/src/ecs/README.md` - Actualiza documentación para reflejar nuevos sistemas y estructura

#### Archivos Eliminados

- `frontend/src/ecs/systems/animation-system.js` - Sistema antiguo eliminado completamente

#### Renombramientos

- `animation-state-machine.js` → `animation-state-system.js` (para consistencia con nomenclatura de sistemas ECS)
- `AnimationStateMachine` → `AnimationStateSystem` (clase renombrada)

### Arquitectura Implementada

**Patrones de Diseño:**
1. **State Machine (FSM)**: Cada animación es un estado con condiciones de activación
2. **Configuration Pattern**: Separación de datos (config) de lógica (evaluación)
3. **Strategy Pattern**: Diferentes tipos de condiciones (Input, Physics, Movement)
4. **Registry Pattern**: `StateRegistry` centraliza gestión de estados
5. **Factory Pattern**: `ConditionFactory` crea condiciones desde configuración

**Flujo de Ejecución:**
1. `AnimationStateSystem` (Priority 2) evalúa condiciones y determina estado activo
2. Actualiza `AnimationComponent.currentState`
3. `AnimationMixerSystem` (Priority 2.5) lee estado y reproduce animación GLB correspondiente

**Sistema de Condiciones:**
- Soporta operadores: `equals`, `notEquals`, `greaterThan`, `lessThan`, `greaterThanOrEqual`, `lessThanOrEqual`
- Tipos de condiciones: `input` (InputComponent), `physics` (PhysicsComponent), `movement` (movimiento)
- Evaluación con lógica AND (todas las condiciones deben cumplirse)

## Testing

Se realizó testing manual exhaustivo:

- [x] Probado localmente en navegador
- [x] Todas las animaciones existentes funcionan correctamente (idle, walk, run, attack, jump, crouch)
- [x] Transiciones entre estados son suaves (fadeIn/fadeOut correctos)
- [x] Prioridades funcionan correctamente (attack > jump > run > walk > idle)
- [x] Condiciones se evalúan correctamente para cada tipo (input, physics, movement)
- [x] Fallback automático funciona (estados sin animación usan combat_stance)
- [x] Sistema mantiene mismo rendimiento que anterior
- [x] Agregar nuevo estado solo requiere modificar configuración (verificado con ejemplo)

**Escenarios Verificados:**
1. Agregar nueva acción: Se puede agregar `block` solo modificando `animation-config.js`
2. Cambiar prioridades: Modificar prioridad entre estados solo requiere configuración
3. Estado sin animación: Estados sin animación definida usan fallback automático
4. Compatibilidad: Todas las animaciones actuales siguen funcionando
5. Transiciones: Transiciones entre estados son suaves y correctas

## Referencias

- Ticket: JDG-016
- Análisis de Arquitectura: `instructions/analysis/JDG-016-architecture-analysis_2025-12-09_19-59-40.md`
- Plan de Acción: `instructions/tasks/JDG-016-action-plan_2025-12-09_21-37-27.md`
- Relacionado con: JDG-015 (Sistema de animaciones básico)
- Documentación: `frontend/src/ecs/animation/README.md`

## Deployment

### Cambios Requeridos

- [x] No requiere rebuild de Docker images (solo cambios en JavaScript)
- [ ] Ejecutar migraciones de base de datos: No aplica
- [ ] Actualizar variables de entorno: No aplica
- [ ] Reiniciar servicios Docker: No es necesario, cambios solo en frontend

### Verificación Post-Deployment

- [ ] Verificar que todas las animaciones funcionan en navegador
- [ ] Verificar transiciones suaves entre estados
- [ ] Verificar que agregar nuevo estado solo requiere modificar configuración
- [ ] Verificar rendimiento (no debe ser más lento que antes)
- [ ] Verificar logs de consola (no deben aparecer errores)

## Riesgos y Plan de Rollback

**Riesgos Identificados:**

1. **Bajo Riesgo**: Cambio de arquitectura completo del sistema de animaciones
   - **Mitigación**: Sistema mantiene compatibilidad total con `AnimationComponent` existente
   - **Rollback**: Revertir commit y restaurar `AnimationSystem` antiguo desde historial

2. **Bajo Riesgo**: Posibles bugs en evaluación de condiciones
   - **Mitigación**: Testing exhaustivo realizado, sistema probado con todas las animaciones existentes
   - **Rollback**: Si se detectan bugs, pueden corregirse sin afectar el resto del sistema

3. **Ninguno**: Cambios en performance
   - **Mitigación**: Sistema mantiene mismo rendimiento, condiciones cacheadas

**Plan de Rollback:**

Si es necesario revertir:

```bash
# Opción 1: Revertir commit específico
git revert <commit-hash>

# Opción 2: Restaurar sistema antiguo desde historial
git checkout <commit-anterior> -- frontend/src/ecs/systems/animation-system.js
```

**Archivos críticos a verificar en rollback:**
- `frontend/src/ecs/systems/animation-system.js` (restaurar desde historial)
- `frontend/src/app.js` (restaurar referencia a `AnimationSystem`)
- `frontend/src/ecs/systems/index.js` (restaurar export de `AnimationSystem`)

## Notas Adicionales

- El sistema antiguo (`AnimationSystem`) fue completamente eliminado ya que fue reemplazado por `AnimationStateSystem`
- La configuración está centralizada en `animation-config.js`, facilitando agregar nuevas animaciones
- El sistema es completamente backward-compatible: `AnimationComponent` mantiene misma interfaz pública
- `AnimationMixerSystem` sigue funcionando igual, solo cambia de dónde lee la configuración
- Documentación completa disponible en `frontend/src/ecs/animation/README.md` con ejemplos de uso

## Anexo: Cambios Fuera del Plan

### Actualización de Nomenclatura para Consistencia

**Cambio:** Renombrado `AnimationStateMachine` → `AnimationStateSystem`

**Archivos afectados:**
- `frontend/src/ecs/systems/animation-state-machine.js` → `animation-state-system.js`
- Todos los imports y referencias actualizados

**Razón:** Mantener consistencia con nomenclatura de sistemas ECS (todos terminan en "System": `InputSystem`, `PhysicsSystem`, `RenderSystem`, etc.)

**Impacto:** Solo nomenclatura, sin cambios funcionales. Todos los archivos de código y documentación fueron actualizados.

### Actualización de Documentación en Archivos de Instrucciones

**Cambios:**
- Actualizado `instructions/analysis/JDG-016-architecture-analysis_2025-12-09_19-59-40.md`
- Actualizado `instructions/tickets/JDG-016_work-ticket_2025-12-09_19-59-40.md`

**Razón:** Mantener documentación sincronizada con nombres correctos de sistemas después del renombramiento

**Impacto:** Solo documentación, sin impacto en código

### Eliminación de Código No Usado

**Cambio:** Eliminado completamente `AnimationSystem` antiguo y todas sus referencias

**Archivos eliminados:**
- `frontend/src/ecs/systems/animation-system.js`

**Razón:** Sistema completamente reemplazado, no hay razón para mantener código obsoleto

**Impacto:** Limpieza de código, reduce confusión y mantiene codebase limpio

### Creación de README Completo

**Archivo creado:**
- `frontend/src/ecs/animation/README.md` - Documentación completa del módulo

**Razón:** Seguir práctica establecida de documentar cada módulo/carpeta con su README según regla `readme-rule.mdc`

**Impacto:** Mejora mantenibilidad y facilita onboarding de nuevos desarrolladores

