# fix(frontend): Animaciones en loop se detienen correctamente al soltar teclas de movimiento

## Resumen
Corrige el bug donde las animaciones de movimiento continuo (walk, run) no se detenían al soltar las teclas. También implementa un sistema escalable basado en configuración para determinar qué animaciones deben interrumpirse cuando se suelta el input, reemplazando código hardcodeado.

## Motivación
Las animaciones en loop (walk, run) continuaban reproduciéndose indefinidamente aunque el personaje estuviera quieto al soltar las teclas. Esto creaba una inconsistencia visual donde el personaje parecía estar caminando pero estaba quieto. Además, el código tenía lógica hardcodeada para verificar estados específicos, lo que dificultaba agregar nuevas animaciones de movimiento continuo.

## Criterios de Aceptación
- [x] Cuando el jugador suelta todas las teclas de movimiento, la animación actual se detiene y transiciona a 'idle'
- [x] La transición entre animaciones es suave (fadeOut/fadeIn)
- [x] El estado visual del personaje siempre refleja su estado real
- [x] Las animaciones en loop se detienen correctamente cuando cambia el estado
- [x] No se producen animaciones "fantasma"
- [x] El comportamiento funciona para todas las animaciones en loop
- [x] El sistema es escalable y permite agregar nuevas animaciones de movimiento continuo solo con configuración

## Cambios Técnicos

### Frontend

**Sistema de Animaciones:**
- Corregida lógica en `AnimationMixerSystem.playAnimation()` que impedía interrumpir animaciones de movimiento cuando el estado cambiaba a 'idle'
- Agregada propiedad `interruptOnInputRelease` a `StateConfig` para marcar animaciones que deben interrumpirse al soltar input
- Agregada propiedad `interruptOnInputRelease: true` a estados 'walk' y 'run' en la configuración
- Creado mapa `stateConfigMap` en `AnimationMixerSystem` para acceder a configuraciones de estados
- Reemplazada lógica hardcodeada que verificaba estados específicos por verificación de propiedad de configuración

**Archivos modificados:**
- `frontend/src/ecs/systems/animation-mixer-system.js` - Corrección de lógica de interrupción y uso de configuración escalable
- `frontend/src/ecs/animation/states/state-config.js` - Agregada propiedad `interruptOnInputRelease` con documentación
- `frontend/src/ecs/animation/config/animation-config.js` - Agregado `interruptOnInputRelease: true` a walk y run

## Testing
Pruebas manuales realizadas en navegador:
- Walk → Idle: Presionar 'W' inicia animación de caminar, soltar 'W' detiene inmediatamente y transiciona a idle
- Run → Idle: Presionar 'W' + 'Shift' inicia animación de correr, soltar ambas teclas detiene inmediatamente y transiciona a idle
- Walk → Run → Idle: Transiciones entre estados funcionan correctamente
- Attack → Idle: Animación de ataque completa antes de transicionar a idle (comportamiento esperado)
- Múltiples cambios rápidos: No se producen animaciones fantasma, el estado siempre refleja el estado real

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Transiciones verificadas visualmente
- [x] No hay errores en consola del navegador

## Referencias
- Ticket: JDG-020
- Plan de acción: `instructions/tasks/JDG-020-action-plan_2025-12-10_08-38-19.md`
- Relacionado con: JDG-015 (Sistema de Animaciones con GLB), JDG-016 (Sistema de Animaciones Configurable)

## Deployment

### Cambios Requeridos
- [ ] Rebuild Docker images (solo frontend si es necesario)
- [ ] Reiniciar servicios Docker (solo frontend)

### Verificación Post-Deployment
- [x] Verificar que las animaciones se detienen correctamente al soltar teclas
- [x] Verificar que las transiciones son suaves
- [x] Verificar que no hay errores en consola

## Riesgos y Plan de Rollback
**Riesgo bajo:** Cambios solo afectan el sistema de animaciones del frontend, no modifican lógica crítica del juego.

**Posibles problemas:**
- Si alguna animación no funciona correctamente, puede revertirse fácilmente cambiando `interruptOnInputRelease` en la configuración
- Si hay problemas con transiciones, los valores de fadeOut/fadeIn (0.2 segundos) pueden ajustarse

**Plan de rollback:**
1. Revertir commits relacionados con JDG-020
2. O modificar `interruptOnInputRelease: false` temporalmente en las animaciones problemáticas
3. Rebuild y redeploy del frontend

## Notas Adicionales

**Mejora de escalabilidad:**
La implementación permite agregar nuevas animaciones de movimiento continuo (swim, fly, crawl, etc.) sin modificar código, solo agregando `interruptOnInputRelease: true` en la configuración del estado correspondiente. Esto reemplaza el código hardcodeado anterior que verificaba `currentState === 'walk' || currentState === 'run'`.

**Compatibilidad:**
- Animaciones existentes mantienen su comportamiento (valor por defecto `interruptOnInputRelease = false`)
- El sistema es retrocompatible con animaciones que no tienen esta propiedad definida

