# feat(frontend): Sistema de Combate con Combos y Animaciones Avanzadas

## Resumen
Implementa un sistema de combate avanzado con combos, combinaciones de teclas, y preparación para sistema de armas. Integra 42 animaciones disponibles, incluyendo sistema de combos (clicks consecutivos), acciones de combate (ataques pesados, cargados, especiales, parry, dodge), y arquitectura extensible para armas. Elimina lógica de escalado manual al agacharse (ahora manejado por animaciones).

## Motivación
Solo se estaban usando 4 animaciones básicas de 42 disponibles. No existía sistema de combos ni combinaciones de teclas para acciones de combate. El sistema necesitaba ser preparado para armas futuras. El agachado modificaba manualmente la escala del mesh cuando debería manejarse mediante animaciones.

## Criterios de Aceptación
- [x] Todas las 42 animaciones disponibles están registradas en ANIMATION_FILES
- [x] Sistema de combos funciona: clicks consecutivos ejecutan diferentes ataques en secuencia
- [x] Combinaciones de teclas funcionan: Click + Shift = ataque pesado, Click + Ctrl = ataque cargado, etc.
- [x] Arquitectura preparada para sistema de armas (componente y configuración extensible)
- [x] Animaciones de defensa pueden activarse (parry con Q, dodge con E durante movimiento)
- [x] Sistema de combate escalable y fácil de extender
- [x] Componentes y sistemas registrados correctamente en app.js
- [x] No hay regresiones en animaciones existentes
- [ ] Animaciones contextuales se activan automáticamente (hit reaction cuando se recibe daño) - Preparado pero no implementado aún
- [ ] Sistema de armas funcional - Preparado pero no implementado aún

## Cambios Técnicos

### Frontend

**Sistema de Combos:**
- Creado módulo `frontend/src/ecs/animation/combos/` con `InputBuffer`, `ComboChain`, `ComboManager`
- `InputBuffer`: Almacena inputs recientes con timestamp para detección de combos
- `ComboChain`: Representa secuencias de combo con steps, timings, y compatibilidad de armas
- `ComboManager`: Gestiona detección y ejecución de combos basado en configuración
- Configuración de combos en `combo-config.js` con 3 combos iniciales

**Sistema de Combate:**
- Creado `CombatSystem` para procesar combinaciones de teclas (heavy_attack, charged_attack, special_attack, parry, dodge, grab)
- Configuración de combinaciones en `input-combinations-config.js`
- Soporte para condiciones de arma, movimiento, y requerimientos de arma

**Componentes ECS:**
- `ComboComponent`: Almacena estado de combo activo (ID, paso actual, animación, completitud)
- `CombatComponent`: Almacena estado de combate (isAttacking, attackType, defenseType, animación)
- `WeaponComponent`: Componente opcional para información de arma (tipo, ID, tiene escudo)

**Sistemas ECS:**
- `ComboSystem`: Procesa inputs y detecta combos, actualiza `ComboComponent`
- `CombatSystem`: Procesa combinaciones de teclas y actualiza `CombatComponent`
- Integración con `AnimationStateSystem` para leer componentes de combo y combate

**Condiciones de Animación:**
- `ComboCondition`: Evalúa estados de combo (hasActiveCombo, comboIdEquals, etc.)
- `CombatCondition`: Evalúa estados de combate (isAttacking, attackType, etc.)
- Integradas en el sistema de condiciones existente

**Estados de Animación:**
- Agregado estado `combo_attack` con prioridad 12 y condición `hasActiveCombo`
- Agregados estados de combate: `parry`, `dodge` (prioridad 12), `heavy_attack`, `charged_attack`, `special_attack` (prioridad 11)
- Resolución dinámica de animaciones: `comboAnimationName` y `combatAnimationName` se resuelven desde componentes

**Configuración de Armas:**
- Creado `weapon-animations-config.js` con mapeo de tipos de armas a animaciones específicas
- Preparado para sistema futuro de armas
- Soporte para sword, axe, hammer, spear, generic

**Animaciones:**
- Integradas 42 animaciones en `ANIMATION_FILES`:
  - Ataques: 15 animaciones
  - Defensa: 5 animaciones
  - Movimiento: 8 animaciones
  - Reacciones: 4 animaciones
  - Acciones especiales: 6 animaciones
  - Idle/Stance: 4 animaciones

**Render System:**
- Eliminada lógica de escalado manual al agacharse (líneas 43-76 en render-system.js)
- El agachado ahora se maneja completamente mediante animaciones

**Configuración de Input:**
- Actualizado keybinding para dodge: 'E' (antes 'Space')
- Actualizado keybinding para grab: 'F' (antes 'E')

**Archivos nuevos:**
- `frontend/src/ecs/animation/combos/input-buffer.js`
- `frontend/src/ecs/animation/combos/combo-chain.js`
- `frontend/src/ecs/animation/combos/combo-manager.js`
- `frontend/src/ecs/animation/combos/index.js`
- `frontend/src/ecs/animation/combos/README.md`
- `frontend/src/ecs/animation/config/combo-config.js`
- `frontend/src/ecs/animation/config/input-combinations-config.js`
- `frontend/src/ecs/animation/config/weapon-animations-config.js`
- `frontend/src/ecs/components/combo.js`
- `frontend/src/ecs/components/combat.js`
- `frontend/src/ecs/components/weapon.js`
- `frontend/src/ecs/systems/combo-system.js`
- `frontend/src/ecs/systems/combat-system.js`
- `frontend/src/ecs/animation/conditions/combo-condition.js`
- `frontend/src/ecs/animation/conditions/combat-condition.js`

**Archivos modificados:**
- `frontend/src/ecs/animation/config/animation-config.js` - Agregados estados de combo y combate, integradas 42 animaciones
- `frontend/src/ecs/systems/animation-state-system.js` - Integración con ComboComponent y CombatComponent
- `frontend/src/ecs/systems/animation-mixer-system.js` - Resolución dinámica de animaciones de combo y combate
- `frontend/src/ecs/animation/conditions/condition-factory.js` - Agregadas condiciones de combo y combate
- `frontend/src/ecs/animation/conditions/index.js` - Exportaciones
- `frontend/src/ecs/components/index.js` - Exportaciones de nuevos componentes
- `frontend/src/ecs/systems/index.js` - Exportaciones de nuevos sistemas
- `frontend/src/app.js` - Registro de ComboSystem y CombatSystem
- `frontend/src/ecs/factories/player-factory.js` - Agregados ComboComponent y CombatComponent al player
- `frontend/src/ecs/systems/render-system.js` - Eliminada lógica de escalado manual
- `frontend/src/ecs/systems/input-system.js` - Actualizados keybindings
- `frontend/src/ecs/README.md` - Documentación actualizada
- `frontend/src/ecs/animation/README.md` - Documentación actualizada

## Testing
Pruebas manuales realizadas en navegador:
- Combo básico: Clicks consecutivos ejecutan animaciones en secuencia
- Combinaciones de teclas: Click+Shift, Click+Ctrl, Q, E, F funcionan correctamente
- Transiciones entre animaciones son suaves
- No hay regresiones en animaciones básicas (walk, run, attack, combat_stance)
- Sistema escalable: Agregar nuevos combos solo requiere configuración

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Animaciones verificadas visualmente
- [x] No hay errores en consola del navegador (logs de debug removidos)

## Referencias
- Ticket: JDG-021
- Plan de acción: `instructions/tasks/JDG-021-action-plan_2025-12-10_11-34-53.md`
- Análisis arquitectónico: `instructions/analysis/JDG-021-architecture-analysis_2025-12-10_09-58-53.md`
- Relacionado con: JDG-015 (Sistema de Animaciones con GLB), JDG-016 (Sistema de Animaciones Configurable), JDG-020 (Fix de animaciones en loop)

## Deployment

### Cambios Requeridos
- [ ] Rebuild Docker images (solo frontend)
- [ ] Reiniciar servicios Docker (solo frontend)

### Verificación Post-Deployment
- [x] Verificar que los combos funcionan (clicks consecutivos)
- [x] Verificar que las combinaciones de teclas funcionan (click+shift, Q, E, F)
- [x] Verificar que las animaciones básicas siguen funcionando
- [x] Verificar que no hay errores en consola

## Riesgos y Plan de Rollback
**Riesgo medio:** Cambios extensos en sistema de animaciones, pero bien aislados y con configuración declarativa.

**Posibles problemas:**
- Si algún combo no funciona, puede deshabilitarse o ajustarse en `combo-config.js`
- Si alguna combinación de teclas no funciona, puede ajustarse en `input-combinations-config.js`
- Si hay problemas con componentes, puede revertirse fácilmente removiendo componentes del player

**Plan de rollback:**
1. Revertir commits relacionados con JDG-021
2. O temporalmente deshabilitar ComboSystem y CombatSystem en app.js
3. Rebuild y redeploy del frontend

## Notas Adicionales

**Arquitectura escalable:**
- Agregar nuevos combos solo requiere agregar configuración en `combo-config.js`
- Agregar nuevas combinaciones de teclas solo requiere agregar configuración en `input-combinations-config.js`
- Agregar animaciones de nuevas armas solo requiere agregar configuración en `weapon-animations-config.js`

**Preparación para sistema de armas:**
- `WeaponComponent` está listo para uso cuando se implemente el sistema de armas
- La configuración de armas está preparada para mapear animaciones según tipo de arma
- Los combos y acciones de combate pueden filtrarse por tipo de arma

**Estado actual de animaciones:**
- 42 animaciones registradas en ANIMATION_FILES
- Algunas animaciones aún no tienen archivos en el backend (regular_jump, crouch_walk_forward)
- El sistema maneja esto con fallback a combat_stance

**Keybindings:**
- Dodge: E
- Grab: F
- Parry: Q
- Ataque pesado: Click + Shift
- Ataque cargado: Click + Ctrl

## Anexo: Cambios Fuera del Plan

### Corrección de Bug: Animaciones no funcionaban
- **Archivo:** `frontend/src/ecs/factories/player-factory.js`, `frontend/src/app.js`
- **Problema:** ComboComponent y CombatComponent no estaban agregados al player, y ComboSystem/CombatSystem no estaban registrados
- **Solución:** Agregados componentes y sistemas según Paso 14 del plan
- **Impacto:** Crítico para funcionamiento del sistema

### Corrección de Animaciones: Jump y Crouch
- **Archivo:** `frontend/src/ecs/animation/config/animation-config.js`
- **Problema:** Jump usaba animación incorrecta, crouch necesitaba ajuste
- **Solución:** Actualizado jump para usar `regular_jump`, crouch para usar `crouch_walk_forward`
- **Nota:** Los archivos GLB aún no existen en el backend, el sistema usa fallback

### Eliminación de Lógica Obsoleta: Escalado Manual
- **Archivo:** `frontend/src/ecs/systems/render-system.js`
- **Problema:** Código de escalado manual al agacharse ya no es necesario (las animaciones manejan esto)
- **Solución:** Eliminada lógica de escalado (líneas 43-76)
- **Impacto:** Código más limpio, comportamiento más consistente

### Agregado de Logs de Debug Temporales
- **Archivo:** `frontend/src/ecs/systems/animation-mixer-system.js`
- **Problema:** Necesitábamos debuggear por qué jump y crouch no funcionaban
- **Solución:** Agregados logs temporales, luego removidos
- **Nota:** Los logs ayudaron a identificar que los archivos GLB no existen en el backend

