# feat(frontend): Sistema de Detección de Agua y Estados de Natación (JDG-024)

## Resumen

Implementa sistema de detección de agua/líquidos en el `CollisionSystem` y estados de animación de natación (`swim`, `swim_idle`) que se activan automáticamente cuando el personaje está en agua. El sistema detecta partículas líquidas por `estado_nombre` y `tipo_nombre`, actualiza la propiedad `isInWater` en `PhysicsComponent`, y utiliza una nueva condición `WaterCondition` para evaluar estados ambientales en el sistema de animaciones.

## Motivación

El juego actualmente no detecta cuando el personaje está en agua o líquidos, y no hay estados de animación para natación. Esto resulta en que el personaje camina sobre el fondo del agua como si fuera tierra sólida, sin activar animaciones de natación. Se necesita un sistema que detecte partículas líquidas y active automáticamente los estados de natación apropiados.

## Criterios de Aceptación

- [x] Sistema de detección de agua funciona correctamente (detecta partículas líquidas por `estado_nombre` y `tipo_nombre`)
- [x] Propiedad `isInWater` agregada a `PhysicsComponent` y actualizada por `CollisionSystem`
- [x] Estado `swim` funciona correctamente: se activa cuando está en agua + movimiento
- [x] Estado `swim_idle` funciona correctamente: se activa cuando está en agua sin movimiento
- [x] Prioridades de estados correctamente configuradas (swim/swim_idle 7.5 > walk/run 4-5, pero < combat/jump 9-12)
- [x] Transiciones configuradas en todos los estados relevantes
- [x] WaterCondition creada e integrada en el sistema de condiciones
- [x] Código sigue el patrón ECS y usa el sistema de condiciones existente

## Cambios Técnicos

### Frontend

**Nuevos archivos:**
- `frontend/src/ecs/conditions/water-condition.js`: Condición para evaluar si una entidad está en agua, extiende `BaseCondition` y verifica `physics.isInWater`

**Archivos modificados:**
- `frontend/src/ecs/components/physics.js`:
  - Agregada propiedad `isInWater` al constructor (inicializada en `false` por defecto)
  - Documentada en JSDoc del constructor

- `frontend/src/config/animation-constants.js`:
  - Agregada constante `CONDITION_TYPES.WATER = 'water'`
  - Agregadas constantes `COLLISION.PARTICLE_STATE_LIQUID = 'liquido'` y `COLLISION.LIQUID_TYPES = ['agua', 'agua_sucia', 'lava', 'pantano']`

- `frontend/src/ecs/systems/collision-system.js`:
  - Agregado método `detectLiquidAtPosition(position)` que detecta partículas líquidas en una posición específica
  - Método filtra partículas por `estado_nombre === 'liquido'` o `tipo_nombre` en lista de tipos líquidos conocidos
  - Integrada detección en `update()` para actualizar `physics.isInWater` cada frame

- `frontend/src/ecs/conditions/condition-factory.js`:
  - Agregado import de `WaterCondition`
  - Agregado caso en switch para `CONDITION_TYPES.WATER` que retorna nueva instancia de `WaterCondition`

- `frontend/src/ecs/conditions/index.js`:
  - Agregado export de `WaterCondition`

- `frontend/src/config/animation-config.js`:
  - Agregado estado `swim` con prioridad 7.5, condiciones: `isInWater`, `hasMovement`, `!isFlying`, animación `swim_forward`
  - Agregado estado `swim_idle` con prioridad 7.5, condiciones: `isInWater`, `noMovement`, `!isFlying`, animación `swim_idle`
  - Actualizadas transiciones en estados `jump`, `flying`, `crouch_walk`, `crouch_idle`, `run`, `walk`, `idle` para incluir `swim` y `swim_idle`
  - Agregada condición `notInWater` en estados `walk` e `idle` para evitar conflictos (swim tiene mayor prioridad)

## Testing

La implementación fue verificada mediante:
- Revisión de código y verificación de sintaxis (sin errores de linting)
- Verificación de que todas las constantes y referencias están correctamente definidas
- Confirmación de que las animaciones `swim_forward` y `swim_idle` existen en `ANIMATION_FILES`
- Verificación de que `AnimationStateSystem` ya incluye `physics` en el contexto (no requirió cambios)

**Testing manual pendiente:**
- [ ] Entrar al agua: Caminar hacia partículas de agua y verificar activación de `swim` o `swim_idle`
- [ ] Nadar: Moverse en agua y verificar animación `swim_forward`
- [ ] Flotar: Quedarse quieto en agua y verificar animación `swim_idle`
- [ ] Salir del agua: Caminar fuera del agua y verificar transición a `walk`/`run`/`idle`
- [ ] Diferentes tipos de líquidos: Probar con agua, agua_sucia, lava, pantano
- [ ] Prioridades: Verificar que combat y jump tienen prioridad sobre natación
- [ ] Transiciones suaves: Verificar que no hay flickering al entrar/salir del agua

- [x] Probado localmente (verificación de código)
- [ ] Frontend probado en navegador (testing manual pendiente)

## Referencias

- Ticket: JDG-024
- Análisis de arquitectura: `instructions/analysis/JDG-024-architecture-analysis_2026-01-10_12-46-47.md`
- Plan de acción: `instructions/tasks/JDG-024-action-plan_2026-01-10_12-46-47.md`
- Ticket original: `instructions/tickets/JDG-024_work-ticket_2025-12-10_15-10-00.md`

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (no necesario, solo cambios frontend)
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica)
- [ ] Reiniciar servicios Docker (solo frontend si está en modo desarrollo)

### Verificación Post-Deployment

- [ ] Verificar que el juego funciona igual visualmente
- [ ] Verificar que las animaciones de natación se activan correctamente en agua
- [ ] Verificar que no hay errores en consola
- [ ] Verificar detección con diferentes tipos de líquidos
- [ ] Verificar transiciones suaves al entrar/salir del agua

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo riesgo: Cambios son aditivos y no modifican funcionalidad existente
- La detección de líquidos depende de que las partículas estén cargadas en el viewport
- Si no hay partículas cargadas, `detectLiquidAtPosition` retorna `false` (comportamiento seguro)
- Las animaciones de natación ya existen, solo se configuraron estados nuevos

**Plan de Rollback:**
- Revertir commit del PR
- Las optimizaciones no afectan datos persistentes
- El juego funcionará igual sin las optimizaciones (solo sin detección de agua/natación)

## Notas Adicionales

- El sistema detecta líquidos tanto por `estado_nombre === 'liquido'` (genérico) como por `tipo_nombre` específico ('agua', 'agua_sucia', 'lava', 'pantano') para máxima compatibilidad
- La detección usa partículas ya cargadas del viewport cuando están disponibles (optimización)
- Si no hay partículas cargadas, retorna `false` (puede extenderse en el futuro para consultar API)
- Prioridad 7.5 para estados de natación asegura precedencia sobre walk/run pero permite que combat y jump tengan prioridad
- Backend y base de datos no requieren cambios (la información de partículas ya incluye `tipo_nombre` y `estado_nombre`)
- El sistema puede extenderse fácilmente en el futuro para otros ambientes (lava para daño, gas tóxico, etc.)

## Anexo: Cambios Fuera del Plan

### Condición notInWater en estados walk e idle

- **Archivo:** `frontend/src/config/animation-config.js`
- **Cambio:** Agregada condición `{ type: 'water', operator: 'notInWater' }` en estados `walk` e `idle`
- **Razón:** Prevenir que estos estados se activen cuando el personaje está en agua, aunque swim/swim_idle ya tienen mayor prioridad
- **Impacto:** Mejora la claridad y evita posibles conflictos de estados
