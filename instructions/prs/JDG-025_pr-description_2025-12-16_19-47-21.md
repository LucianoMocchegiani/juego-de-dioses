# feat(frontend): Sistema de Equipamiento y Visualización de Armas

## Resumen

Implementa un sistema completo de equipamiento y visualización de armas que carga modelos GLB desde el backend y los adjunta visualmente al personaje usando bones del esqueleto. El sistema incluye cache de modelos, manejo de attachment por bones, y utilidades para desarrollo.

## Motivación

Anteriormente, el `WeaponComponent` solo almacenaba el tipo de arma como string, sin cargar ni visualizar modelos 3D. Los modelos GLB estaban disponibles en el backend pero no se utilizaban. Este PR implementa la carga, cache y attachment de modelos de armas al personaje, integrando con el sistema de animaciones existente.

## Criterios de Aceptación

- [x] Los modelos GLB de armas se cargan correctamente desde `/static/models/weapons/`
- [x] Las armas se visualizan adjuntadas al personaje en la posición correcta
- [x] El sistema soporta attachment por bones (el personaje debe tener esqueleto)
- [x] El `WeaponComponent` almacena información completa del arma (modelo, attachment point, offsets)
- [x] El sistema usa cache para reutilizar modelos de armas entre múltiples personajes
- [x] Las armas se pueden equipar/desequipar cambiando el `WeaponComponent`
- [x] El sistema se integra correctamente con el sistema de animaciones existente
- [x] Todas las armas disponibles (sword, axe, two-handed-axe, hammer, two-handed-hammer, spear) funcionan correctamente

## Cambios Técnicos

### Frontend

- **Extendido `WeaponComponent`**: Agregados campos `modelPath`, `modelInstance`, `attachmentPoint`, `offset`, `rotation`, y `scale` para almacenar información completa del modelo de arma
- **Creado `weapon-models-config.js`**: Configuración centralizada que mapea cada tipo de arma a su ruta GLB, punto de attachment, offsets, rotación y escala
- **Creado `weapon-attachment.js`**: Utilidades para adjuntar/desadjuntar armas al personaje usando bones del esqueleto, con extracción robusta de `THREE.Mesh` desde `THREE.Group`/`THREE.Scene`
- **Creado `WeaponEquipSystem`**: Sistema ECS que procesa entidades con `WeaponComponent` y `RenderComponent`, cargando modelos, aplicando cache, y gestionando attachment/detachment de armas
- **Actualizado `app.js`**: Registrado `WeaponEquipSystem` con prioridad 2.8 (después de AnimationMixerSystem, antes de PositionUpdateSystem)
- **Actualizado `player-factory.js`**: Agregado soporte para especificar arma inicial al crear el jugador
- **Creado `weapon-utils.js`**: Funciones helper (`equipWeapon`, `getEquippedWeapon`, `listAvailableWeapons`) para facilitar testing y desarrollo
- **Actualizado `dev-exposure.js`**: Expuestas funciones de armas globalmente (`window.equipWeapon`, etc.) solo en modo desarrollo
- **Limpieza de logs**: Reemplazados `console.log/error/warn` por `debugLogger` en todos los archivos relacionados con armas para mejor control y filtrado de logs

### Base de Datos

- No requiere cambios

### Docker/Infraestructura

- No requiere cambios

## Testing

Funcionalidad probada manualmente:
- [x] Carga inicial de arma por defecto (sword) al crear el jugador
- [x] Cambio de armas usando `equipWeapon()` desde consola del navegador
- [x] Desequipamiento de armas
- [x] Visualización correcta de armas adjuntadas al bone `RightHand`
- [x] Cache de modelos funcionando (múltiples instancias reutilizan el mismo modelo)
- [x] Integración con animaciones (las armas siguen las animaciones del personaje)
- [x] Todas las armas disponibles funcionando (sword, axe, two-handed-axe, hammer, two-handed-hammer, spear)
- [x] Manejo de errores cuando el bone no existe o el modelo no se puede cargar

Pruebas realizadas desde consola del navegador:
```javascript
equipWeapon('sword')    // Equipar espada
equipWeapon('axe')      // Equipar hacha
equipWeapon(null)       // Desequipar arma
getEquippedWeapon()     // Obtener arma equipada
listAvailableWeapons()  // Listar armas disponibles
```

## Screenshots/Demo

No se incluyen screenshots en este PR. Las armas se visualizan correctamente adjuntadas al personaje en la mano derecha.

## Referencias

- Ticket: JDG-025
- Plan de acción: `instructions/tasks/JDG-025-action-plan_2025-12-14_15-59-27.md`

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (solo frontend)
- [ ] Verificar que los modelos GLB estén disponibles en `/static/models/weapons/`
- [ ] No requiere migraciones de base de datos
- [ ] No requiere cambios en variables de entorno
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar que las armas se cargan correctamente desde el backend
- [ ] Verificar que las armas se visualizan en el personaje
- [ ] Verificar que el cambio de armas funciona
- [ ] Verificar logs de consola para errores de carga
- [ ] Verificar que el cache funciona correctamente

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Si el personaje no tiene esqueleto, el sistema mostrará error y no adjuntará armas
- Si un modelo GLB no existe en el backend, el sistema continuará sin visualizar el arma
- Cambios en `WeaponComponent` podrían afectar código existente que usa solo `weaponType`

**Mitigación:**
- El sistema valida existencia de esqueleto antes de intentar attachment
- Errores de carga se manejan gracefulmente sin romper el juego
- `WeaponComponent` mantiene compatibilidad con código existente (campos nuevos son opcionales)

**Plan de rollback:**
- Revertir commit del PR
- El código anterior solo usaba `weaponType` sin visualización, por lo que el rollback es seguro
- No hay migraciones de base de datos que revertir

## Notas Adicionales

- El sistema requiere que el personaje tenga esqueleto (skeleton) para funcionar correctamente
- Los modelos de armas deben tener su origen en el punto de agarre (empuñadura) para un posicionamiento correcto
- Los offsets y rotaciones en `weapon-models-config.js` pueden requerir ajustes finos según los modelos específicos
- El sistema usa `ModelCache` global para optimizar memoria al reutilizar modelos entre múltiples entidades
- Las funciones de desarrollo (`equipWeapon`, etc.) están expuestas solo en modo desarrollo (localhost/127.0.0.1)

## Anexo: Cambios Fuera del Plan

### Limpieza de Logs

- **Archivos afectados**: 
  - `frontend/src/utils/weapon-attachment.js`
  - `frontend/src/utils/weapon-utils.js`
  - `frontend/src/ecs/systems/weapon-equip-system.js`
  - `frontend/src/debug/dev-exposure.js`
- **Cambio**: Reemplazados todos los `console.log`, `console.error`, y `console.warn` por `debugLogger` para mejor control y filtrado de logs
- **Razón**: Mejorar la experiencia de desarrollo permitiendo filtrar/desactivar logs innecesarios mediante el sistema de `debugLogger`
- **Impacto**: Bajo, mejora la calidad del código y la experiencia de desarrollo

### Mejora en Extracción de Mesh de Armas

- **Archivos afectados**: 
  - `frontend/src/utils/weapon-attachment.js`
  - `frontend/src/ecs/systems/weapon-equip-system.js`
- **Cambio**: Implementada lógica robusta para extraer `THREE.Mesh` desde `THREE.Group`/`THREE.Scene` retornado por `GLTFLoader`
- **Razón**: Algunos modelos GLB retornan `THREE.Group` en lugar de `THREE.Mesh` directo, causando fallos en el attachment
- **Impacto**: Crítico para el funcionamiento correcto del sistema con todos los modelos de armas
