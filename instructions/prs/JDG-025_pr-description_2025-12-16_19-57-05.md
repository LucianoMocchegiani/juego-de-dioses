# feat(frontend): Sistema de Equipamiento y Visualización de Armas + Reorganización de Estructura ECS

## Resumen

Implementa un sistema completo de equipamiento y visualización de armas que carga modelos GLB desde el backend y los adjunta visualmente al personaje usando bones del esqueleto. Además, reorganiza la estructura del ECS moviendo sistemas genéricos (`conditions/`, `states/`, `combos/`) fuera de `animation/` para reflejar su naturaleza reutilizable. El sistema incluye cache de modelos, manejo de attachment por bones, utilidades para desarrollo, y mejoras en herramientas de debugging.

## Motivación

Anteriormente, el `WeaponComponent` solo almacenaba el tipo de arma como string, sin cargar ni visualizar modelos 3D. Los modelos GLB estaban disponibles en el backend pero no se utilizaban. Este PR implementa la carga, cache y attachment de modelos de armas al personaje, integrando con el sistema de animaciones existente.

Adicionalmente, la estructura del ECS tenía sistemas genéricos (`conditions/`, `states/`, `combos/`) dentro de `animation/`, lo cual era confuso ya que estos sistemas son reutilizables y no específicos de animaciones. Esta reorganización mejora la claridad y facilita la reutilización futura.

## Criterios de Aceptación

- [x] Los modelos GLB de armas se cargan correctamente desde `/static/models/weapons/`
- [x] Las armas se visualizan adjuntadas al personaje en la posición correcta
- [x] El sistema soporta attachment por bones (el personaje debe tener esqueleto)
- [x] El `WeaponComponent` almacena información completa del arma (modelo, attachment point, offsets)
- [x] El sistema usa cache para reutilizar modelos de armas entre múltiples personajes
- [x] Las armas se pueden equipar/desequipar cambiando el `WeaponComponent`
- [x] El sistema se integra correctamente con el sistema de animaciones existente
- [x] Todas las armas disponibles (sword, axe, two-handed-axe, hammer, two-handed-hammer, spear) funcionan correctamente
- [x] Reorganización de directorios completada sin romper funcionalidad existente
- [x] Herramientas de debugging mejoradas con funciones de copia de logs

## Cambios Técnicos

### Frontend

#### Sistema de Equipamiento de Armas

- **Extendido `WeaponComponent`**: Agregados campos `modelPath`, `modelInstance`, `attachmentPoint`, `offset`, `rotation`, y `scale` para almacenar información completa del modelo de arma
- **Creado `weapon-models-config.js`**: Configuración centralizada que mapea cada tipo de arma a su ruta GLB, punto de attachment, offsets, rotación y escala
- **Creado `weapon-attachment.js`**: Utilidades para adjuntar/desadjuntar armas al personaje usando bones del esqueleto, con extracción robusta de `THREE.Mesh` desde `THREE.Group`/`THREE.Scene`
- **Creado `WeaponEquipSystem`**: Sistema ECS que procesa entidades con `WeaponComponent` y `RenderComponent`, cargando modelos, aplicando cache, y gestionando attachment/detachment de armas
- **Actualizado `app.js`**: 
  - Registrado `WeaponEquipSystem` con prioridad 2.8 (después de AnimationMixerSystem, antes de RenderSystem)
  - Refactorizado inicialización de herramientas de debugging para usar `dev-exposure.js` centralizado
  - Agregado `exposeAppOnly()` en `main.js` para exponer app básico antes de inicialización completa
- **Actualizado `player-factory.js`**: 
  - Agregado soporte para especificar arma inicial al crear el jugador (`initialWeapon`)
  - Mejorado logging de bones disponibles usando `listBonesFormatted()`
  - Mejorado logging de mapeo de bones a partes del cuerpo
- **Creado `weapon-utils.js`**: Funciones helper (`equipWeapon`, `getEquippedWeapon`, `listAvailableWeapons`) para facilitar testing y desarrollo
- **Actualizado `dev-exposure.js`**: 
  - Centralizada lógica de detección de entorno de desarrollo
  - Centralizada inicialización de herramientas de debugging
  - Expuestas funciones de armas globalmente (`window.equipWeapon`, etc.) solo en modo desarrollo
  - Funciones lazy que buscan `playerId` dinámicamente
- **Limpieza de logs**: Reemplazados `console.log/error/warn` por `debugLogger` en todos los archivos relacionados con armas para mejor control y filtrado de logs

#### Reorganización de Estructura ECS

- **Movido `ecs/animation/combos/` → `ecs/combos/`**: Sistema de combos movido a nivel raíz de ECS ya que es específico de combate, no de animaciones
- **Movido `ecs/animation/conditions/` → `ecs/conditions/`**: Sistema genérico de condiciones movido a nivel raíz para facilitar reutilización (IA, combate, UI, etc.)
- **Movido `ecs/animation/states/` → `ecs/states/`**: Sistema genérico de máquinas de estados movido a nivel raíz para facilitar reutilización
- **Actualizados imports en sistemas**: 
  - `combo-system.js`: Actualizado import de `ComboManager`
  - `animation-state-system.js`: Actualizado import de `StateRegistry`
  - `animation-mixer-system.js`: Actualizado import de `AnimationState`
  - `state-registry.js`: Actualizada ruta relativa a `config/`
  - `condition-factory.js`: Actualizada ruta relativa a `config/`
- **Actualizada documentación**: 
  - `ecs/README.md`: Actualizada estructura de directorios y referencias
  - `ecs/combos/README.md`: Actualizadas rutas relativas
  - `ecs/animation/README.md`: Eliminado (contenido movido a `ecs/README.md`)
  - `ecs/animation/index.js`: Eliminado (ya no necesario)
  - `config/README.md`: Agregada documentación de `weapon-models-config.js`

#### Mejoras en Herramientas de Debugging

- **Actualizado `debug-interface.js`**: 
  - Agregado botón "Copiar" en cada log individual
  - Agregado botón "Copiar todos" en el header de logs
  - Implementadas funciones `copyLogToClipboard()` y `copyAllLogsToClipboard()`
  - Mejorado layout de logs con flexbox para acomodar botones
  - Soporte para copiar logs filtrados por entidad
- **Actualizado `camera-controller.js`**: 
  - Agregada detección de tecla ALT para permitir rotación de cámara sin rotar personaje
  - Mejorada lógica de rotación del personaje para respetar ALT + click derecho

#### Otros Cambios

- **Actualizado `render-system.js`**: Removidos imports no utilizados (`input`, `animation`)
- **Actualizado `main.js`**: Agregado `exposeAppOnly()` para exponer app básico antes de inicialización completa
- **Actualizado `utils/README.md`**: Agregada documentación de `weapon-attachment.js` y `weapon-utils.js`

### Base de Datos

- No requiere cambios

### Docker/Infraestructura

- No requiere cambios

## Testing

Funcionalidad probada manualmente:
- [x] Carga inicial de arma por defecto (sword) al crear el jugador
- [x] Cambio de armas usando `equipWeapon()` desde consola del navegador
- [x] Desequipamiento de armas
- [x] Visualización correcta de armas adjuntadas al bone `RightHand`
- [x] Cache de modelos funcionando (múltiples instancias reutilizan el mismo modelo)
- [x] Integración con animaciones (las armas siguen las animaciones del personaje)
- [x] Todas las armas disponibles funcionando (sword, axe, two-handed-axe, hammer, two-handed-hammer, spear)
- [x] Manejo de errores cuando el bone no existe o el modelo no se puede cargar
- [x] Reorganización de directorios no rompe funcionalidad existente (animaciones y combos siguen funcionando)
- [x] Herramientas de debugging funcionan correctamente (copiar logs individuales y todos)
- [x] Rotación de cámara con ALT funciona correctamente

Pruebas realizadas desde consola del navegador:
```javascript
equipWeapon('sword')    // Equipar espada
equipWeapon('axe')      // Equipar hacha
equipWeapon(null)       // Desequipar arma
getEquippedWeapon()     // Obtener arma equipada
listAvailableWeapons()  // Listar armas disponibles
```

## Screenshots/Demo

No se incluyen screenshots en este PR. Las armas se visualizan correctamente adjuntadas al personaje en la mano derecha.

## Referencias

- Ticket: JDG-025
- Plan de acción: `instructions/tasks/JDG-025-action-plan_2025-12-14_15-59-27.md`
- Análisis de arquitectura: `instructions/analysis/JDG-031-architecture-analysis_2025-12-14_22-40-43.md`
- Análisis de attachment: `instructions/analysis/weapon-attachment-analysis.md`
- Propuesta de reorganización: `instructions/reorganizacion-frontend.md`

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (solo frontend)
- [ ] Verificar que los modelos GLB estén disponibles en `/static/models/weapons/`
- [ ] No requiere migraciones de base de datos
- [ ] No requiere cambios en variables de entorno
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar que las armas se cargan correctamente desde el backend
- [ ] Verificar que las armas se visualizan en el personaje
- [ ] Verificar que el cambio de armas funciona
- [ ] Verificar logs de consola para errores de carga
- [ ] Verificar que el cache funciona correctamente
- [ ] Verificar que las animaciones siguen funcionando correctamente
- [ ] Verificar que los combos siguen funcionando correctamente

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Si el personaje no tiene esqueleto, el sistema mostrará error y no adjuntará armas
- Si un modelo GLB no existe en el backend, el sistema continuará sin visualizar el arma
- Cambios en `WeaponComponent` podrían afectar código existente que usa solo `weaponType`
- Reorganización de directorios podría romper imports si hay código externo que los usa directamente
- Cambios en estructura de debugging podrían afectar scripts de desarrollo existentes

**Mitigación:**
- El sistema valida existencia de esqueleto antes de intentar attachment
- Errores de carga se manejan gracefulmente sin romper el juego
- `WeaponComponent` mantiene compatibilidad con código existente (campos nuevos son opcionales)
- Todos los imports internos han sido actualizados correctamente
- Herramientas de debugging mantienen compatibilidad con API existente

**Plan de rollback:**
- Revertir commit del PR
- El código anterior solo usaba `weaponType` sin visualización, por lo que el rollback es seguro
- No hay migraciones de base de datos que revertir
- La reorganización de directorios es reversible sin pérdida de funcionalidad

## Notas Adicionales

- El sistema requiere que el personaje tenga esqueleto (skeleton) para funcionar correctamente
- Los modelos de armas deben tener su origen en el punto de agarre (empuñadura) para un posicionamiento correcto
- Los offsets y rotaciones en `weapon-models-config.js` pueden requerir ajustes finos según los modelos específicos
- El sistema usa `ModelCache` global para optimizar memoria al reutilizar modelos entre múltiples entidades
- Las funciones de desarrollo (`equipWeapon`, etc.) están expuestas solo en modo desarrollo (localhost/127.0.0.1)
- La reorganización de directorios mejora la claridad y facilita la reutilización futura de sistemas genéricos
- Los sistemas `conditions/` y `states/` ahora están disponibles para uso en otros contextos (IA, combate, UI, etc.)

## Anexo: Cambios Fuera del Plan

### Limpieza de Logs

- **Archivos afectados**: 
  - `frontend/src/utils/weapon-attachment.js`
  - `frontend/src/utils/weapon-utils.js`
  - `frontend/src/ecs/systems/weapon-equip-system.js`
  - `frontend/src/debug/dev-exposure.js`
- **Cambio**: Reemplazados todos los `console.log`, `console.error`, y `console.warn` por `debugLogger` para mejor control y filtrado de logs
- **Razón**: Mejorar la experiencia de desarrollo permitiendo filtrar/desactivar logs innecesarios mediante el sistema de `debugLogger`
- **Impacto**: Bajo, mejora la calidad del código y la experiencia de desarrollo

### Mejora en Extracción de Mesh de Armas

- **Archivos afectados**: 
  - `frontend/src/utils/weapon-attachment.js`
  - `frontend/src/ecs/systems/weapon-equip-system.js`
- **Cambio**: Implementada lógica robusta para extraer `THREE.Mesh` desde `THREE.Group`/`THREE.Scene` retornado por `GLTFLoader`
- **Razón**: Algunos modelos GLB retornan `THREE.Group` en lugar de `THREE.Mesh` directo, causando fallos en el attachment
- **Impacto**: Crítico para el funcionamiento correcto del sistema con todos los modelos de armas

### Mejoras en Herramientas de Debugging

- **Archivos afectados**: 
  - `frontend/src/debug/ui/debug-interface.js`
- **Cambio**: Agregadas funciones para copiar logs individuales y todos los logs al portapapeles
- **Razón**: Facilitar el debugging permitiendo copiar logs fácilmente para compartir o analizar
- **Impacto**: Bajo, mejora la experiencia de desarrollo

### Mejora en Control de Cámara

- **Archivos afectados**: 
  - `frontend/src/systems/camera-controller.js`
- **Cambio**: Agregada detección de tecla ALT para permitir rotación de cámara sin rotar el personaje
- **Razón**: Mejorar la experiencia de usuario permitiendo inspeccionar el personaje desde diferentes ángulos
- **Impacto**: Bajo, mejora la experiencia de usuario

### Centralización de Herramientas de Desarrollo

- **Archivos afectados**: 
  - `frontend/src/debug/dev-exposure.js`
  - `frontend/src/app.js`
  - `frontend/src/main.js`
- **Cambio**: Centralizada lógica de detección de entorno, inicialización y exposición de herramientas de desarrollo
- **Razón**: Reducir duplicación de código y mejorar mantenibilidad
- **Impacto**: Bajo, mejora la organización del código
