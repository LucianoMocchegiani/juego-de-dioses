# refactor(models): Migración de Modelos y Animaciones a Estructura Biped

## Resumen

Migra modelos de personajes y animaciones a la nueva estructura organizada `biped/male/`, actualizando todas las rutas en código, base de datos y frontend. Incluye renombrado de archivos (modelo principal a `biped_male.glb` y eliminación del prefijo `Meshy_AI_Animation_` en animaciones) y actualización completa de rutas en `animation-config.js` con nueva organización de categorías.

## Motivación

La estructura actual tenía modelos y animaciones en ubicaciones inconsistentes (`characters/` y `animations/biped/`). La nueva estructura `biped/male/` organiza mejor los recursos por tipo de entidad y variante, preparando el sistema para futuras expansiones (quadrupeds, female, etc.) y facilitando el mantenimiento.

## Criterios de Aceptación

- [x] Todos los modelos de personajes están en `backend/static/models/biped/male/characters/`
- [x] El modelo principal se llama `biped_male.glb` (renombrado desde `Meshy_AI_Character_output.glb`)
- [x] Todas las animaciones están en `backend/static/models/biped/male/animations/{category}/`
- [x] Las animaciones no tienen prefijo `Meshy_AI_Animation_` (eliminado del nombre)
- [x] Script de migración de base de datos creado
- [x] Templates de bipeds actualizados para usar nuevas rutas
- [x] Frontend `animation-config.js` actualizado con nuevas rutas y categorías
- [x] Referencias en código actualizadas
- [x] Documentación actualizada
- [ ] Ejecutar migración de base de datos (requiere ejecución manual en desarrollo)
- [ ] Probar carga de modelos y animaciones (testing manual pendiente)

## Cambios Técnicos

### Backend

- **Renombrado de archivos:**
  - Modelo principal: `Meshy_AI_Character_output.glb` → `biped_male.glb`
  - Eliminado prefijo `Meshy_AI_Animation_` de todas las animaciones (48 archivos renombrados)

- **Script de seed/base de BD:**
  - Creado `backend/src/database/seed_biped_structure.py`
  - Actualiza rutas de modelos en tabla `agrupaciones` desde `characters/Character_output.glb` a `biped/male/characters/biped_male.glb`
  - Script idempotente: puede ejecutarse múltiples veces de forma segura
  - **Integrado en startup automático:** Se ejecuta automáticamente al iniciar el backend (en `main.py` lifespan), por lo que no requiere ejecución manual al clonar el repo

- **Consolidación de scripts:**
  - Eliminado `seed_character_with_model.py` (redundante)
  - Integrada creación de personaje demo en `seed_demo.py` para evitar duplicación
  - Actualizado nombre de dimensión demo: "Terreno de Prueba - Primer Humano" (coincide con frontend)

- **Integración automática:**
  - `main.py`: Agregada llamada a `migrate_model_paths()` en el lifespan del backend para ejecución automática al iniciar
  - `seed_demo.py`: Integrada creación automática de personaje demo con modelo 3D (eliminando necesidad de script separado)

### Frontend

- **Actualización de `animation-config.js`:**
  - Nueva ruta base: `animations/biped/` → `biped/male/animations/`
  - Reorganización de categorías:
    - `sword/`, `axe/`, `shield/` → `shield-and-one-hand-weapon/`
    - `two-hand-sword/`, `two-hand-hammer/` → `two-hands-weapon/`
    - `idle/` → `movement/`
    - `spear/` → `movement/`
    - `interactions/Animation_Stand_Up2...` → `transitions/Stand_Up2...`
  - Eliminado prefijo `Meshy_AI_Animation_` de todas las rutas
  - Agregadas alternativas para animaciones que no existen en nueva estructura
  - Comentadas animaciones faltantes con notas

- **Actualización de referencias:**
  - `animation-mixer-system.js`: Comentario actualizado con nuevo nombre de modelo
  - `animation-tester.js`: Lógica de organización actualizada para nueva estructura
  - `renderers/models/README.md`: Ejemplos actualizados con nuevas rutas

### Base de Datos

- Script de seed/base se ejecuta automáticamente al iniciar el backend
- Script actualiza rutas en campo `modelo_3d` (JSONB) de tabla `agrupaciones`
- Script es idempotente y puede ejecutarse múltiples veces

### Documentación

- `backend/src/api/routes/README.md`: Ejemplos de rutas actualizados
- `frontend/src/config/README.md`: Descripción de estructura de animaciones actualizada
- `frontend/src/renderers/models/README.md`: Ejemplos y referencias actualizados
- `database/init/01-init-schema.sql`: Comentario del schema actualizado con nueva estructura de ejemplo

## Testing

- [ ] Probar carga de modelo desde nueva ubicación
- [ ] Verificar que todas las animaciones cargan correctamente
- [ ] Probar endpoint `/api/v1/dimensions/{id}/characters/{id}/model` retorna nueva ruta
- [ ] Ejecutar script de seed/base en desarrollo y verificar resultados
- [ ] Probar personajes existentes después de migración de BD
- [ ] Verificar sistema de animaciones funciona con nuevas rutas

**Nota:** El testing requiere ejecución manual ya que implica:
1. Ejecutar script de migración de BD
2. Probar en navegador que modelos y animaciones cargan
3. Verificar que no hay errores 404 en consola

## Referencias

- Ticket: JDG-033
- Análisis de arquitectura: `/instructions/analysis/JDG-033-architecture-analysis_2025-12-19_16-33-48.md`
- Plan de acción: `/instructions/tasks/JDG-033-action-plan_2025-12-19_16-50-32.md`
- Relacionado con: JDG-032 (Limpieza de animaciones duplicadas), JDG-012 (Sistema de modelos 3D), JDG-015 (Sistema de animaciones)

## Deployment

### Cambios Requeridos

- [x] Archivos renombrados en estructura de archivos
- [ ] Ejecutar script de seed/base de datos: `python backend/src/database/seed_biped_structure.py`
- [ ] Verificar que todos los archivos están accesibles en nuevas ubicaciones
- [ ] Invalidar cache del navegador (opcional, para forzar descarga de nuevos modelos)

### Verificación Post-Deployment

- [ ] Verificar endpoint `/api/v1/dimensions/{id}/characters/{id}/model` retorna nueva ruta
- [ ] Verificar que personajes cargan correctamente en el juego
- [ ] Verificar que animaciones reproducen sin errores
- [ ] Verificar logs de backend para errores 404
- [ ] Verificar consola del navegador para errores de carga de modelos/animaciones

## Riesgos y Plan de Rollback

**Riesgos:**
- Personajes existentes con rutas antiguas dejarán de cargar si no se ejecuta la migración
- Cache del navegador puede servir modelos/animaciones antiguos
- Animaciones faltantes pueden causar errores si se intentan usar

**Plan de Rollback:**
1. Revertir cambios en `animation-config.js` a rutas antiguas
2. Revertir renombrado de archivos (restaurar desde backup)
3. Ejecutar script inverso para actualizar BD a rutas antiguas (si fue ejecutado)
4. Revertir cambios en código (seed scripts, documentación)

**Mitigación:**
- Script de migración valida rutas antes de actualizar
- Documentación de animaciones faltantes para referencia
- Backup de archivos antes de renombrar (recomendado)

## Notas Adicionales

- **Animaciones faltantes:** Varias animaciones de la estructura antigua no existen en la nueva estructura. Se han usado alternativas donde es posible (ej: `attack` → `left_slash`, `sword_judgment` → `thrust_slash`). Las animaciones no disponibles están comentadas en `animation-config.js`.
- **Script de seed/base de BD:** El script está listo pero debe ejecutarse manualmente después de verificar que los archivos están correctamente renombrados. Es idempotente y puede ejecutarse múltiples veces. Hacer backup de BD antes de ejecutar.
- **Compatibilidad:** El sistema mantiene compatibilidad con el código existente ya que las rutas se actualizaron centralizadamente en `animation-config.js`.
- **Estructura futura:** Esta migración prepara el sistema para agregar `biped/female/`, `biped/base/`, `quadrupeds/`, etc. en el futuro.

## Anexo: Cambios Fuera del Plan

### Corrección de Parser en animation-tester.js

- **Archivo:** `frontend/src/debug/ui/animation-tester.js`
- **Problema:** El parser de rutas esperaba estructura antigua `animations/biped/{category}/`
- **Solución:** Actualizado para soportar nueva estructura `biped/male/animations/{category}/` manteniendo compatibilidad con estructura antigua
- **Impacto:** El debugger de animaciones (F6) organiza correctamente las animaciones por carpetas con nueva estructura

### Agregadas Alternativas para Animaciones Faltantes

- **Archivo:** `frontend/src/config/animation-config.js`
- **Cambio:** Agregadas animaciones alternativas para `attack` y `sword_judgment` que no existen en nueva estructura
  - `attack`: Usa `left_slash` como alternativa
  - `sword_judgment`: Usa `thrust_slash` como alternativa
- **Razón:** Estas animaciones se usan en `ANIMATION_STATES` y configuraciones de combate, requieren una ruta válida para evitar errores
- **Impacto:** El sistema de combate puede funcionar aunque algunas animaciones específicas no estén disponibles

## Anexo 2: Refactorización de Seeds de Terreno y Correcciones Adicionales

### Refactorización de Nombres de Seeds y Dimensiones

- **Archivos modificados:**
  - `backend/src/database/seed_demo.py` → `seed_terrain_test_1.py`
  - `backend/src/database/seed_terrain_test_2.py` (función renombrada de `seed_human_test()` a `seed_terrain_test_2()`)
  - `backend/src/main.py`: Actualizado para ejecutar ambos seeds automáticamente
  - `frontend/src/constants.js`: Actualizado `DEMO_DIMENSION_NAME`

- **Nombres de dimensiones:**
  - `seed_terrain_test_1`: Crea "Terreno Test 1 - Bosque Denso" (bosque denso con acuífero)
  - `seed_terrain_test_2`: Crea "Terreno Test 2 - Lago y Montaña" (lago, montaña, pocos árboles) - por defecto

- **Ejecución automática:**
  - Ambos seeds se ejecutan automáticamente al iniciar el backend si las dimensiones no existen
  - Eliminada inconsistencia donde ambos scripts creaban dimensiones con el mismo nombre

### Corrección de Posición del Personaje

- **Problema:** El personaje aparecía flotando en el aire a cierta distancia del suelo
- **Causa:** Offset del modelo (`offset_z = 0.9` metros) empujaba al personaje hacia arriba
- **Solución:**
  - Eliminado `offset_z` en `seed_terrain_test_2.py` y `seed_character_with_model.py`
  - Ahora usa `offset_z = 0.0` y permite que el `CollisionSystem` ajuste automáticamente la posición al suelo
- **Impacto:** El personaje ahora aparece correctamente sobre el terreno, sin flotar

### Búsqueda de Posición con Hierba

- **Archivo:** `backend/src/database/seed_terrain_test_2.py`
- **Problema:** El personaje podía aparecer en el agua del lago
- **Solución inicial:** Implementada búsqueda de posición con hierba en varias ubicaciones
- **Solución final:** Configurada posición fija en coordenadas específicas (x=98, y=60, z=1) donde se verifica que haya terreno

### Configuración de Coordenadas Fijas para Personaje Demo

- **Archivo:** `backend/src/database/seed_terrain_test_2.py`
- **Cambio:** El personaje demo ahora se crea en coordenadas fijas: **x=98, y=60, z=1**
- **Verificación:** El seed verifica que exista terreno en esa posición y ajusta Z si es necesario
- **Razón:** Garantiza que el personaje aparezca en una ubicación específica y conocida sobre terreno sólido

### Agregado de Coordenadas al Panel de Debug (F3)

- **Archivo:** `frontend/src/debug/ui/debug-panel.js`
- **Cambio:** Agregada sección "Player Position" que muestra las coordenadas X, Y, Z del jugador en tiempo real
- **Características:**
  - Actualización automática cada segundo (igual que las métricas de performance)
  - Muestra coordenadas con 2 decimales de precisión
  - Color cyan (#0ff) para destacar
  - Solo se muestra si el jugador existe y tiene componente Position
- **Impacto:** Facilita el debugging de posición del personaje durante el desarrollo

### Actualización de Documentación

- **Archivo:** `backend/src/database/README.md`
- **Cambio:** Actualizada documentación para reflejar nuevos nombres de seeds y sus responsabilidades
  - `seed_terrain_test_1.py`: Documentado como creador de "Terreno Test 1 - Bosque Denso"
  - `seed_terrain_test_2.py`: Documentado como creador de "Terreno Test 2 - Lago y Montaña" (por defecto)

### Resumen de Cambios Técnicos

**Backend:**
- Renombrados scripts y funciones de seeds de terreno
- Corregido offset del modelo para eliminar flotación del personaje
- Configurada posición fija del personaje demo en coordenadas específicas
- Agregada ejecución automática de ambos seeds en `main.py`

**Frontend:**
- Agregadas coordenadas del jugador al panel de debug F3
- Actualizado `DEMO_DIMENSION_NAME` para usar nombre correcto de dimensión

**Documentación:**
- Actualizado README de database con nueva estructura de seeds
