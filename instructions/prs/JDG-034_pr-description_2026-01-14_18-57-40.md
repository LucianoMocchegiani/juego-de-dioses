# fix(frontend): Bloquear Movimiento WASD Durante Animaciones de Habilidades

## Resumen

Implementa bloqueo de movimiento WASD durante animaciones de habilidades cuando la acción no tiene `hasMovement: true`. Agrega verificaciones en `InputSystem` y `PhysicsSystem` para consultar el estado de `combat.activeAction` y la configuración `hasMovement` antes de procesar movimiento normal. Incluye fricción adicional durante bloqueo para transiciones más suaves.

## Motivación

El jugador podía moverse libremente con WASD durante cualquier animación de habilidad, lo cual rompía la inmersión, afectaba el balance del combate y era inconsistente con el diseño de acciones que tienen `preventInterruption`. Solo las habilidades con `hasMovement: true` (como dodge) deberían permitir movimiento durante su animación.

## Criterios de Aceptación

- [x] Cuando `combat.activeAction` está activa y la acción NO tiene `hasMovement: true`, el jugador NO puede moverse con WASD
- [x] Cuando `combat.activeAction` está activa y la acción tiene `hasMovement: true` (como dodge), el movimiento funciona según configuración de la acción
- [x] Cuando `combat.activeAction` es null (animación terminó), el movimiento normal vuelve a funcionar
- [x] Los ataques básicos bloquean movimiento durante su animación
- [x] Las habilidades especiales bloquean movimiento durante su animación
- [x] Parry bloquea movimiento durante su animación
- [x] Dodge permite movimiento según su configuración (`hasMovement: true`)
- [x] No hay regresiones en otras funcionalidades de movimiento o combate

## Cambios Técnicos

### Frontend

- **`frontend/src/ecs/systems/input-system.js`**:
  - Agregado import de `COMBAT_ACTIONS` para acceder a configuración de acciones
  - Agregada verificación de `combat.activeAction` y `hasMovement` antes de calcular `moveDirection`
  - Bloqueo de cálculo de `moveDirection` cuando acción activa no tiene `hasMovement: true`
  - Bloqueo de aplicación de aceleración a física cuando movimiento está bloqueado
  - Si está bloqueado, `moveDirection` se establece en 0 (NONE)

- **`frontend/src/ecs/systems/physics-system.js`**:
  - Agregada verificación de seguridad adicional para bloquear aceleración normal
  - Agregada fricción extra (0.7) cuando movimiento está bloqueado para reducir velocidad más rápido
  - Esto evita transiciones bruscas cuando la animación termina

## Testing

- Probado localmente en navegador con Three.js
- Verificado que ataques básicos bloquean movimiento durante animación
- Verificado que habilidades especiales bloquean movimiento durante animación
- Verificado que parry bloquea movimiento durante animación
- Verificado que dodge permite movimiento según configuración
- Verificado que movimiento normal vuelve a funcionar cuando animación termina
- Verificado que no hay regresiones en otras funcionalidades de movimiento o combate
- Verificado que transiciones son suaves gracias a fricción adicional

## Referencias

- Ticket: JDG-034
- Análisis de arquitectura: `instructions/analysis/JDG-034-architecture-analysis_2026-01-14_18-24-26.md`
- Plan de acción: `instructions/tasks/JDG-034-action-plan_2026-01-14_18-31-08.md`
- Relacionado con: JDG-021 (Integración de Animaciones Avanzadas y Sistema de Combate con Combos), JDG-028 (Simplificación y Optimización del Sistema de Animaciones y Combate)

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar frontend en navegador
- [ ] Verificar que ataques bloquean movimiento correctamente
- [ ] Verificar que dodge permite movimiento correctamente
- [ ] Verificar que transiciones son suaves

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo riesgo: Solo agrega verificaciones condicionales sin cambiar lógica existente
- Si hay problemas, revertir cambios en `input-system.js` y `physics-system.js`

**Plan de Rollback:**
- Revertir commit del PR
- O manualmente eliminar las verificaciones de `shouldBlockMovement` y `shouldBlockNormalMovement`
- Restaurar código original de cálculo de `moveDirection` y aplicación de aceleración

## Notas Adicionales

- La solución es no invasiva: solo agrega verificaciones condicionales
- Todas las acciones de combate tienen `hasMovement` configurado correctamente en `combat-actions-config.js`
- La fricción adicional durante bloqueo mejora las transiciones pero puede ajustarse si es necesario

## Anexo: Cambios Fuera del Plan

### Mejora de Transiciones Suaves

- **Archivo:** `frontend/src/ecs/systems/physics-system.js`
- **Cambio:** Agregada fricción extra (0.7) cuando movimiento está bloqueado para reducir velocidad más rápido
- **Razón:** Durante testing se detectó que las transiciones eran bruscas cuando la animación terminaba. La fricción adicional reduce la velocidad residual más rápido, haciendo las transiciones más naturales
- **Impacto:** Mejora la experiencia de usuario sin afectar funcionalidad
