# feat(frontend): Mejoras en Sistema de Armas y Consolidación de Tipos

## Resumen

Mejoras en el sistema de equipamiento de armas con logs de debug detallados, inspección completa de modelos GLB, y compensación automática de offsets para meshes desplazados. También se consolidaron tipos compartidos moviendo `Dimension` a `types.js` y eliminando duplicación de `Viewport`.

## Motivación

Durante el debugging del sistema de armas se identificaron dos problemas principales:
1. Falta de visibilidad sobre la estructura interna de los modelos GLB al cargar armas, dificultando identificar por qué algunas armas no se adjuntaban correctamente
2. Meshes desplazados dentro de Groups causaban que las armas se adjuntaran en posiciones incorrectas al bone

Adicionalmente, se encontró que el tipo `Dimension` estaba definido localmente en `viewport.js` aunque se usaba en múltiples módulos, y `Viewport` estaba duplicado.

## Criterios de Aceptación

- [x] Tipos compartidos consolidados en `types.js`
- [x] Sistema de debug detallado para modelos de armas implementado
- [x] Inspección completa de jerarquía de modelos GLB funcionando
- [x] Compensación automática de offsets para meshes desplazados
- [x] Logs estructurados usando `debugLogger` en lugar de `console.log`
- [x] Sin errores de linter

## Cambios Técnicos

### Frontend

**Consolidación de Tipos:**
- Movido tipo `Dimension` desde `terrain/components/viewport.js` a `types.js`
- Eliminada definición duplicada de `Viewport` en `viewport.js`
- Actualizado `viewport.js` para importar tipos desde `types.js`

**Sistema de Debug para Modelos de Armas:**
- Agregada función `inspectWeaponModel()` en `WeaponEquipSystem` que analiza la estructura completa del modelo
- Logs detallados de jerarquía completa (depth, path, transformaciones locales y mundiales)
- Detección de Groups intermedios que pueden afectar el origen
- Análisis de paths desde meshes hasta root con distancias desde origen
- Advertencias cuando hay transformaciones que pueden afectar el attachment

**Compensación Automática de Offsets:**
- Detección automática de meshes desplazados dentro de Groups
- Cálculo automático de offset necesario para compensar posición del mesh
- Ajuste dinámico del `attachmentConfig.offset` antes de adjuntar al bone
- Logs detallados del proceso de compensación

**Mejoras en Logging:**
- Reemplazados todos los `console.log` por `debugLogger` en:
  - `ecs/systems/weapon-equip-system.js`
  - `ecs/models/model-loader.js`
  - `utils/weapon-attachment.js`
- Logs estructurados con niveles apropiados (debug, info, warn, error)

## Testing

- [x] Probado localmente equipando diferentes armas (sword, axe, hammer, spear)
- [x] Verificados logs de debug en consola del navegador
- [x] Confirmada compensación automática de offset para axe (mesh desplazado en x: 0.91)
- [x] Verificada estructura de jerarquía en logs para diferentes modelos
- [x] Confirmado que tipos consolidados funcionan correctamente en todos los módulos

## Referencias

- Análisis de estructura de modelos GLB para debugging
- Consolidación de tipos compartidos para mejor mantenibilidad

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (si hay cambios en frontend)
- [ ] Verificar que no hay cambios en variables de entorno
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [x] Verificar frontend en navegador
- [x] Verificar logs de debug en consola
- [x] Probar equipamiento de diferentes armas
- [x] Verificar que compensación automática funciona correctamente

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo: Cambios son principalmente de logging y compensación automática
- La compensación automática podría afectar armas que ya tenían offsets configurados manualmente (pero solo se aplica si el mesh está desplazado > 0.01 unidades)

**Plan de Rollback:**
- Revertir cambios en `weapon-equip-system.js` si la compensación automática causa problemas
- Los tipos consolidados son retrocompatibles (solo cambian ubicación, no estructura)

## Notas Adicionales

- La compensación automática de offsets solo se aplica cuando el mesh está desplazado significativamente (> 0.01 unidades)
- Los logs de debug están configurados para nivel `debug` e `info`, asegurarse de que el debugger esté habilitado para ver toda la información
- La inspección de modelos muestra información detallada que puede ser útil para debugging futuro de modelos GLB

## Anexo: Cambios Fuera del Plan

### Consolidación de Tipos
- **Archivo:** `frontend/src/types.js`, `frontend/src/terrain/components/viewport.js`
- **Cambio:** Movido tipo `Dimension` a `types.js` y eliminada duplicación de `Viewport`
- **Razón:** Durante la revisión de tipos se identificó que `Dimension` se usaba en múltiples módulos pero estaba definido localmente, y `Viewport` estaba duplicado
- **Impacto:** Mejora la mantenibilidad y evita inconsistencias entre definiciones

### Corrección de Error en Inspección de Modelos
- **Archivo:** `frontend/src/ecs/systems/weapon-equip-system.js`
- **Problema:** Error al convertir `Quaternion` a `Euler` usando método inexistente `toEuler()`
- **Solución:** Cambiado a usar `Euler.setFromQuaternion()` que es el método correcto en Three.js
- **Impacto:** Crítico para que funcione la inspección de modelos

