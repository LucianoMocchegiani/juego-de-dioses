# refactor(particles): Refactorización de Dimensiones a Bloques y Fase 1 del Sistema de Partículas

## Resumen

Este PR implementa la Fase 1 del sistema de partículas (JDG-038), refactorizando completamente `dimensiones` a `bloques` en toda la aplicación y estableciendo la fundación del sistema de partículas con schema actualizado, funciones auxiliares básicas y sistema de bloques unificado. Incluye mejoras adicionales en renderizado, opacidad, velocidades de movimiento, control de cámara y gestión de cursor.

## Motivación

El sistema actual usa `dimensiones` pero el diseño final requiere `bloques` con funcionalidad extendida. Además, el schema de partículas necesita campos adicionales (`integridad`, `conductividad_electrica`, `magnetismo`, `carga_electrica`) y el sistema requiere funciones auxiliares básicas para operaciones comunes. Este PR establece las bases para todas las fases siguientes del sistema de partículas.

## Criterios de Aceptación

- [x] Tabla `dimensiones` reemplazada por `bloques` en schema inicial
- [x] Tabla `particulas` usa `bloque_id` desde schema inicial
- [x] Tabla `tipos_particulas` actualizada con campos del diseño final
- [x] Tabla `particulas` actualizada con campos del diseño final
- [x] Tabla `transiciones_particulas` con campos de integridad
- [x] Clases `WorldBloque` y `WorldBloqueManager` implementadas
- [x] Funciones auxiliares básicas implementadas
- [x] Backend actualizado para usar `bloque_id` en todos los endpoints
- [x] Frontend actualizado para usar `bloques` en lugar de `dimensions`
- [x] Seeds actualizados para usar `bloque_id`
- [x] Colores y geometrías de partículas configurados correctamente
- [x] Partículas con diferentes colores se renderizan correctamente
- [x] Agua se renderiza semi-transparente
- [x] Backend responde inmediatamente (seeds en segundo plano)
- [x] Cursor se oculta por defecto y aparece en interfaces
- [x] Cámara gira automáticamente con movimiento del mouse
- [x] Velocidades de movimiento ajustadas

## Cambios Técnicos

### Backend

- Renombrado `dimensiones` a `bloques` en schema inicial con campo `tamano_bloque` agregado
- Actualizado `tipos_particulas`: agregados `integridad`, `conductividad_electrica`, `magnetismo`
- Renombrado `calor_especifico` a `inercia_termica` en `tipos_particulas` con comentario explicativo
- Actualizado `particulas`: renombrado `dimension_id` a `bloque_id`, agregados `integridad` y `carga_electrica`
- Actualizado `transiciones_particulas`: agregados `condicion_integridad` y `valor_integridad`
- Actualizado `agrupaciones`: renombrado `dimension_id` a `bloque_id`
- Endpoint `/api/v1/dimensions` renombrado a `/api/v1/bloques`
- Todos los modelos Pydantic actualizados para usar `bloque_id`
- Todos los queries SQL actualizados para usar `bloque_id` y `juego_dioses.bloques`
- Agregado campo `opacidad` a `ParticleTypeResponse` y queries SQL
- Creado `WorldBloque` class para representar bloques en memoria
- Creado `WorldBloqueManager` class para gestión de bloques en memoria
- Creado `ParticulaService` con funciones auxiliares básicas
- Creado `particula_schemas.py` con modelos Pydantic para partículas
- Seeds movidos a segundo plano usando `asyncio.create_task()` para no bloquear startup
- Corregido `seed_terrain_test_1()` (renombrada de `seed_demo()`)
- Actualizados todos los builders y creators para usar `bloque_id`

### Frontend

- Renombrado `dimensions.js` a `bloques.js` en API endpoints
- Renombrado `dimensions-client.js` a `bloques-client.js`
- Actualizadas todas las referencias de `dimensionId` a `bloqueId`
- Actualizado manejo de `color` y `geometria` directamente desde backend
- Actualizado `TerrainManager` para convertir nueva estructura a formato compatible
- Actualizado `Style` parser para manejar colores hex y nombres CSS
- Actualizado renderizado de partículas para usar nuevas geometrías
- Actualizado UI para mostrar "Bloque" en lugar de "Dimensión"
- Corregido `getGeometryKey` en `ParticleRenderer` para incluir color en clave de agrupación
- Agregado soporte para opacidad de partículas desde backend
- Creado `CursorManager` para gestión centralizada de visibilidad del cursor
- Actualizado `BaseInterface` para mostrar/ocultar cursor automáticamente
- Actualizadas velocidades de movimiento del personaje: `WALK_SPEED` de 15 a 200, `RUN_SPEED` de 30 a 1500
- Actualizada sensibilidad de rotación de cámara de 0.005 a 0.008
- Agregadas sensibilidades separadas para juego (0.008) y menús (0.002)
- Implementada rotación automática de cámara sin necesidad de click derecho

### Base de Datos

- Schema inicial (`01-init-schema.sql`) completamente actualizado
- Tabla `bloques` reemplaza `dimensiones` con campo `tamano_bloque INTEGER DEFAULT 40`
- Seed inicial (`02-seed-data.sql`) actualizado con colores hex, geometrías y opacidades
- Creado script de actualización (`03-update-colors-geometries.sql`) para colores y formas
- Colores configurados: agua (#4169E1), madera (#8B4513), hierba (#7CFC00), hojas (#006400), piedra (#696969)
- Geometrías configuradas: agua (esfera), madera (cilindro), resto (cajas)
- Opacidades configuradas: agua (0.6 semi-transparente), gases (0.0-0.7 según tipo), sólidos (1.0 opaco)

## Testing

- Backend inicia correctamente sin bloquearse (seeds en segundo plano)
- Endpoint `/api/v1/bloques` responde correctamente con datos de bloques
- Partículas se renderizan con colores y geometrías correctas en frontend
- Partículas con diferentes colores se renderizan correctamente (piedra gris, hierba verde lima, hojas verde oscuro)
- Agua se renderiza semi-transparente (opacidad 0.6)
- Seeds se ejecutan en segundo plano sin afectar disponibilidad del API
- Verificado que todos los tipos de partículas tienen colores y geometrías diferenciadas
- Cursor se oculta por defecto y aparece correctamente al abrir F4/F6
- Cámara gira automáticamente con movimiento del mouse
- Velocidades de movimiento del personaje funcionan correctamente
- Probado localmente con Docker Compose
- Frontend probado en navegador con recarga forzada

## Screenshots/Demo

No aplica para este PR (cambios de backend y schema principalmente).

## Referencias

- Ticket: JDG-038
- Action Plan: `instructions/tasks/JDG-038-action-plan_2025-12-24_10-21-56.md`
- Documentación: `Juego de Dioses/Ideas/29-Diseno-Final-Particulas.md` y siguientes

## Deployment

### Cambios Requeridos

- [x] Rebuild Docker images (ya realizado en desarrollo)
- [ ] Ejecutar migraciones de base de datos: No aplica (cambios en schema inicial)
- [ ] Actualizar variables de entorno: No aplica
- [x] Reiniciar servicios Docker (ya realizado en desarrollo)

### Verificación Post-Deployment

- [ ] Verificar endpoints con curl/Postman: `/api/v1/bloques` debe responder correctamente
- [ ] Verificar frontend en navegador: partículas deben verse con colores y formas correctas
- [ ] Verificar logs de Docker: backend debe iniciar sin errores
- [ ] Verificar conexión a PostgreSQL y Redis: deben estar funcionando

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Breaking change: cambio de `dimensiones` a `bloques` afecta toda la aplicación
- Datos existentes: si hay datos en producción, requerirán migración manual
- Frontend cache: puede requerir limpieza de caché del navegador

**Plan de rollback:**
1. Revertir commits del PR
2. Restaurar schema anterior si hay datos en producción
3. Rebuild Docker images con schema anterior
4. Verificar que endpoints funcionan correctamente

**Mitigación:**
- Todos los cambios están en schema inicial (no hay migraciones)
- Frontend completamente actualizado para eliminar referencias a `dimensions`
- Seeds en segundo plano no bloquean el startup

## Notas Adicionales

- Todos los cambios se aplicaron directamente al schema inicial según política del proyecto (sin migraciones)
- El frontend fue completamente refactorizado para eliminar cualquier referencia a "dimensions"
- Los seeds ahora se ejecutan en segundo plano, permitiendo que el backend responda inmediatamente
- Los colores usan formato hex (#RRGGBB) para mejor compatibilidad con Three.js
- El sistema de cursor está preparado para futuras interfaces (inventario, menús, etc.)

## Anexo: Cambios Fuera del Plan

### Corrección de Bugs Encontrados

- **Archivo:** `backend/src/database/creators/entity_creator.py`
- **Problema:** Uso de `self.dimension_id` en lugar de `self.bloque_id`
- **Solución:** Corregido a `self.bloque_id`
- **Impacto:** Crítico para funcionamiento de seeds

- **Archivo:** `backend/src/database/builders/biped_builder.py`
- **Problema:** Query SQL usando `juego_dioses.dimensiones` en lugar de `juego_dioses.bloques`
- **Solución:** Actualizado a `juego_dioses.bloques`
- **Impacto:** Crítico para creación de personajes

- **Archivo:** `backend/src/database/seed_terrain_test_1.py`
- **Problema:** Función `seed_demo()` no coincidía con import esperado `seed_terrain_test_1()`
- **Solución:** Renombrada función a `seed_terrain_test_1()`
- **Impacto:** Crítico para ejecución de seeds

### Optimización de Startup

- **Archivo:** `backend/src/main.py`
- **Cambio:** Seeds movidos a segundo plano usando `asyncio.create_task()`
- **Razón:** Los seeds bloqueaban el startup del backend, causando errores 502
- **Impacto:** Backend ahora responde inmediatamente mientras seeds se ejecutan en background

### Mejoras de Colores y Geometrías

- **Archivo:** `database/init/02-seed-data.sql` y `database/init/03-update-colors-geometries.sql`
- **Cambio:** Actualizados colores a formato hex y geometrías apropiadas para cada tipo
- **Razón:** Partículas se veían todas verdes y cuadradas, requerían diferenciación visual
- **Impacto:** Mejora significativa en visualización de partículas

### Corrección de Renderizado de Partículas

- **Archivo:** `frontend/src/terrain/renderers/particle-renderer.js`
- **Problema:** Partículas con diferentes colores se agrupaban juntas porque `getGeometryKey` no incluía el color
- **Solución:** Agregado color a la clave de agrupación para que partículas con diferentes colores se rendericen por separado
- **Impacto:** Crítico para visualización correcta de diferentes tipos de partículas

### Sistema de Opacidad para Partículas

- **Archivo:** `backend/src/models/schemas.py`, `backend/src/api/routes/particles.py`, `database/init/02-seed-data.sql`, `database/init/03-update-colors-geometries.sql`
- **Cambio:** Agregado campo `opacidad` a `ParticleTypeResponse` y queries SQL, configurado agua con opacidad 0.6 (semi-transparente)
- **Razón:** El agua debe verse semi-transparente para mejor realismo visual
- **Impacto:** Mejora visual del agua y preparación para futuras partículas transparentes

### Optimizaciones de Velocidad y Control

- **Archivo:** `frontend/src/config/animation-constants.js`
- **Cambio:** Aumentadas velocidades de movimiento: `WALK_SPEED` de 15 a 200, `RUN_SPEED` de 30 a 1500 celdas/segundo
- **Razón:** Movimiento del personaje era demasiado lento
- **Impacto:** Mejora significativa en experiencia de juego

- **Archivo:** `frontend/src/world/camera-controller.js`
- **Cambio:** Aumentada sensibilidad de rotación de cámara de 0.005 a 0.008, agregadas sensibilidades separadas para juego (0.008) y menús (0.002)
- **Razón:** Rotación de cámara era demasiado lenta
- **Impacto:** Mejora en control de cámara

### Sistema de Gestión de Cursor

- **Archivo:** `frontend/src/utils/cursor-manager.js` (nuevo), `frontend/src/interfaces/base-interface.js`, `frontend/src/main.js`, `frontend/index.html`
- **Cambio:** Creado sistema centralizado para ocultar/mostrar cursor. Cursor oculto por defecto, visible solo cuando se abren interfaces (F4, F6)
- **Razón:** Mejor experiencia de juego con cursor oculto durante gameplay
- **Impacto:** Mejora en inmersión y preparación para futuras interfaces (inventario, menús)

### Rotación Automática de Cámara

- **Archivo:** `frontend/src/world/camera-controller.js`
- **Cambio:** Cámara ahora gira automáticamente con movimiento del mouse sin necesidad de mantener presionado click derecho
- **Razón:** Mejor experiencia de control, más intuitivo
- **Impacto:** Mejora significativa en usabilidad de cámara

