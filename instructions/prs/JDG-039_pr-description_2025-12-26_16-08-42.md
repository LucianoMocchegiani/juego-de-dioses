# feat(backend): Sistema de Temperatura Ambiental y Sistema Sol/Luna Gleason (JDG-039)

## Resumen

Implementa el sistema de temperatura ambiental y el sistema de sol/luna con proyección Gleason para calcular la temperatura base de bloques espaciales. Incluye servicio autoritativo de tiempo celestial en el backend, cálculo de temperatura basado en múltiples factores ambientales (latitud, altitud, proximidad al agua, albedo), e integración con `WorldBloque`. Expone endpoints REST para consultar estado celestial y calcular temperatura.

## Motivación

Este sistema es fundamental para que las partículas puedan ajustar su temperatura hacia la temperatura ambiental, y es requisito previo para sistemas de disipación de temperatura y transiciones por temperatura. Los bloques espaciales existían pero no calculaban temperatura ambiental, y no había sistema de sol/luna para determinar posición solar y ciclo día/noche.

## Criterios de Aceptación

- [x] Sistema `CelestialTimeService` implementado con movimiento circular del sol alrededor del centro (proyección Gleason)
- [x] Sistema de luna implementado con movimiento circular y fases lunares
- [x] Función `calculate_solar_temperature()` calcula temperatura según latitud (distancia del centro) y posición del sol
- [x] Función `get_altitude_modifier()` calcula modificador de temperatura por altitud (-6.5°C por cada 1000 unidades)
- [x] Función `get_water_modifier()` calcula modificador por proximidad al agua (efecto moderador)
- [x] Función `get_albedo_modifier()` calcula modificador por tipo de superficie (albedo desde BD)
- [x] Función `calculate_cell_temperature()` integra todos los modificadores para calcular temperatura final
- [x] `WorldBloque.calcular_temperatura()` actualizado para usar sistema celestial y modificadores
- [x] Ciclo día/noche funcional (determina si es día o noche según posición del sol)
- [x] Endpoints REST para consultar estado celestial y calcular temperatura
- [x] Funciones auxiliares documentadas y con ejemplos de uso

## Cambios Técnicos

### Backend

- **Nuevo servicio `CelestialTimeService`** (`backend/src/services/celestial_time_service.py`):
  - Gestiona tiempo del juego autoritativo (single source of truth)
  - Calcula ángulos solares y lunares usando proyección Gleason
  - Calcula fases lunares y ciclo día/noche
  - Calcula intensidad solar en posiciones específicas
  - Diseñado para ser extensible (futuros modificadores de hechizos, estadísticas, eventos)

- **Nuevo servicio `TemperatureService`** (`backend/src/services/temperature_service.py`):
  - `calculate_solar_temperature()`: Temperatura base según latitud y posición del sol
  - `get_altitude_modifier()`: Modificador por altitud (gradiente adiabático)
  - `get_water_modifier()`: Modificador por proximidad al agua (async, consulta BD)
  - `get_albedo_modifier()`: Modificador por albedo (async, consulta desde BD)
  - `calculate_cell_temperature()`: Función principal que integra todos los modificadores

- **Actualizado `WorldBloque`** (`backend/src/services/world_bloque.py`):
  - Método `calcular_temperatura()` ahora usa `CelestialTimeService` y `TemperatureService`
  - Acepta parámetro opcional `tipo_particula_superficie` para considerar albedo

- **Nuevos endpoints REST** (`backend/src/api/routes/celestial.py`):
  - `GET /api/v1/celestial/state`: Obtener estado completo del tiempo celestial
  - `POST /api/v1/celestial/temperature`: Calcular temperatura en una posición específica
  - Instancia global singleton de `CelestialTimeService` que se actualiza cada segundo en segundo plano

- **Schemas Pydantic** (`backend/src/models/schemas.py`):
  - `CelestialStateResponse`: Estado del tiempo celestial
  - `TemperatureRequest`: Request para calcular temperatura
  - `TemperatureResponse`: Respuesta con temperatura calculada

- **Exportaciones** (`backend/src/services/__init__.py`):
  - Exportados `CelestialTimeService` y todas las funciones de temperatura

- **Inicialización** (`backend/src/main.py`):
  - Servicio celestial se inicia en segundo plano durante startup
  - Router celestial registrado en la aplicación FastAPI

- **Documentación** (`backend/src/services/README.md`):
  - Secciones completas para `CelestialTimeService` y `TemperatureService`
  - Ejemplos de uso y explicación de factores de temperatura
  - Documentación de endpoints REST

### Base de Datos

- **Schema actualizado** (`database/init/01-init-schema.sql`):
  - Agregada columna `albedo DECIMAL(3,2) DEFAULT 0.2` a tabla `tipos_particulas`
  - Comentario explicativo agregado

- **Seed data actualizado** (`database/init/02-seed-data.sql`):
  - Agregados valores de albedo para todos los tipos de partículas en `INSERT` inicial
  - Valores basados en propiedades físicas reales (nieve: 0.9, hielo: 0.8, piedra: 0.1, etc.)

### Docker/Infraestructura

- **Configuración nginx** (`frontend/nginx.conf`):
  - Agregados timeouts explícitos para proxy de API (60s) para evitar 504 Gateway Timeout

## Testing

- [x] Probado localmente con Docker Compose
- [x] Endpoints probados: `/api/v1/celestial/state` y `/api/v1/celestial/temperature`
- [x] Verificado que el servicio celestial se inicializa correctamente en segundo plano
- [x] Verificado que `WorldBloque.calcular_temperatura()` funciona correctamente
- [x] Verificado que los valores de albedo se obtienen correctamente desde la BD
- [x] Verificado logs de Docker (sin errores después de correcciones)

## Referencias

- Ticket: JDG-039
- Plan de acción: `instructions/tasks/JDG-039-action-plan_2025-12-26_13-00-59.md`
- Análisis de arquitectura: `instructions/analysis/JDG-039-architecture-analysis_2025-12-26_13-00-59.md`
- Documentación relacionada:
  - `Juego de Dioses/Ideas/31-Sistema-Temperatura-Ambiental.md`
  - `Juego de Dioses/Ideas/32-Sistema-Sol-Luna-Gleason.md`
  - `Juego de Dioses/Ideas/52-Orden-Prioridad-Desarrollo.md` (Fase 2.1 y 2.2)

## Deployment

### Cambios Requeridos

- [x] Rebuild Docker images (ya aplicado con cambios)
- [ ] Ejecutar migraciones de base de datos: No requiere migraciones, cambios en schema de init
- [ ] Actualizar variables de entorno: No se requieren nuevas variables
- [x] Reiniciar servicios Docker (ya aplicado)

### Verificación Post-Deployment

- [ ] Verificar endpoints `/api/v1/celestial/state` y `/api/v1/celestial/temperature` con curl/Postman
- [ ] Verificar que el servicio celestial se actualiza correctamente (logs)
- [ ] Verificar que `WorldBloque.calcular_temperatura()` retorna valores razonables
- [ ] Verificar logs de Docker (sin errores)
- [ ] Verificar conexión a PostgreSQL (valores de albedo en BD)

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- El servicio celestial se ejecuta en segundo plano y podría consumir recursos si no se maneja correctamente (mitigado con manejo de excepciones y cancelación)
- Los cálculos de temperatura requieren consultas a BD para agua y albedo, lo que podría impactar performance si se llama frecuentemente (mitigado con cache opcional en `WorldBloque`)

**Plan de rollback:**
1. Revertir commits relacionados con JDG-039
2. Restaurar schema de BD si se ejecutaron cambios (aunque no hay migraciones, solo init)
3. Rebuild y restart de contenedores Docker
4. Verificar que endpoints anteriores funcionan correctamente

## Notas Adicionales

- El sistema usa proyección Gleason: centro (radio 0) = Polo Norte, borde (radio 100%) = Polo Sur
- La velocidad del tiempo es configurable (actualmente 60x: 1 segundo real = 1 minuto de juego)
- El albedo se almacena en la BD para flexibilidad y consistencia con otros campos de tipos de partículas
- El sistema está diseñado para ser extensible: futuros modificadores de hechizos según fase lunar, estadísticas de personajes según ciclo solar/lunar, eventos especiales (eclipses, alineaciones)
- Arquitectura híbrida: backend autoritativo para tiempo y cálculos, frontend puede recibir estado para renderizado visual

## Anexo: Cambios Fuera del Plan

### Corrección de Bugs Encontrados

- **Archivo:** `backend/src/services/world_bloque.py`
- **Problema:** Indentación incorrecta en docstring del módulo causaba `IndentationError` y 502 Bad Gateway
- **Solución:** Corregida indentación del docstring
- **Impacto:** Crítico para funcionamiento del backend

- **Archivo:** `backend/src/api/routes/celestial.py` y `backend/src/main.py`
- **Problema:** `start_celestial_service_background_task()` no era async pero se llamaba con `await`, causando problemas de inicialización
- **Solución:** Función convertida a `async` y llamada con `asyncio.create_task()` para no bloquear startup
- **Impacto:** Importante para inicialización correcta del servicio

- **Archivo:** `frontend/nginx.conf`
- **Problema:** Timeouts no explícitos causaban 504 Gateway Timeout en algunos casos
- **Solución:** Agregados timeouts explícitos (60s) para proxy de API
- **Impacto:** Mejora estabilidad de conexiones API

### Actualización de Plan de Acción

- **Archivo:** `instructions/tasks/JDG-039-action-plan_2025-12-26_13-00-59.md`
- **Cambio:** Eliminada sección completa de Testing (Paso 9) según solicitud del usuario
- **Razón:** El usuario no desea implementar tests en este momento
- **Impacto:** Plan actualizado, no afecta implementación

