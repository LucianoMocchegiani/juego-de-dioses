# feat(frontend): Sistema de Vuelo del Personaje y Pointer Lock para Observación Celestial

## Resumen

Implementa sistema de vuelo del personaje mediante triple salto y control tipo avión, junto con Pointer Lock API para evitar que el mouse salga del canvas durante la rotación de cámara. Estos cambios permiten al jugador volar y observar el sistema celestial (sol/luna) implementado en JDG-039.

## Motivación

Para observar correctamente el sistema celestial (sol/luna) implementado en el backend, se necesitaba:
1. Sistema de vuelo que permita al personaje elevarse y alcanzar la altura del sol/luna
2. Control de vuelo intuitivo tipo avión (solo se mueve con WASD, frena cuando no hay input)
3. Pointer Lock para evitar que el mouse salga del canvas y cause bugs durante la rotación de cámara

## Criterios de Aceptación

- [x] El personaje puede activar vuelo con triple salto (espacio tres veces seguidas)
- [x] El vuelo se controla con WASD basado en la dirección de la cámara
- [x] El movimiento vertical en vuelo se controla con la orientación vertical de la cámara y W/S
- [x] El personaje frena cuando no hay input (comportamiento tipo avión)
- [x] No hay límite de altura para permitir alcanzar el sol/luna
- [x] La animación de salto no se activa durante el vuelo
- [x] El mouse queda bloqueado dentro del canvas cuando el cursor está oculto
- [x] El pointer lock se activa automáticamente al hacer click en el canvas
- [x] El pointer lock se desactiva cuando se abren interfaces (F4, F6)

## Cambios Técnicos

### Frontend

#### Sistema de Vuelo

**PhysicsComponent** (`frontend/src/ecs/components/physics.js`):
- Agregadas propiedades para sistema de triple salto: `consecutiveJumps`, `lastJumpTime`
- Agregada propiedad `isFlying` para estado de vuelo
- Agregada propiedad `flySpeed` para velocidad de vuelo (200 celdas/segundo)

**InputComponent** (`frontend/src/ecs/components/input.js`):
- Agregadas propiedades `wantsToFlyUp` y `wantsToFlyDown` para control vertical (no utilizadas en implementación final)

**InputSystem** (`frontend/src/ecs/systems/input-system.js`):
- Implementada detección de triple salto para activar vuelo
- Implementado cálculo de movimiento 3D en vuelo basado en dirección de cámara
- El movimiento vertical se controla con la orientación vertical de la cámara y W/S
- Solo aplica aceleración cuando hay input (WASD), permitiendo frenado natural

**PhysicsSystem** (`frontend/src/ecs/systems/physics-system.js`):
- Modificada lógica de salto para permitir múltiples saltos en el aire
- Implementada activación de vuelo después de tres saltos consecutivos
- Desactivada gravedad durante vuelo
- Aplicada fricción en todas las direcciones (X, Y, Z) durante vuelo para frenado tipo avión
- Fricción de vuelo: 0.85 (más fuerte que fricción normal para frenado rápido)

**CollisionSystem** (`frontend/src/ecs/systems/collision-system.js`):
- Eliminado límite máximo de altura (`maxZ`) para permitir vuelo infinito hacia arriba
- Solo se mantiene límite mínimo (`minZ`) para prevenir caída infinita

**AnimationConfig** (`frontend/src/config/animation-config.js`):
- Agregada condición a estado `jump` para prevenir activación durante vuelo
- Agregado nuevo estado `flying` con mayor prioridad que `jump`

**AnimationConstants** (`frontend/src/config/animation-constants.js`):
- Aumentado `MAX_VELOCITY.z` a `Infinity` para permitir velocidad vertical ilimitada

#### Pointer Lock API

**CursorManager** (`frontend/src/utils/cursor-manager.js`):
- Implementada integración con Pointer Lock API
- Agregado listener para eventos `pointerlockchange` y `pointerlockerror`
- Agregado listener para click en canvas que activa pointer lock cuando cursor está oculto
- Implementada reactivación automática de pointer lock si se pierde y cursor sigue oculto
- Pointer lock se desactiva automáticamente cuando se muestra el cursor (interfaces abiertas)

## Testing

- [x] Probado localmente con Docker Compose
- [x] Verificado que el triple salto activa vuelo correctamente
- [x] Verificado que el vuelo se controla con WASD basado en dirección de cámara
- [x] Verificado que el personaje frena cuando no hay input
- [x] Verificado que el personaje puede alcanzar la altura del sol/luna
- [x] Verificado que la animación de salto no se activa durante vuelo
- [x] Verificado que el pointer lock se activa al hacer click en el canvas
- [x] Verificado que el mouse no sale del canvas durante rotación de cámara
- [x] Verificado que el pointer lock se desactiva al abrir interfaces (F4, F6)

## Screenshots/Demo

No aplica (cambios de mecánicas de juego, no UI visible)

## Referencias

- Ticket: JDG-040
- PRs relacionados: JDG-039 (backend del sistema celestial)
- Documentación relacionada: `instructions/tasks/JDG-040-action-plan_2025-12-26_16-34-34.md`

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (solo frontend)
- [ ] No requiere migraciones de base de datos
- [ ] No requiere cambios en variables de entorno
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar que el triple salto activa vuelo
- [ ] Verificar que el vuelo se controla correctamente con WASD
- [ ] Verificar que el pointer lock funciona al hacer click en el canvas
- [ ] Verificar que el mouse no sale del canvas durante rotación
- [ ] Verificar que no hay errores en consola del navegador
- [ ] Verificar performance (FPS no debe bajar significativamente)

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- El pointer lock puede no funcionar en algunos navegadores o requerir interacción del usuario
- El vuelo puede causar problemas de colisión si el personaje vuela dentro de objetos sólidos
- La velocidad de vuelo puede ser demasiado rápida o lenta según el hardware

**Plan de rollback:**
- Revertir cambios en `PhysicsComponent`, `InputSystem`, `PhysicsSystem` y `CollisionSystem` para desactivar vuelo
- Revertir cambios en `CursorManager` para desactivar pointer lock
- Los cambios son solo frontend, no afectan backend ni base de datos

## Notas Adicionales

- El sistema de vuelo está diseñado específicamente para observar el sistema celestial
- La velocidad de vuelo (200 celdas/segundo) está configurada para alcanzar el sol/luna a 500m de altura en aproximadamente 10 segundos
- El pointer lock solo se activa cuando el cursor está oculto (modo juego), no cuando hay interfaces abiertas
- El sistema de vuelo puede extenderse en el futuro para incluir más mecánicas (vuelo horizontal más rápido, efectos visuales, etc.)

## Anexo: Cambios Fuera del Plan

### Mejoras Adicionales al Sistema de Vuelo

**Archivo:** `frontend/src/ecs/systems/input-system.js`
- **Cambio:** Implementado cálculo de movimiento 3D basado en dirección de cámara para vuelo
- **Razón:** Permite control intuitivo del vuelo similar a juegos de aviones
- **Impacto:** Mejora significativa en la experiencia de vuelo

**Archivo:** `frontend/src/ecs/systems/physics-system.js`
- **Cambio:** Implementada fricción en todas las direcciones durante vuelo (tipo avión)
- **Razón:** El personaje debe frenar cuando no hay input, no continuar volando automáticamente
- **Impacto:** Comportamiento más natural y controlable

**Archivo:** `frontend/src/ecs/systems/collision-system.js`
- **Cambio:** Eliminado límite máximo de altura
- **Razón:** El sol/luna están a 500m de altura, se necesita poder alcanzarlos
- **Impacto:** Permite observación completa del sistema celestial

**Archivo:** `frontend/src/config/animation-config.js`
- **Cambio:** Agregado estado `flying` y condición para prevenir animación de salto durante vuelo
- **Razón:** La animación de salto se activaba en bucle durante vuelo, causando problemas visuales
- **Impacto:** Animación correcta durante vuelo

### Sistema de Pointer Lock

**Archivo:** `frontend/src/utils/cursor-manager.js`
- **Cambio:** Implementada integración completa con Pointer Lock API
- **Razón:** El mouse salía del canvas durante rotación de cámara, causando bugs
- **Impacto:** Mejora significativa en la experiencia de juego, el mouse queda bloqueado dentro del canvas

