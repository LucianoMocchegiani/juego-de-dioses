# feat(backend): Sistema de Conservación de Calor para Partículas (JDG-041)

## Resumen

Implementa sistema que permite que partículas con `inercia_termica` (agua, hielo, lava) absorban temperatura del ambiente y la conserven, afectando la temperatura del bloque. Incluye background task que actualiza temperaturas periódicamente, funciones genéricas para cualquier tipo de partícula, y mejoras al sistema de temperatura existente para leer temperatura real de partículas.

## Motivación

El sistema de temperatura actual solo consideraba proximidad al agua sin leer su temperatura real. Las partículas tienen `temperatura` en BD pero no se actualizaba dinámicamente. Este sistema permite que partículas como agua, hielo y lava absorban temperatura del sol/ambiente y la conserven según sus propiedades físicas (`inercia_termica`), haciendo el sistema más realista y preparado para transiciones de estado (agua → hielo).

## Criterios de Aceptación

- [x] El agua absorbe temperatura del ambiente periódicamente
- [x] El agua conserva temperatura según su `inercia_termica`
- [x] El hielo también funciona (sistema genérico)
- [x] La temperatura del agua/hielo afecta la temperatura del bloque
- [x] Sistema funciona para cualquier partícula con `inercia_termica > 0`
- [x] Background task actualiza temperatura cada X minutos (configurable)
- [x] No se rompe código existente (compatibilidad mantenida)

## Cambios Técnicos

### Backend

- **Nueva función `update_particle_temperature()`** (`backend/src/services/temperature_service.py`):
  - Actualiza temperatura de una partícula según temperatura ambiental e `inercia_termica`
  - Alta inercia (agua: 4.0) → cambia lentamente
  - Baja inercia (metal: 0.5) → cambia rápidamente
  - Sistema genérico que funciona para cualquier tipo de partícula

- **Mejorada función `get_water_modifier()`** (`backend/src/services/temperature_service.py`):
  - Ahora lee temperatura real de partículas de agua/hielo
  - Calcula modificador basado en diferencia de temperatura (no solo proximidad)
  - Considera `conductividad_termica` del tipo de partícula
  - Mantiene compatibilidad con código existente (parámetro `temp_ambiente` opcional)

- **Nueva función `get_particle_temperature_modifier()`** (`backend/src/services/temperature_service.py`):
  - Función genérica que funciona para cualquier tipo de partícula (agua, hielo, lava, etc.)
  - Lee temperatura real de partículas y calcula modificador según diferencia con temperatura ambiental
  - Considera distancia y `conductividad_termica` para propagación de calor

- **Actualizada función `calculate_cell_temperature()`** (`backend/src/services/temperature_service.py`):
  - Ahora usa `get_particle_temperature_modifier()` para considerar temperatura real de partículas
  - Calcula temperatura ambiental base primero, luego aplica modificadores de partículas

- **Nueva función `get_particulas_con_inercia()`** (`backend/src/services/particula_service.py`):
  - Obtiene partículas de un bloque que tienen `inercia_termica > 0`
  - Retorna información necesaria para actualización (temperatura, tipo, propiedades)

- **Background task de actualización** (`backend/src/api/routes/celestial.py`):
  - `update_particle_temperatures_periodically()`: Actualiza temperatura de partículas cada X minutos
  - `start_particle_temperature_update_task()`: Inicia el background task
  - Se ejecuta en segundo plano sin bloquear requests
  - Manejo de errores para no romper el task

- **Integración en startup** (`backend/src/main.py`):
  - Background task se inicia automáticamente al arrancar FastAPI
  - Similar a `CelestialTimeService`, se ejecuta en segundo plano

- **Configuración** (`backend/src/config/celestial_config.py`):
  - Agregado `PARTICLE_TEMPERATURE_UPDATE_INTERVAL = 300` (5 minutos)
  - Configurable desde un solo lugar

- **Exportaciones** (`backend/src/services/__init__.py`):
  - Exportadas nuevas funciones: `update_particle_temperature`, `get_particle_temperature_modifier`, `get_particulas_con_inercia`

- **Documentación** (`backend/src/services/README.md`):
  - Actualizada sección de `TemperatureService` con nuevas funciones
  - Documentado sistema de conservación de calor (JDG-041)
  - Explicación de cómo funciona `inercia_termica` y actualización de temperatura

## Testing

- [x] Probado localmente con Docker Compose
- [x] Verificado que background task se inicia correctamente (logs)
- [x] Verificado que funciones genéricas funcionan para agua y hielo
- [x] Verificado compatibilidad con código existente (no se rompe)
- [ ] Tests unitarios: Pendiente (según preferencia del usuario)
- [ ] Verificación de actualización de temperatura en BD: Pendiente verificación manual

## Referencias

- Ticket: JDG-041
- Plan de acción: `instructions/tasks/JDG-041-action-plan_2025-12-28_11-48-02.md`
- Análisis de arquitectura: `instructions/analysis/JDG-041-architecture-analysis_2025-12-28_11-48-02.md`
- Análisis de sistema de temperatura: `instructions/analysis/temperature-system-analysis.md`
- Deuda técnica relacionada:
  - `instructions/technical debt/03-cache-tipos-particulas.md` (cache de tipos de partículas)
  - `instructions/technical debt/04-optimizacion-bloques-activos-temperatura.md` (optimización de bloques activos)

## Deployment

### Cambios Requeridos

- [x] Rebuild Docker images (ya aplicado con cambios)
- [ ] Ejecutar migraciones de base de datos: No requiere migraciones
- [ ] Actualizar variables de entorno: No se requieren nuevas variables (configuración en código)
- [x] Reiniciar servicios Docker (ya aplicado)

### Verificación Post-Deployment

- [ ] Verificar que background task se inicia (logs: "Tarea de actualización de temperatura de partículas iniciada")
- [ ] Verificar que temperatura de partículas se actualiza en BD (consultar `particulas.temperatura` después de 5 minutos)
- [ ] Verificar que temperatura del bloque considera temperatura de partículas (F3 en frontend)
- [ ] Verificar logs de errores (no debe haber errores críticos en background task)
- [ ] Verificar que partículas con `inercia_termica = 0` no se actualizan

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Background task podría consumir recursos si hay muchas partículas (mitigado: actualiza cada 5 minutos, manejo de errores)
- Actualiza todas las partículas de todos los bloques (optimización futura: solo bloques activos - ver deuda técnica)
- Múltiples llamadas a `get_tipo_particula_por_nombre()` sin cache (optimización futura - ver deuda técnica)

**Plan de rollback:**
1. Revertir commits relacionados con JDG-041
2. Rebuild y restart de contenedores Docker
3. Verificar que endpoints anteriores funcionan correctamente
4. El background task se detiene automáticamente al reiniciar

## Notas Adicionales

- El sistema es genérico: funciona para cualquier partícula con `inercia_termica > 0` (agua, hielo, lava, etc.)
- La `inercia_termica` controla qué tan rápido cambia la temperatura: alta inercia = cambio lento (agua conserva temperatura)
- El intervalo de actualización es configurable en `celestial_config.py` (default: 5 minutos)
- Sistema preparado para Fase 2: propagación de calor entre partículas, fuego, eventos dinámicos
- Compatible con sistema de transiciones existente (`transiciones_particulas` table)

## Anexo: Cambios Fuera del Plan

### Mejoras de Configuración

- **Archivo:** `backend/src/config/celestial_config.py`
- **Cambio:** Agregado `PARTICLE_TEMPERATURE_UPDATE_INTERVAL` para centralizar configuración
- **Razón:** Mover valores hardcodeados a configuración centralizada
- **Impacto:** Mejora mantenibilidad

### Documentación de Deuda Técnica

- **Archivos creados:**
  - `instructions/technical debt/03-cache-tipos-particulas.md`: Cache de tipos de partículas
  - `instructions/technical debt/04-optimizacion-bloques-activos-temperatura.md`: Optimización de bloques activos
- **Razón:** Identificar optimizaciones futuras durante implementación
- **Impacto:** Documenta mejoras pendientes para escalabilidad

### Mejoras de Documentación en Código

- **Archivo:** `backend/src/services/temperature_service.py`
- **Cambio:** Agregados comentarios detallados en `update_particle_temperature()` explicando el algoritmo
- **Razón:** Clarificar cómo funciona el sistema de conservación de calor
- **Impacto:** Mejora legibilidad del código

