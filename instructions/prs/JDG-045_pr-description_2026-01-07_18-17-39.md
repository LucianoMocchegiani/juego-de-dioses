# feat(debug): Sistema de Logging de Rendimiento (RAM, GPU, CPU)

## Resumen

Implementa un sistema de logging de rendimiento estructurado que monitorea y registra métricas de recursos del sistema (RAM, GPU, CPU) tanto en backend como en frontend. El sistema proporciona visibilidad del consumo de recursos para facilitar la identificación de problemas de rendimiento y memory leaks.

## Motivación

Actualmente no existe un sistema centralizado de logging de rendimiento que permita monitorear el consumo de recursos del sistema. Esto dificulta la identificación de problemas de rendimiento, memory leaks, y optimizaciones necesarias. El frontend tiene un sistema básico de métricas que solo mide frame time y tiempos de sistemas ECS, pero no incluye métricas de memoria, GPU o CPU.

## Criterios de Aceptación

- [x] Backend loguea métricas de rendimiento periódicamente (configurable, default: cada 30 segundos)
- [x] Backend incluye métricas de memoria (RSS, heap total, heap usado) en formato legible (MB)
- [x] Backend incluye métricas de CPU (load average 1m, 5m, 15m, percent)
- [x] Backend incluye métricas del pool de conexiones de PostgreSQL (total, idle, active, maxSize)
- [x] Backend usa formato de log estructurado (JSON) similar al ejemplo de NestJS
- [x] Frontend extiende el sistema de debugger existente con métricas de memoria
- [x] Frontend incluye métricas de GPU (si están disponibles desde Three.js)
- [x] Frontend muestra métricas en la interfaz de debug (F4) cuando está habilitada
- [x] Frontend puede loguear métricas a consola con formato estructurado (opcional)
- [x] El sistema no degrada significativamente el rendimiento (< 1% de overhead)
- [x] Las métricas se pueden habilitar/deshabilitar mediante configuración

## Cambios Técnicos

### Backend

- **Nuevo servicio:** `backend/src/services/performance_monitor_service.py` - Servicio principal de monitoreo de rendimiento que recopila métricas de memoria, CPU y pool de conexiones
- **Nueva configuración:** `backend/src/config/performance_config.py` - Configuración centralizada para intervalos de logging, niveles de log y habilitación/deshabilitación
- **Dependencia nueva:** `psutil>=5.9.0` agregada a `backend/requirements.txt` para obtener métricas del sistema
- **Integración:** `backend/src/main.py` - Integrado en el ciclo de vida de FastAPI (startup/shutdown) usando lifespan context manager
- **Logging estructurado:** Formato JSON con prefijo `[RUNTIME STATS]` similar al ejemplo de NestJS
- **Manejo de errores:** El sistema funciona gracefulmente si `psutil` no está disponible (con advertencia)

### Frontend

- **Extensión de métricas:** `frontend/src/debug/metrics.js` - Agregados métodos `getMemoryMetrics()` y `getGPUMetrics()` para recopilar métricas de memoria y GPU
- **Nuevo módulo:** `frontend/src/debug/performance-logger.js` - Logger opcional para logging estructurado a consola
- **Interfaz de debug:** `frontend/src/interfaces/debug-interface.js` - Mejorado tab de métricas con:
  - Visualización automática de métricas al abrir el tab
  - Botón de refrescar manual
  - Checkbox para auto-refresh cada 3 segundos (desactivado por defecto)
  - Formato legible de métricas (Frame Time, Memoria, GPU, Sistemas ECS)
- **Configuración:** `frontend/src/config/debug-config.js` - Agregada configuración `performanceLogging` con opciones de habilitación e intervalo

### Docker/Infraestructura

- **Dockerfile backend:** Actualizado `CMD` para incluir `--log-level debug` en uvicorn para que los logs de performance sean visibles

## Testing

- [x] Probado localmente con Docker Compose
- [x] Backend loguea métricas cada 30 segundos con formato JSON correcto
- [x] Backend incluye todas las métricas requeridas (memoria, CPU, DB pool)
- [x] Frontend muestra métricas en interfaz de debug (F4 → tab Métricas)
- [x] Frontend muestra métricas de memoria y GPU cuando están disponibles
- [x] Auto-refresh funciona correctamente (se puede activar/desactivar)
- [x] El sistema no degrada rendimiento significativamente
- [x] El sistema funciona aunque algunas APIs no estén disponibles (fallback graceful)

## Screenshots/Demo

Las métricas se pueden ver en:
- **Backend:** Logs de Docker Compose con formato `[RUNTIME STATS]` cada 30 segundos
- **Frontend:** Interfaz de debug (F4) → tab "Métricas" con visualización estructurada

## Referencias

- Ticket: JDG-045
- Documentación relacionada: `backend/VER-LOGS-PERFORMANCE.md` (instrucciones para ver logs del backend)
- PRs relacionados: Ninguno

## Deployment

### Cambios Requeridos

- [x] Rebuild Docker images (backend requiere `psutil`)
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica, pero se pueden agregar en el futuro)
- [x] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar logs del backend (deben aparecer métricas cada 30 segundos con formato `[RUNTIME STATS]`)
- [ ] Verificar frontend en navegador (abrir F4 → tab Métricas y verificar que se muestran métricas)
- [ ] Verificar logs de Docker (no deben aparecer errores relacionados con performance monitoring)
- [ ] Verificar conexión a PostgreSQL y Redis (no afectado)

## Riesgos y Plan de Rollback

**Riesgos identificados:**
- Bajo: El sistema es opcional y no afecta funcionalidad core si está deshabilitado
- Bajo: `psutil` puede no estar disponible en algunos entornos (manejado con fallback)
- Bajo: Overhead mínimo (< 1%) pero puede acumularse en sistemas con muchos procesos

**Plan de rollback:**
1. Si hay problemas con `psutil`, se puede deshabilitar el monitoreo configurando `PERFORMANCE_LOG_ENABLED=false`
2. Si hay problemas de rendimiento, reducir el intervalo de logging o deshabilitar completamente
3. Si hay problemas en frontend, el logging está deshabilitado por defecto y no afecta funcionalidad

## Notas Adicionales

- El sistema de logging del backend está habilitado por defecto y loguea cada 30 segundos
- El sistema de logging del frontend está deshabilitado por defecto (configurable en `debug-config.js`)
- Las métricas de memoria del frontend pueden no estar disponibles en todos los navegadores (`performance.memory` es una API no estándar)
- El auto-refresh en la interfaz de debug está desactivado por defecto para no saturar la UI
- Se agregó documentación en `backend/VER-LOGS-PERFORMANCE.md` con instrucciones para ver los logs del backend

## Anexo: Cambios Fuera del Plan

### Mejoras en la Interfaz de Debug

- **Archivo:** `frontend/src/interfaces/debug-interface.js`
- **Cambio:** Mejorada la visualización de métricas en el tab de Métricas:
  - Visualización automática al abrir el tab
  - Formato más legible con secciones organizadas (Frame Time, Memoria, GPU, Sistemas ECS)
  - Auto-refresh configurable (cada 3 segundos, desactivado por defecto)
  - Manejo de errores mejorado con mensajes informativos
- **Razón:** Mejorar la experiencia de usuario al visualizar métricas de rendimiento
- **Impacto:** Positivo, no afecta funcionalidad existente

### Limpieza de Debug Prints

- **Archivo:** `backend/src/services/performance_monitor_service.py`
- **Cambio:** Eliminados prints de debug verbosos, dejando solo logs apropiados
- **Razón:** Limpiar output de consola para logs más profesionales
- **Impacto:** Positivo, logs más limpios

### Corrección de Manejo de Pool de Conexiones

- **Archivo:** `backend/src/api/routes/celestial.py`
- **Cambio:** Mejorado manejo de errores durante shutdown del pool de conexiones
- **Razón:** Prevenir errores excesivos "pool is closing" durante shutdown
- **Impacto:** Positivo, logs más limpios durante shutdown
