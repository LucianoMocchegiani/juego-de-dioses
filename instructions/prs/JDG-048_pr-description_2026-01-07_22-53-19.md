# perf(frontend): Optimizaciones de Medio Riesgo para Mejorar FPS (JDG-048)

## Resumen

Implementa tres optimizaciones de medio riesgo en el frontend para mejorar el rendimiento: sistema de frustum culling para solo renderizar entidades visibles, sistema de LOD (Level of Detail) para reducir complejidad de entidades lejanas, y sistema de render batching para agrupar actualizaciones similares. Incluye funciones de verificación en el debug interface (F4).

## Motivación

Después de las optimizaciones de bajo riesgo (JDG-047), se necesitan optimizaciones más agresivas que proporcionen mejoras significativas de FPS. El sistema actual procesa todas las entidades cada frame sin verificar visibilidad, renderiza todas con el mismo nivel de detalle, y no agrupa actualizaciones similares. Estas optimizaciones son fundamentales para escalar el juego a escenas con muchas entidades.

## Criterios de Aceptación

- [x] Se implementa frustum culling que verifica visibilidad de entidades usando bounding sphere
- [x] El Render System solo actualiza entidades visibles dentro del frustum
- [x] Se implementa sistema LOD básico con 2 niveles (alto/bajo) basado en distancia
- [x] Entidades lejanas usan menor calidad (frecuencia de animación reducida)
- [x] Se implementa sistema de render batching (listo para uso futuro)
- [x] Las optimizaciones no causan artefactos visuales
- [x] La transición LOD es suave
- [x] Funciones de verificación disponibles en F4 debug interface
- [x] Código mantenible y bien documentado

## Cambios Técnicos

### Frontend

**Nuevos archivos:**
- `frontend/src/core/optimizations/frustum-culling.js`: Sistema de frustum culling con estadísticas de uso
- `frontend/src/core/optimizations/lod-manager.js`: Sistema de LOD con 2 niveles (alto/bajo) basado en distancia
- `frontend/src/core/optimizations/render-batcher.js`: Sistema de render batching para agrupar actualizaciones por material

**Archivos modificados:**
- `frontend/src/ecs/systems/render-system.js`:
  - Integración de frustum culling para filtrar entidades visibles antes de procesarlas
  - Solo actualiza entidades dentro del frustum de la cámara

- `frontend/src/ecs/systems/animation-mixer-system.js`:
  - Integración de LOD manager para reducir frecuencia de actualización de animaciones en entidades lejanas
  - Respeto a `updateFrequency` configurado por LOD (actualización cada 2 frames para LOD bajo)

- `frontend/src/app.js`:
  - Inicialización de `FrustumCuller` después de cargar la escena y cámara
  - Inicialización de `LODManager` después de cargar la escena y cámara
  - Actualización de frustum culler cada frame antes de actualizar sistemas ECS
  - Integración de frustum culler con RenderSystem
  - Integración de LOD manager con AnimationMixerSystem

- `frontend/src/core/optimizations/README.md`:
  - Documentación completa de los tres nuevos sistemas de optimización
  - Ejemplos de uso y beneficios

- `frontend/src/dev-exposure.js`:
  - Funciones `checkAdvancedOptimizations()` y `monitorAdvancedOptimizations()` para verificar optimizaciones
  - Logs informativos contextualizados (explican cuando 0% culling es normal)

- `frontend/src/interfaces/debug-interface.js`:
  - Botones "Verificar Optimizaciones Avanzadas" y "Monitorear Optimizaciones Avanzadas" en tab Comandos
  - Integración con sistema de logging existente

## Testing

Las optimizaciones fueron verificadas mediante:
- Funciones de verificación ejecutadas desde F4 debug interface y consola
- Frustum culling verificado: funciona correctamente, 0% culling es normal con pocas entidades visibles
- LOD Manager verificado: reduce frecuencia de animaciones en entidades lejanas correctamente
- Render Batching: sistema creado y listo para uso (opcional según necesidades futuras)
- Sin errores durante gameplay normal
- Sin artefactos visuales observados

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Verificado que funcionalidad del juego no cambió
- [x] Verificado que optimizaciones están activas y funcionando

## Referencias

- Ticket: JDG-048
- Análisis de arquitectura: JDG-046 (`instructions/analysis/JDG-046-architecture-analysis_2026-01-07_20-00-39.md`)
- Plan de acción: `instructions/tasks/JDG-048-action-plan_2026-01-07_20-12-57.md`
- Depende de: JDG-047 (Fase 1 - optimizaciones de bajo riesgo)
- Bloquea: JDG-049 (Fase 3 - optimizaciones avanzadas)

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (no necesario, solo cambios frontend)
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica)
- [ ] Reiniciar servicios Docker (solo frontend si está en modo desarrollo)

### Verificación Post-Deployment

- [x] Verificar que el juego funciona igual visualmente
- [x] Verificar funciones de debugging disponibles en F4
- [x] Verificar que no hay errores en consola
- [x] Verificar optimizaciones con `checkAdvancedOptimizations()`

## Riesgos y Plan de Rollback

**Riesgos:**
- Medio riesgo: Las optimizaciones pueden afectar visualmente si hay bugs
- Frustum culling puede ocultar entidades si hay errores en cálculo de bounding sphere
- LOD puede causar "pop-in" si la transición no es suave
- Render batching no está en uso aún (solo creado)

**Plan de Rollback:**
- Revertir commit del PR
- Las optimizaciones no afectan datos persistentes
- El juego funcionará igual sin las optimizaciones (solo con menor FPS potencial)

## Notas Adicionales

- Esta es la Fase 2 de un plan de optimización de 3 fases
- Las optimizaciones son más efectivas con muchas entidades distribuidas en áreas grandes
- Con pocas entidades visibles, el frustum culling muestra 0% culling (comportamiento normal)
- LOD será más útil cuando haya entidades distribuidas en diferentes distancias
- Render Batching está creado pero no integrado aún (listo para uso futuro cuando sea necesario)
- Funciones de verificación disponibles: `checkAdvancedOptimizations()`, `monitorAdvancedOptimizations(seconds)`

## Anexo: Cambios Fuera del Plan

### Corrección de Error de Frustum Culling

- **Archivo:** `frontend/src/core/optimizations/frustum-culling.js`
- **Problema:** Error `Cannot read properties of undefined (reading 'boundingSphere')` al usar `intersectsObject()` directamente
- **Solución:** Implementación usando `Box3.setFromObject()` y `intersectsSphere()` directamente, calculando bounding sphere manualmente
- **Impacto:** Frustum culling funciona correctamente con cualquier tipo de objeto (Mesh, Group, etc.)

### Integración de Funciones de Verificación en Debug Interface

- **Archivos:** `frontend/src/dev-exposure.js`, `frontend/src/interfaces/debug-interface.js`
- **Cambio:** Agregadas funciones `checkAdvancedOptimizations()` y `monitorAdvancedOptimizations()` con botones en F4
- **Razón:** Permitir verificación fácil de las optimizaciones implementadas durante desarrollo y debugging
- **Nota:** Mensajes mejorados con contexto (explican cuando 0% culling es normal)

### Uso de debugLogger en lugar de console

- **Archivo:** `frontend/src/core/optimizations/frustum-culling.js`
- **Cambio:** Reemplazado `console.warn` por `debugLogger.warn` para consistencia con el resto del proyecto
- **Razón:** Mantener consistencia en el sistema de logging del proyecto
