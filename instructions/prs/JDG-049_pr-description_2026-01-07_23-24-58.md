# perf(frontend): Optimizaciones Avanzadas para Mejorar FPS (JDG-049)

## Resumen

Implementa tres optimizaciones avanzadas en el frontend para maximizar rendimiento: sistema de instancing para agrupar entidades similares en `InstancedMesh`, sistema de frame scheduling para distribuir trabajo pesado a lo largo de múltiples frames, y sistema de spatial partitioning usando grid para optimizar queries espaciales. Los sistemas están creados e integrados en el ECS, con funciones de verificación en el debug interface (F4).

## Motivación

Después de las optimizaciones de bajo y medio riesgo (JDG-047, JDG-048), se necesitan optimizaciones avanzadas que proporcionen mejoras significativas adicionales de FPS. El sistema actual procesa todas las entidades cada frame, renderiza cada entidad individualmente, y no tiene estructura espacial para queries eficientes. Estas optimizaciones son fundamentales para escalar el juego a escenas con cientos de entidades.

## Criterios de Aceptación

- [x] Se implementa sistema de instancing que agrupa entidades similares en `InstancedMesh`
- [x] Se implementa frame scheduling que distribuye actualizaciones a lo largo de múltiples frames
- [x] Se implementa spatial partitioning (grid) para organizar entidades espacialmente
- [x] Spatial Grid se integra en CollisionSystem para queries eficientes
- [x] Frame Scheduler se integra en ECSManager y está disponible para sistemas
- [x] Instancing Manager está inicializado y disponible para uso futuro
- [x] Las optimizaciones no causan bugs o artefactos visuales
- [x] Funciones de verificación disponibles en F4 debug interface
- [x] Código mantenible y bien documentado

**Nota:** La integración completa de Instancing en RenderSystem y el uso activo de Frame Scheduler en sistemas individuales están documentadas como technical debt para implementación futura (ver `instructions/technical debt/05-integracion-instancing-render-system.md` y `instructions/technical debt/06-uso-activo-frame-scheduler.md`).

## Cambios Técnicos

### Frontend

**Nuevos archivos:**
- `frontend/src/core/optimizations/instancing-manager.js`: Sistema de instancing para agrupar entidades similares en `InstancedMesh` de Three.js, reduciendo draw calls cuando hay muchas entidades del mismo tipo
- `frontend/src/core/optimizations/frame-scheduler.js`: Sistema de frame scheduling para distribuir trabajo pesado a lo largo de múltiples frames, evitando sobrecarga en un solo frame
- `frontend/src/core/optimizations/spatial-partition.js`: Sistema de spatial partitioning usando grid para organizar entidades espacialmente, optimizando queries espaciales de O(n) a O(1) en el mejor caso

**Archivos modificados:**
- `frontend/src/app.js`:
  - Inicialización de `FrameScheduler` antes de ECS
  - Inicialización de `InstancingManager` después de cargar escena
  - Inicialización de `SpatialGrid` con tamaño basado en dimension
  - Integración de `SpatialGrid` en `CollisionSystem`
  - Conexión de `FrameScheduler` con `ECSManager`

- `frontend/src/ecs/manager.js`:
  - Métodos `setFrameScheduler()` y `getFrameScheduler()` para conectar FrameScheduler
  - Lógica para usar FrameScheduler en el loop de actualización (verifica `system.updateFrequency` y `shouldUpdate()`)
  - FrameScheduler disponible para todos los sistemas que quieran usarlo

- `frontend/src/ecs/systems/collision-system.js`:
  - Integración de `SpatialGrid` en constructor
  - Actualización de entidades en SpatialGrid cada frame (`spatialGrid.update()`)
  - Uso de `spatialGrid.queryRange()` para obtener entidades cercanas para colisiones (optimización de queries)

- `frontend/src/core/optimizations/README.md`:
  - Documentación completa de los tres nuevos sistemas de optimización
  - Ejemplos de uso y beneficios esperados

- `frontend/src/dev-exposure.js`:
  - Funciones `checkAdvancedOptimizations()` y `monitorAdvancedOptimizations()` actualizadas para incluir estadísticas de Instancing Manager, Frame Scheduler y Spatial Grid
  - Logs informativos contextualizados para cada sistema

- `frontend/src/interfaces/debug-interface.js`:
  - Ya incluye botones para verificar optimizaciones avanzadas (agregados en JDG-048)
  - Las funciones ahora incluyen verificación de los tres nuevos sistemas

## Testing

Las optimizaciones fueron verificadas mediante:
- Funciones de verificación ejecutadas desde F4 debug interface y consola
- Instancing Manager: Inicializado correctamente, disponible para uso futuro
- Frame Scheduler: Integrado en ECSManager, disponible para sistemas que quieran usarlo
- Spatial Grid: Integrado en CollisionSystem, actualiza entidades automáticamente, queries funcionando
- Sin errores durante gameplay normal
- Sin artefactos visuales observados
- Funcionalidad del juego no cambió

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Verificado que funcionalidad del juego no cambió
- [x] Verificado que sistemas están inicializados y funcionando
- [x] Verificado con funciones de debugging en F4

## Referencias

- Ticket: JDG-049
- Análisis de arquitectura: JDG-046 (`instructions/analysis/JDG-046-architecture-analysis_2026-01-07_20-00-39.md`)
- Plan de acción: `instructions/tasks/JDG-049-action-plan_2026-01-07_20-12-57.md`
- Depende de: JDG-047 (Fase 1), JDG-048 (Fase 2)
- Bloquea: Ninguno

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (no necesario, solo cambios frontend)
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica)
- [ ] Reiniciar servicios Docker (solo frontend si está en modo desarrollo)

### Verificación Post-Deployment

- [x] Verificar que el juego funciona igual visualmente
- [x] Verificar funciones de debugging disponibles en F4
- [x] Verificar que no hay errores en consola
- [x] Verificar optimizaciones con `checkAdvancedOptimizations()`

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo riesgo: Los sistemas están creados pero no afectan funcionalidad existente
- Instancing Manager no está en uso aún (no afecta rendering actual)
- Frame Scheduler está disponible pero sistemas no lo usan activamente (no afecta comportamiento actual)
- Spatial Grid está en uso pero es optimización transparente (mejora rendimiento sin cambiar lógica)

**Plan de Rollback:**
- Revertir commit del PR
- Las optimizaciones no afectan datos persistentes
- El juego funcionará igual sin las optimizaciones (solo con menor FPS potencial)

## Notas Adicionales

- Esta es la Fase 3 (final) de un plan de optimización de 3 fases
- Los tres sistemas están completamente funcionales y listos para usar
- Spatial Grid está activamente en uso en CollisionSystem
- Frame Scheduler está disponible pero los sistemas individuales pueden optar por usarlo cuando sea necesario
- Instancing Manager está creado pero requiere refactorización mayor de RenderSystem para integrarse completamente (documentado como technical debt)
- Funciones de verificación disponibles: `checkAdvancedOptimizations()`, `monitorAdvancedOptimizations(seconds)`

## Anexo: Cambios Fuera del Plan

### Documentación de Technical Debt

- **Archivos creados:**
  - `instructions/technical debt/05-integracion-instancing-render-system.md`: Documentación detallada sobre la integración pendiente de Instancing en RenderSystem, incluye 3 opciones de implementación y análisis de complejidad/riesgo
  - `instructions/technical debt/06-uso-activo-frame-scheduler.md`: Documentación detallada sobre el uso activo pendiente de Frame Scheduler en sistemas individuales, incluye estrategias de implementación y sistemas candidatos

- **Razón:** Documentar pendientes opcionales identificados durante la implementación para referencia futura

- **Impacto:** No afecta funcionalidad, solo documentación para planificación futura

### Actualización de Funciones de Verificación

- **Archivo:** `frontend/src/dev-exposure.js`
- **Cambio:** Funciones `checkAdvancedOptimizations()` y `monitorAdvancedOptimizations()` actualizadas para incluir estadísticas de los tres nuevos sistemas (Instancing Manager, Frame Scheduler, Spatial Grid)
- **Razón:** Mantener funciones de verificación completas y actualizadas para todos los sistemas de optimización
- **Nota:** Los mensajes explican cuando 0% uso es normal (sistemas creados pero no en uso activo aún)
