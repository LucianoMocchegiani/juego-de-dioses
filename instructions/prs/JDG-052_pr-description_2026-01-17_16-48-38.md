# feat(animations): Animaciones Direccionales de Agacharse y Caminar Agachado

## Resumen

Implementa sistema de animaciones direccionales para agacharse y caminar agachado, permitiendo que el personaje muestre diferentes animaciones según la tecla presionada (W, A, S, D) cuando está agachado. Corrige el estado `crouch_idle` para usar una animación apropiada de agacharse en lugar de la animación de caminar agachado. También restringe correr cuando está agachado y reduce la velocidad de movimiento al 50% cuando está agachado.

## Motivación

Actualmente el sistema de agacharse tiene problemas:
1. El estado `crouch_idle` (Ctrl sin movimiento) usa incorrectamente la animación `crouch_walk_forward` en lugar de una animación de solo agacharse
2. El estado `crouch_walk` (Ctrl + movimiento) siempre usa `crouch_walk_forward` sin importar la dirección
3. No hay diferenciación visual entre caminar agachado hacia adelante, atrás, izquierda o derecha
4. El personaje puede correr cuando está agachado (no debería)
5. La velocidad de movimiento no se reduce cuando está agachado

Las animaciones direccionales ya fueron obtenidas desde Meshy y están disponibles en el backend, solo faltaba implementar la lógica para seleccionarlas según la dirección del movimiento.

## Criterios de Aceptación

- [x] Cuando el jugador presiona Ctrl o C sin movimiento, se reproduce la animación `crouch_idle` (solo agacharse, NO caminar agachado)
- [x] Cuando el jugador presiona Ctrl o C + W (adelante), se reproduce `crouch_walk_forward`
- [x] Cuando el jugador presiona Ctrl o C + S (atrás), se reproduce `crouch_walk_backward`
- [x] Cuando el jugador presiona Ctrl o C + D (derecha), se reproduce `crouch_walk_right`
- [x] Cuando el jugador presiona Ctrl o C + A (izquierda), se reproduce `crouch_walk_left`
- [x] El sistema verifica directamente las teclas presionadas (KeyW, KeyS, KeyA, KeyD) similar a JDG-051
- [x] Solo se usa una dirección a la vez (prioridad: W > S > A > D), sin combinar teclas para movimiento diagonal
- [x] No se puede correr cuando está agachado (Shift no tiene efecto)
- [x] La velocidad de movimiento se reduce al 50% cuando está agachado
- [x] Las animaciones direccionales aparecen en la interfaz F6 para testing
- [x] No hay regresiones en otras animaciones existentes

## Cambios Técnicos

### Frontend

**`frontend/src/config/animation-config.js`:**
- Modificado estado `crouch_idle` para usar animación `crouch_idle` en lugar de `crouch_walk_forward`
- Agregadas animaciones direccionales a `ANIMATION_FILES`:
  - `crouch_walk_backward`: `Cautious_Crouch_Walk_Backward_inplace_withSkin.glb` (nueva)
  - `crouch_walk_left`: `Cautious_Crouch_Walk_Left_inplace_withSkin.glb` (nueva)
  - `crouch_idle`: `CrouchLookAroundBow_withSkin.glb` (nueva, para idle agachado)
  - `crouch_walk_forward` y `crouch_walk_right` ya existían

**`frontend/src/ecs/systems/animation-mixer-system.js`:**
- Extendido `getAnimationNameForState()` para soportar animaciones direccionales de `crouch_walk`
- Implementada lógica simple que verifica directamente las teclas presionadas (KeyW, KeyS, KeyA, KeyD) cuando el estado es `crouch_walk`
- Prioridad de selección: W > S > A > D (solo una dirección a la vez)
- Modificado `resolveAnimationName()` para pasar `InputComponent` cuando el estado es `crouch_walk` (además de `walk`)
- Modificado `playAnimation()` para detectar cambios en animaciones direccionales de `crouch_walk` (similar a `walk`)
- Esto permite transiciones suaves al cambiar de dirección mientras está agachado

**`frontend/src/ecs/systems/input-system.js`:**
- Movida verificación de `wantsToCrouch` antes de la lógica de correr
- Modificada lógica de correr: `input.isRunning` solo es `true` si se presiona Shift + W (adelante) Y NO está agachado
- Agregada reducción de velocidad cuando está agachado: se aplica `CROUCH_SPEED_MULTIPLIER` (0.5 = 50% de velocidad) a la velocidad de movimiento

**`frontend/src/config/animation-constants.js`:**
- Agregada constante `CROUCH_SPEED_MULTIPLIER: 0.5` (50% de velocidad cuando está agachado)

**`frontend/src/interfaces/test-interface.js`:**
- Ya estaba actualizado en JDG-051 para recargar animaciones desde `ANIMATION_FILES` en cada renderizado
- Esto asegura que las nuevas animaciones direccionales de agacharse aparezcan en la interfaz F6

## Testing

- Probado localmente con Docker Compose
- Verificado que `crouch_idle` se reproduce correctamente cuando se presiona Ctrl o C sin movimiento
- Verificado que Ctrl/C + W, A, S, D muestran las animaciones direccionales correspondientes
- Verificado que solo se usa una dirección a la vez (Ctrl+W+D solo usa W)
- Verificado que no se puede correr cuando está agachado (Shift no tiene efecto)
- Verificado que la velocidad se reduce al 50% cuando está agachado
- Verificado que las animaciones direccionales se muestran correctamente en F6
- Verificado que no hay regresiones en otras animaciones (walk, run, jump, attack, etc.)

## Referencias

- Ticket: JDG-052
- Animaciones obtenidas desde: Meshy (https://www.meshy.ai/)
- Ubicación de animaciones: `backend/static/models/biped/male/animations/movement/`
- Relacionado con: JDG-051 (animaciones direccionales de caminar) - reutiliza la misma estrategia simple
- PR relacionado: JDG-051

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (si hay cambios en frontend)
- [ ] Verificar que los archivos GLB estén en `backend/static/models/biped/male/animations/movement/`:
  - `Cautious_Crouch_Walk_Backward_inplace_withSkin.glb` (nuevo)
  - `Cautious_Crouch_Walk_Left_inplace_withSkin.glb` (nuevo)
  - `CrouchLookAroundBow_withSkin.glb` (nuevo)
  - `Cautious_Crouch_Walk_Forward_inplace_withSkin.glb` (ya existe)
  - `Cautious_Crouch_Walk_Right_inplace_withSkin.glb` (ya existe)

### Verificación Post-Deployment

- [ ] Verificar que `crouch_idle` se reproduce correctamente (Ctrl/C sin movimiento)
- [ ] Verificar que las animaciones direccionales de agacharse se cargan correctamente
- [ ] Verificar que Ctrl/C + W, A, S, D muestran las animaciones correctas
- [ ] Verificar que no se puede correr cuando está agachado
- [ ] Verificar que la velocidad se reduce cuando está agachado
- [ ] Verificar que no hay errores 404 en la consola del navegador

## Riesgos y Plan de Rollback

**Riesgos:**
- Si los archivos GLB no están en el backend, las animaciones direccionales no se cargarán (pero hay fallback a `crouch_walk_forward`)
- Cambios en InputSystem podrían afectar el movimiento si hay bugs
- La reducción de velocidad podría sentirse demasiado lenta o rápida según preferencias del usuario

**Plan de Rollback:**
- Revertir cambios en `animation-mixer-system.js` y `input-system.js`
- Revertir cambios en `animation-config.js` (volver `crouch_idle` a usar `crouch_walk_forward`)
- Las animaciones direccionales en `ANIMATION_FILES` no afectan el sistema si no se usan (solo se cargan si se referencian)
- La constante `CROUCH_SPEED_MULTIPLIER` no afecta si no se usa

## Anexo: Cambios Fuera del Plan

### Restricción de Correr Cuando Está Agachado

- **Archivo:** `frontend/src/ecs/systems/input-system.js`
- **Cambio:** `input.isRunning` solo es `true` si se presiona Shift + W (adelante) Y NO está agachado (`!input.wantsToCrouch`)
- **Razón:** El usuario reportó que cuando presiona Shift mientras está agachado, el personaje va rápido. Esto no debería pasar - cuando está agachado, no debería poder correr.
- **Impacto:** Cambia el comportamiento de correr, pero es más realista y consistente

### Reducción de Velocidad Cuando Está Agachado

- **Archivo:** `frontend/src/config/animation-constants.js` y `frontend/src/ecs/systems/input-system.js`
- **Cambio:** Agregada constante `CROUCH_SPEED_MULTIPLIER: 0.5` (50% de velocidad) y aplicada cuando `input.wantsToCrouch` es `true`
- **Razón:** El usuario solicitó que la velocidad se reduzca cuando está agachado, usando un porcentaje de la velocidad normal
- **Impacto:** Cambia el comportamiento de movimiento cuando está agachado, haciendo que el personaje se mueva más lento (más realista)
