# refactor(frontend): Refactorizar AnimationMixerSystem con Helpers Externos

## Resumen

Refactorización de `animation-mixer-system.js` extrayendo responsabilidades específicas a 4 helpers especializados en `ecs/helpers/animation/`. El sistema se redujo de 799 a 344 líneas (57% de reducción), mejorando legibilidad y mantenibilidad sin cambiar funcionalidad.

## Motivación

El archivo `animation-mixer-system.js` tenía 799 líneas con múltiples responsabilidades mezcladas (carga de animaciones, resolución de nombres, reproducción, gestión de combate), dificultando mantenimiento, lectura y testing. Esta refactorización separa cada responsabilidad en helpers independientes y testables.

## Criterios de Aceptación

- [x] `animation-mixer-system.js` reducido de 799 a 344 líneas (57% de reducción)
- [x] Carpeta `ecs/helpers/animation/` creada con 4 helpers especializados
- [x] Cada helper tiene una responsabilidad única y clara
- [x] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
- [x] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
- [x] Los helpers son testables independientemente
- [x] No hay regresiones en animaciones existentes
- [x] El código es más legible y mantenible
- [x] La estructura sigue las mismas convenciones que otros sistemas pequeños

## Cambios Técnicos

### Frontend

**Nuevos archivos creados:**
- `frontend/src/ecs/helpers/animation/animation-loader.js` - Helper para carga de animaciones GLB y gestión de cache
- `frontend/src/ecs/helpers/animation/animation-resolver.js` - Helper para resolución de nombres de animación según estado/dirección y prioridad (Combo > Combate > Normal)
- `frontend/src/ecs/helpers/animation/animation-player.js` - Helper para reproducción de animaciones, transiciones y detección de cambios direccionales
- `frontend/src/ecs/helpers/animation/combat-animation-handler.js` - Helper para gestión de combate (i-frames, cleanup temprano y final)
- `frontend/src/ecs/helpers/animation/README.md` - Documentación de la carpeta y helpers

**Archivos modificados:**
- `frontend/src/ecs/systems/animation-mixer-system.js` - Refactorizado para usar helpers como orquestador:
  - Eliminados métodos extraídos a helpers: `loadAnimation`, `getAnimationNameForState`, `resolveAnimationName`, `playAnimation`, `playAnimationByName`, `updateCombatAction`, `cleanupFinishedCombatAction`
  - Agregado método `setECSManager()` para inicializar `AnimationPlayer` cuando ECS está disponible
  - Método `initializeMixer()` actualizado para usar `AnimationLoader`
  - Método `update()` simplificado para delegar a helpers
  - Interfaz pública mantenida: `playAnimationByName()` sigue disponible delegando al helper

**Cambios específicos:**
- Reducción de líneas: 799 → 344 (57% de reducción)
- `AnimationMixerSystem` ahora actúa como orquestador delegando a helpers
- Helpers instanciados en constructor (`AnimationLoader`, `AnimationResolver`, `CombatAnimationHandler`) y en `setECSManager()` (`AnimationPlayer`)
- Todos los helpers reciben componentes como parámetros, no buscan en el ECS directamente

## Testing

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Verificadas animaciones básicas (idle, walk, run, jump)
- [x] Verificadas animaciones direccionales (walk_forward, walk_backward, walk_left, walk_right)
- [x] Verificadas animaciones de combate (attack, parry, dodge)
- [x] Verificada interfaz de prueba de animaciones (F6)
- [x] Verificadas transiciones entre animaciones
- [x] Verificada gestión de combate (i-frames, cleanup)

**Nota:** Durante las pruebas se corrigieron dos bugs encontrados:
1. Método `setECS` → `setECSManager` (nombre correcto del método en System base)
2. `AnimationPlayer.playAnimation()` ahora usa `resolveAnimationName` en lugar de solo `getAnimationNameForState` para considerar combos/combate

## Screenshots/Demo

No aplica (refactorización interna sin cambios visuales)

## Referencias

- Ticket: JDG-057
- Plan de acción: `instructions/tasks/JDG-057-action-plan_2026-01-17_21-58-50.md`
- Archivos relacionados:
  - `frontend/src/ecs/systems/animation-mixer-system.js`
  - `frontend/src/ecs/systems/animation-state-system.js` (referencia de sistema pequeño)
  - `frontend/src/ecs/systems/combo-system.js` (referencia de sistema pequeño)

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (si aplica, aunque no es necesario si se monta como volumen)
- [ ] Reiniciar servicios Docker (solo si no se usa hot-reload)

### Verificación Post-Deployment

- [x] Verificar frontend en navegador
- [x] Verificar que todas las animaciones funcionan correctamente
- [x] Verificar que no hay errores en consola del navegador
- [x] Verificar que la interfaz F6 (prueba de animaciones) funciona

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo: Refactorización interna sin cambios de funcionalidad
- Posible: Inicialización tardía de `AnimationPlayer` si `setECSManager()` no se llama correctamente (corregido durante implementación)

**Plan de Rollback:**
- Revertir commit del PR si se detectan problemas
- El código anterior (799 líneas) está disponible en el historial de Git

## Notas Adicionales

- Esta refactorización establece un patrón que puede aplicarse a otros sistemas grandes (ej: `weapon-equip-system.js` con 628 líneas)
- Los helpers son completamente independientes y pueden reutilizarse por otros sistemas si es necesario
- La interfaz pública del sistema se mantiene intacta, por lo que no requiere cambios en otros sistemas que lo usan

## Anexo: Cambios Fuera del Plan

### Corrección de Bugs Encontrados Durante Implementación

1. **Bug de inicialización de AnimationPlayer:**
   - **Problema:** Método `setECS()` no existe en System base, debería ser `setECSManager()`
   - **Solución:** Corregido nombre del método en línea 177 de `animation-mixer-system.js`
   - **Impacto:** Crítico - sin esta corrección, `animationPlayer` nunca se inicializaba y las animaciones no funcionaban
   - **Estado:** Corregido y probado

2. **Bug de resolución de animaciones en AnimationPlayer:**
   - **Problema:** `playAnimation()` en helper usaba solo `getAnimationNameForState()` sin considerar combos/combate
   - **Solución:** Actualizado para usar `resolveAnimationName()` que considera prioridad Combo > Combate > Normal
   - **Impacto:** Medio - afectaba animaciones de combate y combos
   - **Estado:** Corregido y probado
