# refactor(frontend): Refactorizar WeaponEquipSystem con Helpers Externos

## Resumen

Refactorización de `weapon-equip-system.js` extrayendo responsabilidades específicas a 3 helpers especializados en `ecs/helpers/weapon/`. El sistema se redujo de 628 a 173 líneas (73% de reducción), mejorando legibilidad y mantenibilidad sin cambiar funcionalidad.

## Motivación

El archivo `weapon-equip-system.js` tenía 628 líneas con múltiples responsabilidades mezcladas (inspección de modelos, carga de modelos con cache, adjuntamiento de armas), dificultando mantenimiento, lectura y testing. Esta refactorización separa cada responsabilidad en helpers independientes y testables, siguiendo el patrón establecido en JDG-057 para `animation-mixer-system.js`.

## Criterios de Aceptación

- [x] `weapon-equip-system.js` reducido de 628 a 173 líneas (73% de reducción)
- [x] Carpeta `ecs/helpers/weapon/` creada con 3 helpers especializados
- [x] Cada helper tiene una responsabilidad única y clara
- [x] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
- [x] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
- [x] Los helpers son testables independientemente
- [x] No hay regresiones en el equipamiento de armas existente
- [x] El código es más legible y mantenible
- [x] La estructura sigue las mismas convenciones que `ecs/helpers/animation/` (JDG-057)

## Cambios Técnicos

### Frontend

**Nuevos archivos creados:**
- `frontend/src/ecs/helpers/weapon/weapon-model-inspector.js` - Helper para inspección y análisis de estructura de modelos de armas GLB (jerarquía, transformaciones, meshes, grupos)
- `frontend/src/ecs/helpers/weapon/weapon-model-loader.js` - Helper para carga de modelos de armas con gestión de cache y promesas para evitar cargas duplicadas
- `frontend/src/ecs/helpers/weapon/weapon-attachment-manager.js` - Helper para adjuntar y desequipar armas al personaje usando bones del esqueleto
- `frontend/src/ecs/helpers/weapon/README.md` - Documentación de la carpeta y helpers

**Archivos modificados:**
- `frontend/src/ecs/systems/weapon-equip-system.js` - Refactorizado para usar helpers como orquestador:
  - Eliminado método `inspectWeaponModel()` (extraído a `WeaponModelInspector`)
  - Eliminada lógica de carga de modelos del método `equipWeapon()` (extraída a `WeaponModelLoader`)
  - Eliminado método `attachWeaponToEntity()` (extraído a `WeaponAttachmentManager`)
  - Método `unequipWeapon()` simplificado para delegar a `WeaponAttachmentManager`
  - Método `equipWeapon()` simplificado para delegar a `WeaponModelLoader` y `WeaponAttachmentManager`
  - Método `update()` mantiene la misma lógica de detección de cambios de armas
  - Constructor actualizado para instanciar helpers especializados
  - Método `destroy()` actualizado para limpiar recursos de helpers

**Cambios específicos:**
- Reducción de líneas: 628 → 173 (73% de reducción)
- `WeaponEquipSystem` ahora actúa como orquestador delegando a helpers
- Helpers instanciados en constructor: `WeaponModelInspector`, `WeaponModelLoader`, `WeaponAttachmentManager`
- `WeaponModelLoader` recibe `ModelLoader`, `ModelCache` y `WeaponModelInspector` como dependencias
- Todos los helpers reciben parámetros necesarios, no buscan en el ECS directamente
- El Object Pool (optimización JDG-047) se pasa como parámetro opcional a `WeaponModelInspector`

## Testing

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Verificado equipamiento de espada (sword)
- [x] Verificado equipamiento de hacha (axe)
- [x] Verificado equipamiento de lanza (spear)
- [x] Verificado cambio entre diferentes tipos de armas
- [x] Verificado desequipamiento de armas
- [x] Verificado que el cache funciona correctamente (no hay cargas duplicadas)
- [x] Verificado que las armas se adjuntan correctamente al skeleton del personaje

**Nota:** Durante las pruebas se mejoró la lógica de detección de cambios de armas en `update()` para asegurar que se equipen correctamente cuando cambia el `weaponType`.

## Screenshots/Demo

No aplica (refactorización interna sin cambios visuales)

## Referencias

- Ticket: JDG-058
- Plan de acción: `instructions/tasks/JDG-058-action-plan_2026-01-17_22-33-51.md`
- PR relacionado: JDG-057 (refactorización similar de `animation-mixer-system.js`)
- Archivos relacionados:
  - `frontend/src/ecs/systems/weapon-equip-system.js`
  - `frontend/src/ecs/helpers/animation/` (patrón de referencia para estructura de helpers)

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (si aplica, aunque no es necesario si se monta como volumen)
- [ ] Reiniciar servicios Docker (solo si no se usa hot-reload)

### Verificación Post-Deployment

- [x] Verificar frontend en navegador
- [x] Verificar que todas las armas se equipan correctamente
- [x] Verificar que no hay errores en consola del navegador
- [x] Verificar cambio entre diferentes tipos de armas (sword, axe, spear)
- [x] Verificar que el cache de modelos funciona correctamente

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo: Refactorización interna sin cambios de funcionalidad
- Posible: Dependencias circulares si los helpers intentan acceder al ECS (mitigado: helpers reciben parámetros)

**Plan de Rollback:**
- Revertir commit del PR si se detectan problemas
- El código anterior (628 líneas) está disponible en el historial de Git

## Notas Adicionales

- Esta refactorización sigue el mismo patrón establecido en JDG-057 para `animation-mixer-system.js`
- Los helpers son completamente independientes y pueden reutilizarse por otros sistemas si es necesario
- La interfaz pública del sistema se mantiene intacta, por lo que no requiere cambios en otros sistemas que lo usan
- El Object Pool (optimización JDG-047) se mantiene en `WeaponModelInspector` para no perder optimizaciones

## Anexo: Cambios Fuera del Plan

### Mejora de Lógica de Detección de Cambios de Armas

**Problema encontrado:** La lógica de detección de cambios de armas en `update()` solo verificaba `!weapon.modelInstance` para decidir si equipar, lo que podía fallar cuando se cambiaba entre diferentes tipos de armas.

**Solución:** Actualizada la condición en línea 81 de `weapon-equip-system.js`:
- **Antes:** `if (!weapon.modelInstance)` - Solo verificaba si no había modelo
- **Después:** `if (!weapon.modelInstance || weapon.modelPath !== weaponConfig.path)` - Verifica también si el path del modelo no coincide con el configurado

**Impacto:** 
- Medio - Asegura que las armas se equipen correctamente cuando cambia el `weaponType`
- Permite que múltiples tipos de armas (sword, axe, spear) se equipen y cambien correctamente

**Estado:** Implementado y probado
