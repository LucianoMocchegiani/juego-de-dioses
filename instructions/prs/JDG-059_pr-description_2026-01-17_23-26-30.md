# refactor(frontend): Refactorizar InputSystem con Helpers Externos

## Resumen

Refactorización de `input-system.js` extrayendo responsabilidades específicas a 4 helpers especializados en `ecs/helpers/input/`. El sistema se redujo de 385 a 175 líneas (54% de reducción), mejorando legibilidad y mantenibilidad sin cambiar funcionalidad.

## Motivación

El archivo `input-system.js` tenía 385 líneas con múltiples responsabilidades mezcladas (verificación de acciones, cálculo de dirección de movimiento 2D/3D, sistema de saltos, procesamiento de inputs de combate), dificultando mantenimiento, lectura y testing. Esta refactorización separa cada responsabilidad en helpers independientes y testables, siguiendo el patrón establecido en JDG-057 y JDG-058.

## Criterios de Aceptación

- [x] `input-system.js` reducido de 385 a 175 líneas (54% de reducción)
- [x] Carpeta `ecs/helpers/input/` creada con 4 helpers especializados
- [x] Cada helper tiene una responsabilidad única y clara
- [x] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
- [x] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
- [x] Los helpers son testables independientemente
- [x] No hay regresiones en procesamiento de input (movimiento, saltos, combate)
- [x] El código es más legible y mantenible
- [x] La estructura sigue las mismas convenciones que `ecs/helpers/animation/` (JDG-057) y `ecs/helpers/weapon/` (JDG-058)

## Cambios Técnicos

### Frontend

**Nuevos archivos creados:**
- `frontend/src/ecs/helpers/input/input-action-checker.js` - Helper para verificación de acciones de input y combinaciones de teclas/mouse
- `frontend/src/ecs/helpers/input/movement-direction-calculator.js` - Helper para cálculo de dirección de movimiento 2D normal y 3D en vuelo con rotación de cámara
- `frontend/src/ecs/helpers/input/jump-handler.js` - Helper para sistema de saltos y activación de vuelo (triple salto)
- `frontend/src/ecs/helpers/input/combat-input-processor.js` - Helper para procesamiento de inputs de combate (ataques, defensas)
- `frontend/src/ecs/helpers/input/README.md` - Documentación de la carpeta y helpers

**Archivos modificados:**
- `frontend/src/ecs/systems/input-system.js` - Refactorizado para usar helpers como orquestador:
  - Eliminado método `checkAction()` (extraído a `InputActionChecker`, delegado para mantener interfaz pública)
  - Eliminada lógica de cálculo de dirección 2D/3D de `update()` (extraída a `MovementDirectionCalculator`)
  - Eliminada lógica de saltos y vuelo de `update()` (extraída a `JumpHandler`)
  - Eliminada lógica de procesamiento de combate de `update()` (extraída a `CombatInputProcessor`)
  - Método `update()` simplificado para delegar a helpers
  - Constructor actualizado para instanciar helpers especializados
  - Mantiene lógica de actualización de teclas, bloqueo de movimiento y aplicación de movimiento a física

**Cambios específicos:**
- Reducción de líneas: 385 → 175 (54% de reducción)
- `InputSystem` ahora actúa como orquestador delegando a helpers
- Helpers instanciados en constructor: `InputActionChecker`, `MovementDirectionCalculator`, `JumpHandler`, `CombatInputProcessor`
- `CombatInputProcessor` recibe `InputActionChecker` como dependencia para verificar acciones
- `MovementDirectionCalculator` recibe `cameraController` como dependencia opcional para rotación vertical
- Todos los helpers reciben parámetros necesarios, no buscan en el ECS directamente
- La interfaz pública se mantiene: método `checkAction()` sigue disponible delegando al helper

## Testing

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Verificado movimiento básico (W/A/S/D en 2D)
- [x] Verificado movimiento en vuelo (3D con rotación de cámara)
- [x] Verificado sistema de saltos (simple, doble, triple → vuelo)
- [x] Verificado inputs de combate (clicks, Q para parry, E para dodge)
- [x] Verificado combinaciones de teclas (Shift+Click, Ctrl+Click)
- [x] Verificado bloqueo de movimiento durante acciones de combate
- [x] Verificado que no hay errores en consola del navegador

## Screenshots/Demo

No aplica (refactorización interna sin cambios visuales)

## Referencias

- Ticket: JDG-059
- Plan de acción: `instructions/tasks/JDG-059-action-plan_2026-01-17_23-06-05.md`
- PRs relacionados: JDG-057 (refactorización de `animation-mixer-system.js`), JDG-058 (refactorización de `weapon-equip-system.js`)
- Archivos relacionados:
  - `frontend/src/ecs/systems/input-system.js`
  - `frontend/src/ecs/helpers/animation/` (patrón de referencia para estructura de helpers)
  - `frontend/src/ecs/helpers/weapon/` (patrón de referencia para estructura de helpers)

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (si aplica, aunque no es necesario si se monta como volumen)
- [ ] Reiniciar servicios Docker (solo si no se usa hot-reload)

### Verificación Post-Deployment

- [x] Verificar frontend en navegador
- [x] Verificar movimiento básico (W/A/S/D)
- [x] Verificar movimiento en vuelo (triple salto + W/A/S/D en 3D)
- [x] Verificar sistema de saltos (simple, doble, triple → vuelo)
- [x] Verificar combate (clicks, Q para parry, E para dodge)
- [x] Verificar combinaciones de teclas (Shift+Click, Ctrl+Click)
- [x] Verificar que no hay errores en consola del navegador

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo: Refactorización interna sin cambios de funcionalidad
- Posible: Dependencias circulares si los helpers intentan acceder al ECS (mitigado: helpers reciben parámetros)
- Posible: Cambios sutiles en comportamiento si la lógica 3D del `MovementDirectionCalculator` no replica exactamente el código original (mitigado: código extraído sin modificaciones)

**Plan de Rollback:**
- Revertir commit del PR si se detectan problemas
- El código anterior (385 líneas) está disponible en el historial de Git

## Notas Adicionales

- Esta refactorización sigue el mismo patrón establecido en JDG-057 y JDG-058
- Los helpers son completamente independientes y pueden reutilizarse por otros sistemas si es necesario
- La interfaz pública del sistema se mantiene intacta (método `checkAction()` sigue disponible), por lo que no requiere cambios en otros sistemas que lo usan
- `MovementDirectionCalculator` es el helper más complejo debido a la lógica 3D con rotación de cámara horizontal y vertical
- `CombatInputProcessor` depende de `InputActionChecker` para verificar acciones de combate
- El orden de llamadas a helpers en `update()` es crítico y debe mantenerse igual al flujo original
