# refactor(frontend): Refactorizar CollisionSystem con Helpers Externos

## Resumen

Refactorización de `collision-system.js` extrayendo responsabilidades específicas a 4 helpers especializados en `ecs/helpers/collision/`. El sistema se redujo de 269 a 133 líneas (50.6% de reducción), mejorando legibilidad y mantenibilidad sin cambiar funcionalidad.

## Motivación

El archivo `collision-system.js` tenía 269 líneas con múltiples responsabilidades mezcladas (gestión de cache de colisiones, detección de colisiones laterales y suelo, detección de líquidos, verificación de límites del terreno), dificultando mantenimiento, lectura y testing. Esta refactorización separa cada responsabilidad en helpers independientes y testables, siguiendo el patrón establecido en JDG-057, JDG-058 y JDG-059.

## Criterios de Aceptación

- [x] `collision-system.js` reducido de 269 a 133 líneas (50.6% de reducción)
- [x] Carpeta `ecs/helpers/collision/` creada con 4 helpers especializados
- [x] Cada helper tiene una responsabilidad única y clara
- [x] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
- [x] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
- [x] Los helpers son testables independientemente
- [x] No hay regresiones en detección de colisiones (laterales, suelo, límites)
- [x] El código es más legible y mantenible
- [x] La estructura sigue las mismas convenciones que `ecs/helpers/animation/` (JDG-057), `ecs/helpers/weapon/` (JDG-058) y `ecs/helpers/input/` (JDG-059)

## Cambios Técnicos

### Frontend

**Nuevos archivos creados:**
- `frontend/src/ecs/helpers/collision/collision-cache-manager.js` - Helper para gestión de cache de colisiones por entidad, invalidación basada en movimiento y actualización de celdas ocupadas desde partículas cargadas
- `frontend/src/ecs/helpers/collision/collision-detector-helper.js` - Helper para detección de colisiones laterales (X/Y) y con suelo (Z), ajustando velocidad y posición
- `frontend/src/ecs/helpers/collision/liquid-detector.js` - Helper para detección de líquidos en una posición dada basándose en partículas cargadas
- `frontend/src/ecs/helpers/collision/terrain-bounds-checker.js` - Helper para verificación de límites del terreno y respawn si la entidad cae fuera
- `frontend/src/ecs/helpers/collision/README.md` - Documentación de la carpeta y helpers

**Archivos modificados:**
- `frontend/src/ecs/systems/collision-system.js` - Refactorizado para usar helpers como orquestador:
  - Eliminada gestión de cache interna (extraída a `CollisionCacheManager`)
  - Eliminada lógica de actualización de celdas ocupadas (extraída a `CollisionCacheManager`)
  - Eliminada lógica de detección de colisiones laterales y suelo (extraída a `CollisionDetectorHelper`)
  - Eliminada lógica de detección de líquidos (extraída a `LiquidDetector`)
  - Eliminada lógica de verificación de límites del terreno (extraída a `TerrainBoundsChecker`)
  - Método `update()` simplificado para delegar a helpers en el orden correcto
  - Constructor actualizado para instanciar helpers especializados
  - Mantiene métodos públicos: `setParticles()`, `detectLiquidAtPosition()`, `updateLoadedCells()` para compatibilidad
  - Mantiene lógica de actualización de spatial grid

**Cambios específicos:**
- Reducción de líneas: 269 → 133 (50.6% de reducción)
- `CollisionSystem` ahora actúa como orquestador delegando a helpers
- Helpers instanciados en constructor: `CollisionCacheManager`, `CollisionDetectorHelper`, `LiquidDetector`, `TerrainBoundsChecker`
- `CollisionCacheManager` maneja cache interno de celdas ocupadas y últimas posiciones de entidades
- `CollisionDetectorHelper` recibe `collisionDetector` como dependencia para usar `isCellOccupied`
- Todos los helpers reciben parámetros necesarios, no buscan en el ECS directamente
- La interfaz pública se mantiene: métodos `setParticles()`, `detectLiquidAtPosition()` y `updateLoadedCells()` siguen disponibles

## Testing

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Verificado colisiones laterales (X/Y se bloquean correctamente al chocar con partículas sólidas)
- [x] Verificado colisión con suelo (Z se ajusta y `isGrounded` se establece correctamente)
- [x] Verificado límites del terreno (posición se limita correctamente y respawn funciona)
- [x] Verificado detección de líquidos (`isInWater` se establece correctamente)
- [x] Verificado cache de colisiones (cache funciona y se invalida correctamente)
- [x] Verificado actualización de spatial grid (spatial grid se actualiza correctamente)
- [x] Verificado casos edge: entidad dentro de partícula sólida (ajusta hacia arriba), caída fuera de límites (respawn), sin partículas cargadas (usa cache o consulta)

## Screenshots/Demo

N/A - Refactorización de código sin cambios visuales.

## Referencias

- Ticket: JDG-060
- PRs relacionados: #JDG-057 (AnimationMixerSystem refactorizado), #JDG-058 (WeaponEquipSystem refactorizado), #JDG-059 (InputSystem refactorizado)
- Documentación relacionada:
  - `frontend/src/ecs/helpers/animation/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/weapon/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/input/README.md` (patrón de referencia)

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica)
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar frontend en navegador
- [ ] Verificar colisiones laterales (caminar contra paredes)
- [ ] Verificar colisión con suelo (caer y tocar suelo)
- [ ] Verificar límites del terreno (moverse a bordes, caer fuera)
- [ ] Verificar respawn si cae fuera del terreno
- [ ] Verificar detección de líquidos (nadar en agua)
- [ ] Verificar que no hay errores en consola del navegador

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo: Refactorización sin cambios de funcionalidad, solo reorganización de código
- El cache de colisiones es crítico para rendimiento, pero la lógica se mantiene idéntica en `CollisionCacheManager`
- Las consultas async de colisiones se mantienen en `CollisionCacheManager.getOccupiedCells()`

**Plan de Rollback:**
- Si hay problemas con detección de colisiones, revertir el PR completo
- El código original estaba en `collision-system.js` (269 líneas), puede restaurarse desde git history
- No hay cambios en configuración, dependencias o estructura de datos

## Notas Adicionales

- Este refactor sigue el mismo patrón establecido en JDG-057, JDG-058 y JDG-059
- Los helpers mantienen la misma eficiencia que el código original, especialmente el cache
- La consulta async de `checkCollision` se mantiene en `CollisionCacheManager.getOccupiedCells()` para no bloquear el frame
- Los helpers pueden modificarse independientemente sin afectar otros aspectos del sistema de colisiones
- La estructura permite extender fácilmente funcionalidades (por ejemplo, agregar nuevos tipos de detección de colisiones)
