# refactor(frontend): Refactorizar CombatSystem con Helpers Externos

## Resumen

Refactorización de `combat-system.js` extrayendo responsabilidades específicas a 4 helpers especializados en `ecs/helpers/combat/`. El sistema se redujo de 217 a 123 líneas (43.3% de reducción), mejorando legibilidad y mantenibilidad sin cambiar funcionalidad.

## Motivación

El archivo `combat-system.js` tenía 217 líneas con múltiples responsabilidades mezcladas (cache de animation states, verificación de input de acción, validación de condiciones de ejecución, aplicación de configuración de acción), dificultando mantenimiento, lectura y testing. Esta refactorización separa cada responsabilidad en helpers independientes y testables, siguiendo el patrón establecido en JDG-057, JDG-058, JDG-059 y JDG-060.

## Criterios de Aceptación

- [x] `combat-system.js` reducido de 217 a 123 líneas (43.3% de reducción)
- [x] Carpeta `ecs/helpers/combat/` creada con 4 helpers especializados
- [x] Cada helper tiene una responsabilidad única y clara
- [x] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
- [x] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
- [x] Los helpers son testables independientemente
- [x] No hay regresiones en procesamiento de combate (ataques, defensas, cooldowns)
- [x] El código es más legible y mantenible
- [x] La estructura sigue las mismas convenciones que `ecs/helpers/animation/` (JDG-057), `ecs/helpers/weapon/` (JDG-058), `ecs/helpers/input/` (JDG-059) y `ecs/helpers/collision/` (JDG-060)

## Cambios Técnicos

### Frontend

**Nuevos archivos creados:**
- `frontend/src/ecs/helpers/combat/combat-animation-state-cache.js` - Helper para cache O(1) de animation states por ID
- `frontend/src/ecs/helpers/combat/combat-action-input-checker.js` - Helper para verificación de input de acción desde InputComponent
- `frontend/src/ecs/helpers/combat/combat-action-validator.js` - Helper para validación de condiciones de ejecución (arma requerida, tipo de arma)
- `frontend/src/ecs/helpers/combat/combat-action-config-applier.js` - Helper para aplicación de configuración de acción y mapeo de animation states
- `frontend/src/ecs/helpers/combat/README.md` - Documentación de la carpeta y helpers

**Archivos modificados:**
- `frontend/src/ecs/systems/combat-system.js` - Refactorizado para usar helpers como orquestador:
  - Eliminada construcción de cache de animation states (extraída a `CombatAnimationStateCache`)
  - Eliminado método `checkActionInput()` (extraído a `CombatActionInputChecker`)
  - Eliminado método `canExecuteAction()` (extraído a `CombatActionValidator`)
  - Eliminado método `applyActionConfig()` (extraída a `CombatActionConfigApplier`)
  - Método `update()` simplificado para delegar a helpers
  - Constructor actualizado para instanciar helpers especializados
  - Eliminada importación de `stateValidator` (ahora en helper)
  - Mantiene lógica de coordinación: actualización de cooldowns, verificación de combo activo, obtención de tipo de arma
  - Mantiene logging y eventos de debug en el lugar apropiado

**Cambios específicos:**
- Reducción de líneas: 217 → 123 (43.3% de reducción)
- `CombatSystem` ahora actúa como orquestador delegando a helpers
- Helpers instanciados en constructor: `CombatAnimationStateCache`, `CombatActionInputChecker`, `CombatActionValidator`, `CombatActionConfigApplier`
- `CombatAnimationStateCache` maneja cache interno para lookup O(1) de animation states
- `CombatActionConfigApplier` recibe `animationStateCache` como dependencia
- Todos los helpers reciben parámetros necesarios, no buscan en el ECS directamente
- La interfaz pública se mantiene: método `update()` sigue funcionando igual

## Testing

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Verificado ataques básicos (clicks se procesan correctamente según input)
- [x] Verificado defensas (Q para parry, E para dodge funcionan correctamente)
- [x] Verificado cooldowns (no permiten ejecución repetida inmediata)
- [x] Verificado validación de arma (parry requiere arma, special_attack requiere espada)
- [x] Verificado aplicación de configuración (configuraciones de acción se aplican correctamente)
- [x] Verificado cache de animation states (cache funciona correctamente, O(1) lookup)
- [x] Verificado combos activos (si hay combo activo, se omite procesamiento de acciones individuales)
- [x] Verificado acción activa en progreso (si hay acción activa, no se procesan nuevos inputs)

## Screenshots/Demo

N/A - Refactorización de código sin cambios visuales.

## Referencias

- Ticket: JDG-061
- PRs relacionados: #JDG-057 (AnimationMixerSystem refactorizado), #JDG-058 (WeaponEquipSystem refactorizado), #JDG-059 (InputSystem refactorizado), #JDG-060 (CollisionSystem refactorizado)
- Documentación relacionada:
  - `frontend/src/ecs/helpers/animation/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/weapon/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/input/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/collision/README.md` (patrón de referencia)

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica)
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar frontend en navegador
- [ ] Verificar ataques básicos (clicks)
- [ ] Verificar defensas (Q para parry, E para dodge)
- [ ] Verificar cooldowns (no permitir ejecución repetida inmediata)
- [ ] Verificar validación de arma (parry requiere arma, special_attack requiere espada)
- [ ] Verificar que no hay errores en consola del navegador

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo: Refactorización sin cambios de funcionalidad, solo reorganización de código
- El cache de animation states es crítico para rendimiento, pero la lógica se mantiene idéntica en `CombatAnimationStateCache`
- Los helpers mantienen la misma lógica que el código original

**Plan de Rollback:**
- Si hay problemas con procesamiento de combate, revertir el PR completo
- El código original estaba en `combat-system.js` (217 líneas), puede restaurarse desde git history
- No hay cambios en configuración, dependencias o estructura de datos

## Notas Adicionales

- Este refactor sigue el mismo patrón establecido en JDG-057, JDG-058, JDG-059 y JDG-060
- El cache de animation states mantiene la misma eficiencia (O(1) lookup) que el código original
- Los helpers pueden modificarse independientemente sin afectar otros aspectos del sistema de combate
- La estructura permite extender fácilmente funcionalidades (por ejemplo, agregar nuevas validaciones de acción)
- La importación de `stateValidator` fue eliminada del sistema principal ya que ahora se usa en `CombatActionConfigApplier`
