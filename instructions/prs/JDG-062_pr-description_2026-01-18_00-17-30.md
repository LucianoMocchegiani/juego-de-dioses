# refactor(frontend): Refactorizar PhysicsSystem con Helpers Externos

## Resumen

Refactorización de `physics-system.js` extrayendo responsabilidades específicas a 4 helpers especializados en `ecs/helpers/physics/`. El sistema se redujo de 220 a 153 líneas (30.5% de reducción), mejorando legibilidad y mantenibilidad sin cambiar funcionalidad.

## Motivación

El archivo `physics-system.js` tenía 220 líneas con múltiples responsabilidades mezcladas (timestep fijo y acumulador, movimiento de acciones de combate, aplicación de fricción, limitación de velocidad máxima), dificultando mantenimiento, lectura y testing. Esta refactorización separa cada responsabilidad en helpers independientes y testables, siguiendo el patrón establecido en JDG-057, JDG-058, JDG-059, JDG-060 y JDG-061.

## Criterios de Aceptación

- [x] `physics-system.js` reducido de 220 a 153 líneas (30.5% de reducción)
- [x] Carpeta `ecs/helpers/physics/` creada con 4 helpers especializados
- [x] Cada helper tiene una responsabilidad única y clara
- [x] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
- [x] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
- [x] Los helpers son testables independientemente
- [x] No hay regresiones en física (gravedad, velocidad, aceleración, fricción, movimiento de combate)
- [x] El código es más legible y mantenible
- [x] La estructura sigue las mismas convenciones que `ecs/helpers/animation/` (JDG-057), `ecs/helpers/weapon/` (JDG-058), `ecs/helpers/input/` (JDG-059), `ecs/helpers/collision/` (JDG-060) y `ecs/helpers/combat/` (JDG-061)

## Cambios Técnicos

### Frontend

**Nuevos archivos creados:**
- `frontend/src/ecs/helpers/physics/physics-timestep-manager.js` - Helper para gestión de timestep fijo y acumulador
- `frontend/src/ecs/helpers/physics/combat-movement-applier.js` - Helper para aplicación de movimiento de acciones de combate
- `frontend/src/ecs/helpers/physics/physics-friction-applier.js` - Helper para aplicación de fricción (vuelo, normal, bloqueado)
- `frontend/src/ecs/helpers/physics/physics-velocity-limiter.js` - Helper para limitación de velocidad máxima
- `frontend/src/ecs/helpers/physics/README.md` - Documentación de la carpeta y helpers

**Archivos modificados:**
- `frontend/src/ecs/systems/physics-system.js` - Refactorizado para usar helpers como orquestador:
  - Eliminada gestión de acumulador (extraída a `PhysicsTimestepManager`)
  - Eliminada lógica de movimiento de acciones de combate (extraída a `CombatMovementApplier`)
  - Eliminada lógica de aplicación de fricción (extraída a `PhysicsFrictionApplier`)
  - Eliminada lógica de limitación de velocidad (extraída a `PhysicsVelocityLimiter`)
  - Método `update()` simplificado para usar `PhysicsTimestepManager`
  - Método `updatePhysics()` simplificado para delegar a helpers
  - Constructor actualizado para instanciar helpers especializados
  - Mantiene lógica simple: aplicación de saltos, gestión de vuelo, bloqueo de movimiento normal, aplicación de gravedad, actualización de velocidad/posición

**Cambios específicos:**
- Reducción de líneas: 220 → 153 (30.5% de reducción)
- `PhysicsSystem` ahora actúa como orquestador delegando a helpers
- Helpers instanciados en constructor: `PhysicsTimestepManager`, `CombatMovementApplier`, `PhysicsFrictionApplier`, `PhysicsVelocityLimiter`
- `PhysicsTimestepManager` maneja acumulador interno para timestep fijo
- `CombatMovementApplier` maneja cálculo de dirección y flag `movementApplied` en `render.mesh.userData`
- `PhysicsFrictionApplier` maneja tres casos: vuelo (0.85), normal (`groundFriction`/`airFriction`), bloqueado (0.7)
- `PhysicsVelocityLimiter` limita velocidad horizontal siempre, pero solo limita velocidad vertical si NO está volando
- Todos los helpers reciben parámetros necesarios, no buscan en el ECS directamente
- La interfaz pública se mantiene: métodos `update()` y `updatePhysics()` siguen funcionando igual

## Testing

- [x] Probado localmente con Docker Compose
- [x] Frontend probado en navegador
- [x] Verificado gravedad (caída correcta cuando no está volando)
- [x] Verificado velocidad y aceleración (movimiento correcto)
- [x] Verificado fricción (frenado correcto en vuelo, normal y bloqueado)
- [x] Verificado límites de velocidad (no excede máximo)
- [x] Verificado movimiento de combate (impulso correcto en acciones)
- [x] Verificado saltos (salto normal y doble salto funcionan correctamente)
- [x] Verificado vuelo (se desactiva al tocar suelo)
- [x] Verificado timestep fijo (física estable con múltiples pasos si es necesario)

## Screenshots/Demo

N/A - Refactorización de código sin cambios visuales.

## Referencias

- Ticket: JDG-062
- PRs relacionados: #JDG-057 (AnimationMixerSystem refactorizado), #JDG-058 (WeaponEquipSystem refactorizado), #JDG-059 (InputSystem refactorizado), #JDG-060 (CollisionSystem refactorizado), #JDG-061 (CombatSystem refactorizado)
- Documentación relacionada:
  - `frontend/src/ecs/helpers/animation/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/weapon/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/input/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/collision/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/combat/README.md` (patrón de referencia)

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images
- [ ] Ejecutar migraciones de base de datos (no aplica)
- [ ] Actualizar variables de entorno (no aplica)
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] Verificar frontend en navegador
- [ ] Verificar gravedad (caída correcta)
- [ ] Verificar velocidad y aceleración (movimiento correcto)
- [ ] Verificar fricción (frenado correcto)
- [ ] Verificar límites de velocidad (no excede máximo)
- [ ] Verificar movimiento de combate (impulso correcto en acciones)
- [ ] Verificar saltos (salto normal y doble salto)
- [ ] Verificar vuelo (se desactiva al tocar suelo)
- [ ] Verificar que no hay errores en consola del navegador

## Riesgos y Plan de Rollback

**Riesgos:**
- Bajo: Refactorización sin cambios de funcionalidad, solo reorganización de código
- El timestep fijo es crítico para física estable, pero la lógica se mantiene idéntica en `PhysicsTimestepManager`
- Los helpers mantienen la misma lógica que el código original

**Plan de Rollback:**
- Si hay problemas con física (gravedad, velocidad, fricción), revertir el PR completo
- El código original estaba en `physics-system.js` (220 líneas), puede restaurarse desde git history
- No hay cambios en configuración, dependencias o estructura de datos

## Notas Adicionales

- Este refactor sigue el mismo patrón establecido en JDG-057, JDG-058, JDG-059, JDG-060 y JDG-061
- El timestep fijo mantiene la misma eficiencia que el código original
- Los helpers pueden modificarse independientemente sin afectar otros aspectos del sistema de física
- La estructura permite extender fácilmente funcionalidades (por ejemplo, agregar nuevos tipos de fricción o limitaciones de velocidad)
- La lógica de saltos, gravedad y actualización de posición/velocidad se mantiene en el sistema principal (son operaciones simples y directas)
