# refactor(backend): estructura por dominio, motor de creación y limpieza de módulos

## Resumen

Reorganización del backend FastAPI: dominios bajo `src/domains/` (bloques, particles, characters, celestial, agrupaciones, shared); motor de creación del mundo en `src/world_creation_engine/` (templates, builders, creators, terrain_builder); eliminación de carpetas obsoletas (api, models, services, database/utils). La API expuesta (URLs y contratos JSON) no cambia.

## Motivación

Centralizar por concepto: API en dominios; lógica de creación (entidades y terreno) en un único motor; persistencia solo en database (conexión y seeds). Mejorar descubribilidad y mantenibilidad sin romper el contrato de la API.

## Criterios de Aceptación

- [x] Existe `src/domains/` con shared, bloques, particles, characters, celestial, agrupaciones (schemas + routes; service donde aplica).
- [x] Schemas compartidos en `domains/shared/schemas.py`; consultas de terreno en `domains/bloques/terrain_utils.py`.
- [x] main.py registra routers desde `src.domains.*`; prefijos y rutas iguales.
- [x] Motor de creación en `src/world_creation_engine/` (templates, builders, creators, terrain_builder); seeds y dominios lo usan.
- [x] No queda `api/`, `models/`, `services/`, `database/utils/`; database solo connection + seeds.
- [x] READMEs y docs reflejan la estructura actual (domains, world_creation_engine, database).

## Cambios Técnicos

### Backend

- **Dominios:** `src/domains/` (no api/domains). Cada dominio: schemas.py, routes.py; celestial y particles tienen service.py. shared: schemas, performance_monitor, world_bloque, world_bloque_manager.
- **Bloques:** Modelos de entidad BloqueBase/Create/Bloque en domains/bloques/schemas.py; consultas get_terrain_height, get_terrain_height_area en domains/bloques/terrain_utils.py.
- **Partículas:** Schemas unificados en domains/particles/schemas.py (DTOs API + modelos entidad); Bloque movido a dominios bloques.
- **Motor de creación:** `src/world_creation_engine/` (templates, builders, creators, terrain_builder). Renombrado desde entity_creation. Exporta EntityCreator, create_boundary_layer, BaseTemplate, BaseBuilder.
- **Database:** Solo connection.py, seeds (seed_terrain_test_1/2, seed_biped_structure, seed_character_with_model). Sin utils, sin terrain_builder; consultas terreno en domains/bloques; creación en world_creation_engine.
- **Eliminado:** Carpeta api; carpetas models y services; database/utils; referencias a tickets en comentarios de código.

### Documentación

- READMEs de backend (database, domains, world_creation_engine, config, storage y por dominio) actualizados: rutas, imports, separación domains = API / world_creation_engine = creación.
- docs/endpoints-flujo.md: referencias a backend actualizadas (`src/domains/` y enlace a domains/README.md).
- README raíz: estructura del proyecto con backend simplificado (src/domains, src/world_creation_engine, src/database).

## Testing

- Refactor de estructura; misma API. Verificación manual recomendada: GET /api/v1/bloques, GET /api/v1/bloques/{id}/particles, GET /api/v1/celestial/state, POST character; OpenAPI /docs con mismos esquemas.
- [ ] Probado localmente con Docker Compose
- [ ] Endpoints probados (curl o /docs)
- [ ] Seeds ejecutados sin error (terrain test 1/2, character with model)

## Referencias

- Ticket: JDG-065
- Plan: instructions/tasks/JDG-065-action-plan_2026-02-01_22-35-00.md
- Análisis: instructions/analysis/JDG-065-architecture-analysis_2026-02-01_22-35-00.md

## Deployment

### Cambios Requeridos

- [ ] Rebuild Docker images (backend)
- [ ] No migraciones de BD ni variables de entorno nuevas
- [ ] Reiniciar servicios Docker

### Verificación Post-Deployment

- [ ] GET /health y GET /api/v1 correctos
- [ ] GET /api/v1/bloques y al menos un bloque con partículas
- [ ] Logs del backend sin errores de import

## Riesgos y Plan de Rollback

- Riesgo bajo: solo reorganización de código e imports. Si algo falla, revertir commit y re-desplegar imagen anterior.

## Anexo: Cambios Fuera del Plan

- **domains en src (no en api):** Dominios movidos de `api/domains/` a `src/domains/` por coherencia con config, database, storage. Carpeta api eliminada.
- **world_creation_engine:** Módulo de creación renombrado de entity_creation a world_creation_engine; documentación actualizada para dejar claro “motor de creación del mundo”.
- **Bloques:** Modelos BloqueBase/Create/Bloque movidos de particles a domains/bloques; terrain_utils (consultas altura) movidas de database/utils a domains/bloques/terrain_utils.py.
- **terrain_builder:** create_boundary_layer movido de database/terrain_builder.py a world_creation_engine/terrain_builder.py (lógica de creación).
- **Eliminación de referencias a tickets:** Comentarios y READMEs sin JDG-065 u otros IDs de ticket.
- **database/utils eliminada:** Carpeta eliminada; terrain_utils ya en domains/bloques.
