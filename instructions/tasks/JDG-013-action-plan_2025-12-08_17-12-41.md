# JDG-013 - Reemplazar Modelo de Personaje con Human.glb

## Descripción de la Tarea

Reemplazar los modelos de prueba actuales (duck.glb, humano_test.glb) con el nuevo modelo `Human.glb` que incluye vertex groups para el sistema de daño por partes. El modelo ya está disponible en `backend/static/models/characters/Human.glb` y debe configurarse como modelo principal para personajes humanos.

**Comportamiento actual:**
- Los personajes usan modelos de prueba (duck.glb, humano_test.glb)
- El script `seed_character_with_model.py` crea personajes con `humano_test.glb`
- No hay un modelo humanoide principal definido
- Los modelos de prueba no tienen vertex groups preparados

**Comportamiento esperado:**
- El modelo `Human.glb` se usa como modelo principal para personajes humanos
- Los personajes nuevos se crean con `Human.glb` por defecto
- El modelo se renderiza correctamente con escala y posición adecuadas
- Los vertex groups están disponibles para futura implementación del sistema de daño por partes

## Criterios de Aceptación

1. ❌ El modelo `Human.glb` está disponible y accesible
2. ❌ Se puede crear un personaje con `Human.glb` usando el script de seed
3. ❌ El modelo se carga correctamente en el frontend
4. ❌ El modelo se renderiza correctamente en Three.js
5. ❌ Los vertex groups están presentes en el modelo cargado (verificación)
6. ❌ El modelo tiene escala apropiada (no demasiado grande ni pequeño)
7. ❌ El script `seed_character_with_model.py` usa `Human.glb` por defecto

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [x] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura

### Tecnologías Involucradas
- Backend: Python 3.11, FastAPI, Uvicorn, asyncpg
- Frontend: HTML5, JavaScript ES6+, Three.js, GLTFLoader
- Base de datos: PostgreSQL 16 (campo modelo_3d en agrupaciones)
- Modelo 3D: GLB con vertex groups

## Pasos de Implementación

### Paso 1: Verificar Modelo y Vertex Groups

**Descripción:**
Verificar que el modelo `Human.glb` está en la ubicación correcta y que los vertex groups se exportaron correctamente.

**Archivos a verificar:**
- `backend/static/models/characters/Human.glb`

**Detalles de implementación:**
```bash
# Verificar que el archivo existe
ls -lh backend/static/models/characters/Human.glb

# Verificar tamaño (debe ser ~77KB según lo visto)
```

**Verificación de vertex groups:**
1. Opción A: Importar en Blender y verificar vertex groups
2. Opción B: Cargar en Three.js y verificar que `model.userData` o grupos están disponibles
3. Opción C: Usar visor online: https://gltf-viewer.donmccurdy.com/

**Notas:**
- El modelo debe tener los vertex groups: head, torso, left_arm, right_arm, left_leg, right_leg
- Si los vertex groups no están, necesitarás re-exportar desde Blender con vertex groups preservados

---

### Paso 2: Actualizar Script de Seed para Usar Human.glb

**Descripción:**
Modificar `seed_character_with_model.py` para usar `Human.glb` en lugar de `humano_test.glb` por defecto.

**Archivos a modificar:**
- `backend/src/database/seed_character_with_model.py`

**Detalles de implementación:**
```python
# Cambiar model_path de:
model_path = "characters/humano_test.glb"

# A:
model_path = "characters/Human.glb"

# Ajustar escala si es necesario (empezar con 1.0 y ajustar según resultado)
modelo_3d = Model3D(
    tipo="glb",
    ruta=model_path,
    escala=1.0,  # Ajustar según necesidad
    offset={"x": 0, "y": 0, "z": 0},
    rotacion={"x": 0, "y": 0, "z": 0}
)
```

**Notas:**
- La escala puede necesitar ajuste después de probar en el juego
- Mantener compatibilidad: el script puede aceptar un parámetro para elegir el modelo

---

### Paso 3: Crear Personaje de Prueba con Human.glb

**Descripción:**
Ejecutar el script de seed para crear un personaje con el nuevo modelo y verificar que se crea correctamente.

**Archivos a modificar:**
- Ninguno (solo ejecutar script)

**Detalles de implementación:**
```bash
# Ejecutar script de seed
docker-compose exec backend bash -c "cd /app && python src/database/seed_character_with_model.py"
```

**Verificación:**
1. Verificar en logs que el personaje se creó correctamente
2. Verificar en BD que el campo `modelo_3d` tiene la ruta correcta
3. Verificar que el personaje tiene ID y está en la dimensión correcta

**Notas:**
- Si hay errores, verificar que el modelo existe en la ruta especificada
- Verificar que la dimensión existe (si no, ejecutar seed_demo primero)

---

### Paso 4: Verificar Carga del Modelo en Frontend

**Descripción:**
Verificar que el modelo se carga correctamente desde la API y se renderiza en Three.js.

**Archivos a verificar:**
- `frontend/src/ecs/factories/player-factory.js`
- `frontend/src/renderers/models/model-utils.js`

**Detalles de implementación:**
1. Iniciar el juego (Docker Compose)
2. Cargar el personaje creado en el paso anterior
3. Verificar en consola del navegador que no hay errores de carga
4. Verificar que el modelo aparece en la escena

**Verificación de vertex groups en Three.js:**
```javascript
// En player-factory.js o model-utils.js, después de cargar el modelo:
model.traverse((child) => {
    if (child.isMesh) {
        console.log('Mesh:', child.name);
        console.log('UserData:', child.userData);
        // Verificar si hay información de vertex groups
    }
});
```

**Notas:**
- Los vertex groups pueden estar en `child.userData` o en la geometría
- Si no aparecen, puede ser que Blender no los exportó correctamente
- El modelo debe renderizarse con la escala y posición correctas

---

### Paso 5: Ajustar Escala del Modelo

**Descripción:**
Ajustar la escala del modelo si es necesario para que tenga tamaño apropiado en el juego.

**Archivos a modificar:**
- `backend/src/database/seed_character_with_model.py` (escala)
- O actualizar directamente en BD si el personaje ya existe

**Detalles de implementación:**
```python
# Si el modelo es demasiado grande, reducir escala:
modelo_3d = Model3D(
    tipo="glb",
    ruta="characters/Human.glb",
    escala=0.5,  # Ajustar según necesidad
    # ...
)

# Si el modelo es demasiado pequeño, aumentar escala:
modelo_3d = Model3D(
    tipo="glb",
    ruta="characters/Human.glb",
    escala=2.0,  # Ajustar según necesidad
    # ...
)
```

**O actualizar en BD directamente:**
```sql
UPDATE juego_dioses.agrupaciones
SET modelo_3d = jsonb_set(modelo_3d, '{escala}', '1.0'::jsonb)
WHERE modelo_3d->>'ruta' = 'characters/Human.glb';
```

**Notas:**
- La escala debe hacer que el personaje tenga aproximadamente 1.5-2 metros de altura
- Probar diferentes valores hasta encontrar el adecuado
- Considerar el `cellSize` de la dimensión al calcular la escala

---

### Paso 6: Verificar Vertex Groups en Modelo Cargado

**Descripción:**
Verificar que los vertex groups están disponibles en el modelo cargado en Three.js para futura implementación del sistema de daño por partes.

**Archivos a crear/modificar:**
- `frontend/src/renderers/models/vertex-groups-utils.js` (nuevo, opcional)

**Detalles de implementación:**
```javascript
/**
 * Verificar vertex groups en un modelo cargado
 * @param {THREE.Group} model - Modelo Three.js cargado
 * @returns {Object} Mapa de vertex groups encontrados
 */
export function getVertexGroups(model) {
    const groups = {};
    
    model.traverse((child) => {
        if (child.isMesh && child.geometry) {
            // Los vertex groups pueden estar en:
            // 1. child.userData (si Blender los exportó así)
            // 2. child.geometry.groups (grupos de geometría)
            // 3. child.morphTargetInfluences (morph targets)
            
            if (child.userData && child.userData.vertexGroups) {
                Object.assign(groups, child.userData.vertexGroups);
            }
        }
    });
    
    return groups;
}
```

**Verificación:**
1. Cargar el modelo en el juego
2. Ejecutar función de verificación en consola
3. Verificar que se encuentran los grupos: head, torso, left_arm, right_arm, left_leg, right_leg

**Notas:**
- Los vertex groups pueden no estar directamente accesibles en Three.js si Blender no los exportó correctamente
- En ese caso, puede ser necesario acceder a ellos de otra forma o re-exportar desde Blender
- Esta verificación es para preparar JDG-014 (sistema de daño por partes)

---

### Paso 7: Actualizar Documentación

**Descripción:**
Actualizar documentación para reflejar que `Human.glb` es el modelo principal.

**Archivos a modificar:**
- `backend/src/database/seed_character_with_model.py` (comentarios)
- `INSTRUCCIONES-DESCARGAR-MODELO.md` (si aplica)
- `backend/src/api/routes/README.md` (si menciona modelos específicos)

**Detalles de implementación:**
```python
# En seed_character_with_model.py, actualizar comentarios:
"""
Script para crear personaje con modelo 3D

Modelo principal: Human.glb (voxel/low-poly con vertex groups)
Ubicación: backend/static/models/characters/Human.glb

Vertex groups disponibles:
- head
- torso
- left_arm
- right_arm
- left_leg
- right_leg
"""
```

**Notas:**
- **⚠️ READMEs:** Actualizar READMEs relevantes si se modifican módulos
- Documentar que este modelo prepara el terreno para JDG-014

---

### Paso Final: Generar Descripción del Pull Request

**Descripción:**
Una vez completados todos los pasos anteriores y verificada la implementación, genera la descripción completa del Pull Request usando la regla `@pr-description.mdc`.

**Comando a ejecutar:**
```
@pr-description.mdc
```

**Resultado esperado:**
- Archivo generado: `JDG-013_pr-description_[FECHA-HORA].md` en `/instructions/prs/` (con fecha y hora obtenida de `Get-Date -Format "yyyy-MM-dd_HH-mm-ss"`)
- El archivo contendrá una descripción completa del PR lista para copiar y pegar en Git
- Incluirá: título, resumen, motivación, cambios técnicos, testing, referencias y riesgos

**Notas:**
- Este paso se ejecuta DESPUÉS de completar toda la implementación
- La descripción se genera automáticamente basándose en los cambios realizados
- El desarrollador solo necesita copiar y pegar el contenido en Git
- No editar manualmente a menos que sea estrictamente necesario

---

## Consideraciones Técnicas

### Performance
- El modelo tiene 905 caras (optimizado), no debería afectar rendimiento
- El cache de modelos en frontend evita recargas innecesarias

### Seguridad
- Validar que la ruta del modelo no contenga `..` (ya implementado en JDG-012)
- El modelo está en ubicación segura dentro de `static/models/`

### Casos Edge
- Modelo no encontrado → fallback a primitivas (ya implementado)
- Escala incorrecta → ajustar en modelo_3d o re-crear personaje
- Vertex groups no disponibles → verificar exportación desde Blender

### Compatibilidad
- Mantener compatibilidad con modelos existentes (duck.glb, humano_test.glb)
- El sistema debe funcionar con cualquier modelo GLB
- No romper personajes existentes que usan otros modelos

## Patrones de Código a Usar

- **Backend (FastAPI)**: 
  - Usar Model3D schema existente
  - Mantener compatibilidad con scripts existentes
  - Documentación con docstrings

- **Frontend (Three.js)**: 
  - Usar sistema de carga de modelos existente (model-utils.js)
  - Verificar vertex groups sin modificar código de renderizado
  - Mantener fallback a primitivas

## Dependencias

### Nuevas Dependencias
Ninguna (usa dependencias existentes de JDG-012)

### Variables de Entorno
Ninguna nueva (usa configuración existente)

## Archivos Principales Involucrados

1. `backend/src/database/seed_character_with_model.py` - Script para crear personajes con modelo
2. `backend/static/models/characters/Human.glb` - Modelo nuevo
3. `frontend/src/ecs/factories/player-factory.js` - Factory que carga modelos
4. `frontend/src/renderers/models/model-utils.js` - Utilidades de carga

## Testing

### Tests a Crear/Modificar
- Script de seed actualizado para usar Human.glb
- Verificación manual de renderizado en navegador
- Verificación de vertex groups en modelo cargado

### Escenarios de Prueba
1. Crear personaje con Human.glb usando script de seed
2. Verificar que el modelo se carga en frontend
3. Verificar que el modelo se renderiza correctamente
4. Verificar que la escala es apropiada
5. Verificar que los vertex groups están disponibles (preparación para JDG-014)

## Deployment

### Orden de Deployment
1. Backend: No requiere rebuild (solo archivo estático)
2. Frontend: No requiere cambios (usa sistema existente)
3. Base de datos: No requiere migraciones
4. Verificar que el modelo está accesible en `/static/models/characters/Human.glb`

### Verificación Post-Deployment
- [ ] Verificar que el modelo está accesible en `/static/models/characters/Human.glb`
- [ ] Crear personaje con script de seed
- [ ] Verificar que el modelo se carga en frontend
- [ ] Verificar que el modelo se renderiza correctamente
- [ ] Verificar que la escala es apropiada
- [ ] Verificar logs de Docker para errores

---

**Nota Final:** Este plan debe ejecutarse paso a paso, verificando cada paso antes de continuar con el siguiente. Si encuentras problemas o necesitas clarificación, consulta con el equipo antes de proceder.

**⚠️ IMPORTANTE:** El último paso del plan SIEMPRE debe ser "Generar Descripción del Pull Request" usando `@pr-description.mdc`. Esto genera automáticamente la descripción completa del PR lista para Git.

