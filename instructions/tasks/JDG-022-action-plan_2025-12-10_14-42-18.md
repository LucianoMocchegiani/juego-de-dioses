# JDG-022 - Reestructuración de Animaciones: Crouch Walk y Estados Contextuales

## Descripción de la Tarea

Reestructurar el sistema de animaciones para manejar correctamente estados contextuales: caminar agachado, agacharse en lugar, y mejorar la lógica de estados de movimiento. Eliminar código obsoleto.

**Comportamiento actual:**
- Estado `crouch` se activa con Ctrl pero usa animación de caminar agachado incluso sin movimiento
- No hay diferenciación entre caminar agachado y agacharse en lugar
- Código obsoleto de balanceo manual en render-system.js
- Estados `walk` y `run` no excluyen el estado de agachado

**Comportamiento esperado:**
- `crouch_walk`: Ctrl + movimiento → caminar agachado
- `crouch_idle`: Ctrl sin movimiento → agacharse en lugar
- `walk` y `run` NO se activan cuando `wantsToCrouch = true`
- Código obsoleto eliminado

## Criterios de Aceptación

1. ✅ Estado `crouch_walk` funciona: se activa solo con Ctrl + movimiento
2. ✅ Estado `crouch_idle` funciona: se activa solo con Ctrl sin movimiento
3. ✅ Estado `walk` NO se activa cuando `wantsToCrouch = true`
4. ✅ Estado `run` NO se activa cuando `wantsToCrouch = true`
5. ✅ Código obsoleto de balanceo eliminado de `render-system.js`
6. ✅ Prioridades de estados correctamente configuradas
7. ✅ No hay regresiones en animaciones existentes

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [x] Frontend (Three.js)

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js AnimationMixer
- ECS (Entity Component System)
- Sistema de estados de animación declarativo

## Pasos de Implementación

### Paso 1: Reestructurar Estados de Animación en animation-config.js

**Descripción:**
Agregar nuevos estados y modificar estados existentes para manejar correctamente crouch_walk y crouch_idle.

**Archivos a modificar:**
- `frontend/src/ecs/animation/config/animation-config.js`

**Detalles de implementación:**

```javascript
export const ANIMATION_STATES = [
    // ... estados existentes ...
    
    // Estados de agachado (prioridad 7 y 6)
    {
        id: 'crouch_walk',
        priority: 7,
        conditions: [
            { type: 'input', property: 'wantsToCrouch', operator: 'equals', value: true },
            { type: 'movement', operator: 'hasMovement' }
        ],
        animation: 'crouch_walk_forward',
        interruptOnInputRelease: true,
        transitions: ['crouch_idle', 'walk', 'run', 'idle']
    },
    {
        id: 'crouch_idle',
        priority: 6,
        conditions: [
            { type: 'input', property: 'wantsToCrouch', operator: 'equals', value: true },
            { type: 'movement', operator: 'noMovement' }
        ],
        animation: 'crouch_walk_forward', // Temporal: usar misma animación con velocidad 0
        transitions: ['crouch_walk', 'idle']
    },
    
    // Estado de correr (modificar para excluir agachado)
    {
        id: 'run',
        priority: 5,
        conditions: [
            { type: 'input', property: 'isRunning', operator: 'equals', value: true },
            { type: 'movement', operator: 'hasMovement' },
            { type: 'input', property: 'wantsToCrouch', operator: 'equals', value: false } // Excluir agachado
        ],
        animation: 'run',
        interruptOnInputRelease: true,
        transitions: ['idle', 'walk', 'crouch_walk']
    },
    
    // Estado de caminar (modificar para excluir agachado)
    {
        id: 'walk',
        priority: 4,
        conditions: [
            { type: 'movement', operator: 'hasMovement' },
            { type: 'input', property: 'wantsToCrouch', operator: 'equals', value: false } // Excluir agachado
        ],
        animation: 'walk',
        interruptOnInputRelease: true,
        transitions: ['idle', 'run', 'crouch_walk']
    },
    
    // ... resto de estados ...
];
```

---

### Paso 2: Eliminar Código Obsoleto de Balanceo en render-system.js

**Descripción:**
Eliminar la lógica manual de balanceo que ya no es necesaria.

**Archivos a modificar:**
- `frontend/src/ecs/systems/render-system.js`

**Detalles de implementación:**
Eliminar el bloque de código que modifica `render.mesh.rotation.z` basado en `walk` o `run`.

---

### Paso 3: Testing Manual

**Descripción:**
Probar todas las combinaciones de estados y transiciones.

**Escenarios a probar:**
1. Presionar Ctrl + W → debe activar `crouch_walk`
2. Presionar Ctrl sin movimiento → debe activar `crouch_idle`
3. Presionar W sin Ctrl ni Shift → debe activar `walk`
4. Presionar Shift + W → debe activar `run`
5. Presionar Ctrl + Shift + W → debe activar `crouch_walk` (Ctrl tiene prioridad)
6. Cambiar entre estados debe ser suave

---

### Paso 4: Implementar Ataque Especial (Shift + Click)

**Descripción:**
Implementar la lógica para activar el ataque especial cuando se presiona Shift + Click Izquierdo.

**Archivos a modificar:**
- `frontend/src/ecs/components/input.js`
- `frontend/src/ecs/systems/input-system.js`
- `frontend/src/ecs/animation/config/animation-config.js`

**Detalles de implementación:**

1.  **input.js**: Agregar `this.wantsToSpecialAttack = false;` y resetearlo en `clearFrame()`.
2.  **input-system.js**:
    ```javascript
    // Golpear
    if (this.inputManager.isMouseButtonDown(0)) { // Click izquierdo
        if (input.isRunning) {
            input.wantsToSpecialAttack = true;
        } else {
            input.wantsToAttack = true;
        }
    }
    ```
3.  **animation-config.js**: Actualizar condición de `special_attack`:
    ```javascript
    {
        id: 'special_attack',
        priority: 11,
        conditions: [
            { type: 'input', property: 'wantsToSpecialAttack', operator: 'equals', value: true }
        ],
        // ...
    }
    ```

---

### Paso 5: Refactorizar Lógica de Animación (Configuración Declarativa)

**Descripción:**
Mover la lógica hardcodeada de "one-shot" e interrupciones desde `AnimationMixerSystem` a `animation-config.js`.

**Archivos a modificar:**
- `frontend/src/ecs/animation/config/animation-config.js`
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Detalles de implementación:**

1.  **animation-config.js**: Agregar `isOneShot: true` y `preventInterruption: true` a los estados de ataque.
2.  **animation-mixer-system.js**: Actualizar lógica para usar estas propiedades.

---

### Paso 6: Ajustes y Refinamiento

**Descripción:**
Ajustar prioridades, timings, y transiciones según resultados de testing.

**Archivos a modificar:**
- `frontend/src/ecs/animation/config/animation-config.js`

---

### Paso 7: Actualizar Documentación

**Descripción:**
Actualizar READMEs para documentar los nuevos estados.

**Archivos a modificar:**
- `frontend/src/ecs/animation/README.md`

---

### Paso Final: Generar Descripción del Pull Request

**Comando a ejecutar:**
`@pr-description.mdc`
