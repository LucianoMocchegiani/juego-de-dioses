# JDG-023 - Refactorización Data-Driven de Sistemas Core

## Descripción de la Tarea

Refactorizar los sistemas core de animación e input (`AnimationStateSystem`, `InputSystem`, `AnimationMixerSystem`) para eliminar lógica hardcodeada y dependencias de IDs específicos. El objetivo es que el comportamiento se defina completamente a través de archivos de configuración, facilitando la escalabilidad y mantenibilidad.

**Comportamiento actual:**
- `InputSystem` tiene mapeos de teclas hardcodeados (`KeyW`, `ControlLeft`).
- `AnimationStateSystem` verifica IDs específicos (`special_attack`, `combo_attack`) en el código.
- `AnimationMixerSystem` contiene lógica residual específica de ciertos estados.

**Comportamiento esperado:**
- `InputSystem` lee mapeos desde `input-map-config.js`.
- `AnimationStateSystem` opera sobre tipos y categorías definidos en `animation-config.js`.
- `AnimationMixerSystem` es completamente agnóstico a los estados específicos.

## Criterios de Aceptación

1. ✅ `InputSystem` utiliza `input-map-config.js` para determinar acciones.
2. ✅ `AnimationStateSystem` no contiene referencias a IDs de estados específicos.
3. ✅ `AnimationMixerSystem` no contiene lógica específica de estados.
4. ✅ El juego mantiene toda la funcionalidad existente (movimiento, combate, combos) sin regresiones.

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura

### Tecnologías Involucradas
- Frontend: JavaScript ES6+, Three.js, ECS Architecture

## Pasos de Implementación

### Paso 0: Centralizar Configuraciones en `src/config`

**Descripción:**
Mover todas las configuraciones dispersas (`ecs/animation/config`, `ecs/config`) a un directorio centralizado `frontend/src/config`. Esto simplifica las importaciones y mejora la organización.

**Archivos a modificar/crear:**
- `frontend/src/config/` (Nuevo directorio)
- Mover `frontend/src/ecs/config/input-map-config.js` -> `frontend/src/config/input-map-config.js`
- Mover `frontend/src/ecs/animation/config/*.js` -> `frontend/src/config/*.js`
- Actualizar importaciones en todos los sistemas afectados.

---

### Paso 1: Crear Configuración de Input Map
*(Ya realizado, pero ahora se moverá a la nueva ubicación)*


**Descripción:**
Crear un nuevo archivo de configuración que defina el mapeo entre acciones abstractas (ej: `moveForward`, `specialAttack`) y teclas físicas o combinaciones.

**Archivos a modificar/crear:**
- `frontend/src/ecs/config/input-map-config.js` (Nuevo)
- `frontend/src/ecs/config/README.md` (Nuevo/Actualizar)

**Detalles de implementación:**
```javascript
export const INPUT_MAP = {
    moveForward: ['KeyW', 'ArrowUp'],
    moveBackward: ['KeyS', 'ArrowDown'],
    moveLeft: ['KeyA', 'ArrowLeft'],
    moveRight: ['KeyD', 'ArrowRight'],
    run: ['ShiftLeft', 'ShiftRight'],
    jump: ['Space'],
    crouch: ['ControlLeft', 'ControlRight', 'KeyC'],
    attack: ['ClickLeft'], // Click izquierdo
    specialAttack: ['KeyR', 'Control+ClickLeft'], // Combinación
    grab: ['KeyE', 'ClickRight']
};
```

---

### Paso 2: Refactorizar InputSystem

**Descripción:**
Modificar `InputSystem` para que use `INPUT_MAP` en lugar de verificar teclas hardcodeadas. Implementar lógica para parsear combinaciones simples (ej: `Control+ClickLeft`).

**Archivos a modificar/crear:**
- `frontend/src/ecs/systems/input-system.js`

**Detalles de implementación:**
- Importar `INPUT_MAP`.
- Crear método helper `checkAction(actionName)` que verifique si alguna de las teclas/combinaciones mapeadas está activa.
- Reemplazar `input.isKeyPressed('KeyW')` por `this.checkAction('moveForward')`.

---

### Paso 3: Generalizar Configuración de Animación

**Descripción:**
Agregar propiedades de tipo y categoría a `ANIMATION_STATES` para que `AnimationStateSystem` pueda categorizar estados sin conocer sus IDs.

**Archivos a modificar/crear:**
- `frontend/src/ecs/animation/config/animation-config.js`

**Detalles de implementación:**
Agregar propiedades como:
```javascript
{
    id: 'special_attack',
    type: 'combat', // Categoría general
    combatType: 'special', // Subtipo para lógica de combate
    // ...
}
```

---

### Paso 4: Refactorizar AnimationStateSystem

**Descripción:**
Eliminar los `if (activeState.id === '...')` y reemplazarlos por lógica basada en las nuevas propiedades `type` y `combatType`.

**Archivos a modificar/crear:**
- `frontend/src/ecs/systems/animation-state-system.js`

**Detalles de implementación:**
- Iterar sobre estados activos.
- Si `state.type === 'combat'`, delegar a lógica de combate genérica.
- Si `state.type === 'combo'`, delegar a lógica de combo.

---

### Paso 5: Limpieza Final de AnimationMixerSystem

**Descripción:**
Revisar `AnimationMixerSystem` y eliminar cualquier referencia a IDs específicos (como los warnings de `regular_jump` o lógica de interrupción hardcodeada si queda alguna).

**Archivos a modificar/crear:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

---

### Paso Final: Generar Descripción del Pull Request

**Descripción:**
Generar la descripción del PR una vez completada la refactorización.

**Comando a ejecutar:**
```
@pr-description.mdc
```

**Resultado esperado:**
- Archivo generado: `JDG-023_pr-description_[FECHA-HORA].md`

---

## Consideraciones Técnicas

### Performance
- El chequeo de input debe ser eficiente. Pre-procesar el `INPUT_MAP` si es necesario para evitar parsing de strings en cada frame.

### Compatibilidad
- Asegurar que las combinaciones de teclas (Ctrl+Click) sigan funcionando exactamente igual que antes.

### Testing
- Probar todos los movimientos y ataques.
- Verificar que cambiar una tecla en `input-map-config.js` efectivamente cambia el control en el juego.
