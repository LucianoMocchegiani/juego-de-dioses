# JDG-026 - Correcci√≥n de Detecci√≥n de Inputs y Sistema de Dodge B√°sico

## Descripci√≥n de la Tarea

Corregir problemas cr√≠ticos en el sistema de inputs del frontend que imped√≠an que las teclas Q, E, F, R se detectaran correctamente. Implementar un sistema b√°sico de dodge que se active con un solo press y aplique movimiento al personaje.

**Comportamiento actual:**
- Las teclas Q, E, F, R no se detectaban (no aparec√≠an en logs ni activaban acciones)
- El sistema de dodge no funcionaba correctamente (no se activaba la animaci√≥n, requer√≠a mantener presionada la tecla)
- El click simple activaba incorrectamente el special attack
- No hab√≠a movimiento durante el dodge

**Comportamiento esperado:**
- Todas las teclas de juego (Q, E, F, R) se detectan correctamente
- El dodge se activa con un solo press de E
- El dodge mueve al personaje en la direcci√≥n de movimiento (o hacia adelante si no hay movimiento)
- La animaci√≥n de dodge se reproduce correctamente
- Las acciones de combate (parry, dodge, special attack) funcionan correctamente

## Criterios de Aceptaci√≥n

1. ‚úÖ Las teclas Q, E, F, R se detectan correctamente cuando se presionan
2. ‚úÖ El log `Tecla presionada: [c√≥digo]` aparece en consola para todas las teclas
3. ‚úÖ El dodge se activa con un solo press de E (no requiere mantener presionado)
4. ‚úÖ El dodge mueve al personaje en la direcci√≥n de movimiento actual
5. ‚úÖ Si no hay movimiento, el dodge mueve al personaje hacia adelante
6. ‚úÖ La animaci√≥n de dodge (`roll_dodge`) se reproduce cuando se presiona E
7. ‚úÖ El special attack (R) solo se activa cuando se presiona R, no con click simple
8. ‚úÖ Las acciones de combate (parry Q, dodge E, special attack R, grab F) funcionan correctamente

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura

### Tecnolog√≠as Involucradas
- Frontend: HTML5, JavaScript ES6+, Three.js
- ECS (Entity Component System): InputSystem, CombatSystem, PhysicsSystem, AnimationMixerSystem
- Sistema de input (InputManager, InputComponent)

## Pasos de Implementaci√≥n

### Paso 1: Corregir Detecci√≥n de Teclas en InputManager

**Descripci√≥n:**
Agregar las teclas Q, E, F, R a la lista de teclas de juego con `preventDefault()` y `stopPropagation()` para que se detecten correctamente. Agregar log de debug para facilitar troubleshooting.

**Archivos a modificar:**
- `frontend/src/systems/input-manager.js`

**Detalles de implementaci√≥n:**
```javascript
handleKeyDown(event) {
    console.log('Tecla presionada:', event.code);
    
    // Prevenir comportamiento por defecto para teclas de juego
    const gameKeys = ['KeyW', 'KeyA', 'KeyS', 'KeyD', 'Space', 'ShiftLeft', 'ShiftRight', 
                     'ControlLeft', 'ControlRight', 'KeyC', 'AltLeft', 'AltRight', 
                     'KeyR', 'KeyQ', 'KeyE', 'KeyF', 'KeyP'];
    if (gameKeys.includes(event.code)) {
        event.preventDefault();
        event.stopPropagation();
    }

    // ... resto del c√≥digo ...
}
```

**Notas:**
- Agregar `KeyQ`, `KeyE`, `KeyF`, `KeyP` a la lista `gameKeys`
- Agregar `stopPropagation()` para evitar que otros listeners capturen el evento
- El log de debug se puede remover en el futuro si no es necesario

---

### Paso 2: Cambiar Detecci√≥n de Dodge a isKeyDown

**Descripci√≥n:**
Cambiar la detecci√≥n de dodge para usar `isKeyDown()` en lugar de `checkAction()` (que usa `isKeyPressed`). Esto permite que el dodge se active con un solo press en lugar de requerir mantener presionada la tecla.

**Archivos a modificar:**
- `frontend/src/ecs/systems/input-system.js`

**Detalles de implementaci√≥n:**
```javascript
// 1. Defensas
// Parry: mantener presionado
if (this.checkAction('parry')) {
    input.wantsToParry = true;
}
// Dodge: solo un press (isKeyDown), no mantener presionado
const dodgeKeys = INPUT_MAP['dodge'];
let dodgeJustPressed = false;
for (const key of dodgeKeys) {
    if (this.inputManager.isKeyDown(key)) {
        dodgeJustPressed = true;
        break;
    }
}
if (dodgeJustPressed) {
    input.wantsToDodge = true;
}
```

**Notas:**
- Usar `isKeyDown()` verifica si la tecla fue presionada en este frame (no mantenida)
- Esto permite activaci√≥n con un solo press
- Mantener `checkAction()` para parry si requiere mantenerse presionado

---

### Paso 3: Remover Requisito de Movimiento para Dodge

**Descripci√≥n:**
Remover el requisito de movimiento para activar dodge. Ahora el dodge funciona simplemente presionando E, incluso sin movimiento previo.

**Archivos a modificar:**
- `frontend/src/ecs/systems/combat-system.js`

**Detalles de implementaci√≥n:**
```javascript
// 2. Dodge (Defensa) - Puede usarse con o sin movimiento
if (input.wantsToDodge) {
    combat.combatAnimation = 'roll_dodge';
    combat.defenseType = 'dodge';
    combat.isAttacking = false;
    combat.canCancel = true;
    return; // Prioridad alta
}
```

**Notas:**
- Remover la verificaci√≥n `hasMovement` que estaba antes
- El dodge ahora se activa simplemente con `input.wantsToDodge`

---

### Paso 4: Implementar Movimiento de Dodge

**Descripci√≥n:**
Agregar l√≥gica en `PhysicsSystem` para aplicar impulso de movimiento cuando se hace dodge. Si hay direcci√≥n de movimiento, esquivar en esa direcci√≥n. Si no hay movimiento, esquivar hacia adelante basado en la rotaci√≥n de la c√°mara.

**Archivos a modificar:**
- `frontend/src/ecs/systems/physics-system.js`

**Detalles de implementaci√≥n:**
```javascript
// Aplicar dodge (esquivar) - Impulso de movimiento horizontal
if (input && input.wantsToDodge && physics.isGrounded) {
    // Velocidad de dodge en celdas/segundo
    const dodgeSpeed = 20; // M√°s r√°pido que correr normal
    
    // Si hay direcci√≥n de movimiento, usar esa direcci√≥n
    // Si no, usar direcci√≥n hacia adelante (basada en moveDirection que ya est√° calculada)
    if (input.moveDirection.x !== 0 || input.moveDirection.y !== 0) {
        // Usar la direcci√≥n de movimiento actual
        physics.velocity.x = input.moveDirection.x * dodgeSpeed;
        physics.velocity.y = input.moveDirection.y * dodgeSpeed;
    } else {
        // Si no hay movimiento, esquivar hacia adelante (direcci√≥n negativa Y en espacio local)
        // Necesitamos obtener la rotaci√≥n de la c√°mara para calcular direcci√≥n adelante
        const render = this.ecs.getComponent(entityId, 'Render');
        const cameraRotation = render && render.rotationY !== undefined ? render.rotationY : 0;
        const cos = Math.cos(cameraRotation);
        const sin = Math.sin(cameraRotation);
        // Adelante es negativo Y en espacio local, rotado por la c√°mara
        physics.velocity.x = -sin * dodgeSpeed;
        physics.velocity.y = -cos * dodgeSpeed;
    }
    
    input.wantsToDodge = false; // Resetear para que solo se active una vez
}
```

**Notas:**
- Velocidad de dodge: 20 celdas/segundo (hardcodeada temporalmente, se mover√° a configuraci√≥n en JDG-027)
- Usar `input.moveDirection` si est√° disponible (ya calculada con rotaci√≥n de c√°mara)
- Si no hay movimiento, calcular direcci√≥n adelante basada en rotaci√≥n de c√°mara
- Resetear `wantsToDodge` despu√©s de aplicar para evitar aplicaci√≥n m√∫ltiple

---

### Paso 5: Renombrar StateConfig a AnimationState

**Descripci√≥n:**
Renombrar el archivo `state-config.js` a `animation-state.js` y la clase `StateConfig` a `AnimationState` para evitar confusi√≥n con archivos de configuraci√≥n est√°tica.

**Archivos a modificar:**
- `frontend/src/ecs/animation/states/state-config.js` ‚Üí `animation-state.js` (renombrar)
- `frontend/src/ecs/animation/states/state-registry.js` (actualizar imports)
- `frontend/src/ecs/animation/states/index.js` (actualizar exports)
- `frontend/src/ecs/systems/animation-mixer-system.js` (actualizar imports)
- `frontend/src/ecs/animation/README.md` (actualizar documentaci√≥n)

**Detalles de implementaci√≥n:**
1. Renombrar archivo: `state-config.js` ‚Üí `animation-state.js`
2. Renombrar clase: `StateConfig` ‚Üí `AnimationState`
3. Actualizar todos los imports que usan `StateConfig`
4. Actualizar documentaci√≥n en README

**Notas:**
- Esto mejora la claridad: archivos en `config/` son configuraciones est√°ticas, `animation-state.js` es una clase
- Mantener compatibilidad actualizando todas las referencias

---

### Paso 6: Agregar Log de Animaci√≥n Reproducida

**Descripci√≥n:**
Agregar log de debug en `AnimationMixerSystem` para mostrar qu√© animaci√≥n se est√° reproduciendo cuando cambia el estado.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Detalles de implementaci√≥n:**
```javascript
action.fadeIn(ANIMATION_MIXER.defaultTransitionDuration);
action.play();

// Log de animaci√≥n reproducida
if (stateChanged) {
    console.log(`üé¨ Animaci√≥n: ${state}`);
}

// Guardar referencia a la acci√≥n y estado actual
mesh.userData.currentAction = action;
mesh.userData.currentAnimationState = state;
```

**Notas:**
- El log solo aparece cuando cambia el estado (no cada frame)
- √ötil para debugging y verificaci√≥n
- Se puede remover en el futuro si no es necesario

---

### Paso 7: Testing y Verificaci√≥n

**Descripci√≥n:**
Probar todos los cambios realizados para verificar que funcionan correctamente. Verificar que las teclas se detectan, que el dodge funciona con y sin movimiento, y que las animaciones se reproducen correctamente.

**Escenarios de prueba:**
1. Presionar Q, E, F, R y verificar que aparecen en consola
2. Presionar WASD + E y verificar que esquiva en direcci√≥n de movimiento
3. Presionar solo E y verificar que esquiva hacia adelante
4. Verificar que la animaci√≥n `roll_dodge` se reproduce
5. Presionar R y verificar que solo se activa con R, no con click simple

**Notas:**
- Probar todas las acciones de combate
- Verificar que no hay regresiones en otras funcionalidades

---

### Paso Final: Generar Descripci√≥n del Pull Request

**Descripci√≥n:**
Generar la descripci√≥n completa del Pull Request usando la regla `@pr-description.mdc`.

**Comando a ejecutar:**
```
@pr-description.mdc
```

**Resultado esperado:**
- Archivo generado: `JDG-026_pr-description_2025-12-13_10-43-28.md` en `/instructions/prs/`
- El archivo contiene una descripci√≥n completa del PR lista para copiar y pegar en Git

**Notas:**
- Este paso se ejecut√≥ despu√©s de completar toda la implementaci√≥n
- La descripci√≥n se gener√≥ autom√°ticamente bas√°ndose en los cambios realizados

---

## Consideraciones T√©cnicas

### Performance
- Los cambios no afectan el rendimiento significativamente
- El log de debug puede generar ruido en consola pero no afecta gameplay

### Compatibilidad
- Compatible con el sistema ECS existente
- No rompe funcionalidad existente
- Mantiene compatibilidad con sistema de combate actual

### Extensibilidad
- La estructura permite agregar m√°s acciones de combate f√°cilmente
- Preparado para refactor futuro (JDG-027) con configuraci√≥n centralizada

## Dependencias

### Dependencias Existentes
- Depende de: JDG-021 (Sistema de Combate y Animaciones)

### Nuevas Dependencias
- Ninguna

## Archivos Principales Involucrados

1. `frontend/src/systems/input-manager.js` - Correcci√≥n de detecci√≥n de teclas
2. `frontend/src/ecs/systems/input-system.js` - Cambio de detecci√≥n de dodge
3. `frontend/src/ecs/systems/combat-system.js` - Remoci√≥n de requisito de movimiento
4. `frontend/src/ecs/systems/physics-system.js` - Implementaci√≥n de movimiento de dodge
5. `frontend/src/ecs/animation/states/` - Renombrado de archivos y clases
6. `frontend/src/ecs/systems/animation-mixer-system.js` - Log de animaci√≥n

## Testing

### Escenarios de Prueba Ejecutados
1. ‚úÖ Presionar Q, E, F, R y verificar que aparecen en consola
2. ‚úÖ Presionar WASD + E y verificar que esquiva en direcci√≥n de movimiento
3. ‚úÖ Presionar solo E y verificar que esquiva hacia adelante
4. ‚úÖ Verificar que la animaci√≥n `roll_dodge` se reproduce
5. ‚úÖ Presionar R y verificar que solo se activa con R, no con click simple

### Casos Edge Considerados
- Presionar E m√∫ltiples veces r√°pidamente (actualmente no hay cooldown - ser√° mejorado en JDG-027)
- Presionar E mientras se est√° atacando (actualmente se puede interrumpir - ser√° mejorado en JDG-027)
- Presionar E sin estar en el suelo (actualmente funciona en el aire tambi√©n)

## Deployment

### Cambios Requeridos
- [x] Rebuild Docker images (frontend)
- [x] Reiniciar servicios Docker

### Verificaci√≥n Post-Deployment
- [x] Verificar frontend en navegador
- [x] Verificar que todas las teclas de juego funcionan correctamente
- [x] Verificar que dodge funciona correctamente
- [x] Verificar logs de Docker

---

**Nota Final:** Este plan de acci√≥n fue generado retroactivamente para documentar los cambios ya implementados en JDG-026. Todos los pasos fueron completados exitosamente.

**Estado:** ‚úÖ COMPLETADO

