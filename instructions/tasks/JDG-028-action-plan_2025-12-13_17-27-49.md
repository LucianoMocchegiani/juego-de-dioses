# JDG-028 - Simplificación del Sistema de Animaciones y Combate

## Descripción de la Tarea

Simplificar y mejorar el sistema de animaciones y combate eliminando duplicación de estado, centralizando la resolución de nombres de animación y clarificando las responsabilidades de cada sistema.

**Comportamiento actual:**
- `comboAnimationName` y `combatAnimationName` se copian desde otros componentes a `AnimationComponent`
- `AnimationMixerSystem` tiene tres rutas condicionales para resolver nombres de animación
- Estado disperso en múltiples componentes
- Lógica de limpieza distribuida

**Comportamiento esperado:**
- `AnimationComponent` solo almacena `currentState` (sin nombres duplicados)
- `AnimationMixerSystem` resuelve nombres directamente desde componentes fuente usando función centralizada
- Single Source of Truth para nombres de animación
- Limpieza de estado centralizada en métodos de componentes

## Criterios de Aceptación

1. ✅ `AnimationComponent` ya no tiene `comboAnimationName` ni `combatAnimationName`
2. ✅ `AnimationStateSystem` solo determina estados, no copia nombres
3. ✅ `AnimationMixerSystem` resuelve nombres usando función `resolveAnimationName()`
4. ✅ `CombatComponent` tiene método `clearCombatState()` para limpieza centralizada
5. ✅ Eliminado `stateToAnimationMap` duplicado
6. ✅ Funcionalidad existente no se rompe (todas las animaciones funcionan)

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [x] Frontend (Three.js)

### Tecnologías Involucradas
- Frontend: JavaScript ES6+, Three.js
- ECS (Entity Component System)

## Pasos de Implementación

### Paso 1: Agregar método `clearCombatState()` a `CombatComponent`

**Descripción:**
Crear método centralizado para limpiar todo el estado de combate en un solo lugar.

**Archivos a modificar:**
- `frontend/src/ecs/components/combat.js`

**Detalles de implementación:**
```javascript
/**
 * Limpiar completamente el estado de combate
 * Útil para limpieza centralizada cuando termina una animación
 */
clearCombatState() {
    this.activeAction = null;
    this.actionStartTime = null;
    this.defenseType = null;
    this.attackType = null;
    this.combatAnimation = null;
    this.isAttacking = false;
    this.hasIFrames = false;
}
```

**Notas:**
- Este método será usado por `AnimationMixerSystem` cuando terminen las animaciones
- Reemplazará la lógica de limpieza distribuida actual

---

### Paso 2: Agregar método `resolveAnimationName()` a `AnimationMixerSystem`

**Descripción:**
Crear función centralizada que resuelva nombres de animación desde componentes fuente según prioridad.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Detalles de implementación:**
```javascript
/**
 * Resolver nombre de animación desde componentes fuente según prioridad
 * Prioridad: Combo > Combate > Normal (config)
 * 
 * @param {number} entityId - ID de la entidad
 * @param {string} stateId - ID del estado actual
 * @returns {string|null} Nombre de la animación o null si no se encuentra
 */
resolveAnimationName(entityId, stateId) {
    // Prioridad 1: Combo (si hay combo activo)
    const combo = this.ecs.getComponent(entityId, 'Combo');
    if (combo && combo.activeComboId && combo.comboAnimation) {
        return combo.comboAnimation;
    }
    
    // Prioridad 2: Combate (si hay acción activa)
    const combat = this.ecs.getComponent(entityId, 'Combat');
    if (combat && combat.activeAction && combat.combatAnimation) {
        return combat.combatAnimation;
    }
    
    // Prioridad 3: Resolver desde configuración (estado normal)
    return this.getAnimationNameForState(stateId);
}
```

**Notas:**
- Esta función será usada en el `update()` para reemplazar las tres rutas condicionales
- Mantiene la misma lógica de prioridad pero de forma centralizada

---

### Paso 3: Actualizar `AnimationMixerSystem.update()` para usar `resolveAnimationName()`

**Descripción:**
Reemplazar las tres rutas condicionales por una llamada a `resolveAnimationName()`.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Detalles de implementación:**
```javascript
// Reemplazar líneas 499-512 (aproximadamente)
// ANTES:
// if (animation.comboAnimationName) {
//     animationName = animation.comboAnimationName;
// } else if (animation.combatAnimationName) {
//     animationName = animation.combatAnimationName;
//     stateToUse = animation.currentState;
// } else {
//     animationName = this.getAnimationNameForState(animation.currentState);
//     stateToUse = animation.currentState;
// }

// DESPUÉS:
const animationName = this.resolveAnimationName(entityId, animation.currentState);
const stateToUse = animation.currentState; // Siempre usar currentState para configuración
```

**Notas:**
- Simplifica significativamente el código
- Mantiene la misma funcionalidad pero con menos complejidad

---

### Paso 4: Actualizar limpieza en `AnimationMixerSystem` para usar `clearCombatState()`

**Descripción:**
Simplificar la limpieza de estado cuando terminan las animaciones usando el nuevo método centralizado.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Detalles de implementación:**
```javascript
// En la sección donde se limpia el estado cuando termina la animación (líneas 450-473 aproximadamente)
// Reemplazar:
// combat.endAction();
// combat.attackType = null;
// combat.combatAnimation = null;
// combat.isAttacking = false;
// if (finishedActionId === 'parry') {
//     if (!input || !input.wantsToParry) {
//         combat.defenseType = null;
//     }
// } else if (finishedActionId === 'dodge') {
//     combat.defenseType = null;
// } else {
//     combat.defenseType = null;
// }

// Por:
combat.clearCombatState(); // Limpieza centralizada

// Manejo específico para parry (mantener si la tecla sigue presionada)
if (finishedActionId === 'parry' && input && input.wantsToParry) {
    // Mantener defenseType para reactivación
    combat.defenseType = 'parry';
}

// Cambiar estado a idle
if (anim) {
    anim.currentState = 'idle';
}
```

**Notas:**
- Simplifica la limpieza pero mantiene la lógica específica de parry
- El resto de la limpieza está centralizada

---

### Paso 5: Eliminar copia de nombres en `AnimationStateSystem`

**Descripción:**
`AnimationStateSystem` solo debe determinar el estado, no copiar nombres de animación.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-state-system.js`

**Detalles de implementación:**
```javascript
// Líneas 57-68 (Estados de Combo)
// ANTES:
if (combo && combo.comboAnimation) {
    animation.currentState = activeState.id;
    animation.comboAnimationName = combo.comboAnimation; // ❌ Eliminar
    animation.combatAnimationName = null; // ❌ Eliminar
}

// DESPUÉS:
if (combo && combo.comboAnimation) {
    animation.currentState = activeState.id;
}

// Líneas 75-86 (Estados de Combate)
// ANTES:
if (combat && combat.activeAction) {
    if (combat.combatAnimation) {
        animation.currentState = activeState.id;
        animation.combatAnimationName = combat.combatAnimation; // ❌ Eliminar
        animation.comboAnimationName = null; // ❌ Eliminar
    }
}

// DESPUÉS:
if (combat && combat.activeAction) {
    animation.currentState = activeState.id;
}

// Líneas 87-93 (Cuando no hay acción activa)
// ANTES:
animation.combatAnimationName = null; // ❌ Eliminar
animation.comboAnimationName = null; // ❌ Eliminar

// DESPUÉS:
// No hacer nada (solo no activar estado de combate)

// Líneas 96-100 (Estados Normales)
// ANTES:
animation.currentState = activeState.id;
animation.comboAnimationName = null; // ❌ Eliminar
animation.combatAnimationName = null; // ❌ Eliminar

// DESPUÉS:
animation.currentState = activeState.id;
```

**Notas:**
- `AnimationStateSystem` ahora solo determina estados
- No copia nombres de animación (eso lo hace `AnimationMixerSystem` directamente)

---

### Paso 6: Eliminar propiedades `comboAnimationName` y `combatAnimationName` de `AnimationComponent`

**Descripción:**
Eliminar las propiedades duplicadas del componente ya que ahora se resuelven directamente desde componentes fuente.

**Archivos a modificar:**
- `frontend/src/ecs/components/animation.js`

**Detalles de implementación:**
```javascript
// Eliminar líneas 25-35 (aproximadamente):
/**
 * Nombre de animación específica para combos (se resuelve dinámicamente desde ComboComponent)
 * @type {string|null}
 */
this.comboAnimationName = null; // ❌ Eliminar

/**
 * Nombre de animación específica para combate (se resuelve dinámicamente desde CombatComponent)
 * @type {string|null}
 */
this.combatAnimationName = null; // ❌ Eliminar
```

**Notas:**
- Simplifica el componente
- Elimina duplicación de estado

---

### Paso 7: Eliminar `stateToAnimationMap` duplicado en `AnimationMixerSystem`

**Descripción:**
Ya no necesitamos `stateToAnimationMap` porque `getAnimationNameForState()` puede buscar directamente en `stateConfigMap`.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Detalles de implementación:**
```javascript
// En constructor (líneas 30-41 aproximadamente)
// ANTES:
this.stateToAnimationMap = new Map(); // ❌ Eliminar
this.stateConfigMap = new Map();

for (const stateConfigData of ANIMATION_STATES) {
    const animationState = new AnimationState(stateConfigData);
    this.stateToAnimationMap.set(animationState.id, animationState.animation); // ❌ Eliminar
    this.stateConfigMap.set(animationState.id, animationState);
}

// DESPUÉS:
this.stateConfigMap = new Map(
    ANIMATION_STATES.map(config => [
        config.id,
        new AnimationState(config)
    ])
);

// getAnimationNameForState() ya busca en stateConfigMap, no necesita cambios
```

**Notas:**
- Elimina duplicación de datos
- `getAnimationNameForState()` ya funciona correctamente buscando en `stateConfigMap`

---

### Paso 8: Actualizar limpieza de `anim.combatAnimationName` en `AnimationMixerSystem`

**Descripción:**
Ya no necesitamos limpiar `anim.combatAnimationName` porque la propiedad ya no existe.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Detalles de implementación:**
```javascript
// Buscar y eliminar todas las referencias a:
anim.combatAnimationName = null; // ❌ Eliminar todas las ocurrencias
anim.comboAnimationName = null; // ❌ Eliminar todas las ocurrencias
```

**Notas:**
- Limpiar todas las referencias obsoletas
- Verificar que no queden referencias en el código

---

### Paso 9: Verificar que no hay otras referencias a propiedades eliminadas

**Descripción:**
Buscar en todo el código cualquier referencia restante a `comboAnimationName` o `combatAnimationName`.

**Archivos a verificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`
- `frontend/src/ecs/systems/animation-state-system.js`
- `frontend/src/ecs/components/animation.js`
- Cualquier otro archivo que pueda referenciar estas propiedades

**Detalles de implementación:**
- Usar grep o búsqueda en el IDE para encontrar referencias
- Eliminar o actualizar cualquier referencia encontrada

**Notas:**
- Asegurar que no queden referencias obsoletas
- El código debe compilar sin errores

---

### Paso 10: Testing y Verificación

**Descripción:**
Verificar que todas las animaciones funcionan correctamente después de la simplificación.

**Tests a realizar:**
1. ✅ Animaciones normales (idle, walk, run, jump, crouch)
2. ✅ Animaciones de combate (attack, parry, dodge)
3. ✅ Animaciones de combo
4. ✅ Prioridad correcta (combo > combat > normal)
5. ✅ Limpieza de estado cuando terminan animaciones
6. ✅ Parry se reactiva si la tecla sigue presionada
7. ✅ Dodge solo se activa una vez por press

**Notas:**
- Probar cada tipo de animación manualmente
- Verificar que no hay regresiones
- Confirmar que la funcionalidad es idéntica a antes

---

### Paso Final: Generar Descripción del Pull Request

**Descripción:**
Una vez completados todos los pasos anteriores y verificada la implementación, genera la descripción completa del Pull Request usando la regla `@pr-description.mdc`.

**Comando a ejecutar:**
```
@pr-description.mdc
```

**Resultado esperado:**
- Archivo generado: `JDG-028_pr-description_[FECHA-HORA].md` en `/instructions/prs/`
- El archivo contendrá una descripción completa del PR lista para copiar y pegar en Git
- Incluirá: título, resumen, motivación, cambios técnicos, testing, referencias y riesgos

**Notas:**
- Este paso se ejecuta DESPUÉS de completar toda la implementación
- La descripción se genera automáticamente basándose en los cambios realizados
- El desarrollador solo necesita copiar y pegar el contenido en Git

---

## Consideraciones Técnicas

### Performance

**Impacto esperado:**
- ✅ **Mejor:** Menos escrituras a `AnimationComponent` (no copiar nombres cada frame)
- ✅ **Mejor:** Menos mapas en memoria (`stateToAnimationMap` eliminado)
- ⚠️ **Neutro:** Resolución de nombres ahora requiere acceso a múltiples componentes (O(1) lookup, impacto mínimo)
- ✅ **Mejor:** Menos código ejecutado en total

**Resultado neto:** Performance igual o mejor.

### Compatibilidad

**✅ No rompe funcionalidad existente:**
- La lógica de resolución es equivalente a la anterior
- Solo cambia dónde se almacena y cómo se accede al estado
- Mismo comportamiento final

**✅ Compatible con sistemas existentes:**
- `ComboSystem` no cambia (solo cambia cómo se lee `comboAnimation`)
- `CombatSystem` no cambia (solo cambia cómo se lee `combatAnimation`)
- `AnimationStateSystem` se simplifica pero mantiene misma funcionalidad

### Casos Edge

- ✅ Animaciones que no existen en clips (fallback sigue funcionando)
- ✅ Múltiples acciones en el mismo frame (prioridad sigue siendo combo > combat > normal)
- ✅ Parry con tecla mantenida (lógica específica se mantiene)
- ✅ Estados sin animación configurada (fallback a `combat_stance`)

### Testing

**Escenarios críticos:**
1. Animación de combo activa mientras hay input de combate (prioridad combo)
2. Animación de combate activa mientras hay movimiento (prioridad combat)
3. Animación normal cuando no hay combate ni combo
4. Limpieza de estado cuando termina animación de combate
5. Reactivación de parry si tecla sigue presionada
6. Dodge solo se activa una vez

## Archivos Principales Involucrados

1. `frontend/src/ecs/components/animation.js` - Eliminar propiedades duplicadas
2. `frontend/src/ecs/components/combat.js` - Agregar `clearCombatState()`
3. `frontend/src/ecs/systems/animation-state-system.js` - Eliminar copia de nombres
4. `frontend/src/ecs/systems/animation-mixer-system.js` - Agregar `resolveAnimationName()`, usar nueva lógica, eliminar `stateToAnimationMap`

---

**Nota Final:** Este plan debe ejecutarse paso a paso, verificando cada paso antes de continuar con el siguiente. Si encuentras problemas o necesitas clarificación, consulta con el equipo antes de proceder.

