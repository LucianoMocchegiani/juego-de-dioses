# JDG-029 - Centralización de Valores Hardcodeados en Sistema de Animaciones y Combate

## Descripción de la Tarea

Centralizar todos los valores hardcodeados (strings mágicos y números mágicos) dispersos en el código del sistema ECS, animaciones y combate en archivos de configuración dedicados. Esto incluye nombres de componentes ECS, estados de animación, tipos, valores numéricos del sistema, y constantes de gameplay.

**Comportamiento actual:**
- Strings mágicos hardcodeados en múltiples lugares ('idle', 'combat', 'combo', nombres de componentes, etc.)
- Números mágicos hardcodeados (velocidades, thresholds, offsets, etc.)
- Valores duplicados en diferentes archivos
- No hay validación de que valores existen antes de usar
- Difícil refactoring (hay que buscar y reemplazar en múltiples lugares)
- Riesgo de typos que causan bugs silenciosos

**Comportamiento esperado:**
- Todos los valores hardcodeados centralizados en archivos de configuración
- Constantes con nombres descriptivos y documentación JSDoc
- Single Source of Truth para cada valor
- Fácil refactoring cambiando valores en un solo lugar
- Prevención de typos con constantes
- Validación opcional de valores

## Criterios de Aceptación

1. ✅ Archivo `ecs-constants.js` creado con `COMPONENT_NAMES`
2. ✅ Archivo `animation-constants.js` creado con todas las constantes de animación y sistemas
3. ✅ Todos los nombres de componentes ECS reemplazados con constantes
4. ✅ Todos los strings críticos de animación ('idle', 'combat', 'combo') reemplazados con constantes
5. ✅ Todos los números hardcodeados reemplazados con constantes (velocidades, thresholds, offsets, etc.)
6. ✅ Strings de acciones en switch statements reemplazados con constantes
7. ✅ Funcionalidad existente no se rompe (todas las animaciones y sistemas funcionan correctamente)
8. ✅ No hay errores de lint en archivos modificados
9. ✅ READMEs actualizados para documentar nuevos archivos de constantes
10. ✅ Testing completo verifica que no hay regresiones

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [x] Frontend (Three.js)
- [ ] Backend (FastAPI)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura

### Tecnologías Involucradas
- Frontend: JavaScript ES6+, Three.js
- ECS (Entity Component System)
- Sistema de animaciones y combate

## Pasos de Implementación

### Paso 1: Crear archivo `ecs-constants.js`

**Descripción:**
Crear archivo de constantes centralizadas para el sistema ECS con nombres de componentes.

**Archivos a crear:**
- `frontend/src/config/ecs-constants.js`

**Detalles de implementación:**
```javascript
/**
 * Constantes centralizadas para sistema ECS
 * 
 * Centraliza nombres de componentes para evitar typos y facilitar refactoring.
 */
export const ECS_CONSTANTS = {
    // Nombres de componentes ECS
    COMPONENT_NAMES: {
        POSITION: 'Position',
        PHYSICS: 'Physics',
        RENDER: 'Render',
        INPUT: 'Input',
        ANIMATION: 'Animation',
        COMBO: 'Combo',
        COMBAT: 'Combat',
        WEAPON: 'Weapon',
    },
};
```

**Notas:**
- Incluir documentación JSDoc completa
- Organizar por categorías lógicas
- Mantener nombres consistentes con los componentes existentes

---

### Paso 2: Crear archivo `animation-constants.js`

**Descripción:**
Crear archivo de constantes centralizadas para sistema de animaciones con todas las constantes identificadas en el análisis.

**Archivos a crear:**
- `frontend/src/config/animation-constants.js`

**Detalles de implementación:**
```javascript
/**
 * Constantes centralizadas para sistema de animaciones
 * 
 * Centraliza valores mágicos y strings para evitar errores de tipeo
 * y facilitar cambios futuros.
 */
export const ANIMATION_CONSTANTS = {
    // Estados fundamentales (usados como fallback y valores por defecto)
    STATE_IDS: {
        IDLE: 'idle',
        COMBAT_STANCE: 'combat_stance',
    },
    
    // Tipos de estado (usados en type checking)
    STATE_TYPES: {
        COMBAT: 'combat',
        COMBO: 'combo',
        NORMAL: 'normal',
    },
    
    // Tipos de condición (usados en ConditionFactory)
    CONDITION_TYPES: {
        INPUT: 'input',
        PHYSICS: 'physics',
        MOVEMENT: 'movement',
        COMBO: 'combo',
        COMBAT: 'combat',
    },
    
    // Valores numéricos del sistema
    NUMERIC: {
        // Progreso de animación (100%)
        PROGRESS_COMPLETE: 1.0,
        
        // Valores por defecto
        DEFAULT_OFFSET_X: 0,
        DEFAULT_OFFSET_Y: 0,
        DEFAULT_OFFSET_Z: 0,
        DEFAULT_ROTATION_X: 0,
        DEFAULT_ROTATION_Y: 0,
        DEFAULT_ROTATION_Z: 0,
    },
    
    // Prioridades de sistemas (para documentación y validación)
    SYSTEM_PRIORITIES: {
        INPUT_SYSTEM: 0,
        PHYSICS_SYSTEM: 1,
        COMBAT_SYSTEM: 1.4,
        COMBO_SYSTEM: 1.5,
        ANIMATION_STATE_SYSTEM: 2,
        ANIMATION_MIXER_SYSTEM: 2.5,
        RENDER_SYSTEM: 3,
    },
    
    // Configuración de física del jugador
    PLAYER_PHYSICS: {
        MASS: 70,
        GROUND_FRICTION: 0.8,
        AIR_FRICTION: 0.95,
        MAX_VELOCITY: { x: 5, y: 10, z: 5 },
        JUMP_VELOCITY: 5, // Velocidad de salto en celdas/segundo
        ANIMATION_SPEED: 1.0,
    },
    
    // Valores por defecto de spawn
    DEFAULT_SPAWN: {
        X: 80,
        Y: 80,
        Z: 1,
        CELL_SIZE: 0.25,
    },
    
    // Configuración de mesh por defecto (fallback)
    DEFAULT_MESH: {
        BODY: {
            RADIUS: 0.3,
            HEIGHT: 1.0,
            SEGMENTS: 8,
            COLOR: 0x8B4513,
            POSITION_Y: 0.5,
        },
        HEAD: {
            RADIUS: 0.25,
            SEGMENTS: 8,
            COLOR: 0xFFDBB3,
            POSITION_Y: 1.25,
        },
        MATERIAL: {
            METALNESS: 0.1,
            ROUGHNESS: 0.8,
        },
    },
    
    // Valores del sistema de input
    INPUT: {
        // Velocidades de movimiento (celdas/segundo)
        WALK_SPEED: 15,
        RUN_SPEED: 30,
        
        // Thresholds
        DIRECTION_NORMALIZE_THRESHOLD: 0.01,
        
        // Valores de dirección
        DIRECTION: {
            FORWARD: -1,
            BACKWARD: 1,
            LEFT: -1,
            RIGHT: 1,
            NONE: 0,
        },
        
        // Mouse button indices
        MOUSE_BUTTONS: {
            LEFT: 0,
            RIGHT: 2,
            MIDDLE: 1,
        },
    },
    
    // Valores del sistema de física
    PHYSICS: {
        GRAVITY: -9.8, // celdas/segundo²
        FIXED_TIMESTEP: 1/60, // segundos (60 FPS)
    },
    
    // Valores del sistema de combos
    COMBO: {
        TIMING_MULTIPLIER: 1.5, // Multiplicador para timing window de expiración
    },
    
    // Valores del sistema de colisiones
    COLLISION: {
        // Threshold de invalidación de cache (en celdas)
        CACHE_INVALIDATION_THRESHOLD: 2,
        
        // Estado de partícula sólida
        PARTICLE_STATE_SOLID: 'solido',
        
        // Valores de respawn por defecto
        DEFAULT_RESPAWN: {
            X: 80,
            Y: 80,
            Z: 1,
        },
        
        // Valores de límites de dimensión por defecto
        DEFAULT_DIMENSION: {
            MIN_Z: -10,
            MAX_Z: 40,
        },
        
        // Valores de corrección de posición
        POSITION_CORRECTION: {
            MIN_Z: 1,
            VELOCITY_RESET: 0,
        },
    },
};
```

**Notas:**
- Incluir documentación JSDoc completa para cada sección
- Agrupar constantes relacionadas
- Mantener estructura jerárquica clara

---

### Paso 3: Actualizar todos los sistemas para usar `ECS_CONSTANTS.COMPONENT_NAMES`

**Descripción:**
Reemplazar todos los strings hardcodeados de nombres de componentes con constantes de `ECS_CONSTANTS`.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-state-system.js`
- `frontend/src/ecs/systems/animation-mixer-system.js`
- `frontend/src/ecs/systems/combat-system.js`
- `frontend/src/ecs/systems/input-system.js`
- `frontend/src/ecs/systems/physics-system.js`
- `frontend/src/ecs/systems/combo-system.js`
- `frontend/src/ecs/systems/render-system.js`
- `frontend/src/ecs/systems/collision-system.js`
- `frontend/src/ecs/factories/player-factory.js`

**Detalles de implementación:**

**Para cada archivo:**
1. Agregar import: `import { ECS_CONSTANTS } from '../../config/ecs-constants.js';`
2. Reemplazar `requiredComponents`:
   ```javascript
   // Antes
   this.requiredComponents = ['Animation', 'Input', 'Physics'];
   
   // Después
   import { ECS_CONSTANTS } from '../../config/ecs-constants.js';
   this.requiredComponents = [
       ECS_CONSTANTS.COMPONENT_NAMES.ANIMATION,
       ECS_CONSTANTS.COMPONENT_NAMES.INPUT,
       ECS_CONSTANTS.COMPONENT_NAMES.PHYSICS
   ];
   ```
3. Reemplazar `ecs.getComponent()`:
   ```javascript
   // Antes
   const animation = this.ecs.getComponent(entityId, 'Animation');
   
   // Después
   const animation = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.ANIMATION);
   ```
4. Reemplazar `ecs.addComponent()`:
   ```javascript
   // Antes
   ecs.addComponent(playerId, 'Position', new PositionComponent(...));
   
   // Después
   ecs.addComponent(playerId, ECS_CONSTANTS.COMPONENT_NAMES.POSITION, new PositionComponent(...));
   ```
5. Reemplazar `ecs.hasComponent()`:
   ```javascript
   // Antes
   if (this.ecs.hasComponent(entityId, 'Weapon')) {
   
   // Después
   if (this.ecs.hasComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.WEAPON)) {
   ```

**Notas:**
- Revisar TODOS los usos de nombres de componentes en cada archivo
- Verificar que no hay strings hardcodeados olvidados
- Mantener imports organizados

---

### Paso 4: Actualizar `animation-state-system.js` para usar constantes

**Descripción:**
Reemplazar strings hardcodeados de tipos de estado con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-state-system.js`

**Detalles de implementación:**
```javascript
// Antes
if (activeState.type === 'combat') {

// Después
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
if (activeState.type === ANIMATION_CONSTANTS.STATE_TYPES.COMBAT) {
```

**Notas:**
- Agregar import de `ANIMATION_CONSTANTS`
- Reemplazar `'combat'` con `ANIMATION_CONSTANTS.STATE_TYPES.COMBAT`

---

### Paso 5: Actualizar `state-registry.js` para usar constantes

**Descripción:**
Reemplazar strings hardcodeados de tipos de estado y estado 'idle' con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/animation/states/state-registry.js`

**Detalles de implementación:**
```javascript
// Antes
if (state.type === 'combat') {
    // ...
}
return this.states.get('idle') || null;

// Después
import { ANIMATION_CONSTANTS } from '../../../config/animation-constants.js';

if (state.type === ANIMATION_CONSTANTS.STATE_TYPES.COMBAT) {
    // ...
}
return this.states.get(ANIMATION_CONSTANTS.STATE_IDS.IDLE) || null;
```

**Notas:**
- Reemplazar `'combat'` con `ANIMATION_CONSTANTS.STATE_TYPES.COMBAT`
- Reemplazar `'idle'` con `ANIMATION_CONSTANTS.STATE_IDS.IDLE`

---

### Paso 6: Actualizar `condition-factory.js` para usar constantes

**Descripción:**
Reemplazar strings hardcodeados de tipos de condición con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/animation/conditions/condition-factory.js`

**Detalles de implementación:**
```javascript
// Antes
case 'combo':
    return new ComboCondition(conditionConfig);
case 'combat':
    return new CombatCondition(conditionConfig);

// Después
import { ANIMATION_CONSTANTS } from '../../../config/animation-constants.js';

case ANIMATION_CONSTANTS.CONDITION_TYPES.COMBO:
    return new ComboCondition(conditionConfig);
case ANIMATION_CONSTANTS.CONDITION_TYPES.COMBAT:
    return new CombatCondition(conditionConfig);
```

**Notas:**
- Reemplazar todos los tipos de condición en el switch statement
- Verificar que todos los casos están actualizados

---

### Paso 7: Actualizar `animation.js` (componente) para usar constantes

**Descripción:**
Reemplazar string hardcodeado 'idle' con constante.

**Archivos a modificar:**
- `frontend/src/ecs/components/animation.js`

**Detalles de implementación:**
```javascript
// Antes
this.currentState = options.currentState || 'idle';

// Después
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
this.currentState = options.currentState || ANIMATION_CONSTANTS.STATE_IDS.IDLE;
```

**Notas:**
- Solo hay un uso de 'idle' en este archivo

---

### Paso 8: Actualizar `animation-mixer-system.js` para usar constantes

**Descripción:**
Reemplazar strings y números hardcodeados con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Detalles de implementación:**
```javascript
// Antes
anim.currentState = 'idle';
const animationFinished = progress >= 1.0 || ...;
const modelOffset = render.mesh.userData.modelOffset || { x: 0, y: 0, z: 0 };
const modelRotation = render.mesh.userData.modelRotation || { x: 0, y: 0, z: 0 };

// Después
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
import { ECS_CONSTANTS } from '../../config/ecs-constants.js';

anim.currentState = ANIMATION_CONSTANTS.STATE_IDS.IDLE;
const animationFinished = progress >= ANIMATION_CONSTANTS.NUMERIC.PROGRESS_COMPLETE || ...;
const modelOffset = render.mesh.userData.modelOffset || {
    x: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_OFFSET_X,
    y: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_OFFSET_Y,
    z: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_OFFSET_Z
};
const modelRotation = render.mesh.userData.modelRotation || {
    x: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_ROTATION_X,
    y: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_ROTATION_Y,
    z: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_ROTATION_Z
};
```

**También actualizar usos de componentes:**
```javascript
// Reemplazar todos los ecs.getComponent() con constantes ECS
const combat = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.COMBAT);
const input = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.INPUT);
// etc.
```

**Notas:**
- Hay múltiples lugares donde se usan componentes, revisar todos
- También reemplazar números hardcodeados (1.0, offsets, etc.)

---

### Paso 9: Actualizar `combat-system.js` para usar constantes

**Descripción:**
Reemplazar strings hardcodeados de acciones, nombres de componentes y tipos de arma con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/systems/combat-system.js`

**Detalles de implementación:**
```javascript
// Antes
let weaponType = 'generic';
switch (inputAction) {
    case 'dodge':
        return input.wantsToDodge;
    case 'specialAttack':
        return input.wantsToSpecialAttack;
    // ...
}

// Después
import { COMBAT_CONSTANTS } from '../../config/combat-constants.js';
import { ECS_CONSTANTS } from '../../config/ecs-constants.js';

let weaponType = COMBAT_CONSTANTS.WEAPON_TYPES.GENERIC;
switch (inputAction) {
    case COMBAT_CONSTANTS.ACTION_IDS.DODGE:
        return input.wantsToDodge;
    case COMBAT_CONSTANTS.ACTION_IDS.SPECIAL_ATTACK:
        return input.wantsToSpecialAttack;
    // ...
}
```

**También actualizar usos de componentes:**
```javascript
// Reemplazar todos los nombres de componentes con constantes ECS
const input = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.INPUT);
const combat = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.COMBAT);
```

**Notas:**
- Reemplazar 'generic' en línea 61
- Reemplazar todos los cases en el switch statement
- Actualizar usos de componentes

---

### Paso 10: Actualizar `player-factory.js` para usar constantes

**Descripción:**
Reemplazar todos los valores hardcodeados con constantes (estado idle, física del jugador, tipos de arma, spawn, mesh por defecto).

**Archivos a modificar:**
- `frontend/src/ecs/factories/player-factory.js`

**Detalles de implementación:**
```javascript
// Antes
currentState: 'idle',
mass: 70,
groundFriction: 0.8,
airFriction: 0.95,
maxVelocity: { x: 5, y: 10, z: 5 },
animationSpeed: 1.0,
weaponType: 'sword',
x = 80, y = 80, z = 1, cellSize = 0.25,

// Después
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
import { COMBAT_CONSTANTS } from '../../config/combat-constants.js';
import { ECS_CONSTANTS } from '../../config/ecs-constants.js';

currentState: ANIMATION_CONSTANTS.STATE_IDS.IDLE,
mass: ANIMATION_CONSTANTS.PLAYER_PHYSICS.MASS,
groundFriction: ANIMATION_CONSTANTS.PLAYER_PHYSICS.GROUND_FRICTION,
airFriction: ANIMATION_CONSTANTS.PLAYER_PHYSICS.AIR_FRICTION,
maxVelocity: ANIMATION_CONSTANTS.PLAYER_PHYSICS.MAX_VELOCITY,
animationSpeed: ANIMATION_CONSTANTS.PLAYER_PHYSICS.ANIMATION_SPEED,
weaponType: COMBAT_CONSTANTS.WEAPON_TYPES.SWORD,
x = ANIMATION_CONSTANTS.DEFAULT_SPAWN.X,
y = ANIMATION_CONSTANTS.DEFAULT_SPAWN.Y,
z = ANIMATION_CONSTANTS.DEFAULT_SPAWN.Z,
cellSize = ANIMATION_CONSTANTS.DEFAULT_SPAWN.CELL_SIZE,
```

**También actualizar mesh por defecto:**
```javascript
// Antes
const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.3, 1.0, 8);
const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
body.position.y = 0.5;

// Después
const bodyGeometry = new THREE.CylinderGeometry(
    ANIMATION_CONSTANTS.DEFAULT_MESH.BODY.RADIUS,
    ANIMATION_CONSTANTS.DEFAULT_MESH.BODY.RADIUS,
    ANIMATION_CONSTANTS.DEFAULT_MESH.BODY.HEIGHT,
    ANIMATION_CONSTANTS.DEFAULT_MESH.BODY.SEGMENTS
);
const bodyMaterial = new THREE.MeshStandardMaterial({
    color: ANIMATION_CONSTANTS.DEFAULT_MESH.BODY.COLOR,
    metalness: ANIMATION_CONSTANTS.DEFAULT_MESH.MATERIAL.METALNESS,
    roughness: ANIMATION_CONSTANTS.DEFAULT_MESH.MATERIAL.ROUGHNESS
});
body.position.y = ANIMATION_CONSTANTS.DEFAULT_MESH.BODY.POSITION_Y;
```

**También actualizar usos de componentes:**
```javascript
// Reemplazar todos los ecs.addComponent() con constantes ECS
ecs.addComponent(playerId, ECS_CONSTANTS.COMPONENT_NAMES.POSITION, ...);
ecs.addComponent(playerId, ECS_CONSTANTS.COMPONENT_NAMES.PHYSICS, ...);
// etc.
```

**Notas:**
- Hay muchos valores hardcodeados en este archivo, revisar todos
- Aplicar constantes para cabeza también

---

### Paso 11: Actualizar `physics-system.js` para usar constantes

**Descripción:**
Reemplazar valores hardcodeados de física (gravedad, timestep, velocidad de salto) y nombres de componentes con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/systems/physics-system.js`

**Detalles de implementación:**
```javascript
// Antes
this.gravity = options.gravity !== undefined ? options.gravity : -9.8;
this.fixedTimestep = options.fixedTimestep !== undefined ? options.fixedTimestep : 1/60;
physics.velocity.z = 5;

// Después
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
import { ECS_CONSTANTS } from '../../config/ecs-constants.js';

this.gravity = options.gravity !== undefined ? options.gravity : ANIMATION_CONSTANTS.PHYSICS.GRAVITY;
this.fixedTimestep = options.fixedTimestep !== undefined ? options.fixedTimestep : ANIMATION_CONSTANTS.PHYSICS.FIXED_TIMESTEP;
physics.velocity.z = ANIMATION_CONSTANTS.PLAYER_PHYSICS.JUMP_VELOCITY;
```

**También actualizar usos de componentes:**
```javascript
// Reemplazar todos los nombres de componentes con constantes ECS
const physics = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.PHYSICS);
const position = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.POSITION);
```

**Notas:**
- Actualizar valores por defecto de gravedad y timestep
- Actualizar velocidad de salto
- Actualizar usos de componentes

---

### Paso 12: Actualizar `input-system.js` para usar constantes

**Descripción:**
Reemplazar valores hardcodeados de input (velocidades, thresholds, mouse buttons, valores de dirección) y nombres de componentes con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/systems/input-system.js`

**Detalles de implementación:**
```javascript
// Antes
const speed = input.isRunning ? 30 : 15;
if (length > 0.01) {
if (!this.inputManager.isMouseButtonDown(0)) allPressed = false;
localY -= 1; // Adelante
localY += 1; // Atrás
localX -= 1; // Izquierda
localX += 1; // Derecha

// Después
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
import { ECS_CONSTANTS } from '../../config/ecs-constants.js';

const speed = input.isRunning ? ANIMATION_CONSTANTS.INPUT.RUN_SPEED : ANIMATION_CONSTANTS.INPUT.WALK_SPEED;
if (length > ANIMATION_CONSTANTS.INPUT.DIRECTION_NORMALIZE_THRESHOLD) {
if (!this.inputManager.isMouseButtonDown(ANIMATION_CONSTANTS.INPUT.MOUSE_BUTTONS.LEFT)) allPressed = false;
localY -= ANIMATION_CONSTANTS.INPUT.DIRECTION.FORWARD; // Adelante (ya es -1)
localY += ANIMATION_CONSTANTS.INPUT.DIRECTION.BACKWARD; // Atrás (ya es 1)
localX -= ANIMATION_CONSTANTS.INPUT.DIRECTION.LEFT; // Izquierda (ya es -1)
localX += ANIMATION_CONSTANTS.INPUT.DIRECTION.RIGHT; // Derecha (ya es 1)
```

**También actualizar mouse button checks:**
```javascript
// Antes
if (key === 'ClickLeft') {
    if (!this.inputManager.isMouseButtonDown(0)) allPressed = false;
} else if (key === 'ClickRight') {
    if (!this.inputManager.isMouseButtonDown(2)) allPressed = false;
}

// Después
if (key === 'ClickLeft') {
    if (!this.inputManager.isMouseButtonDown(ANIMATION_CONSTANTS.INPUT.MOUSE_BUTTONS.LEFT)) allPressed = false;
} else if (key === 'ClickRight') {
    if (!this.inputManager.isMouseButtonDown(ANIMATION_CONSTANTS.INPUT.MOUSE_BUTTONS.RIGHT)) allPressed = false;
}
```

**También actualizar usos de componentes:**
```javascript
// Reemplazar todos los nombres de componentes con constantes ECS
const input = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.INPUT);
const physics = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.PHYSICS);
```

**Notas:**
- Reemplazar todas las velocidades (30, 15)
- Reemplazar threshold (0.01)
- Reemplazar mouse button indices (0, 2)
- Reemplazar valores de dirección (1, -1)
- Actualizar usos de componentes

---

### Paso 13: Actualizar `combo-system.js` para usar constantes

**Descripción:**
Reemplazar strings hardcodeados de inputType, multiplicador de timing y nombres de componentes con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/systems/combo-system.js`

**Detalles de implementación:**
```javascript
// Antes
if (input.wantsToHeavyAttack) {
    inputType = 'heavyAttack';
} else if (input.wantsToChargedAttack) {
    inputType = 'chargedAttack';
} else if (input.wantsToSpecialAttack) {
    inputType = 'specialAttack';
} else if (input.wantsToAttack) {
    inputType = 'attack';
}
if (currentStep && timeSinceLastInput > currentStep.timing * 1.5) {

// Después
import { COMBAT_CONSTANTS } from '../../config/combat-constants.js';
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
import { ECS_CONSTANTS } from '../../config/ecs-constants.js';

if (input.wantsToHeavyAttack) {
    inputType = COMBAT_CONSTANTS.ACTION_IDS.HEAVY_ATTACK;
} else if (input.wantsToChargedAttack) {
    inputType = COMBAT_CONSTANTS.ACTION_IDS.CHARGED_ATTACK;
} else if (input.wantsToSpecialAttack) {
    inputType = COMBAT_CONSTANTS.ACTION_IDS.SPECIAL_ATTACK;
} else if (input.wantsToAttack) {
    inputType = COMBAT_CONSTANTS.ACTION_IDS.LIGHT_ATTACK;
}
if (currentStep && timeSinceLastInput > currentStep.timing * ANIMATION_CONSTANTS.COMBO.TIMING_MULTIPLIER) {
```

**También actualizar usos de componentes:**
```javascript
// Reemplazar todos los nombres de componentes con constantes ECS
const input = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.INPUT);
const combo = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.COMBO);
```

**Notas:**
- Reemplazar todos los strings de inputType
- Reemplazar multiplicador 1.5
- Actualizar usos de componentes

---

### Paso 14: Actualizar `collision-system.js` para usar constantes

**Descripción:**
Reemplazar valores hardcodeados de colisiones (threshold, estado de partícula, respawn, límites) y nombres de componentes con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/systems/collision-system.js`

**Detalles de implementación:**
```javascript
// Antes
this.cacheInvalidationThreshold = 2;
if (particle.estado_nombre === 'solido') {
    // ...
}
position.z = 1;
position.x = 80;
position.y = 80;
const minZ = this.dimension.profundidad_maxima || -10;
const maxZ = this.dimension.altura_maxima || 40;
physics.velocity = { x: 0, y: 0, z: 0 };

// Después
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
import { ECS_CONSTANTS } from '../../config/ecs-constants.js';

this.cacheInvalidationThreshold = ANIMATION_CONSTANTS.COLLISION.CACHE_INVALIDATION_THRESHOLD;
if (particle.estado_nombre === ANIMATION_CONSTANTS.COLLISION.PARTICLE_STATE_SOLID) {
    // ...
}
position.z = ANIMATION_CONSTANTS.COLLISION.POSITION_CORRECTION.MIN_Z;
position.x = ANIMATION_CONSTANTS.COLLISION.DEFAULT_RESPAWN.X;
position.y = ANIMATION_CONSTANTS.COLLISION.DEFAULT_RESPAWN.Y;
const minZ = this.dimension.profundidad_maxima || ANIMATION_CONSTANTS.COLLISION.DEFAULT_DIMENSION.MIN_Z;
const maxZ = this.dimension.altura_maxima || ANIMATION_CONSTANTS.COLLISION.DEFAULT_DIMENSION.MAX_Z;
physics.velocity = {
    x: ANIMATION_CONSTANTS.COLLISION.POSITION_CORRECTION.VELOCITY_RESET,
    y: ANIMATION_CONSTANTS.COLLISION.POSITION_CORRECTION.VELOCITY_RESET,
    z: ANIMATION_CONSTANTS.COLLISION.POSITION_CORRECTION.VELOCITY_RESET
};
```

**También actualizar usos de componentes:**
```javascript
// Reemplazar todos los nombres de componentes con constantes ECS
const position = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.POSITION);
const physics = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.PHYSICS);
```

**Notas:**
- Reemplazar threshold de cache
- Reemplazar estado de partícula 'solido'
- Reemplazar valores de respawn
- Reemplazar límites de dimensión
- Reemplazar valores de corrección
- Actualizar usos de componentes

---

### Paso 15: Actualizar `render-system.js` para usar constantes

**Descripción:**
Reemplazar valores hardcodeados de offsets y nombres de componentes con constantes.

**Archivos a modificar:**
- `frontend/src/ecs/systems/render-system.js`

**Detalles de implementación:**
```javascript
// Antes
const modelOffset = render.mesh.userData.modelOffset || { x: 0, y: 0, z: 0 };
const modelRotation = render.mesh.userData.modelRotation || { x: 0, y: 0, z: 0 };

// Después
import { ANIMATION_CONSTANTS } from '../../config/animation-constants.js';
import { ECS_CONSTANTS } from '../../config/ecs-constants.js';

const modelOffset = render.mesh.userData.modelOffset || {
    x: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_OFFSET_X,
    y: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_OFFSET_Y,
    z: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_OFFSET_Z
};
const modelRotation = render.mesh.userData.modelRotation || {
    x: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_ROTATION_X,
    y: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_ROTATION_Y,
    z: ANIMATION_CONSTANTS.NUMERIC.DEFAULT_ROTATION_Z
};
```

**También actualizar usos de componentes:**
```javascript
// Reemplazar todos los nombres de componentes con constantes ECS
const render = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.RENDER);
const position = this.ecs.getComponent(entityId, ECS_CONSTANTS.COMPONENT_NAMES.POSITION);
```

**Notas:**
- Reemplazar valores por defecto de offsets y rotaciones
- Actualizar usos de componentes

---

### Paso 16: Verificar y limpiar imports duplicados

**Descripción:**
Verificar que no hay imports duplicados o no utilizados después de todos los cambios.

**Archivos a verificar:**
- Todos los archivos modificados en los pasos anteriores

**Detalles de implementación:**
1. Revisar cada archivo modificado
2. Verificar que los imports están organizados (ECS_CONSTANTS, ANIMATION_CONSTANTS, COMBAT_CONSTANTS)
3. Eliminar imports no utilizados
4. Organizar imports en orden lógico (ECS primero, luego animación, luego combate)

**Notas:**
- Mantener imports organizados y limpios
- Verificar que todos los imports necesarios están presentes

---

### Paso 17: Verificar que no hay referencias restantes a valores hardcodeados

**Descripción:**
Buscar exhaustivamente cualquier referencia restante a strings o números hardcodeados que deberían estar en constantes.

**Comandos a ejecutar:**
```bash
# Buscar strings críticos
grep -r "'idle'" frontend/src/ecs/
grep -r "'combat'" frontend/src/ecs/
grep -r "'combo'" frontend/src/ecs/
grep -r "'generic'" frontend/src/ecs/
grep -r "'sword'" frontend/src/ecs/
grep -r "'solido'" frontend/src/ecs/

# Buscar nombres de componentes hardcodeados
grep -r "'Position'" frontend/src/ecs/
grep -r "'Physics'" frontend/src/ecs/
grep -r "'Render'" frontend/src/ecs/
grep -r "'Input'" frontend/src/ecs/
grep -r "'Animation'" frontend/src/ecs/
grep -r "'Combo'" frontend/src/ecs/
grep -r "'Combat'" frontend/src/ecs/
grep -r "'Weapon'" frontend/src/ecs/

# Buscar números críticos
grep -r " 30 " frontend/src/ecs/  # velocidad run
grep -r " 15 " frontend/src/ecs/  # velocidad walk
grep -r " 1.5 " frontend/src/ecs/  # multiplicador combo
grep -r " -9.8 " frontend/src/ecs/  # gravedad
grep -r " 1/60 " frontend/src/ecs/  # timestep
```

**Notas:**
- Los resultados deben mostrar solo comentarios o definiciones en archivos de constantes
- Si hay usos hardcodeados, agregarlos al paso correspondiente
- Algunos valores pueden ser legítimos (no todos los números son "mágicos")

---

### Paso 18: Actualizar `frontend/src/config/README.md`

**Descripción:**
Actualizar la documentación para incluir los nuevos archivos de constantes.

**Archivos a modificar:**
- `frontend/src/config/README.md`

**Detalles de implementación:**
Agregar sección para los nuevos archivos:

```markdown
### Constantes del Sistema

- **`ecs-constants.js`**: Constantes centralizadas para sistema ECS (nombres de componentes). Evita typos y facilita refactoring.
- **`animation-constants.js`**: Constantes centralizadas para sistema de animaciones, física, input, combos y colisiones. Centraliza valores mágicos y strings para evitar errores de tipeo.
- **`combat-constants.js`**: Constantes centralizadas para sistema de combate (thresholds, IDs de acciones, tipos de armas). Evita strings y valores mágicos hardcodeados.
```

**Notas:**
- **⚠️ READMEs:** Actualizar documentación del módulo config para incluir nuevos archivos
- Mantener formato consistente con el resto del README

---

### Paso 19: Verificar errores de lint

**Descripción:**
Verificar que no hay errores de lint en los archivos modificados.

**Comandos a ejecutar:**
- Verificar que el código compila sin errores
- Revisar consola del navegador por warnings o errores
- Si hay linter configurado, ejecutarlo

**Notas:**
- Todos los archivos deben pasar el lint sin errores
- Corregir cualquier error encontrado

---

### Paso 20: Testing básico de funcionalidad

**Descripción:**
Verificar que todas las funcionalidades siguen funcionando correctamente después de los cambios.

**Escenarios a verificar:**
1. ✅ El jugador puede moverse (walk, run)
2. ✅ El jugador puede saltar
3. ✅ El jugador puede agacharse
4. ✅ Las animaciones de combate funcionan (attack, parry, dodge)
5. ✅ Los combos funcionan correctamente
6. ✅ El sistema de física funciona (gravedad, velocidad)
7. ✅ Las colisiones funcionan correctamente
8. ✅ No hay errores en consola del navegador

**Notas:**
- Testing manual básico para verificar que no hay regresiones
- Si algo no funciona, revisar los cambios en el paso correspondiente

---

### Paso Final: Generar Descripción del Pull Request

**Descripción:**
Una vez completados todos los pasos anteriores y verificada la implementación, genera la descripción completa del Pull Request usando la regla `@pr-description.mdc`.

**Comando a ejecutar:**
```
@pr-description.mdc
```

**Resultado esperado:**
- Archivo generado: `JDG-029_pr-description_[FECHA-HORA].md` en `/instructions/prs/` (con fecha y hora obtenida de `Get-Date -Format "yyyy-MM-dd_HH-mm-ss"`)
- El archivo contendrá una descripción completa del PR lista para copiar y pegar en Git
- Incluirá: título, resumen, motivación, cambios técnicos, testing, referencias y riesgos

**Notas:**
- Este paso se ejecuta DESPUÉS de completar toda la implementación
- La descripción se genera automáticamente basándose en los cambios realizados
- El desarrollador solo necesita copiar y pegar el contenido en Git
- No editar manualmente a menos que sea estrictamente necesario

---

## Consideraciones Técnicas

### Performance
- ✅ Cero impacto de performance - Acceso a constante es O(1), igual que string literal
- ✅ No hay overhead adicional
- ✅ Cacheo de componentes y configuraciones ya implementado se mantiene

### Seguridad
- ✅ No hay cambios de seguridad - Solo refactoring de valores hardcodeados
- ✅ Valores son los mismos, solo organizados en constantes

### Compatibilidad
- ✅ 100% compatible con código existente - Los valores son idénticos
- ✅ No rompe funcionalidad existente
- ✅ Cambios son puramente de refactoring

### Casos Edge
- ✅ Validar que constantes existen antes de usar (opcional con helpers)
- ✅ Manejar casos donde valores por defecto pueden sobrescribirse (physics-system.js)
- ✅ Verificar que no hay dependencias circulares entre archivos de constantes

## Patrones de Código a Usar

- **Constantes centralizadas**: Agrupar valores relacionados en objetos jerárquicos
- **Nombres descriptivos**: Usar nombres claros que expliquen el propósito del valor
- **Documentación JSDoc**: Documentar cada sección de constantes
- **Imports organizados**: Importar constantes al inicio del archivo

## Dependencias

### Nuevas Dependencias
- Ninguna - Solo uso de archivos de configuración existentes

### Variables de Entorno
- Ninguna

## Archivos Principales Involucrados

1. `frontend/src/config/ecs-constants.js` - Nuevo archivo de constantes ECS
2. `frontend/src/config/animation-constants.js` - Nuevo archivo de constantes de animación
3. `frontend/src/config/combat-constants.js` - Ya existe, se referencia
4. `frontend/src/ecs/systems/*.js` - Todos los sistemas actualizados
5. `frontend/src/ecs/components/animation.js` - Componente actualizado
6. `frontend/src/ecs/factories/player-factory.js` - Factory actualizada
7. `frontend/src/ecs/animation/states/state-registry.js` - Registry actualizado
8. `frontend/src/ecs/animation/conditions/condition-factory.js` - Factory actualizada

## Testing

### Tests a Verificar
- Verificar que todas las animaciones funcionan correctamente
- Verificar que el sistema de combate funciona
- Verificar que el sistema de física funciona
- Verificar que las colisiones funcionan
- Verificar que no hay errores en consola

### Escenarios de Prueba
1. Movimiento básico: walk, run, jump, crouch
2. Combate: attack, parry, dodge, special attacks
3. Combos: ejecutar secuencias de ataques
4. Física: gravedad, velocidades, límites
5. Colisiones: detección de suelo y paredes

## Deployment

### Orden de Deployment
1. Frontend: Los cambios son solo en JavaScript, no requieren rebuild especial
2. Verificar que el frontend carga correctamente en el navegador
3. Verificar que no hay errores en consola del navegador

### Verificación Post-Deployment
- [ ] Verificar frontend en navegador
- [ ] Verificar que todas las animaciones funcionan correctamente
- [ ] Verificar que no hay errores en consola del navegador
- [ ] Verificar que el sistema de combate funciona
- [ ] Verificar que el sistema de física funciona
- [ ] Verificar logs de Docker (si hay errores)

---

**Nota Final:** Este plan debe ejecutarse paso a paso, verificando cada paso antes de continuar con el siguiente. Si encuentras problemas o necesitas clarificación, consulta con el equipo antes de proceder.

**⚠️ IMPORTANTE:** El último paso del plan SIEMPRE debe ser "Generar Descripción del Pull Request" usando `@pr-description.mdc`. Esto genera automáticamente la descripción completa del PR lista para Git.

