# JDG-032 - Migraci√≥n de Estructura de Animaciones y Mejora de Interfaz de Debugger

## Descripci√≥n de la Tarea

Eliminar las animaciones duplicadas de la ra√≠z de `backend/static/models/animations/` (ya que las mismas animaciones est√°n organizadas en `biped/`), actualizar las rutas en el frontend para usar la estructura organizada, y mejorar la interfaz de debugger (F6) para mostrar las animaciones agrupadas por carpetas con una vista jer√°rquica.

**Comportamiento actual:**
- Las animaciones est√°n duplicadas: existen tanto en la ra√≠z como en `biped/` organizadas por categor√≠as
- Las rutas en `ANIMATION_FILES` apuntan a la ra√≠z (copias duplicadas)
- La interfaz de debugger muestra una lista plana sin reflejar la organizaci√≥n por carpetas

**Comportamiento esperado:**
- Solo las animaciones organizadas en `biped/` existen (sin duplicados en la ra√≠z)
- Las rutas apuntan a las versiones organizadas en `biped/`
- La interfaz de debugger muestra animaciones agrupadas por carpetas con vista jer√°rquica expandible/colapsable

## Criterios de Aceptaci√≥n

1. ‚ùå Todas las animaciones duplicadas de la ra√≠z han sido eliminadas
2. ‚ùå El archivo `animation-config.js` ha sido actualizado con las nuevas rutas
3. ‚ùå El sistema de carga funciona correctamente con las nuevas rutas
4. ‚ùå La interfaz de debugger (F6) muestra animaciones agrupadas por carpetas
5. ‚ùå Las animaciones sin categorizar aparecen en secci√≥n "Sin categorizar"
6. ‚ùå No hay errores de carga de animaciones
7. ‚ùå Todas las animaciones existentes siguen funcionando

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura

### Tecnolog√≠as Involucradas
- Frontend: HTML5, JavaScript ES6+, Three.js
- Sistema de archivos est√°ticos (FastAPI sirve archivos est√°ticos)

## Pasos de Implementaci√≥n

### Paso 1: Verificar Equivalencias de Animaciones

**Descripci√≥n:**
Verificar que todas las animaciones en la ra√≠z tienen su equivalente organizado en `biped/` antes de eliminar los duplicados. Esto asegura que no eliminamos animaciones √∫nicas.

**Archivos a modificar/crear:**
- Ninguno (solo verificaci√≥n)

**Detalles de implementaci√≥n:**
1. Listar todos los archivos `.glb` en `backend/static/models/animations/` (ra√≠z)
2. Para cada archivo, verificar si existe en `biped/` en alguna carpeta
3. Documentar cualquier animaci√≥n que NO tenga equivalente en `biped/`
4. Si hay animaciones √∫nicas en la ra√≠z, decidir si moverlas a `biped/` o mantenerlas temporalmente

**Notas:**
- Usar comandos del sistema para listar archivos
- Crear un mapeo temporal de equivalencias si es necesario
- **‚ö†Ô∏è IMPORTANTE**: No eliminar nada hasta verificar todas las equivalencias

**Recursos √∫tiles:**
- Estructura de carpetas en `biped/`: `axe/`, `sword/`, `movement/`, `idle/`, `hit-reactions/`, `interactions/`, `skills/`, etc.

---

### Paso 2: Actualizar Rutas en animation-config.js

**Descripci√≥n:**
Actualizar todas las rutas en `ANIMATION_FILES` para que apunten a las versiones organizadas en `biped/` en lugar de la ra√≠z.

**Archivos a modificar/crear:**
- `frontend/src/config/animation-config.js`

**Detalles de implementaci√≥n:**
```javascript
// Cambiar de:
'left_slash': 'animations/Animation_Left_Slash_withSkin.glb',
'attack': 'animations/Animation_Attack_withSkin.glb',
'walking': 'animations/Animation_Walking_withSkin.glb',

// A:
'left_slash': 'animations/biped/sword/Animation_Left_Slash_withSkin.glb',
'attack': 'animations/biped/two-hand-sword/Animation_Attack_withSkin.glb',
'walking': 'animations/biped/movement/Animation_Walking_withSkin.glb',
```

**Mapeo de categor√≠as:**
- `sword/`: left_slash, charged_slash, sword_judgment, sword_parry_backward
- `two-hand-sword/`: attack
- `movement/`: walking, running, run_fast, regular_jump, backflip, dive_down_and_land, swimming_to_edge
- `idle/`: idle_11, combat_stance, swim_idle
- `hit-reactions/`: hit_reaction, hit_reaction_1, electrocution_reaction, falling_down, shot_and_fall_backward, stand_dodge, crouch_and_step_back
- `interactions/`: collect_object, stand_and_drink, stand_up, dive_down_and_land
- `skills/`: charged_spell_cast, skill_01, crouch_charge_and_throw
- `axe/`: axe_spin_attack
- `two-hand-axe/`: charged_axe_chop
- `two-hand-hammer/`: heavy_hammer_swing
- `two-swords/`: double_blade_spin
- `spear/`: spear_walk
- `hammer/`: charged_upward_slash
- `shield/`: shield_push_left
- `cuffs/`: simple_kick
- `secondary-interactions/`: crouch_walk_forward, crouch_walk_right, limping_walk, talk_with_hands_open
- `roll_dodge`: roll_dodge (verificar carpeta)

**Notas:**
- Actualizar todas las rutas de una vez
- Mantener los nombres de las claves iguales (solo cambiar las rutas)
- Verificar que todas las rutas apuntan a archivos que existen en `biped/`
- **‚ö†Ô∏è READMEs:** Verificar si hay README en `frontend/src/config/` y actualizarlo si es necesario

---

### Paso 3: Mejorar Interfaz de Debugger con Vista Jer√°rquica

**Descripci√≥n:**
Modificar `animation-tester.js` para mostrar las animaciones agrupadas por carpetas con una vista jer√°rquica expandible/colapsable, reflejando la estructura que ya existe en `biped/`.

**Archivos a modificar/crear:**
- `frontend/src/debug/ui/animation-tester.js`

**Detalles de implementaci√≥n:**

1. **Crear funci√≥n para organizar animaciones por carpetas:**
```javascript
organizeAnimationsByFolder(animations) {
    const organized = {};
    const uncategorized = [];
    
    Object.entries(animations).forEach(([name, path]) => {
        // Extraer estructura de carpetas de la ruta
        // Ejemplo: 'animations/biped/sword/Animation_XXX.glb' ‚Üí ['biped', 'sword']
        const pathParts = path.split('/');
        const folderIndex = pathParts.indexOf('biped');
        
        if (folderIndex !== -1 && folderIndex < pathParts.length - 1) {
            const category = pathParts[folderIndex + 1];
            if (!organized[category]) {
                organized[category] = [];
            }
            organized[category].push({ name, path });
        } else {
            // Animaci√≥n sin categorizar (en la ra√≠z)
            uncategorized.push({ name, path });
        }
    });
    
    return { organized, uncategorized };
}
```

2. **Crear componente de carpeta expandible:**
```javascript
createFolderItem(folderName, animations, isExpanded = false) {
    const folderContainer = document.createElement('div');
    folderContainer.style.cssText = 'margin: 5px 0;';
    
    // Bot√≥n de carpeta (expandir/colapsar)
    const folderButton = document.createElement('button');
    folderButton.textContent = `üìÅ ${folderName} (${animations.length})`;
    folderButton.style.cssText = `
        width: 100%;
        padding: 10px;
        background: rgba(45, 45, 45, 0.5);
        border: 1px solid #444;
        text-align: left;
        cursor: pointer;
        color: #fff;
        font-weight: bold;
    `;
    
    // Contenedor de animaciones (inicialmente oculto si no est√° expandido)
    const animationsContainer = document.createElement('div');
    animationsContainer.style.cssText = `
        margin-left: 20px;
        margin-top: 5px;
        display: ${isExpanded ? 'block' : 'none'};
    `;
    
    // Agregar animaciones
    animations.forEach(({ name, path }) => {
        const animationItem = this.createListItem({
            columns: [
                { content: name, style: 'flex: 0 0 200px; color: #fff; font-weight: bold;' },
                { content: path, style: 'flex: 1; color: #aaa; font-family: monospace; font-size: 11px;' }
            ],
            actions: [{ text: 'Reproducir', onClick: () => this.playAnimation(name), variant: 'small' }]
        });
        animationsContainer.appendChild(animationItem);
    });
    
    // Toggle expand/collapse
    folderButton.onclick = () => {
        const isCurrentlyExpanded = animationsContainer.style.display !== 'none';
        animationsContainer.style.display = isCurrentlyExpanded ? 'none' : 'block';
        folderButton.textContent = `${isCurrentlyExpanded ? 'üìÅ' : 'üìÇ'} ${folderName} (${animations.length})`;
    };
    
    folderContainer.appendChild(folderButton);
    folderContainer.appendChild(animationsContainer);
    
    return folderContainer;
}
```

3. **Modificar `renderAnimationList()` para usar la nueva estructura:**
```javascript
renderAnimationList() {
    if (!this.listContainer || !this.animations) return;
    
    this.listContainer.innerHTML = '';
    
    // Organizar animaciones por carpetas
    const { organized, uncategorized } = this.organizeAnimationsByFolder(this.animations);
    
    // Aplicar filtro de b√∫squeda si existe
    const searchTerm = this.searchTerm.toLowerCase();
    
    // Renderizar carpetas organizadas
    Object.entries(organized)
        .sort(([a], [b]) => a.localeCompare(b))
        .forEach(([folderName, animations]) => {
            // Filtrar animaciones por b√∫squeda
            const filtered = animations.filter(({ name, path }) => {
                if (!searchTerm) return true;
                return name.toLowerCase().includes(searchTerm) || 
                       path.toLowerCase().includes(searchTerm) ||
                       folderName.toLowerCase().includes(searchTerm);
            });
            
            if (filtered.length > 0) {
                this.listContainer.appendChild(
                    this.createFolderItem(folderName, filtered, !searchTerm) // Expandir si no hay b√∫squeda
                );
            }
        });
    
    // Renderizar secci√≥n "Sin categorizar" si hay animaciones
    if (uncategorized.length > 0) {
        const filteredUncategorized = uncategorized.filter(({ name, path }) => {
            if (!searchTerm) return true;
            return name.toLowerCase().includes(searchTerm) || 
                   path.toLowerCase().includes(searchTerm);
        });
        
        if (filteredUncategorized.length > 0) {
            const uncategorizedTitle = document.createElement('div');
            uncategorizedTitle.textContent = 'üìÅ Sin categorizar';
            uncategorizedTitle.style.cssText = 'margin: 15px 0 5px 0; color: #ff9800; font-weight: bold; font-size: 14px;';
            this.listContainer.appendChild(uncategorizedTitle);
            
            filteredUncategorized.forEach(({ name, path }) => {
                this.listContainer.appendChild(this.createListItem({
                    columns: [
                        { content: name, style: 'flex: 0 0 200px; color: #fff; font-weight: bold;' },
                        { content: path, style: 'flex: 1; color: #aaa; font-family: monospace; font-size: 11px;' }
                    ],
                    actions: [{ text: 'Reproducir', onClick: () => this.playAnimation(name), variant: 'small' }]
                }));
            });
        }
    }
    
    // Mensaje si no hay resultados
    if (this.listContainer.children.length === 0) {
        this.listContainer.appendChild(this.createNoResultsMessage(
            searchTerm 
                ? `No se encontraron animaciones que coincidan con "${searchTerm}"`
                : 'No se encontraron animaciones'
        ));
    }
}
```

**Notas:**
- Mantener la funcionalidad de b√∫squeda existente
- La b√∫squeda debe funcionar tambi√©n por nombre de carpeta
- Las carpetas se expanden autom√°ticamente si no hay b√∫squeda activa
- **‚ö†Ô∏è READMEs:** Verificar si hay README en `frontend/src/debug/ui/` y actualizarlo si es necesario

---

### Paso 4: Probar Carga de Animaciones

**Descripci√≥n:**
Verificar que todas las animaciones se cargan correctamente con las nuevas rutas y que el sistema de animaciones funciona correctamente.

**Archivos a modificar/crear:**
- Ninguno (solo testing)

**Detalles de implementaci√≥n:**
1. Iniciar el juego
2. Abrir la interfaz de debugger (F6)
3. Verificar que todas las animaciones aparecen organizadas por carpetas
4. Probar reproducir animaciones desde diferentes carpetas
5. Verificar que no hay errores en la consola del navegador
6. Probar animaciones en el juego durante gameplay

**Notas:**
- Verificar especialmente animaciones de combate y movimiento
- Si hay errores de carga, verificar que las rutas en `animation-config.js` son correctas
- El cache del navegador puede mantener rutas antiguas - hacer hard refresh (Ctrl+Shift+R)

---

### Paso 5: Eliminar Duplicados de la Ra√≠z (Opcional - Manual)

**Descripci√≥n:**
Una vez verificadas todas las animaciones funcionan correctamente con las nuevas rutas, eliminar las copias duplicadas de la ra√≠z de `backend/static/models/animations/`.

**Archivos a modificar/crear:**
- `backend/static/models/animations/` (eliminar archivos .glb de la ra√≠z)

**Detalles de implementaci√≥n:**
1. Verificar que todas las animaciones funcionan con las nuevas rutas (Paso 4)
2. Hacer backup de la carpeta `animations/` por seguridad
3. Eliminar todos los archivos `.glb` de la ra√≠z de `backend/static/models/animations/`
4. Mantener solo la carpeta `biped/` y su estructura

**Notas:**
- **‚ö†Ô∏è IMPORTANTE**: Solo hacer esto DESPU√âS de verificar que todo funciona
- Mantener backup por si acaso
- No eliminar la carpeta `biped/`
- Si hay animaciones √∫nicas en la ra√≠z que no est√°n en `biped/`, NO eliminarlas

---

### Paso Final: Generar Descripci√≥n del Pull Request

**Descripci√≥n:**
Una vez completados todos los pasos anteriores y verificada la implementaci√≥n, genera la descripci√≥n completa del Pull Request usando la regla `@pr-description.mdc`.

**Comando a ejecutar:**
```
@pr-description.mdc
```

**Resultado esperado:**
- Archivo generado: `JDG-032_pr-description_[FECHA-HORA].md` en `/instructions/prs/` (con fecha y hora obtenida de `Get-Date -Format "yyyy-MM-dd_HH-mm-ss"`)
- El archivo contendr√° una descripci√≥n completa del PR lista para copiar y pegar en Git
- Incluir√°: t√≠tulo, resumen, motivaci√≥n, cambios t√©cnicos, testing, referencias y riesgos

**Notas:**
- Este paso se ejecuta DESPU√âS de completar toda la implementaci√≥n
- La descripci√≥n se genera autom√°ticamente bas√°ndose en los cambios realizados
- El desarrollador solo necesita copiar y pegar el contenido en Git
- No editar manualmente a menos que sea estrictamente necesario

---

## Consideraciones T√©cnicas

### Performance
- La carga de animaciones no cambia, solo las rutas
- El sistema de cache funciona igual (usa la ruta completa como clave)
- La interfaz de debugger puede ser ligeramente m√°s lenta al renderizar la vista jer√°rquica, pero es aceptable

### Seguridad
- No hay consideraciones de seguridad especiales
- Las rutas son relativas y validadas por el servidor est√°tico

### Casos Edge
- Animaciones con nombres que no coinciden exactamente entre ra√≠z y `biped/`
- Rutas incorrectas despu√©s de la actualizaci√≥n
- Cache del navegador manteniendo rutas antiguas (soluci√≥n: hard refresh)
- Animaciones sin categorizar que aparecen en la ra√≠z

### Compatibilidad
- Compatible con el sistema existente (solo cambian rutas)
- No requiere cambios en `AnimationMixerSystem` (funciona con cualquier ruta)
- Compatible con versiones anteriores si se mantiene compatibilidad temporal (opcional)

## Patrones de C√≥digo a Usar

- **Frontend (Three.js)**: 
  - Clases ES6 para organizaci√≥n
  - M√©todos privados para organizaci√≥n de datos
  - Separaci√≥n de l√≥gica de presentaci√≥n
  - Reutilizaci√≥n de componentes de BaseInterface

## Dependencias

### Nuevas Dependencias (si aplica)
Ninguna - solo cambios en c√≥digo existente

### Variables de Entorno (si aplica)
Ninguna

## Archivos Principales Involucrados

1. `frontend/src/config/animation-config.js` - Actualizaci√≥n de rutas
2. `frontend/src/debug/ui/animation-tester.js` - Mejora de interfaz con vista jer√°rquica
3. `backend/static/models/animations/` - Eliminaci√≥n de duplicados (manual)

## Testing

### Tests a Crear/Modificar
No se requieren tests automatizados para este cambio (principalmente reorganizaci√≥n y mejora de UI)

### Escenarios de Prueba
1. **Carga de animaciones**: Verificar que todas se cargan correctamente
2. **Interfaz de debugger**: 
   - Verificar vista jer√°rquica funciona
   - Verificar expandir/colapsar carpetas
   - Verificar b√∫squeda por nombre y carpeta
   - Verificar secci√≥n "Sin categorizar"
3. **Animaciones en juego**: Verificar que funcionan durante gameplay
4. **Casos edge**: Verificar manejo de animaciones sin categorizar

## Deployment

### Orden de Deployment
1. Frontend: Actualizar archivos JavaScript
2. Backend: Eliminar archivos duplicados de la ra√≠z (opcional, puede hacerse despu√©s)
3. Verificar en ambiente local con Docker Compose

### Verificaci√≥n Post-Deployment
- [ ] Verificar interfaz de debugger (F6) muestra estructura jer√°rquica
- [ ] Verificar que todas las animaciones se cargan correctamente
- [ ] Verificar que no hay errores en consola del navegador
- [ ] Verificar animaciones funcionan en el juego
- [ ] Verificar b√∫squeda funciona correctamente

---

**Nota Final:** Este plan debe ejecutarse paso a paso, verificando cada paso antes de continuar con el siguiente. Si encuentras problemas o necesitas clarificaci√≥n, consulta con el equipo antes de proceder.

**‚ö†Ô∏è IMPORTANTE:** El √∫ltimo paso del plan SIEMPRE debe ser "Generar Descripci√≥n del Pull Request" usando `@pr-description.mdc`. Esto genera autom√°ticamente la descripci√≥n completa del PR lista para Git.
