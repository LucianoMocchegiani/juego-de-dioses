# JDG-033 - Migración de Modelos y Animaciones a Estructura Biped

## Descripción de la Tarea

Migrar modelos de personajes y animaciones a la nueva estructura organizada `biped/male/`, actualizar todas las rutas en el código y base de datos, y renombrar archivos para usar nombres simplificados (eliminar prefijos innecesarios).

**Comportamiento actual:**
- Modelos de personajes en `backend/static/models/characters/Character_output.glb`
- Animaciones en `backend/static/models/animations/biped/...` con estructura antigua
- Rutas en BD: `"ruta": "characters/Character_output.glb"`
- Frontend usa `animation-config.js` con rutas antiguas `animations/biped/...`

**Comportamiento esperado:**
- Modelos en `backend/static/models/biped/male/characters/biped_male.glb` (renombrado)
- Animaciones en `backend/static/models/biped/male/animations/{categoria}/...` sin prefijo `Meshy_AI_Animation_`
- Rutas en BD: `"ruta": "biped/male/characters/biped_male.glb"`
- Frontend actualizado con nuevas rutas y sin prefijos en nombres de animaciones

## Criterios de Aceptación

1. ❌ Todos los modelos de personajes están en `backend/static/models/biped/male/characters/`
2. ❌ El modelo principal se llama `biped_male.glb` (no `Meshy_AI_Character_output.glb`)
3. ❌ Todas las animaciones están en `backend/static/models/biped/male/animations/{category}/`
4. ❌ Las animaciones no tienen prefijo `Meshy_AI_Animation_` (ej: `Left_Slash_withSkin.glb` en lugar de `Meshy_AI_Animation_Left_Slash_withSkin.glb`)
5. ❌ Las rutas en la base de datos apuntan a la nueva estructura
6. ❌ El frontend carga correctamente modelos y animaciones desde las nuevas ubicaciones
7. ❌ El endpoint `/api/v1/dimensions/{id}/characters/{id}/model` retorna rutas actualizadas
8. ❌ Todos los personajes existentes funcionan correctamente después de la migración
9. ❌ El sistema de animaciones funciona correctamente con las nuevas rutas
10. ❌ No hay regresiones en funcionalidad existente

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [x] Backend (FastAPI)
- [x] Frontend (Three.js)
- [x] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [x] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Backend: Python 3.11, FastAPI, asyncpg
- Frontend: HTML5, JavaScript ES6+, Three.js
- Base de datos: PostgreSQL 16
- GLB/GLTF file formats

## Pasos de Implementación

### Paso 1: Preparar Estructura y Renombrar Archivos

**Descripción:**
Verificar que la estructura `biped/male/` existe y renombrar los archivos según la nueva nomenclatura:
- Modelo: `Meshy_AI_Character_output.glb` → `biped_male.glb`
- Animaciones: Remover prefijo `Meshy_AI_Animation_` de todos los archivos

**Archivos a modificar/crear:**
- `backend/static/models/biped/male/characters/biped_male.glb` (renombrado)
- `backend/static/models/biped/male/animations/{categoria}/*.glb` (renombrados)

**Detalles de implementación:**

1. **Verificar estructura:**
   ```bash
   # Verificar que existe la estructura
   ls -la backend/static/models/biped/male/characters/
   ls -la backend/static/models/biped/male/animations/
   ```

2. **Renombrar modelo principal:**
   ```bash
   # Renombrar el modelo
   mv backend/static/models/biped/male/characters/Meshy_AI_Character_output.glb \
      backend/static/models/biped/male/characters/biped_male.glb
   ```

3. **Renombrar animaciones (eliminar prefijo `Meshy_AI_Animation_`):**
   ```bash
   # Script para renombrar todas las animaciones
   cd backend/static/models/biped/male/animations
   find . -type f -name "Meshy_AI_Animation_*.glb" | while read file; do
       newname=$(echo "$file" | sed 's/Meshy_AI_Animation_//')
       mv "$file" "$newname"
   done
   ```

   Ejemplos de renombrado:
   - `Meshy_AI_Animation_Left_Slash_withSkin.glb` → `Left_Slash_withSkin.glb`
   - `Meshy_AI_Animation_Walking_withSkin.glb` → `Walking_withSkin.glb`
   - `Meshy_AI_Animation_Combat_Stance_withSkin.glb` → `Combat_Stance_withSkin.glb`

**Notas:**
- **⚠️ IMPORTANTE**: Hacer backup de los archivos antes de renombrar
- Verificar que todos los archivos se renombraron correctamente
- Documentar qué archivos no existen en la nueva estructura para referencia futura

**Recursos útiles:**
- Estructura esperada: `biped/male/characters/` y `biped/male/animations/{categoria}/`

---

### Paso 2: Crear Script de Migración de Base de Datos

**Descripción:**
Crear un script que actualice todas las rutas en la base de datos de la estructura antigua a la nueva.

**Archivos a modificar/crear:**
- `backend/src/database/migrations/migrate_biped_structure.py` (nuevo)

**Detalles de implementación:**

```python
"""
Script de migración para actualizar rutas de modelos 3D a estructura biped/male/
"""
import asyncio
import json
from pathlib import Path
import sys

sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from src.database.connection import get_connection


async def migrate_model_paths():
    """Actualizar rutas de modelos en la base de datos"""
    async with get_connection() as conn:
        # Obtener todas las agrupaciones con modelo_3d
        agrupaciones = await conn.fetch("""
            SELECT id, modelo_3d, tipo
            FROM juego_dioses.agrupaciones
            WHERE modelo_3d IS NOT NULL
            AND tipo = 'biped'
        """)
        
        updated = 0
        skipped = 0
        
        for agrupacion in agrupaciones:
            try:
                modelo_3d = json.loads(agrupacion['modelo_3d']) if isinstance(agrupacion['modelo_3d'], str) else agrupacion['modelo_3d']
                
                old_ruta = modelo_3d.get('ruta', '')
                
                # Migrar de estructura antigua a nueva
                new_ruta = None
                
                if old_ruta.startswith('characters/'):
                    # Modelo: characters/Character_output.glb -> biped/male/characters/biped_male.glb
                    if 'Character_output.glb' in old_ruta:
                        new_ruta = 'biped/male/characters/biped_male.glb'
                    else:
                        # Otros modelos de characters (mantener estructura pero mover)
                        filename = old_ruta.replace('characters/', '')
                        new_ruta = f'biped/male/characters/{filename}'
                
                if new_ruta:
                    modelo_3d['ruta'] = new_ruta
                    
                    # Actualizar en BD
                    await conn.execute("""
                        UPDATE juego_dioses.agrupaciones
                        SET modelo_3d = $1::jsonb
                        WHERE id = $2
                    """, json.dumps(modelo_3d), agrupacion['id'])
                    
                    updated += 1
                    print(f"✓ Actualizado {agrupacion['id']}: {old_ruta} -> {new_ruta}")
                else:
                    skipped += 1
                    print(f"⊘ Saltado {agrupacion['id']}: {old_ruta} (no requiere migración)")
                    
            except Exception as e:
                print(f"✗ Error actualizando {agrupacion['id']}: {e}")
        
        print(f"\nResumen: {updated} actualizados, {skipped} saltados")


if __name__ == "__main__":
    asyncio.run(migrate_model_paths())
```

**Notas:**
- Hacer backup de la BD antes de ejecutar
- Ejecutar primero en desarrollo para verificar
- Validar que todas las rutas se actualizaron correctamente

---

### Paso 3: Actualizar Templates de Bipeds

**Descripción:**
Actualizar los templates de bipeds para que usen la nueva ruta del modelo `biped/male/characters/biped_male.glb`.

**Archivos a modificar/crear:**
- `backend/src/database/templates/bipedos/humano.py` (o similar)
- Cualquier otro template de biped que defina modelos

**Detalles de implementación:**

Buscar archivos que definan rutas de modelos y actualizar:

```python
# ANTES:
modelo_3d = Model3D(
    tipo="glb",
    ruta="characters/Character_output.glb",  # o "characters/Meshy_AI_Character_output.glb"
    escala=1.0,
    offset=Model3DOffset(x=0, y=0, z=0),
    rotacion=Model3DRotation(x=0, y=0, z=0)
)

# DESPUÉS:
modelo_3d = Model3D(
    tipo="glb",
    ruta="biped/male/characters/biped_male.glb",
    escala=1.0,
    offset=Model3DOffset(x=0, y=0, z=0),
    rotacion=Model3DRotation(x=0, y=0, z=0)
)
```

**Notas:**
- Buscar todas las referencias a `characters/Character_output.glb` o `characters/Meshy_AI_Character_output.glb`
- Actualizar también `seed_character_with_model.py` si usa rutas hardcodeadas

---

### Paso 4: Actualizar animation-config.js con Nuevas Rutas

**Descripción:**
Actualizar todas las rutas de animaciones en `animation-config.js` para usar:
- Nueva ruta base: `biped/male/animations/`
- Nuevas categorías reorganizadas
- Nombres de archivos sin prefijo `Meshy_AI_Animation_`

**Archivos a modificar/crear:**
- `frontend/src/config/animation-config.js`

**Detalles de implementación:**

**Mapeo de rutas completo:**

```javascript
export const ANIMATION_FILES = {
    // Ataques - shield-and-one-hand-weapon/
    'left_slash': 'biped/male/animations/shield-and-one-hand-weapon/Left_Slash_withSkin.glb',
    'charged_slash': 'biped/male/animations/shield-and-one-hand-weapon/Charged_Slash_withSkin.glb',
    'sword_judgment': 'biped/male/animations/shield-and-one-hand-weapon/Sword_Judgment_withSkin.glb',
    'sword_parry_backward': 'biped/male/animations/shield-and-one-hand-weapon/Sword_Parry_Backward_withSkin.glb',
    'axe_spin_attack': 'biped/male/animations/shield-and-one-hand-weapon/Axe_Spin_Attack_withSkin.glb',
    'shield_push_left': 'biped/male/animations/shield-and-one-hand-weapon/Shield_Push_Left_withSkin.glb',
    
    // Ataques - two-hands-weapon/
    'attack': 'biped/male/animations/two-hands-weapon/Attack_withSkin.glb', // Verificar si existe
    'heavy_hammer_swing': 'biped/male/animations/two-hands-weapon/Heavy_Hammer_Swing_withSkin.glb',
    
    // Ataques - cuffs/
    'simple_kick': 'biped/male/animations/cuffs/Simple_Kick_withSkin.glb',
    
    // Movimiento - movement/
    'walk': 'biped/male/animations/movement/Walking_withSkin.glb',
    'walking': 'biped/male/animations/movement/Walking_withSkin.glb', // Alias
    'run': 'biped/male/animations/movement/Running_withSkin.glb',
    'running': 'biped/male/animations/movement/Running_withSkin.glb', // Alias
    'regular_jump': 'biped/male/animations/movement/Regular_Jump_withSkin.glb',
    'roll_dodge': 'biped/male/animations/movement/Roll_Dodge_1_withSkin.glb',
    'spear_walk': 'biped/male/animations/movement/Spear_Walk_withSkin.glb',
    'swimming_to_edge': 'biped/male/animations/movement/swimming_to_edge_withSkin.glb',
    
    // Idle/Stance - movement/ (movidas desde idle/)
    'combat_stance': 'biped/male/animations/movement/Combat_Stance_withSkin.glb',
    'idle_11': 'biped/male/animations/movement/Idle_11_withSkin.glb',
    'swim_idle': 'biped/male/animations/movement/Swim_Idle_withSkin.glb',
    
    // Crouch movements - movement/
    'crouch_walk_forward': 'biped/male/animations/movement/Cautious_Crouch_Walk_Forward_inplace_withSkin.glb',
    'crouch_walk_right': 'biped/male/animations/movement/Cautious_Crouch_Walk_Right_inplace_withSkin.glb',
    
    // Reacciones/Daño - hit-reactions/
    'hit_reaction': 'biped/male/animations/hit-reactions/Hit_Reaction_withSkin.glb', // Verificar nombre exacto
    'electrocution_reaction': 'biped/male/animations/hit-reactions/Electrocution_Reaction_withSkin.glb',
    'sword_parry_backward_2': 'biped/male/animations/hit-reactions/Sword_Parry_Backward_2_withSkin.glb',
    
    // Transiciones - transitions/
    'stand_up': 'biped/male/animations/transitions/Stand_Up2_withSkin.glb',
    
    // Interacciones - interactions/
    'collect_object': 'biped/male/animations/interactions/Collect_Object_withSkin.glb',
    'stand_and_drink': 'biped/male/animations/interactions/Stand_and_Drink_withSkin.glb',
    'dive_down_and_land': 'biped/male/animations/interactions/Dive_Down_and_Land_2_withSkin.glb',
    
    // Animaciones que pueden no existir (comentar si no están disponibles):
    // 'charged_upward_slash': '...', // hammer/ no existe en nueva estructura
    // 'charged_axe_chop': '...', // two-hand-axe/ no existe
    // 'double_blade_spin': '...', // two-swords/ no existe
    // 'charged_spell_cast': '...', // skills/ no existe
};
```

**Notas:**
- **⚠️ IMPORTANTE**: Verificar que cada archivo existe antes de agregarlo al config
- Si una animación no existe en la nueva estructura, comentarla con nota
- Mantener aliases para compatibilidad (ej: `walking` → `walk`)

---

### Paso 5: Verificar y Actualizar Referencias en Código

**Descripción:**
Buscar y actualizar cualquier referencia hardcodeada a rutas antiguas en el código.

**Archivos a modificar/crear:**
- Cualquier archivo que tenga referencias a `characters/Character_output.glb`
- Cualquier archivo que tenga referencias a `animations/biped/...`

**Detalles de implementación:**

1. **Buscar referencias en backend:**
   ```bash
   grep -r "characters/Character_output" backend/src/
   grep -r "Meshy_AI_Character_output" backend/src/
   ```

2. **Buscar referencias en frontend:**
   ```bash
   grep -r "characters/" frontend/src/
   grep -r "animations/biped" frontend/src/
   ```

3. **Actualizar referencias encontradas** según el nuevo formato:
   - `characters/Character_output.glb` → `biped/male/characters/biped_male.glb`
   - `animations/biped/...` → `biped/male/animations/...`
   - `Meshy_AI_Animation_...` → (sin prefijo)

**Notas:**
- Verificar especialmente `seed_character_with_model.py`
- Verificar comentarios y documentación

---

### Paso 6: Ejecutar Migración de Base de Datos

**Descripción:**
Ejecutar el script de migración en el entorno de desarrollo para actualizar todas las rutas en la BD.

**Archivos a modificar/crear:**
- Ninguno (ejecutar script)

**Detalles de implementación:**

```bash
# Desde el directorio del proyecto
cd backend
python src/database/migrations/migrate_biped_structure.py
```

**Validación:**
```sql
-- Verificar que las rutas se actualizaron correctamente
SELECT id, modelo_3d->>'ruta' as ruta
FROM juego_dioses.agrupaciones
WHERE tipo = 'biped'
AND modelo_3d IS NOT NULL;
```

**Notas:**
- **⚠️ IMPORTANTE**: Hacer backup de BD antes de ejecutar
- Ejecutar primero en desarrollo
- Verificar resultados antes de ejecutar en producción

---

### Paso 7: Probar Carga de Modelos y Animaciones

**Descripción:**
Verificar que el frontend puede cargar correctamente modelos y animaciones desde las nuevas ubicaciones.

**Archivos a modificar/crear:**
- Ninguno (testing)

**Detalles de implementación:**

1. **Probar carga de modelo:**
   - Crear/cargar un personaje en el juego
   - Verificar que el modelo carga desde `biped/male/characters/biped_male.glb`
   - Verificar que no hay errores en consola

2. **Probar animaciones:**
   - Mover personaje (walk, run)
   - Atacar (attack, left_slash)
   - Verificar que todas las animaciones cargan y reproducen correctamente
   - Verificar consola para errores de carga

3. **Verificar endpoint:**
   ```bash
   curl http://localhost:8000/api/v1/dimensions/{dim_id}/characters/{char_id}/model
   ```
   Debe retornar: `{"model_url": "/static/models/biped/male/characters/biped_male.glb", ...}`

**Notas:**
- Probar todas las animaciones usadas en el juego
- Verificar que no hay 404s en la consola del navegador
- Probar tanto personajes nuevos como existentes (después de migración)

---

### Paso 8: Actualizar Documentación

**Descripción:**
Actualizar READMEs y documentación para reflejar la nueva estructura de archivos.

**Archivos a modificar/crear:**
- `backend/src/api/routes/README.md` (si documenta rutas de modelos)
- `backend/src/database/templates/bipedos/README.md` (si existe)
- `frontend/src/config/README.md` (si documenta animaciones)

**Detalles de implementación:**

Actualizar cualquier referencia a:
- Estructura antigua: `characters/`, `animations/biped/`
- Nombres antiguos: `Character_output.glb`, `Meshy_AI_Animation_...`
- Nueva estructura: `biped/male/characters/`, `biped/male/animations/`
- Nuevos nombres: `biped_male.glb`, animaciones sin prefijo

**Notas:**
- Verificar todos los READMEs relacionados
- Actualizar ejemplos de código
- Actualizar diagramas si existen

---

### Paso Final: Generar Descripción del Pull Request

**Descripción:**
Una vez completados todos los pasos anteriores y verificada la implementación, genera la descripción completa del Pull Request usando la regla `@pr-description.mdc`.

**Comando a ejecutar:**
```
@pr-description.mdc
```

**Resultado esperado:**
- Archivo generado: `JDG-033_pr-description_[FECHA-HORA].md` en `/instructions/prs/` (con fecha y hora obtenida de `Get-Date -Format "yyyy-MM-dd_HH-mm-ss"`)
- El archivo contendrá una descripción completa del PR lista para copiar y pegar en Git
- Incluirá: título, resumen, motivación, cambios técnicos, testing, referencias y riesgos

**Notas:**
- Este paso se ejecuta DESPUÉS de completar toda la implementación
- La descripción se genera automáticamente basándose en los cambios realizados
- El desarrollador solo necesita copiar y pegar el contenido en Git
- No editar manualmente a menos que sea estrictamente necesario

---

## Consideraciones Técnicas

### Performance
- La migración no afecta el rendimiento (solo cambia rutas)
- El sistema de cache del frontend seguirá funcionando igual
- Las rutas son más cortas (sin prefijos innecesarios) mejoran ligeramente el rendimiento

### Seguridad
- No hay cambios en seguridad, solo reorganización de archivos
- Validar rutas en el script de migración para evitar paths incorrectos

### Casos Edge
- **Personajes con rutas personalizadas**: El script de migración debe validar y reportar rutas no migrables
- **Archivos faltantes**: Validar que todos los archivos existen antes de actualizar rutas
- **Cache del navegador**: Agregar cache buster o invalidar cache después de migración
- **Animaciones no encontradas**: Comentar o usar fallbacks para animaciones que no existen en nueva estructura

### Compatibilidad
- Mantener compatibilidad temporal con rutas antiguas durante migración (opcional)
- Los aliases en `animation-config.js` mantienen compatibilidad con código existente

## Patrones de Código a Usar

- **Backend (FastAPI)**: 
  - Scripts de migración asíncronos con asyncpg
  - Validación de datos antes de actualizar BD
  - Logging estructurado para tracking de migración

- **Frontend (Three.js)**: 
  - Configuración centralizada en `animation-config.js`
  - Aliases para mantener compatibilidad
  - Manejo de errores en carga de animaciones

## Dependencias

### Nuevas Dependencias (si aplica)
Ninguna

### Variables de Entorno (si aplica)
Ninguna nueva

## Archivos Principales Involucrados

1. `backend/src/database/migrations/migrate_biped_structure.py` - Script de migración (nuevo)
2. `backend/src/database/templates/bipedos/` - Templates de bipeds (actualizar)
3. `backend/src/database/seed_character_with_model.py` - Script de seed (verificar)
4. `frontend/src/config/animation-config.js` - Configuración de animaciones (actualizar)
5. `backend/static/models/biped/male/` - Estructura de archivos (renombrar)

## Testing

### Tests a Crear/Modificar
- Unit tests: Verificar que el script de migración actualiza rutas correctamente
- Integration tests: Verificar que modelos y animaciones cargan desde nuevas ubicaciones

### Escenarios de Prueba
1. **Cargar personaje existente**: Verificar que carga modelo desde nueva ubicación
2. **Crear nuevo personaje**: Verificar que usa nueva ruta en BD
3. **Reproducir animaciones**: Verificar que todas las animaciones cargan y reproducen
4. **Endpoint de modelo**: Verificar que retorna nueva ruta
5. **Migración de BD**: Verificar que todas las rutas se actualizaron correctamente

## Deployment

### Orden de Deployment
1. **Backend**: 
   - Renombrar archivos en servidor
   - Ejecutar script de migración de BD (con backup previo)
   - Reiniciar si es necesario
2. **Frontend**: 
   - Deploy archivos actualizados de `animation-config.js`
   - Invalidar cache del navegador si es necesario
3. **Verificación**: 
   - Verificar que modelos cargan correctamente
   - Verificar que animaciones funcionan
   - Verificar logs para errores

### Verificación Post-Deployment
- [ ] Verificar endpoint `/api/v1/dimensions/{id}/characters/{id}/model` retorna nueva ruta
- [ ] Verificar que personajes cargan correctamente en el juego
- [ ] Verificar que animaciones reproducen sin errores
- [ ] Verificar logs de backend para errores 404
- [ ] Verificar consola del navegador para errores de carga

---

**Nota Final:** Este plan debe ejecutarse paso a paso, verificando cada paso antes de continuar con el siguiente. Hacer backups antes de cualquier operación de renombrado o migración de BD.

**⚠️ IMPORTANTE:** El último paso del plan SIEMPRE debe ser "Generar Descripción del Pull Request" usando `@pr-description.mdc`. Esto genera automáticamente la descripción completa del PR lista para Git.
