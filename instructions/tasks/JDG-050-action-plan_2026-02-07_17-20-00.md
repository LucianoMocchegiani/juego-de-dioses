# JDG-050 - Action Plan: Refactorizar `renderParticles()` en pipeline modular

Fecha: 2026-02-07_17-20-00

## Objetivo
Dividir el método `renderParticles()` de `frontend/src/terrain/renderers/particle-renderer.js` en un orquestador ligero que delegue en helpers/módulos independientes (culling, LOD, limiter, grouper, instancer) para mejorar la legibilidad, testabilidad y mantenibilidad sin cambiar funcionalidad.

## Alcance
Incluye extracción incremental de helpers, tests unitarios para cada helper, actualización de exports y documentación del flujo. No incluye cambios en lógica algorítmica salvo reordenamientos que no alteren resultados visibles.

## Criterios de Aceptación
- [ ] `renderParticles()` reducido a orquestador que llama a helpers privados/modulares.  
- [ ] Helpers extraídos: `culling.js`, `lod.js`, `limiter.js`, `grouper.js`, `instancer.js`.  
- [ ] Tests unitarios para cada helper (coverage mínima en esas funciones).  
- [ ] Integración demo sin regresiones visuales (conteos y posiciones iguales).  
- [ ] No errores de lint y PR(s) listos para revisión.  
- [ ] Documentación actualizada (`frontend/src/terrain/renderers/README.md` y notas en `instructions/`).

## Dependencias
- JDG-008, JDG-008-2 (optimización/ buenas prácticas) — recomendado completados.  
- `frontend/src/rendering/optimizations/*` y `geometryRegistry` disponibles.  
- Herramienta de tests configurada (jest/mocha) o entorno de pruebas disponible.

## Estimación total
4–6 horas (iterativo, en 4 fases). Recomendar commits/PRs por paso.

## Pasos (ordenados)
  

1) Paso 1 — Extraer `applyFrustumCulling` (Responsable: developer)  
   - Descripción: Crear `frontend/src/rendering/optimizations/particles-pipeline/culling.js` con `applyFrustumCulling(particles, camera, cellSize)` y mover la lógica correspondiente fuera de `renderParticles()`. Añadir test unitario. Actualizar `particle-renderer.js` para llamar al helper.  
   - Archivos a crear/modificar:  
     - `frontend/src/rendering/optimizations/particles-pipeline/culling.js` (nuevo)  
     - `frontend/src/terrain/renderers/particle-renderer.js` (modificar)  
     - `tests/optimizations/culling.test.js` (nuevo)  
   - Estimación: 60–90 min  
   - Verificación: Tests unitarios pasan; salida de IDs/conteos igual que antes para un caso de prueba snapshot.  

2) Paso 2 — Extraer LOD y Limiter (Responsable: developer)  
   - Descripción: Crear `lod.js` y `limiter.js` en `particles-pipeline/`. Implementar Strategy básico para LOD y config para limiter. Añadir tests. Integrar en `renderParticles()` orquestador.  
   - Archivos a crear/modificar:  
     - `frontend/src/rendering/optimizations/particles-pipeline/lod.js` (nuevo)  
     - `frontend/src/rendering/optimizations/particles-pipeline/limiter.js` (nuevo)  
     - `tests/optimizations/lod.test.js`, `tests/optimizations/limiter.test.js` (nuevos)  
     - `frontend/src/terrain/renderers/particle-renderer.js` (modificar)  
   - Estimación: 90–120 min  
   - Verificación: Tests pasan; demo sin regresiones; performance similar (timings por etapa medidos).  

3) Paso 3 — Extraer Grouping y Instancing (Responsable: developer)  
   - Descripción: Implementar `grouper.js` (agrupa por geometry+material y separa opacos/transparencias) y `instancer.js` (crea InstancedMesh y añade a la escena). Mantener side-effects sólo en instancer. Añadir tests unitarios para grouping y pruebas de integración para instancing.  
   - Archivos a crear/modificar:  
     - `frontend/src/rendering/optimizations/particles-pipeline/grouper.js` (nuevo)  
     - `frontend/src/rendering/optimizations/particles-pipeline/instancer.js` (nuevo)  
     - `tests/optimizations/grouper.test.js`, `tests/renderers/instancer.integration.test.js`  
     - `frontend/src/terrain/renderers/particle-renderer.js` (modificar)  
   - Estimación: 120–180 min  
   - Verificación: Tests unitarios e integración visual OK; conteos y posiciones iguales; no leaks de memoria en instancing básico.  

4) Paso 4 — Limpieza, documentación y PRs (Responsable: developer)  
   - Descripción: Refactorizar exports, mover helpers a `rendering/optimizations/particles-pipeline/`, actualizar `frontend/src/terrain/renderers/README.md`, agregar ejemplos en README, ejecutar lints y link-checker. Crear PR(s) por cada fase (recomendado).  
   - Archivos a modificar/crear: README(s), `instructions/prs/JDG-050_pr-description_...md`  
   - Estimación: 30–60 min  
   - Verificación: Lints limpios, link-checker OK, PR(s) creados con descripción y checklist completado.

## Riesgos y mitigaciones
- Riesgo: Regresiones visuales o de conteo. Mitigación: tests de integración + revisión manual del demo antes de merge.  
- Riesgo: Pequeñas diferencias de orden que afecten snapshots. Mitigación: usar aserciones tolerantes (comparar sets/contadores) y pruebas visuales.  
- Riesgo: Overhead por modularización. Mitigación: medir timings por etapa y optimizar (preservar funciones puras cuando sea posible).

## Output esperado
- Nuevos archivos en `frontend/src/rendering/optimizations/particles-pipeline/` (culling/lod/limiter/grouper/instancer).  
- `particle-renderer.js` convertido en orquestador con llamadas claras a helpers.  
- Tests unitarios y de integración añadidos.  
- PRs por fase con descripciones y checklist.  

## Notas finales
- Hacer commits pequeños y autónomos (1 helper por commit).  
- Mantener logs/instrumentación para medir impacto de cambios (PerformanceManager).  
- Si durante la extracción se detecta código duplicado o utilidades transversales, extraer a `rendering/optimizations/utils/` y documentar.

