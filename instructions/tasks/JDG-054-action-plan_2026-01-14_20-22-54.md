# JDG-054 - Unificar Transiciones de Animación entre Gameplay Normal y F6

## Descripción de la Tarea

Unificar el comportamiento de transiciones en `playAnimation()` para que sea igual al de `playAnimationByName()` (F6). Esto hará que las transiciones sean más suaves y consistentes, igual que en la herramienta de debugging.

**Problema identificado:**
- `playAnimationByName()` (F6) siempre hace `fadeOut` de la animación anterior y usa `clampWhenFinished = true`
- `playAnimation()` (gameplay normal) hace `fadeOut` condicionalmente y usa `clampWhenFinished = false` para one-shot
- Esto causa diferencias visuales en las transiciones

**Comportamiento esperado:**
- Las transiciones en gameplay normal deben ser iguales a las de F6 (herramienta de debugging)
- Las transiciones deben ser visualmente suaves sin "saltos" de posición
- No debe haber diferencias visuales entre gameplay normal y F6

## Criterios de Aceptación

1. ✅ Las transiciones en gameplay normal son iguales a las de F6 (herramienta de debugging)
2. ✅ Las transiciones entre todas las animaciones son visualmente suaves
3. ✅ No hay regresiones en otras funcionalidades de animación o combate

## Contexto del Proyecto

### Proyecto(s) Afectado(s)
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js (AnimationMixer)
- ECS (Entity Component System)
- Sistema de animaciones (AnimationMixerSystem)
- Herramientas de debugging (F6 - TestInterface)

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/animation-mixer-system.js` - Unificar lógica de transiciones

## Pasos de Implementación

### Paso 1: Unificar Transiciones entre Gameplay Normal y F6 ✅ COMPLETADO

**Descripción:**
Unificar el comportamiento de transiciones en `playAnimation()` para que sea igual al de `playAnimationByName()` (F6). Esto hará que las transiciones sean más suaves y consistentes, igual que en la herramienta de debugging.

**Problema identificado:**
- `playAnimationByName()` (F6) siempre hace `fadeOut` de la animación anterior y usa `clampWhenFinished = true`
- `playAnimation()` (gameplay normal) hace `fadeOut` condicionalmente y usa `clampWhenFinished = false` para one-shot
- Esto causa diferencias visuales en las transiciones

**Archivos a modificar:**
- `frontend/src/ecs/systems/animation-mixer-system.js`

**Cambios realizados:**

1. **FadeOut unificado:**
   - Antes: Lógica condicional con casos especiales para `combat_stance`
   - Ahora: Siempre hacer `fadeOut` si hay animación anterior corriendo y el estado cambió (igual que `playAnimationByName`)

2. **clampWhenFinished = true:**
   - Antes: `clampWhenFinished = false` para one-shot
   - Ahora: `clampWhenFinished = true` para one-shot (igual que F6)
   - Esto mantiene la animación en el último frame, evitando saltos visuales

**Notas:**
- Cambio 1: Siempre hacer `fadeOut` si hay animación anterior corriendo y el estado cambió (igual que F6)
- Cambio 2: Usar `clampWhenFinished = true` para one-shot (igual que F6)
- Esto unifica el comportamiento entre gameplay normal y F6
- Las transiciones serán más suaves y consistentes
- No afecta la lógica de protección de interrupción ni otras funcionalidades

**Testing:**
- ✅ Probar transiciones de `combat_stance` → ataque → `combat_stance`
- ✅ Comparar visualmente con F6 para verificar que son iguales
- ✅ Verificar que no hay regresiones en otras animaciones

---

## Notas Adicionales

**Trabajo pendiente:**
- El problema de desplazamiento durante animaciones (root motion) se ha movido a un ticket separado (JDG-055) para ser abordado más adelante
- Este ticket solo incluye la unificación de transiciones, que mejora la consistencia visual pero no resuelve el desplazamiento

## Referencias

- Ticket original: `instructions/tickets/JDG-054_work-ticket_2026-01-14_19-09-43.md`
- Análisis de arquitectura: `instructions/analysis/JDG-054-architecture-analysis_2026-01-14_19-24-01.md`
- Herramientas de debugging: `frontend/src/interfaces/test-interface.js` (F6)
