# JDG-001 - Árboles atraviesan límites de dimensión

## Tipo
- [ ] Feature (nueva funcionalidad)
- [x] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Las raíces de los árboles creados en el seed demo están fuera del límite del suelo. Esto ocurre porque:

1. El suelo/terreno está en z=0 (superficie)
2. Las raíces de los árboles se crean en z=-1 (debajo del suelo)
3. Aunque z=-1 está dentro del rango de profundidad_maxima (-5), las raíces están visualmente/conceptualmente fuera del suelo
4. Esto causa que las raíces se rendericen incorrectamente o aparezcan flotando/atravesando el límite del suelo en el frontend
5. Las raíces deberían estar dentro del suelo (z=0) o al menos no atravesar el límite visual del terreno

### Comportamiento Actual

- El script `seed_demo.py` crea árboles con raíces en z=-1 (debajo del suelo)
- El suelo/terreno está en z=0 (superficie)
- Las raíces se crean como partículas de madera en z=-1, lo que las coloca debajo del terreno
- Visualmente, las raíces atraviesan o aparecen fuera del límite del suelo
- El frontend renderiza las raíces en z=-1, que pueden aparecer flotando o atravesando el suelo
- No hay validación que verifique que las raíces estén dentro del suelo o en una posición válida

### Comportamiento Esperado

- Las raíces de los árboles deben estar dentro del suelo (z=0) o al menos no atravesar el límite visual del terreno
- Las raíces pueden estar en z=0 (mismo nivel que el suelo) o en z positivos si el suelo tiene profundidad
- El script de seed debe crear las raíces en una posición que respete el límite del suelo
- El frontend debe renderizar las raíces correctamente dentro o sobre el suelo, sin que atraviesen límites
- Las raíces deben ser visibles pero no deben aparecer flotando o atravesando el terreno

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [ ] Frontend (Three.js)
- [x] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Python 3.11, FastAPI, asyncpg
- PostgreSQL 16
- Scripts SQL de inicialización

### Archivos/Componentes Principales
- `backend/src/database/seed_demo.py` - Script que crea los árboles sin validar límites
- `database/init/01-init-schema.sql` - Esquema de la tabla `dimensiones` con campos `ancho_metros`, `alto_metros`, `profundidad_maxima`, `altura_maxima`
- Posiblemente `backend/src/api/routes/particles.py` - Para validar límites en endpoints de creación

## Criterios de Aceptación

1. [ ] Las raíces de los árboles están en z=0 (mismo nivel que el suelo) o en una posición válida dentro del terreno
2. [ ] Las raíces no atraviesan el límite visual del suelo en el frontend
3. [ ] El script `seed_demo.py` crea las raíces en una posición que respeta el límite del suelo
4. [ ] El frontend renderiza las raíces correctamente, sin que aparezcan flotando o atravesando el terreno
5. [ ] Las raíces son visibles y se integran correctamente con el terreno
6. [ ] Se agregan tests unitarios que verifiquen la posición correcta de las raíces

**Nota:** Cada criterio debe ser específico, medible y verificable.

## Detalles de Implementación

### Pasos Sugeridos

1. **Modificar seed_demo.py para cambiar posición de raíces**
   - Cambiar las raíces de z=-1 a z=0 (mismo nivel que el suelo)
   - Las raíces deben estar en el mismo nivel que el terreno de hierba
   - Mantener la estructura del árbol (raíz + tronco + hojas) pero ajustar la posición Z

2. **Ajustar estructura de raíces si es necesario**
   - Si las raíces en z=0 causan conflicto con el terreno de hierba, considerar:
     - Crear raíces en z=0 pero en celdas diferentes (no superponer con hierba)
     - O crear raíces como parte del suelo (mismo z pero tipo diferente)
     - O ajustar la lógica para que raíces y hierba puedan coexistir en z=0

3. **Verificar renderizado en frontend**
   - Asegurar que las raíces en z=0 se rendericen correctamente
   - Verificar que no haya conflictos visuales entre raíces y terreno de hierba
   - Asegurar que las raíces no atraviesen límites visuales

4. **Actualizar documentación si es necesario**
   - Si cambia la lógica de cómo se crean las raíces, actualizar comentarios en el código
   - Documentar que las raíces deben estar en z=0 (nivel del suelo)

5. **Agregar tests**
   - Test que verifique que las raíces se crean en z=0
   - Test que verifique que las raíces no están en z negativo (debajo del suelo)
   - Test que verifique la estructura completa del árbol (raíz + tronco + hojas)

### Consideraciones Técnicas

- **Compatibilidad con terreno**: Las raíces en z=0 pueden superponerse con el terreno de hierba. Considerar si esto es deseable o si se necesita lógica especial.
- **Visualización**: Asegurar que raíces y hierba se rendericen correctamente cuando están en el mismo z.
- **Lógica de núcleo**: Las raíces son el núcleo de los árboles. Asegurar que cambiar su posición no afecte la lógica de conectividad del núcleo.
- **Compatibilidad**: Si hay partículas ya creadas con raíces en z=-1, considerar migración o dejar ambas versiones funcionando.

### Dependencias

- Depende de: Ninguna
- Bloquea: Ninguna (pero debe resolverse antes de crear más contenido)

## Testing

### Escenarios de Prueba

1. **Escenario 1: Raíces en z=0**
   - Ejecutar `seed_demo.py`
   - Verificar que todas las raíces se crean en z=0 (no en z=-1)
   - Verificar que los 3 árboles tienen raíces en el nivel del suelo
   - Verificar que la estructura del árbol (raíz + tronco + hojas) se mantiene correcta

2. **Escenario 2: Renderizado en frontend**
   - Visualizar la dimensión en el frontend
   - Verificar que las raíces no atraviesan el límite del suelo
   - Verificar que las raíces se renderizan correctamente en z=0
   - Verificar que no hay conflictos visuales entre raíces y terreno de hierba

3. **Escenario 3: Integridad del árbol**
   - Verificar que las raíces siguen siendo el núcleo del árbol
   - Verificar que la conectividad del núcleo funciona correctamente
   - Verificar que el árbol completo (raíz + tronco + hojas) se crea sin errores

### Casos Edge a Considerar

- Superposición con terreno: Si raíces y hierba están en z=0, verificar que no haya conflictos
- Múltiples árboles: Todos deben tener raíces en z=0 correctamente
- Árboles en bordes: Las raíces deben estar dentro de los límites horizontales (x, y)
- Núcleo del árbol: Asegurar que cambiar raíces de z=-1 a z=0 no afecte la lógica de núcleo

## Estimación

- **Complejidad:** Baja
- **Tiempo estimado:** 1-2 horas
- **Notas:** 
  - El cambio principal es modificar z=-1 a z=0 en el código de creación de raíces
  - Puede requerir ajustes en la lógica de superposición con el terreno
  - Los tests son importantes para verificar el renderizado correcto

## Referencias

- **Relacionado con:** Seed demo inicial (JDG-000)
- **Documentación relevante:** 
  - `database/init/01-init-schema.sql` - Estructura de tabla `dimensiones`
  - `backend/src/database/seed_demo.py` - Script actual que tiene el bug
- **Discusiones previas:** Bug identificado al levantar el proyecto y visualizar en frontend

## Notas Adicionales

- Este es un bug visual que afecta la presentación correcta del mundo
- Las raíces en z=-1 están técnicamente dentro del rango de profundidad_maxima (-5), pero visualmente están fuera del suelo
- La solución es simple: cambiar las raíces de z=-1 a z=0
- Considerar si las raíces deben superponerse con el terreno de hierba o si necesitan lógica especial para coexistir

