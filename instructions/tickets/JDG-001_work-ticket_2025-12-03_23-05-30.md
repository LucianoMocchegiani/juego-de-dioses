# JDG-001 - Reglas de construcción de terrenos y límites de dimensión

## Tipo
- [x] Feature (nueva funcionalidad)
- [x] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

**Feature: Reglas de construcción de terrenos (PRIORITARIO)**

Se deben establecer reglas de construcción de terrenos para que los dioses puedan crear mundos de forma consistente y controlada. La regla más importante es:

**Regla Principal: Partículas Límite Indestructibles**

En el límite inferior de la dimensión (profundidad_maxima) debe colocarse una capa de partículas indestructibles y transparentes que actúen como barrera del mundo. Estas partículas:

- **Nombre sugerido**: `límite` (alternativas: `barrera`, `frontera_dimensional`, `base_indestructible`)
- **Propiedades**:
  - Son indestructibles (no pueden ser extraídas o modificadas por los dioses)
  - Son transparentes (para no interferir visualmente con el mundo)
  - Se colocan automáticamente en `z = profundidad_maxima` (límite inferior)
  - Cubren todo el área horizontal de la dimensión (x_min a x_max, y_min a y_max)
  - Forman una capa completa en el límite inferior

**Uso adicional de partículas límite:**
- También pueden usarse para el cielo (límite superior en `z = altura_maxima`)
- Pueden usarse en los laterales de la dimensión (límites en x e y)
- Actúan como barreras invisibles que definen los límites del mundo

**Objetivo:**
Establecer estas reglas como base para que cuando los dioses creen contenido, tengan referencias claras de los límites del mundo y no puedan crear partículas fuera de los límites válidos.

**3. Feature: Ejemplos de creación de terrenos con nivel de detalle**

Para que los dioses puedan crear terrenos de forma efectiva, se deben crear archivos de documentación detallados con ejemplos de construcción de diferentes tipos de terrenos, biomas, zonas subterráneas y características geológicas. Estos ejemplos servirán como guía y referencia para la creación de mundos.

**Tipos de ejemplos a documentar:**
- **Biomas**: Bosques, desiertos, tundras, praderas, selvas, montañas, etc.
- **Zonas subterráneas**: Cuevas, túneles, minas, sistemas de cavernas
- **Acuíferos y napas subterráneas**: Agua subterránea, manantiales, ríos subterráneos
- **Estructuras geológicas**: Capas de roca, sedimentos, suelos, formaciones minerales
- **Características del terreno**: Valles, colinas, mesetas, depresiones, llanuras

**Formato de los archivos:**
- Cada ejemplo debe estar en un archivo separado con nombre descriptivo
- Debe incluir estructura de capas (qué partículas en qué niveles z)
- Debe incluir distribución espacial (cómo se distribuyen las partículas en x, y)
- Debe incluir propiedades de las partículas (densidad, temperatura, etc.)
- Debe incluir reglas de generación (cómo crear el terreno paso a paso)

### Comportamiento Actual

- No existen reglas claras para la construcción de terrenos
- No hay ejemplos documentados de cómo crear diferentes tipos de biomas o zonas
- Los dioses no tienen referencias de cómo estructurar terrenos complejos
- No hay documentación sobre cómo crear acuíferos, napas subterráneas o zonas subterráneas

### Comportamiento Esperado

**Feature: Reglas de construcción de terrenos**
- Al crear una dimensión, se debe generar automáticamente una capa de partículas `límite` en `z = profundidad_maxima`
- Las partículas `límite` deben ser indestructibles (no pueden ser extraídas o modificadas)
- Las partículas `límite` deben ser transparentes (opacity < 1.0 o completamente transparentes)
- Las partículas `límite` deben cubrir todo el área horizontal de la dimensión
- Las partículas `límite` deben renderizarse en el frontend como transparentes (o no renderizarse si son completamente invisibles)
- Opcionalmente, se pueden crear partículas `límite` en el cielo (z = altura_maxima) y laterales (x_min, x_max, y_min, y_max)

**Feature: Ejemplos de creación de terrenos**
- Existen archivos de documentación detallados con ejemplos de construcción de diferentes biomas
- Existen ejemplos de zonas subterráneas (cuevas, túneles, sistemas de cavernas)
- Existen ejemplos de acuíferos y napas subterráneas con diferentes configuraciones
- Cada ejemplo incluye estructura de capas, distribución espacial, propiedades de partículas y reglas de generación
- Los ejemplos están organizados en archivos separados con nombres descriptivos
- Los ejemplos sirven como guía para que los dioses creen terrenos complejos y realistas

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [ ] Frontend (Three.js)
- [x] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Python 3.11, FastAPI, asyncpg
- PostgreSQL 16
- Scripts SQL de inicialización

### Archivos/Componentes Principales
- `database/init/01-init-schema.sql` - Esquema de la tabla `dimensiones` con campos `ancho_metros`, `alto_metros`, `profundidad_maxima`, `altura_maxima`
- `backend/src/api/routes/particles.py` - Para validar límites en endpoints de creación
- `instructions/examples/terrenos/` - Carpeta para archivos de ejemplos de construcción de terrenos (a crear)
  - `bioma-bosque.md` - Ejemplo de construcción de bosque
  - `bioma-desierto.md` - Ejemplo de construcción de desierto
  - `zona-subterranea-cueva.md` - Ejemplo de construcción de cueva
  - `acuifero-napa-subterranea.md` - Ejemplo de construcción de acuífero/napa
  - `estructura-geologica-capas.md` - Ejemplo de estructura geológica con capas
  - (más ejemplos según necesidad)

## Criterios de Aceptación

### Feature: Reglas de construcción de terrenos (PRIORITARIO)
1. [ ] Existe un tipo de partícula `límite` (o nombre acordado) en la base de datos
2. [ ] Las partículas `límite` tienen la propiedad de ser indestructibles (no pueden ser extraídas)
3. [ ] Las partículas `límite` son transparentes (opacity < 1.0 o completamente transparentes)
4. [ ] Al crear una dimensión, se genera automáticamente una capa de partículas `límite` en `z = profundidad_maxima`
5. [ ] La capa de partículas `límite` cubre todo el área horizontal de la dimensión (x_min a x_max, y_min a y_max)
6. [ ] El sistema valida que los dioses no puedan crear partículas fuera de los límites definidos
7. [ ] El frontend renderiza las partículas `límite` como transparentes (o no las renderiza si son invisibles)
8. [ ] Se documenta cómo usar partículas `límite` para cielo y laterales (opcional para esta fase)
9. [ ] Se agregan tests unitarios que verifiquen la creación automática de partículas `límite`
10. [ ] Se agregan tests que verifiquen que las partículas `límite` no pueden ser extraídas o modificadas

### Feature: Ejemplos de creación de terrenos
1. [ ] Existe carpeta `instructions/examples/terrenos/` con archivos de ejemplos
2. [ ] Existe al menos un ejemplo de bioma (bosque, desierto, tundra, etc.)
3. [ ] Existe al menos un ejemplo de zona subterránea (cueva, túnel, sistema de cavernas)
4. [ ] Existe al menos un ejemplo de acuífero o napa subterránea
5. [ ] Cada ejemplo incluye estructura de capas (qué partículas en qué niveles z)
6. [ ] Cada ejemplo incluye distribución espacial (cómo se distribuyen las partículas en x, y)
7. [ ] Cada ejemplo incluye propiedades de las partículas (densidad, temperatura, etc.)
8. [ ] Cada ejemplo incluye reglas de generación paso a paso
9. [ ] Los ejemplos están escritos con suficiente nivel de detalle para que los dioses puedan replicarlos
10. [ ] Los ejemplos cubren casos comunes de construcción de terrenos

**Nota:** Cada criterio debe ser específico, medible y verificable.

## Detalles de Implementación

### Pasos Sugeridos (Orden de Prioridad)

#### FASE 1: Reglas de construcción de terrenos (PRIORITARIO)

1. **Crear tipo de partícula `límite` en base de datos**
   - Agregar tipo `límite` en `tipos_particulas` con propiedades:
     - `nombre`: "límite" (o nombre acordado)
     - `categoria`: "sistema" o "límite"
     - `estilos`: Color transparente (opacity: 0.0 o muy bajo)
     - Marcar como tipo especial que no puede ser extraído

2. **Implementar lógica de creación automática de partículas límite**
   - Al crear una dimensión, generar automáticamente partículas `límite` en `z = profundidad_maxima`
   - Crear una capa completa que cubra todo el área horizontal (x_min a x_max, y_min a y_max)
   - Implementar en el script de seed o en la lógica de creación de dimensiones

3. **Implementar validación de indestructibilidad**
   - Agregar flag `indestructible` a partículas `límite` (puede ser campo en tabla o lógica en backend)
   - Validar en endpoints de extracción que las partículas `límite` no puedan ser extraídas
   - Retornar error si se intenta extraer o modificar una partícula `límite`

4. **Renderizado transparente en frontend**
   - Modificar `scene.js` para renderizar partículas `límite` como transparentes
   - O no renderizarlas si son completamente invisibles (opacity: 0.0)
   - Asegurar que no interfieran visualmente con el mundo

5. **Documentar uso para cielo y laterales (opcional)**
   - Documentar cómo extender las partículas `límite` al cielo (z = altura_maxima)
   - Documentar cómo crear límites laterales (x_min, x_max, y_min, y_max)
   - Dejar implementación de cielo/laterales para futuras fases

6. **Crear archivos de ejemplos de construcción de terrenos**
   - Crear carpeta `instructions/examples/terrenos/`
   - Escribir ejemplo de bioma (ej: `bioma-bosque.md`) con:
     - Estructura de capas (suelo, subsuelo, roca base)
     - Distribución de partículas (hierba, tierra, piedra)
     - Propiedades específicas del bioma
     - Reglas de generación paso a paso
   - Escribir ejemplo de zona subterránea (ej: `zona-subterranea-cueva.md`) con:
     - Estructura de cueva (entrada, pasadizos, cámaras)
     - Distribución de partículas (roca, aire, minerales)
     - Propiedades de la zona subterránea
     - Reglas de generación paso a paso
   - Escribir ejemplo de acuífero/napa subterránea (ej: `acuifero-napa-subterranea.md`) con:
     - Estructura del acuífero (nivel freático, capas impermeables)
     - Distribución de partículas (agua, roca, tierra)
     - Propiedades del agua subterránea
     - Reglas de generación paso a paso
   - Agregar más ejemplos según necesidad (desiertos, tundras, montañas, etc.)
   - Asegurar que cada ejemplo tenga suficiente nivel de detalle para ser replicable

### Consideraciones Técnicas

**Reglas de construcción de terrenos:**
- **Nombre de partícula**: Decidir entre `límite`, `barrera`, `frontera_dimensional`, u otro nombre descriptivo
- **Transparencia**: Decidir si las partículas `límite` son completamente invisibles (opacity: 0.0) o semi-transparentes (opacity: 0.1-0.3)
- **Indestructibilidad**: Implementar flag `indestructible` en tabla `particulas` o validar por tipo en lógica de negocio
- **Rendimiento**: Crear muchas partículas `límite` puede afectar rendimiento. Considerar optimizaciones (instancing, no renderizar si son invisibles)
- **Extensibilidad**: Diseñar para que sea fácil agregar límites en cielo y laterales en el futuro
- **Validación de límites**: Los dioses no deben poder crear partículas fuera de los límites. Validar en endpoints de creación

### Dependencias

- Depende de: Ninguna
- Bloquea: Ninguna (pero debe resolverse antes de crear más contenido)

## Testing

### Escenarios de Prueba

1. **Escenario 1: Creación automática de partículas límite**
   - Crear una nueva dimensión
   - Verificar que se generan automáticamente partículas `límite` en `z = profundidad_maxima`
   - Verificar que las partículas `límite` cubren todo el área horizontal
   - Verificar que las partículas `límite` son indestructibles (no se pueden extraer)

2. **Escenario 2: Renderizado transparente**
   - Visualizar la dimensión en el frontend
   - Verificar que las partículas `límite` no se renderizan o se renderizan como transparentes
   - Verificar que no interfieren visualmente con el mundo

3. **Escenario 3: Validación de límites**
   - Intentar crear una partícula fuera de los límites definidos
   - Verificar que el sistema rechaza la creación
   - Verificar que se retorna un error apropiado

4. **Escenario 4: Uso de ejemplos de terrenos**
   - Leer un ejemplo de bioma (ej: bosque)
   - Seguir las reglas de generación paso a paso
   - Verificar que se puede crear el terreno según el ejemplo
   - Verificar que el terreno creado coincide con la descripción del ejemplo


## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 6-8 horas
- **Desglose:**
  - FASE 1 (Reglas de construcción): 3-4 horas
    - Crear tipo `límite`: 30 min
    - Implementar creación automática: 1-2 horas
    - Validación de indestructibilidad: 1 hora
    - Renderizado transparente: 30 min
    - Tests: 1 hora
  - FASE 2 (Ejemplos de terrenos): 3-4 horas
    - Crear estructura de carpetas y plantilla: 30 min
    - Escribir ejemplo de bioma: 1 hora
    - Escribir ejemplo de zona subterránea: 1 hora
    - Escribir ejemplo de acuífero/napa: 1 hora
    - Revisión y ajustes: 30 min
- **Notas:** 
  - La FASE 1 es prioritaria y establece las bases para futuras creaciones de dioses
  - La FASE 2 proporciona ejemplos detallados que servirán como referencia para los dioses
  - Los ejemplos deben tener suficiente nivel de detalle para ser replicables
  - Se pueden agregar más ejemplos en el futuro según necesidad

## Referencias

- **Relacionado con:** Seed demo inicial (JDG-000)
- **Documentación relevante:** 
  - `database/init/01-init-schema.sql` - Estructura de tabla `dimensiones`
  - `backend/src/database/seed_demo.py` - Script actual que tiene el bug
- **Discusiones previas:** Bug identificado al levantar el proyecto y visualizar en frontend

## Notas Adicionales

**Reglas de construcción de terrenos:**
- Esta es la regla más importante para establecer las bases del sistema de construcción de mundos
- Las partículas `límite` actúan como barreras invisibles que definen los límites del mundo
- Estas reglas servirán como referencia para cuando los dioses creen contenido
- Se pueden agregar más reglas de construcción en el futuro (ej: reglas para capas de terreno, reglas para estructuras, etc.)
- El nombre `límite` es una sugerencia, puede cambiarse si se encuentra un nombre más apropiado

**Ejemplos de creación de terrenos:**
- Los ejemplos deben tener un nivel de detalle suficiente para que los dioses puedan replicarlos sin ambigüedad
- Cada ejemplo debe incluir todos los pasos necesarios para crear el terreno desde cero
- Los ejemplos deben cubrir casos comunes pero también casos avanzados (acuíferos, sistemas de cavernas complejos)
- Los ejemplos pueden incluir variaciones (ej: "bosque denso" vs "bosque claro")
- Los ejemplos deben ser extensibles: se pueden agregar más ejemplos en el futuro según necesidad
- Los ejemplos pueden incluir diagramas o descripciones visuales si ayudan a la comprensión



