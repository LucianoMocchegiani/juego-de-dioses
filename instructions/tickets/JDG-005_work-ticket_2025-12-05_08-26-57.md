# JDG-005 - Componentización y Reorganización para Escalabilidad

## Tipo
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento
El proyecto actualmente tiene una estructura que no escala bien para agregar nuevos tipos de entidades. Los templates están mezclados y no hay separación clara entre categorías (árboles, plantas, animales, razas). Esto dificultará agregar nuevos tipos específicos como:
- **Árboles específicos**: Roble, Palmera, Paraíso, Pino, etc. (actualmente solo hay genéricos: arbol_pequeno, arbol_mediano)
- **Plantas**: Trigo, Maíz, Girasol, Cactus, etc.
- **Animales**: Vaca, Oveja, Cerdo, Caballo, etc.
- **Razas**: Humanos (por ahora), Elfos, Enanos, etc. (futuro)

Cada nuevo tipo requerirá duplicar código y modificar archivos existentes, lo que no es sostenible a largo plazo.

### Comportamiento Actual
- `tree_templates.py` contiene templates genéricos (`arbol_pequeno`, `arbol_mediano`) en lugar de tipos específicos
- `seed_demo.py` tiene lógica de creación mezclada con la lógica de seed
- No hay separación por categoría (árboles, plantas, animales, razas)
- No hay abstracción común para templates de diferentes categorías
- Agregar un nuevo tipo requiere modificar múltiples archivos
- No hay reutilización de código entre categorías similares

### Comportamiento Esperado
- Estructura modular con carpetas separadas por categoría (`templates/trees/`, `templates/plants/`, `templates/animals/`, `templates/races/`)
- Clase base abstracta (`BaseTemplate`) para compartir funcionalidad común
- Templates específicos (roble, palmera, vaca, oveja, etc.) que extienden clases base
- Sistema de builders separado (`builders/tree_builder.py`, `builders/animal_builder.py`, etc.)
- Sistema de creators de alto nivel para simplificar creación de entidades
- Registry pattern para descubrir y usar templates dinámicamente
- Agregar un nuevo tipo solo requiere crear un nuevo archivo de template sin modificar código existente
- Código organizado, mantenible y fácil de entender

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [ ] Frontend (Three.js) - Opcional para futuras mejoras
- [ ] Base de Datos (PostgreSQL) - No requiere cambios
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints - No requiere cambios (solo cambios internos)

### Tecnologías Involucradas
- Python 3.11, FastAPI, asyncpg
- Patrones de diseño: Template Method, Builder, Registry, Factory
- Type hints y abstracciones (ABC)

### Archivos/Componentes Principales
- `backend/src/database/tree_templates.py` - Refactorizar a estructura modular
- `backend/src/database/seed_demo.py` - Simplificar usando builders y creators
- Nuevos archivos:
  - `backend/src/database/templates/base.py` - Clase base abstracta
  - `backend/src/database/templates/trees/base.py` - TreeTemplate base
  - `backend/src/database/templates/trees/roble.py` - Template específico
  - `backend/src/database/templates/trees/registry.py` - Registry de árboles
  - `backend/src/database/builders/base.py` - BaseBuilder
  - `backend/src/database/builders/tree_builder.py` - TreeBuilder
  - `backend/src/database/creators/entity_creator.py` - EntityCreator

## Criterios de Aceptación

1. [ ] Existe estructura de carpetas `templates/` con subcarpetas por categoría (`trees/`, `plants/`, `animals/`, `races/`)
2. [ ] Existe clase base abstracta `BaseTemplate` con métodos comunes
3. [ ] Existe `TreeTemplate` que extiende `BaseTemplate` y mantiene funcionalidad actual
4. [ ] Existen al menos 3 templates específicos de árboles (roble, palmera, paraíso) que extienden `TreeTemplate`
5. [ ] Existe registry pattern para cada categoría que permite descubrir templates dinámicamente
6. [ ] Existe sistema de builders (`BaseBuilder`, `TreeBuilder`) separado de templates
7. [ ] Existe sistema de creators (`EntityCreator`) que simplifica creación de entidades
8. [ ] `seed_demo.py` usa el nuevo sistema de builders/creators y funciona igual que antes
9. [ ] Agregar un nuevo template de árbol solo requiere crear un nuevo archivo sin modificar código existente
10. [ ] La estructura está preparada para agregar fácilmente plantas, animales y razas en el futuro
11. [ ] Todo el código existente sigue funcionando (compatibilidad hacia atrás)
12. [ ] La documentación explica cómo agregar nuevos tipos

## Detalles de Implementación

### Consideraciones Técnicas
- **Compatibilidad**: Los templates existentes deben seguir funcionando durante la migración
- **Base de datos**: No requiere cambios en el schema
- **APIs**: No requiere cambios en endpoints (solo cambios internos)
- **Testing**: Cada template y builder debe ser testeable independientemente
- **Migración incremental**: La migración debe hacerse paso a paso sin romper funcionalidad

### Dependencias
- Depende de: JDG-004 (Optimización de visualización de árboles)
- Bloquea: Futuros tickets de plantas, animales y razas

## Testing

### Escenarios de Prueba
1. **Verificación de estructura**: Verificar que todas las carpetas y archivos existen
2. **Verificación de templates**: Verificar que templates específicos (roble, palmera) funcionan correctamente
3. **Verificación de registry**: Verificar que registry puede descubrir y retornar templates
4. **Verificación de builders**: Verificar que builders crean entidades correctamente
5. **Verificación de creators**: Verificar que creators simplifican creación de entidades
6. **Verificación de seed**: Verificar que seed demo funciona igual que antes
7. **Verificación de extensibilidad**: Agregar un nuevo template y verificar que funciona sin modificar código existente
8. **Verificación de compatibilidad**: Verificar que código existente sigue funcionando

### Casos Edge a Considerar
- Templates con parámetros inválidos: Deben validarse y lanzar errores claros
- Registry sin templates: Debe manejar correctamente casos vacíos
- Builders con templates inválidos: Deben validar y lanzar errores claros
- Migración de templates existentes: Debe mantener compatibilidad

## Estimación

- **Complejidad:** Alta
- **Tiempo estimado:** 8-12 horas
- **Notas:** 
  - Requiere refactorización cuidadosa para mantener compatibilidad
  - Requiere documentación detallada
  - Requiere pruebas exhaustivas para asegurar que nada se rompe

## Referencias

- **Relacionado con:** JDG-004 (Optimización de visualización de árboles)
- **Documentación relevante:** 
  - `instructions/analysis/JDG-005-architecture-analysis_2025-12-05_08-26-57.md`
  - `instructions/examples/terrenos/bioma-bosque.md`
- **Discusiones previas:** Necesidad de escalar para agregar plantas, animales y razas

## Notas Adicionales

- Esta refactorización es crítica para el futuro del proyecto
- Debe hacerse de forma incremental para no romper funcionalidad existente
- La documentación es crucial para que otros desarrolladores puedan agregar nuevos tipos fácilmente
- Se recomienda hacer esta refactorización antes de agregar plantas, animales o razas
- El frontend puede optimizarse después si es necesario, pero no es crítico para esta tarea

