# JDG-011 - Sistema de Personajes desde Base de Datos usando Templates/Builders/Creators

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Actualmente el personaje jugable se crea directamente en el frontend usando primitivos simples de Three.js (cilindro para cuerpo, esfera para cabeza). Se requiere que los personajes se definan y creen desde la base de datos usando el sistema de templates/builders/creators, similar a como se crean los árboles. Esto permitirá:

- Definir diferentes tipos de personajes/razas desde la BD
- Usar el sistema de geometría de agrupaciones para definir formas complejas
- Centralizar la definición de personajes en el backend
- Facilitar la creación de múltiples tipos de personajes/razas
- Integrar personajes con el sistema de partículas del mundo

### Comportamiento Actual

- El personaje se crea en `frontend/src/ecs/factories/player-factory.js` usando primitivos Three.js hardcodeados
- El mesh del personaje es un grupo simple con cilindro (cuerpo) y esfera (cabeza)
- No hay integración con el sistema de templates/builders/creators del backend
- No se usa la tabla `agrupaciones` ni `geometria_agrupacion` para definir la forma del personaje
- El personaje no existe como partículas en la base de datos

### Comportamiento Esperado

- Crear sistema de templates para bípedos (personajes) en `backend/src/database/templates/bipedos/`
- Crear builder para bípedos en `backend/src/database/builders/biped_builder.py`
- Actualizar `EntityCreator` para soportar creación de bípedos
- Crear endpoint de API para obtener información de personajes desde la BD
- Modificar `PlayerFactory` en el frontend para cargar la forma del personaje desde la API
- El personaje debe crearse como agrupación en la BD con `geometria_agrupacion` definiendo sus partes
- El frontend debe renderizar el personaje usando la geometría definida en la BD
- El personaje debe poder crearse usando `EntityCreator.create_entity()` con un template de bípedo

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [x] Frontend (Three.js)
- [x] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [x] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Python 3.11, FastAPI, asyncpg
- Three.js, JavaScript ES6+
- PostgreSQL 16
- Sistema ECS (frontend)
- Sistema de Templates/Builders/Creators (backend)

### Archivos/Componentes Principales

**Backend:**
- `backend/src/database/templates/bipedos/base.py` - Clase base BipedTemplate (nuevo)
- `backend/src/database/templates/bipedos/humano.py` - Template de humano (nuevo)
- `backend/src/database/templates/bipedos/registry.py` - Registry de bípedos (nuevo)
- `backend/src/database/builders/biped_builder.py` - Builder para bípedos (nuevo)
- `backend/src/database/creators/entity_creator.py` - Actualizar para soportar bípedos
- `backend/src/api/endpoints/__init__.py` - Agregar endpoint para obtener información de personajes
- `backend/src/models/schemas.py` - Agregar schemas para personajes/bípedos

**Frontend:**
- `frontend/src/ecs/factories/player-factory.js` - Modificar para cargar forma desde API
- `frontend/src/api/endpoints/__init__.js` - Agregar cliente API para personajes
- `frontend/src/renderers/particle-renderer.js` - Asegurar que renderiza agrupaciones con geometría

**Base de Datos:**
- Tabla `agrupaciones` - Usar campo `geometria_agrupacion` para definir formas
- Tabla `particulas` - Almacenar partículas del personaje

## Criterios de Aceptación

1. [ ] Existe sistema de templates para bípedos en `backend/src/database/templates/bipedos/`
2. [ ] Existe `BipedTemplate` como clase base que extiende `BaseTemplate`
3. [ ] Existe template `HumanoTemplate` con estructura básica (cabeza, torso, brazos, piernas)
4. [ ] Existe `BipedBuilder` que convierte templates en partículas para la BD
5. [ ] `EntityCreator` puede crear bípedos usando `create_entity()` con template de bípedo
6. [ ] Los bípedos se crean como agrupaciones en la BD con `geometria_agrupacion` definida
7. [ ] Existe endpoint de API `/api/dimensions/{dimension_id}/characters/{character_id}` para obtener información de personaje
8. [ ] El frontend puede cargar la forma del personaje desde la API
9. [ ] `PlayerFactory` crea el mesh del personaje basándose en `geometria_agrupacion` de la BD
10. [ ] El personaje renderizado coincide con la definición en la BD
11. [ ] El sistema ECS funciona correctamente con personajes creados desde BD
12. [ ] Se puede crear un personaje usando `EntityCreator` desde un script de seed

## Detalles de Implementación

### Consideraciones Técnicas

**Performance:**
- El sistema debe ser eficiente al cargar formas de personajes desde la BD
- Cachear información de templates y geometrías cuando sea posible
- Las consultas de agrupaciones deben ser optimizadas

**Seguridad:**
- Validar que las geometrías definidas en BD sean válidas
- Prevenir inyección SQL en consultas de agrupaciones
- Validar permisos para crear personajes

**Compatibilidad:**
- Mantener compatibilidad con personajes existentes (hardcodeados) durante transición
- El sistema debe funcionar con el ECS existente
- No romper funcionalidad de otros templates (árboles, etc.)

**Escalabilidad:**
- El sistema debe soportar múltiples tipos de bípedos/razas
- Debe ser fácil agregar nuevos templates de personajes
- La estructura debe permitir variaciones (altura, proporciones, etc.)

### Dependencias

- Depende de: JDG-010 (Sistema ECS y personaje jugable básico)
- Bloquea: (ninguno)

### Estructura Propuesta

**Template de Bípedo:**
```python
class BipedTemplate(BaseTemplate):
    def __init__(
        self,
        nombre: str,
        altura_cabeza: int,
        altura_torso: int,
        altura_piernas: int,
        ancho_hombros: int,
        ancho_cadera: int,
        # ... más parámetros
    ):
        super().__init__(nombre, 'biped')
        # ...
```

**Geometría de Agrupación:**
```json
{
  "tipo": "biped",
  "partes": {
    "cabeza": {
      "geometria": {
        "tipo": "sphere",
        "parametros": {"radius": 0.25, "segments": 8}
      },
      "offset": {"x": 0, "y": 0, "z": 1.25}
    },
    "torso": {
      "geometria": {
        "tipo": "cylinder",
        "parametros": {"radiusTop": 0.3, "radiusBottom": 0.3, "height": 1.0}
      },
      "offset": {"x": 0, "y": 0, "z": 0.5}
    },
    "brazo_izquierdo": { ... },
    "brazo_derecho": { ... },
    "pierna_izquierda": { ... },
    "pierna_derecha": { ... }
  }
}
```

## Testing

### Escenarios de Prueba

1. **Crear template de humano:**
   - Crear `HumanoTemplate` con estructura básica
   - Verificar que el template tiene todas las partes necesarias
   - Verificar que los parámetros son válidos

2. **Crear bípedo desde template:**
   - Usar `EntityCreator` para crear un humano en una dimensión
   - Verificar que se crea la agrupación en la BD
   - Verificar que `geometria_agrupacion` está correctamente definida
   - Verificar que las partículas se insertan correctamente

3. **Cargar personaje desde API:**
   - Crear personaje en BD usando template
   - Consultar endpoint de API para obtener información del personaje
   - Verificar que la respuesta incluye `geometria_agrupacion`

4. **Renderizar personaje en frontend:**
   - Cargar información del personaje desde API
   - Crear mesh Three.js basándose en `geometria_agrupacion`
   - Verificar que el mesh renderizado coincide con la definición
   - Verificar que el personaje funciona con el sistema ECS

5. **Múltiples tipos de bípedos:**
   - Crear templates para diferentes razas (humano, elfo, enano, etc.)
   - Verificar que cada tipo se crea correctamente
   - Verificar que cada tipo tiene su propia geometría

### Casos Edge a Considerar

- Personaje sin `geometria_agrupacion` definida (fallback a forma default)
- Partículas del personaje fuera de los límites de la dimensión
- Personaje con geometría inválida (parámetros negativos, etc.)
- Personaje creado pero agrupación no encontrada en BD
- API no disponible (fallback a personaje hardcodeado)
- Múltiples personajes en la misma posición

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 3-4 días
- **Notas:** 
  - Requiere entender bien el sistema de templates/builders/creators existente
  - Requiere integración entre backend y frontend
  - Puede requerir ajustes en el sistema de renderizado de agrupaciones

## Referencias

- **Relacionado con:** JDG-010 (Sistema ECS y personaje jugable básico)
- **Documentación relevante:**
  - `backend/src/database/README.md` - Sistema de templates/builders/creators
  - `backend/src/database/templates/README.md` - Documentación de templates
  - `backend/src/database/builders/README.md` - Documentación de builders
  - `backend/src/database/creators/README.md` - Documentación de creators
  - `frontend/src/ecs/README.md` - Sistema ECS
  - `frontend/src/renderers/README.md` - Sistema de renderizado
- **Discusiones previas:** 
  - El sistema de templates para árboles puede usarse como referencia
  - La estructura de `geometria_agrupacion` ya está definida en la BD

## Notas Adicionales

- Este ticket establece la base para crear múltiples tipos de personajes/razas en el futuro
- El sistema debe ser extensible para agregar más partes al personaje (manos, pies, accesorios, etc.)
- Considerar usar el sistema de estilos de tipos de partículas para colores y materiales
- El personaje puede tener un "núcleo" (partícula crítica) similar a los seres vivos
- Considerar cómo manejar animaciones futuras (el sistema de templates puede incluir información de animación)

