# JDG-015 - Animaciones Básicas para Personaje Humano

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El personaje humano (`Human.glb`) actualmente se muestra en T-pose estático sin movimiento de brazos, piernas u otras partes del cuerpo al caminar, correr o realizar otras acciones. Se requiere implementar animaciones básicas procedurales que muevan las partes del cuerpo según el estado del personaje (idle, walk, run, jump, crouch).

El modelo `Human.glb` tiene vertex groups definidos (head, torso, left_arm, right_arm, left_leg, right_leg) que pueden usarse para animar partes específicas del cuerpo. El modelo probablemente no tiene animaciones incluidas (verificado en JDG-013), por lo que se implementarán animaciones procedurales basadas en funciones matemáticas (seno/coseno) para mover las partes del cuerpo.

### Comportamiento Actual

- El personaje se muestra en T-pose estático todo el tiempo
- El sistema de animaciones (`AnimationSystem`) solo determina el estado (idle, walk, run, jump, crouch) pero no mueve las partes del cuerpo
- El `RenderSystem` solo aplica un balanceo simple (rotación Z del modelo completo) que no anima brazos ni piernas
- No hay movimiento de brazos al caminar/correr
- No hay movimiento de piernas al caminar/correr
- No hay animaciones de salto o agacharse

### Comportamiento Esperado

- Al caminar: brazos se balancean alternativamente, piernas se mueven (simulado con rotación/posición)
- Al correr: movimiento más rápido y exagerado de brazos y piernas
- Al estar idle: posición T-pose relajada (posiblemente con movimiento sutil de respiración)
- Al saltar: movimiento de brazos hacia arriba, piernas flexionadas
- Al agacharse: brazos y piernas se doblan apropiadamente
- Las animaciones deben ser suaves y naturales
- Las animaciones deben sincronizarse con el estado del personaje

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Three.js (manipulación de objetos 3D, rotaciones, posiciones)
- JavaScript ES6+ (funciones matemáticas, animaciones procedurales)
- ECS (Entity Component System) - AnimationSystem, RenderSystem
- Vertex Groups (para identificar y mover partes específicas del cuerpo)

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/animation-system.js` - Sistema que determina estado de animación
- `frontend/src/ecs/systems/render-system.js` - Sistema que aplica animaciones visuales
- `frontend/src/ecs/components/animation.js` - Componente de animación
- `frontend/src/renderers/models/vertex-groups-utils.js` - Utilidades para acceder a vertex groups
- `frontend/src/ecs/factories/player-factory.js` - Factory que crea personajes con modelos

## Criterios de Aceptación

1. [ ] Al caminar, los brazos se balancean alternativamente (left_arm y right_arm rotan en direcciones opuestas)
2. [ ] Al caminar, las piernas se mueven (left_leg y right_leg rotan/posicionan alternativamente)
3. [ ] Al correr, el movimiento de brazos y piernas es más rápido y exagerado que al caminar
4. [ ] Al estar idle, el personaje mantiene T-pose o tiene movimiento sutil de respiración
5. [ ] Al saltar, los brazos se mueven hacia arriba y las piernas se flexionan
6. [ ] Al agacharse, brazos y piernas se doblan apropiadamente
7. [ ] Las animaciones son suaves y naturales (sin saltos bruscos)
8. [ ] Las animaciones se sincronizan correctamente con el estado del personaje
9. [ ] El sistema funciona con el modelo `Human.glb` y sus vertex groups
10. [ ] Las animaciones no afectan negativamente el rendimiento (mantener 60 FPS)

**Nota:** Cada criterio debe ser específico, medible y verificable.

## Detalles de Implementación

### Consideraciones Técnicas

**Animaciones Procedurales:**
- Usar funciones matemáticas (seno/coseno) para crear movimiento suave y cíclico
- Rotar brazos alrededor del eje del hombro (rotación X o Z según orientación)
- Rotar piernas alrededor de la cadera (rotación X o Z según orientación)
- Sincronizar movimiento de brazos y piernas (brazo izquierdo con pierna derecha, etc.)
- Usar `deltaTime` para animaciones independientes del framerate

**Vertex Groups:**
- Usar los vertex groups existentes: head, torso, left_arm, right_arm, left_leg, right_leg
- Acceder a los meshes de cada parte usando `getPartMesh()` de `vertex-groups-utils.js`
- Aplicar rotaciones a cada parte individualmente
- Mantener el torso y la cabeza relativamente estáticos (excepto para respiración)

**Estados de Animación:**
- **Idle**: T-pose o movimiento sutil de respiración (torso/pecho se expande ligeramente)
- **Walk**: Movimiento moderado de brazos y piernas, velocidad de animación ~5
- **Run**: Movimiento rápido y exagerado, velocidad de animación ~10
- **Jump**: Brazos hacia arriba, piernas flexionadas, movimiento rápido
- **Crouch**: Brazos y piernas doblados, posición baja

**Performance:**
- Las animaciones deben ejecutarse eficientemente (no más de 6 partes a animar)
- Usar `requestAnimationFrame` y `deltaTime` para animaciones suaves
- Evitar cálculos costosos en cada frame
- Considerar cachear referencias a meshes de partes del cuerpo

**Compatibilidad:**
- Mantener compatibilidad con modelos sin vertex groups (fallback a animación simple)
- No romper animaciones existentes para otros modelos
- El sistema debe funcionar con o sin vertex groups

### Dependencias
- Depende de: JDG-013 (Reemplazar Modelo de Personaje con Human.glb)
- Bloquea: Ninguno (mejora visual, no bloquea funcionalidad)

## Testing

### Escenarios de Prueba
1. **Caminar**: Personaje camina con WASD, verificar que brazos y piernas se mueven alternativamente
2. **Correr**: Personaje corre (Shift + WASD), verificar movimiento más rápido y exagerado
3. **Idle**: Personaje estático, verificar T-pose o respiración sutil
4. **Salto**: Personaje salta (Space), verificar movimiento de brazos y piernas
5. **Agacharse**: Personaje se agacha (Ctrl), verificar doblado de brazos y piernas
6. **Transiciones**: Verificar que las animaciones cambian suavemente entre estados
7. **Rendimiento**: Verificar que mantiene 60 FPS con animaciones activas

### Casos Edge a Considerar
- Modelo sin vertex groups → fallback a animación simple (balanceo del modelo completo)
- Cambio rápido de estados → transiciones suaves sin saltos bruscos
- Múltiples personajes → cada uno debe animarse independientemente
- Personaje fuera de vista → considerar pausar animaciones para optimización
- Vertex groups no encontrados → manejar graciosamente sin errores

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 4-6 horas
- **Notas:** 
  - Requiere experimentación con valores de rotación y velocidad para que se vea natural
  - Puede requerir ajustes iterativos basados en feedback visual
  - La sincronización de brazos/piernas necesita tuning fino

## Referencias

- **Relacionado con:** JDG-013 (Reemplazar Modelo de Personaje con Human.glb)
- **Documentación relevante:**
  - `frontend/src/renderers/models/vertex-groups-utils.js` - Utilidades para vertex groups
  - `frontend/src/ecs/systems/animation-system.js` - Sistema de estados de animación
  - `frontend/src/ecs/systems/render-system.js` - Sistema de renderizado
  - `frontend/src/ecs/components/animation.js` - Componente de animación
- **Discusiones previas:** 
  - Verificación de animaciones en modelo GLB (JDG-013)
  - Vertex groups disponibles: head, torso, left_arm, right_arm, left_leg, right_leg

## Notas Adicionales

- El modelo `Human.glb` fue creado en T-pose específicamente para facilitar animaciones
- Los vertex groups están definidos y accesibles a través de `vertex-groups-utils.js`
- El sistema actual de animaciones solo determina estados, no aplica movimiento visual
- Las animaciones procedurales son preferibles a animaciones del modelo porque:
  - No requieren que el modelo tenga animaciones incluidas
  - Son más flexibles y personalizables
  - Funcionan con cualquier modelo que tenga vertex groups
  - Permiten ajustes finos de velocidad y amplitud por estado
- Futuras mejoras pueden incluir:
  - Soporte para animaciones del modelo GLB si están disponibles (usando AnimationMixer)
  - Animaciones más complejas (combate, interacciones)
  - Sistema de blending entre animaciones para transiciones más suaves

