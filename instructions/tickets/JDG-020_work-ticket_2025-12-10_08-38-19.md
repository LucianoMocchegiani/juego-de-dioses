# JDG-020 - Animaciones en Loop No Se Detienen al Soltar Tecla de Movimiento

## Tipo
- [ ] Feature (nueva funcionalidad)
- [x] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento
Las animaciones que están configuradas para estar en loops (como la animación de caminar) no se detienen correctamente cuando el jugador deja de presionar la tecla de movimiento (por ejemplo, la tecla 'W'). El personaje deja de moverse físicamente, pero la animación de caminar continúa reproduciéndose indefinidamente, creando una inconsistencia visual donde el personaje parece estar caminando pero está quieto.

### Comportamiento Actual
1. El jugador presiona la tecla 'W' para caminar
2. La animación de caminar se inicia correctamente y el personaje se mueve
3. El jugador suelta la tecla 'W'
4. El personaje deja de moverse físicamente (correcto)
5. **PROBLEMA:** La animación de caminar continúa reproduciéndose indefinidamente en loop, aunque el personaje esté quieto
6. La animación solo cambia a 'idle' (combat_stance) si se ejecuta otra acción, pero no automáticamente al soltar la tecla

### Comportamiento Esperado
1. El jugador presiona la tecla 'W' para caminar
2. La animación de caminar se inicia y el personaje se mueve
3. El jugador suelta la tecla 'W'
4. El personaje deja de moverse físicamente
5. **ESPERADO:** La animación de caminar se detiene inmediatamente y transiciona a la animación 'idle' (combat_stance)
6. El personaje visualmente refleja su estado real: quieto cuando no hay input de movimiento

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js (AnimationMixer, AnimationAction)
- ECS (Entity Component System) - AnimationStateSystem, AnimationMixerSystem
- Sistema de estados de animación basado en configuración declarativa

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/animation-mixer-system.js` - Sistema que reproduce animaciones usando AnimationMixer
- `frontend/src/ecs/systems/animation-state-system.js` - Sistema que determina el estado de animación
- `frontend/src/ecs/systems/input-system.js` - Sistema que procesa input del usuario
- `frontend/src/ecs/components/animation.js` - Componente que almacena el estado de animación
- `frontend/src/ecs/animation/config/animation-config.js` - Configuración de estados y animaciones
- `frontend/src/ecs/animation/states/state-registry.js` - Registry de estados de animación
- `frontend/src/ecs/animation/conditions/movement-condition.js` - Condición que evalúa si hay movimiento

## Criterios de Aceptación

1. [ ] Cuando el jugador suelta todas las teclas de movimiento (W, A, S, D), la animación actual (walk o run) se detiene inmediatamente y transiciona a 'idle' (combat_stance)
2. [ ] La transición entre animaciones es suave (usando fadeOut/fadeIn)
3. [ ] El estado visual del personaje siempre refleja su estado real (caminando solo cuando hay input de movimiento)
4. [ ] Las animaciones en loop se detienen correctamente cuando cambia el estado, incluso si la animación ya estaba reproduciéndose
5. [ ] No se producen animaciones "fantasma" donde el personaje parece estar caminando pero está quieto
6. [ ] El comportamiento funciona correctamente para todas las animaciones en loop (walk, run, combat_stance)

**Nota:** Cada criterio debe ser específico, medible y verificable.

## Detalles de Implementación

### Consideraciones Técnicas
- **Performance:** Las transiciones de animación deben ser eficientes y no causar lag
- **Seguridad:** No aplica directamente
- **Compatibilidad:** Debe mantener compatibilidad con el sistema de animaciones existente
- **Escalabilidad:** La solución debe funcionar para futuras animaciones en loop que se agreguen

### Problema Raíz Identificado
El problema está en el método `playAnimation()` de `AnimationMixerSystem` (línea 212). La lógica actual verifica si la animación ya está reproduciéndose y si el estado es el mismo, y en ese caso no hace nada. Sin embargo, cuando el estado cambia de 'walk' a 'idle', la verificación en la línea 212 previene que se detenga la animación anterior y se inicie la nueva.

**Flujo problemático:**
1. Estado cambia de 'walk' a 'idle' en `AnimationStateSystem`
2. `AnimationMixerSystem` intenta reproducir 'combat_stance' (idle)
3. La verificación en línea 212 detecta que hay una animación corriendo pero no verifica si el ESTADO cambió
4. La animación de 'walk' continúa reproduciéndose porque la condición evita la transición

### Dependencias
- Depende de: JDG-015 (Sistema de Animaciones con GLB), JDG-016 (Sistema de Animaciones Configurable)
- Bloquea: Ninguno conocido

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Soltar tecla de caminar:**
   - Presionar 'W' para caminar
   - Verificar que animación de caminar se inicia
   - Soltar 'W'
   - Verificar que animación cambia a 'idle' (combat_stance) inmediatamente
   - Verificar que el personaje está visualmente quieto

2. **Escenario 2 - Soltar tecla mientras se corre:**
   - Presionar 'W' + 'Shift' para correr
   - Verificar que animación de correr se inicia
   - Soltar ambas teclas
   - Verificar que animación cambia a 'idle' inmediatamente

3. **Escenario 3 - Cambiar dirección rápidamente:**
   - Presionar 'W' para caminar
   - Inmediatamente presionar 'S' para caminar hacia atrás
   - Verificar que la transición es suave
   - Soltar todas las teclas
   - Verificar que cambia a 'idle'

4. **Escenario 4 - Múltiples cambios rápidos:**
   - Presionar 'W', soltar, presionar 'A', soltar, presionar 'D', soltar
   - Verificar que cada transición funciona correctamente
   - Verificar que al final queda en 'idle'

### Casos Edge a Considerar
- **Caso 1:** Soltar todas las teclas mientras se está en medio de una animación de ataque (debe mantener la animación de ataque hasta que termine, luego ir a idle)
- **Caso 2:** Transiciones muy rápidas entre estados (no debe causar flickering o animaciones cortadas)
- **Caso 3:** Presionar múltiples teclas de dirección al mismo tiempo y soltarlas todas (debe ir a idle)
- **Caso 4:** Soltar tecla mientras el personaje está en el aire (saltando) - debe mantener jump hasta tocar suelo

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 2-3 horas
- **Notas:** 
  - El problema está bien identificado en el código
  - La solución requiere modificar la lógica de `playAnimation()` en `AnimationMixerSystem`
  - Necesita pruebas cuidadosas para asegurar que no se rompen otras transiciones de animación

## Referencias

- **Relacionado con:** JDG-015 (Sistema de Animaciones con GLB), JDG-016 (Sistema de Animaciones Configurable)
- **Documentación relevante:** 
  - Three.js AnimationMixer: https://threejs.org/docs/#api/en/animation/AnimationMixer
  - Three.js AnimationAction: https://threejs.org/docs/#api/en/animation/AnimationAction
- **Archivos relevantes:**
  - `frontend/src/ecs/systems/animation-mixer-system.js`
  - `frontend/src/ecs/systems/animation-state-system.js`
  - `frontend/src/ecs/animation/config/animation-config.js`

## Notas Adicionales

- El sistema de animaciones actual funciona correctamente para iniciar animaciones, pero tiene un problema en la detección de cambios de estado cuando una animación en loop ya está reproduciéndose
- La solución debe asegurar que cuando el estado del componente `Animation` cambia, la animación visual también cambia, incluso si la animación anterior estaba en loop
- Es importante mantener las transiciones suaves (fadeOut/fadeIn) para una mejor experiencia de usuario
- La lógica especial para 'combat_stance' que no interrumpe otras animaciones debe mantenerse, pero solo para animaciones de ataque que tienen prioridad

