# JDG-021 - Integración de Animaciones Avanzadas y Sistema de Combate con Combos

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento
Se dispone de un conjunto extenso de animaciones avanzadas (42 archivos GLB en la carpeta biped) que incluyen variantes de ataques, defensas, movimientos especiales, reacciones y acciones contextuales. Actualmente el sistema solo utiliza 4 animaciones básicas (walk, run, combat_stance, left_slash). Se necesita:

1. **Integrar todas las animaciones disponibles** en el sistema de configuración
2. **Implementar sistema de combos** donde múltiples clicks consecutivos ejecuten diferentes ataques en secuencia
3. **Implementar combinaciones de teclas** (click izquierdo + tecla modificadora) para ataques especiales
4. **Preparar arquitectura para sistema de armas** donde diferentes armas usen diferentes animaciones de ataque (aunque el sistema de armas aún no existe)
5. **Integrar animaciones de defensa** (parry, dodge, block)
6. **Integrar animaciones contextuales** (reacciones, recolección, acciones especiales)

### Comportamiento Actual
- Solo 4 animaciones básicas están en uso: walk, run, combat_stance, left_slash
- Un solo tipo de ataque disponible (click izquierdo ejecuta siempre la misma animación)
- No hay sistema de combos
- No hay combinaciones de teclas para ataques especiales
- No hay diferenciación por tipo de arma
- 38 animaciones adicionales disponibles pero no integradas

### Comportamiento Esperado
- Todas las animaciones disponibles están integradas y pueden activarse según contexto
- Sistema de combos: múltiples clicks consecutivos ejecutan secuencias de ataques diferentes
- Combinaciones de teclas: click + Shift = ataque pesado, click + Ctrl = ataque cargado, etc.
- Arquitectura preparada para sistema de armas: cada arma puede tener su propio conjunto de animaciones
- Animaciones de defensa activables (parry, dodge, block)
- Animaciones contextuales según estado del personaje (reacciones a daño, caídas, etc.)

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js (AnimationMixer, AnimationAction)
- ECS (Entity Component System) - AnimationStateSystem, AnimationMixerSystem
- Sistema de estados de animación basado en configuración declarativa
- Sistema de input (InputManager, InputComponent)

### Archivos/Componentes Principales
- `frontend/src/ecs/animation/config/animation-config.js` - Configuración de estados y animaciones
- `frontend/src/ecs/systems/animation-mixer-system.js` - Sistema que reproduce animaciones
- `frontend/src/ecs/systems/animation-state-system.js` - Sistema que determina estados
- `frontend/src/ecs/systems/input-system.js` - Sistema que procesa input
- `frontend/src/ecs/components/input.js` - Componente de input
- `frontend/src/ecs/animation/states/state-config.js` - Configuración de estados
- `frontend/src/ecs/animation/conditions/` - Condiciones para activar estados
- `frontend/src/ecs/components/` - Posible nuevo componente para sistema de combate/armas

### Animaciones Disponibles (42 archivos)

**Ataques (11):**
- Animation_Left_Slash_withSkin.glb (ya integrado)
- Animation_Attack_withSkin.glb
- Animation_Heavy_Hammer_Swing_withSkin.glb
- Animation_Axe_Spin_Attack_withSkin.glb
- Animation_Charged_Axe_Chop_withSkin.glb
- Animation_Charged_Upward_Slash_withSkin.glb
- Animation_Charged_Slash_withSkin.glb
- Animation_Double_Blade_Spin_withSkin.glb
- Animation_Sword_Judgment_withSkin.glb
- Animation_Simple_Kick_withSkin.glb
- Animation_Spear_Walk_withSkin.glb (caminar con lanza)

**Defensa (4):**
- Animation_Sword_Parry_Backward_withSkin.glb
- Animation_Shield_Push_Left_withSkin.glb
- Animation_Stand_Dodge_withSkin.glb
- Animation_Roll_Dodge_withSkin.glb

**Movimiento (10):**
- Animation_Walking_withSkin.glb (ya integrado)
- Animation_Running_withSkin.glb (ya integrado)
- Animation_RunFast_withSkin.glb
- Animation_Regular_Jump_withSkin.glb
- Animation_Backflip_withSkin.glb
- Animation_Dive_Down_and_Land_2_withSkin.glb
- Animation_Swim_Idle_withSkin.glb
- Animation_swimming_to_edge_withSkin.glb
- Animation_Cautious_Crouch_Walk_Forward_inplace_withSkin.glb
- Animation_Cautious_Crouch_Walk_Right_inplace_withSkin.glb
- Animation_Limping_Walk_inplace_withSkin.glb
- Animation_Stand_Up2_withSkin.glb

**Reacciones/Daño (4):**
- Animation_Hit_Reaction_withSkin.glb
- Animation_Hit_Reaction_1_withSkin.glb
- Animation_Electrocution_Reaction_withSkin.glb
- Animation_falling_down_withSkin.glb
- Animation_Shot_and_Fall_Backward_withSkin.glb

**Acciones Especiales (6):**
- Animation_Collect_Object_withSkin.glb
- Animation_Stand_and_Drink_withSkin.glb
- Animation_Talk_with_Hands_Open_withSkin.glb
- Animation_Charged_Spell_Cast_withSkin.glb
- Animation_Skill_01_withSkin.glb
- Animation_Crouch_Charge_and_Throw_withSkin.glb
- Animation_Crouch_and_Step_Back_withSkin.glb

**Idle/Stance (2):**
- Animation_Combat_Stance_withSkin.glb (ya integrado)
- Animation_Idle_11_withSkin.glb

## Criterios de Aceptación

1. [ ] Todas las 42 animaciones disponibles están registradas en ANIMATION_FILES
2. [ ] Sistema de combos funciona: 2-3 clicks consecutivos ejecutan diferentes ataques en secuencia
3. [ ] Combinaciones de teclas funcionan: Click + Shift = ataque pesado, Click + Ctrl = ataque cargado
4. [ ] Arquitectura preparada para sistema de armas (componente o configuración extensible)
5. [ ] Animaciones de defensa pueden activarse (parry con tecla Q, dodge con tecla E durante movimiento)
6. [ ] Animaciones contextuales se activan automáticamente (hit reaction cuando se recibe daño)
7. [ ] Transiciones entre animaciones son suaves
8. [ ] El sistema es escalable y fácil de extender con nuevas animaciones
9. [ ] No hay regresiones en animaciones existentes (walk, run, idle siguen funcionando)

**Nota:** Cada criterio debe ser específico, medible y verificable.

## Detalles de Implementación

### Consideraciones Técnicas
- **Performance:** El sistema de combos debe usar un input buffer temporal para registrar clicks consecutivos sin perder inputs
- **Escalabilidad:** La arquitectura debe permitir agregar nuevas animaciones, combos y armas sin modificar código core
- **Compatibilidad:** Mantener compatibilidad con el sistema de animaciones existente
- **Configuración:** Usar sistema declarativo para definir combos y combinaciones de teclas
- **Input Buffer:** Implementar buffer de input con ventana temporal (ej: 0.5 segundos entre clicks para combo)

### Conceptos Clave

**Sistema de Combos:**
- Input buffer temporal que registra secuencias de clicks
- Cada combo es una secuencia de animaciones (ej: click1 → left_slash, click2 → double_blade_spin)
- Ventana temporal para ejecutar combo (ej: 0.5-1 segundo entre clicks)
- Reset del combo si pasa demasiado tiempo o se ejecuta otra acción

**Combinaciones de Teclas:**
- Click + Shift = Ataque pesado (Heavy_Hammer_Swing, Charged_Slash)
- Click + Ctrl = Ataque cargado (Charged_Axe_Chop, Charged_Upward_Slash)
- Click + Alt = Ataque especial (Double_Blade_Spin, Sword_Judgment)
- Q = Parry/Block
- E durante movimiento = Dodge
- F = Agarrar/Interactuar

**Preparación para Sistema de Armamentos:**
- Componente opcional `Weapon` que indica tipo de arma equipada
- Configuración de animaciones por tipo de arma (espada, hacha, martillo, lanza, etc.)
- Fallback a animaciones genéricas si no hay arma equipada o no hay animación específica

### Dependencias
- Depende de: JDG-015 (Sistema de Animaciones con GLB), JDG-016 (Sistema de Animaciones Configurable), JDG-020 (Fix animaciones en loop)
- Bloquea: JDG-XXX (Sistema de Armamentos - futuro), JDG-XXX (Sistema de Combate - futuro)

## Testing

### Escenarios de Prueba
1. **Sistema de Combos:**
   - Click → Click → Click ejecuta secuencia de 3 ataques diferentes
   - Si se espera demasiado entre clicks, el combo se resetea
   - Si se mueve entre clicks, el combo se cancela

2. **Combinaciones de Teclas:**
   - Click + Shift ejecuta ataque pesado
   - Click + Ctrl ejecuta ataque cargado
   - Q ejecuta parry cuando está disponible
   - E durante movimiento ejecuta dodge

3. **Animaciones Contextuales:**
   - Al recibir daño, se ejecuta hit_reaction
   - Al caer desde altura, se ejecuta falling_down
   - Al recoger objeto, se ejecuta collect_object

4. **Preparación para Armamentos:**
   - Si hay componente Weapon, usa animaciones específicas del arma
   - Si no hay arma, usa animaciones genéricas
   - Transiciones funcionan correctamente en ambos casos

### Casos Edge a Considerar
- **Input buffer overflow:** Múltiples clicks muy rápidos no deben causar errores
- **Combo interrumpido:** Si se recibe daño durante combo, cancelar combo y ejecutar hit_reaction
- **Animación ya corriendo:** No permitir iniciar nuevo ataque si uno está en progreso (a menos que sea cancelable)
- **Cambio de arma durante ataque:** Completar ataque actual antes de cambiar animaciones

## Estimación

- **Complejidad:** Alta
- **Tiempo estimado:** 3-5 días
- **Notas:** 
  - Requiere análisis arquitectónico previo (JDG-021-analysis)
  - La preparación para sistema de armas agrega complejidad pero es necesaria para escalabilidad futura
  - El sistema de combos requiere testing extensivo para balance y feel correcto

## Referencias

- **Relacionado con:** JDG-015 (Sistema de Animaciones), JDG-016 (Sistema Configurable), JDG-020 (Fix animaciones)
- **Archivos de animaciones:** `Juego de Dioses/meshy/animaciones/biped/` (42 archivos GLB)
- **Documentación relevante:** 
  - `frontend/src/ecs/animation/README.md`
  - Sistemas de combate con combos en videojuegos (Dark Souls, Devil May Cry, etc.)

## Notas Adicionales

- Este ticket requiere un análisis arquitectónico previo (JDG-021-analysis) para definir la mejor arquitectura
- El sistema de armas futuro debe integrarse sin romper la arquitectura de animaciones
- Considerar crear un sistema de "action queue" o "action state machine" más robusto que maneje estados de combate
- Las animaciones pueden tener propiedades adicionales como "cancelable", "interruptible", "comboStarter", "comboLinker", "comboFinisher"
- Considerar sistema de "animation priority" para resolver conflictos entre animaciones que se quieren ejecutar simultáneamente

