# JDG-022 - Reestructuración de Animaciones: Crouch Walk y Estados Contextuales

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El sistema actual de animaciones tiene problemas conceptuales:

1. **Estado `crouch` confuso**: Se activa cuando se presiona Ctrl, pero usa la animación `crouch_walk_forward` (caminar agachado). Esto causa que el personaje camine agachado incluso cuando no se está moviendo.

2. **Falta de estados contextuales**: No hay diferenciación entre:
   - Caminar normal vs caminar agachado (Ctrl + movimiento)
   - Caminar vs correr (Shift + movimiento) - esto existe pero puede mejorar

3. **Código obsoleto**: El sistema de renderizado tiene lógica manual de balanceo que ya no es necesaria (las animaciones GLB manejan esto).

### Comportamiento Actual

- El estado `crouch` (prioridad 8) se activa con `wantsToCrouch = true`, pero no verifica movimiento
- Usa animación `crouch_walk_forward` (caminar agachado) incluso cuando no hay movimiento
- El código en `render-system.js` aplica balanceo manual obsoleto para walk/run
- Los estados `walk` y `run` no excluyen el estado de agachado

### Comportamiento Esperado

- **`crouch_walk`**: Se activa cuando hay movimiento Y Ctrl presionado (caminar agachado)
- **`crouch_idle`**: Se activa cuando NO hay movimiento Y Ctrl presionado (agacharse en lugar)
- **`walk`**: Solo se activa con movimiento normal (sin Ctrl ni Shift)
- **`run`**: Solo se activa con Shift + movimiento (sin Ctrl)
- Código obsoleto de balanceo eliminado

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js AnimationMixer
- ECS (Entity Component System)
- Sistema de estados de animación declarativo

### Archivos/Componentes Principales
- `frontend/src/ecs/animation/config/animation-config.js` - Configuración de estados
- `frontend/src/ecs/systems/render-system.js` - Eliminar código obsoleto

## Criterios de Aceptación

1. [ ] Estado `crouch_walk` funciona correctamente: se activa solo con Ctrl + movimiento
2. [ ] Estado `crouch_idle` funciona correctamente: se activa solo con Ctrl sin movimiento
3. [ ] Estado `walk` NO se activa cuando `wantsToCrouch = true`
4. [ ] Estado `run` NO se activa cuando `wantsToCrouch = true`
5. [ ] Código obsoleto de balanceo eliminado de `render-system.js`
6. [ ] Prioridades de estados están correctamente configuradas
7. [ ] No hay regresiones en animaciones existentes

## Detalles de Implementación

### Prioridades de Estados

Orden de prioridad (de mayor a menor):
1. `jump` (9) - Mayor prioridad
2. `crouch_walk` (7) - Ctrl + movimiento
3. `crouch_idle` (6) - Ctrl sin movimiento
4. `run` (5) - Shift + movimiento
5. `walk` (4) - Movimiento normal
6. `attack` (10) - Cuando quiere atacar
7. `idle` (1) - Por defecto

### Dependencias
- Depende de: JDG-021 (sistema de animaciones avanzadas debe estar implementado)

## Testing

### Escenarios de Prueba
1. **Caminar agachado**: Presionar Ctrl + W → debe activar `crouch_walk`
2. **Agacharse en lugar**: Presionar Ctrl sin movimiento → debe activar `crouch_idle`
3. **Caminar normal**: Presionar W sin Ctrl ni Shift → debe activar `walk`
4. **Correr**: Presionar Shift + W → debe activar `run`
5. **Correr agachado**: Presionar Ctrl + Shift + W → debe activar `crouch_walk` (Ctrl tiene prioridad)
6. **Transiciones**: Cambiar entre estados debe ser suave

### Casos Edge a Considerar
- Presionar Ctrl mientras se corre → debe cambiar a `crouch_walk`
- Saltar mientras está agachado → debe priorizar `jump`

## Estimación
- **Complejidad:** Media
- **Tiempo estimado:** 2-3 horas

## Referencias
- **Relacionado con:** JDG-021 (sistema de animaciones avanzadas)
- **Animaciones disponibles:**
  - `crouch_walk_forward` - Caminar agachado

## Notas Adicionales
- El estado `crouch_idle` necesita una animación apropiada. Si no existe, considerar usar `crouch_walk_forward` con velocidad 0 o crear una nueva animación
- El código obsoleto en `render-system.js` (líneas 56-66) aplica balanceo manual que las animaciones GLB ya manejan
