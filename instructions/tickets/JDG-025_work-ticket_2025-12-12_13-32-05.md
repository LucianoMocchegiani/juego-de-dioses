# JDG-025 - Sistema de Equipamiento y Visualización de Armas

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Se necesitan implementar las siguientes funcionalidades relacionadas con armas:

1. **Visualización de armas en el personaje**: Los modelos GLB de armas ya están disponibles en `backend/static/models/weapons/` y necesitan ser cargados y mostrados en el personaje del jugador.

2. **Sistema de equipamiento**: El personaje debe poder equipar diferentes tipos de armas (espada, hacha, martillo, lanza, etc.) y estas deben visualizarse correctamente adheridas al personaje.

3. **Pruebas y validación**: Necesitamos poder probar el sistema equipando diferentes armas al personaje y verificar que:
   - Las armas se muestran correctamente
   - Las animaciones específicas por tipo de arma funcionan
   - El sistema de combate/animaciones respeta el tipo de arma equipada

**Modelos disponibles:**
- `sword.glb` - Espada de una mano
- `axe.glb` - Hacha de una mano
- `two-handed-axe.glb` - Hacha de dos manos
- `hammer.glb` - Martillo de una mano
- `two-handed-hammer.glb` - Martillo de dos manos
- `spear.glb` - Lanza

### Comportamiento Actual

- Los modelos GLB de armas existen en `backend/static/models/weapons/` pero no se cargan ni se muestran
- El sistema de animaciones por tipo de arma ya está implementado (`weapon-animations-config.js`) pero solo funciona a nivel lógico
- `WeaponComponent` existe y se puede agregar a entidades, pero no tiene efecto visual
- No hay forma de equipar/cambiar armas en el personaje
- No hay sistema de attachment points (dónde se pegan las armas al modelo del personaje)

### Comportamiento Esperado

**Sistema de Equipamiento:**
- El personaje puede equipar un arma especificando el tipo y el nombre del modelo
- El arma se carga desde `backend/static/models/weapons/`
- El arma se visualiza correctamente adherida al personaje (en la mano derecha por defecto, o en ambas manos para armas de dos manos)

**Visualización:**
- El modelo del arma se posiciona y orienta correctamente respecto al personaje
- El arma sigue los movimientos y rotaciones del personaje
- El arma se escala apropiadamente según el tamaño del personaje
- Las armas de dos manos se posicionan correctamente (ambas manos)

**Integración con Animaciones:**
- Cuando se equipa un arma, el `WeaponComponent` se actualiza con el tipo correcto
- El sistema de animaciones usa el tipo de arma para seleccionar animaciones apropiadas
- Las animaciones de combate respetan el tipo de arma equipada

**Pruebas:**
- Mecanismo temporal o permanente para equipar/cambiar armas durante pruebas
- Verificación visual de que las armas se muestran correctamente
- Verificación de que las animaciones funcionan correctamente según el tipo de arma

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI) - Ruta para servir modelos de armas (ya existe en `/static/models/`)
- [x] Frontend (Three.js) - Sistema de carga y visualización de armas
- [ ] Base de Datos (PostgreSQL) - No afectado inicialmente (futuro: inventario de armas)
- [ ] Cache (Redis) - No afectado
- [ ] Docker/Infraestructura - No afectado
- [ ] API Endpoints - Posiblemente endpoints futuros para inventario de armas
- [ ] WebSockets - No afectado inicialmente

### Tecnologías Involucradas
- **Three.js**: Carga de modelos GLB, sistema de attachment (parenting), transformaciones
- **JavaScript ES6+**: Lógica de equipamiento, gestión de armas
- **GLB/GLTF**: Formatos de modelos 3D
- **ECS (Entity Component System)**: `WeaponComponent` existente

### Archivos/Componentes Principales

**Frontend - Archivos nuevos:**
- `frontend/src/ecs/systems/weapon-render-system.js` - Sistema para renderizar armas equipadas
- `frontend/src/utils/weapon-attachment.js` - Utilidades para attachment de armas a personajes
- `frontend/src/config/weapon-models-config.js` - Configuración de rutas de modelos de armas

**Frontend - Archivos a modificar:**
- `frontend/src/ecs/factories/player-factory.js` - Agregar soporte para equipar arma inicial
- `frontend/src/ecs/components/weapon.js` - Extender con información de modelo y attachment
- `frontend/src/ecs/systems/combat-system.js` - Asegurar que use WeaponComponent correctamente
- `frontend/src/ecs/systems/combo-system.js` - Asegurar que use WeaponComponent correctamente

**Backend:**
- Ya tiene la ruta `/static/models/weapons/` funcionando (nginx)

## Criterios de Aceptación

1. [ ] El personaje puede equipar un arma especificando su tipo y nombre de modelo
2. [ ] El modelo del arma se carga correctamente desde `backend/static/models/weapons/`
3. [ ] El arma se visualiza adherida al personaje en la posición correcta (mano derecha o ambas manos)
4. [ ] El arma sigue los movimientos y rotaciones del personaje correctamente
5. [ ] Las armas de una mano se posicionan en la mano derecha
6. [ ] Las armas de dos manos se posicionan correctamente (entre ambas manos o en posición de dos manos)
7. [ ] El `WeaponComponent` se actualiza correctamente cuando se equipa un arma
8. [ ] Las animaciones de combate usan el tipo de arma correcto según `WeaponComponent`
9. [ ] Existe un mecanismo (temporal o permanente) para equipar/cambiar armas durante pruebas
10. [ ] Todas las armas disponibles pueden ser equipadas y visualizadas correctamente

## Detalles de Implementación

### Consideraciones Técnicas

**Attachment de Armas:**
- Usar bones del esqueleto del personaje si están disponibles (mano derecha, mano izquierda)
- Si no hay bones, usar offsets relativos al mesh del personaje
- Para armas de dos manos, usar un punto de attachment entre ambas manos o en el centro del torso

**Escala y Orientación:**
- Las armas deben escalarse apropiadamente según el tamaño del personaje
- Las armas deben orientarse correctamente (punta hacia adelante, agarre correcto)
- Puede ser necesario ajustar offsets específicos por tipo de arma

**Performance:**
- Cache de modelos de armas cargados (reutilizar el mismo modelo GLB para múltiples instancias)
- Optimizar carga de modelos (solo cargar cuando se equipa)
- Considerar instanciación para múltiples personajes con la misma arma

**Compatibilidad:**
- Funcionar con personajes que tienen modelo 3D (GLB) y con personajes de geometría primitiva
- Mantener compatibilidad con el sistema de animaciones existente
- No romper funcionalidad existente de combate/animaciones

### Dependencias

- **Depende de**: JDG-021 (Sistema de Combate con Combos - ya completado)
- **Depende de**: JDG-012 (Sistema de Modelos 3D - ya completado)
- **Bloquea**: Sistema de Inventario de Armas (futuro), Sistema de Progresión de Armas (futuro)

## Testing

### Escenarios de Prueba

1. **Equipar Espada de Una Mano:**
   - Equipar `sword.glb`
   - Verificar que se muestra en la mano derecha
   - Verificar que las animaciones de espada funcionan

2. **Equipar Hacha de Dos Manos:**
   - Equipar `two-handed-axe.glb`
   - Verificar que se muestra en posición de dos manos
   - Verificar que las animaciones de hacha funcionan

3. **Cambiar Armas:**
   - Equipar espada, luego cambiar a hacha
   - Verificar que la espada se desequipa y la hacha se equipa
   - Verificar que no hay duplicados de modelos

4. **Desequipar Arma:**
   - Equipar arma, luego desequipar
   - Verificar que el arma desaparece y las animaciones vuelven a genéricas

5. **Múltiples Armas:**
   - Si el sistema lo permite, equipar arma y escudo
   - Verificar que ambos se muestran correctamente

### Casos Edge a Considerar

- Personaje sin modelo 3D (solo geometría primitiva) - ¿cómo se adjunta el arma?
- Personaje sin bones/esqueleto - ¿usar offsets fijos?
- Arma que no existe en la ruta - manejo de errores
- Cambiar arma durante animación de ataque - ¿esperar a que termine?
- Cargar mismo modelo múltiples veces - usar cache

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 2-3 días
- **Notas:** 
  - Depende de si los modelos de personaje tienen bones definidos
  - Puede requerir ajustes manuales de offsets por tipo de arma
  - Pruebas exhaustivas necesarias para cada tipo de arma

## Referencias

- **Relacionado con:** JDG-021 (Sistema de Combate con Combos), JDG-012 (Sistema de Modelos 3D)
- **Documentación relevante:**
  - `frontend/src/ecs/components/weapon.js` - Componente de arma existente
  - `frontend/src/config/weapon-animations-config.js` - Configuración de animaciones por arma
  - `frontend/src/renderers/models/model-utils.js` - Utilidades de carga de modelos
- **Modelos disponibles:** `backend/static/models/weapons/`

## Notas Adicionales

**Modelos de Armas Disponibles:**
- `sword.glb` - Espada de una mano
- `axe.glb` - Hacha de una mano
- `two-handed-axe.glb` - Hacha de dos manos (3.8MB - considerar optimización)
- `hammer.glb` - Martillo de una mano
- `two-handed-hammer.glb` - Martillo de dos manos
- `spear.glb` - Lanza

**Tipos de Armas Soportados:**
- `sword` - Espada
- `axe` - Hacha
- `hammer` - Martillo
- `spear` - Lanza
- `generic` - Sin arma (por defecto)

**Futuro:**
- Sistema de inventario para almacenar múltiples armas
- Sistema de estadísticas de armas (daño, durabilidad, etc.)
- Armas con efectos especiales
- Mejoras y encantamientos de armas

