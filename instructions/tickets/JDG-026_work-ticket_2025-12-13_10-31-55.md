# JDG-026 - Correcci贸n de Inputs y Sistema de Dodge B谩sico

## Tipo
- [x] Feature (nueva funcionalidad)
- [x] Bugfix (correcci贸n de error)
- [ ] Refactor (mejora de c贸digo sin cambiar funcionalidad)
- [ ] Performance (optimizaci贸n)
- [ ] Documentation (documentaci贸n)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad cr铆tica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripci贸n

### Problema/Requerimiento
Se identificaron problemas cr铆ticos en el sistema de inputs y acciones de combate:
1. Las teclas Q, E, F, R no se detectaban correctamente (no aparec铆an en logs ni activaban acciones)
2. El sistema de dodge no funcionaba correctamente (no se activaba la animaci贸n)
3. El click simple activaba incorrectamente el special attack sin presionar R
4. El dodge requer铆a mantener presionada la tecla E en lugar de un solo press

### Comportamiento Actual
- Las teclas Q, E, F, R no se detectaban porque no estaban en la lista de `preventDefault` y no ten铆an `stopPropagation()`
- El jugador no ten铆a `WeaponComponent` por defecto, causando que acciones que requer铆an arma no funcionaran
- El dodge requer铆a mantener presionada la tecla y no mov铆a al personaje
- La animaci贸n de dodge no se activaba porque el `defenseType` se reseteaba cada frame

### Comportamiento Esperado
- Todas las teclas de juego (Q, E, F, R) se detectan correctamente
- El dodge se activa con un solo press de E
- El dodge mueve al personaje en la direcci贸n de movimiento (o hacia adelante si no hay movimiento)
- La animaci贸n de dodge se reproduce correctamente
- Las acciones de combate (parry, dodge, special attack) funcionan correctamente

## Contexto T茅cnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnolog铆as Involucradas
- JavaScript ES6+
- Three.js
- ECS (Entity Component System)
- InputManager
- AnimationMixerSystem

### Archivos/Componentes Principales
- `frontend/src/systems/input-manager.js` - Agregado preventDefault y stopPropagation para Q, E, F, R
- `frontend/src/ecs/systems/input-system.js` - Cambiado dodge para usar isKeyDown en lugar de checkAction
- `frontend/src/ecs/systems/combat-system.js` - Removido requisito de movimiento para dodge
- `frontend/src/ecs/systems/physics-system.js` - Agregado movimiento de dodge (impulso en direcci贸n)
- `frontend/src/ecs/factories/player-factory.js` - Agregado WeaponComponent por defecto (comentado)
- `frontend/src/ecs/components/combat.js` - (Sin cambios, pero se revis贸 la estructura)

## Criterios de Aceptaci贸n

1. [x] Las teclas Q, E, F, R se detectan correctamente cuando se presionan
2. [x] El log `Tecla presionada: [c贸digo]` aparece en consola para todas las teclas
3. [x] El dodge se activa con un solo press de E (no requiere mantener presionado)
4. [x] El dodge mueve al personaje en la direcci贸n de movimiento actual
5. [x] Si no hay movimiento, el dodge mueve al personaje hacia adelante
6. [x] La animaci贸n de dodge (`roll_dodge`) se reproduce cuando se presiona E
7. [x] El special attack (R) solo se activa cuando se presiona R, no con click simple
8. [x] Las acciones de combate (parry Q, dodge E, special attack R, grab F) funcionan correctamente

## Detalles de Implementaci贸n

### Cambios Realizados

1. **InputManager** (`input-manager.js`):
   - Agregado `KeyQ`, `KeyE`, `KeyF`, `KeyP` a la lista de `gameKeys` con `preventDefault()` y `stopPropagation()`
   - Agregado log `console.log('Tecla presionada:', event.code)` para todas las teclas

2. **InputSystem** (`input-system.js`):
   - Cambiado detecci贸n de dodge para usar `isKeyDown()` en lugar de `checkAction()` para activaci贸n con un solo press
   - La detecci贸n ahora verifica si la tecla E fue presionada en este frame (no mantenida)

3. **CombatSystem** (`combat-system.js`):
   - Removido requisito de movimiento para activar dodge
   - El dodge ahora se activa simplemente presionando E

4. **PhysicsSystem** (`physics-system.js`):
   - Agregada l贸gica para aplicar impulso de movimiento cuando se hace dodge
   - Si hay direcci贸n de movimiento, esquivar en esa direcci贸n
   - Si no hay movimiento, esquivar hacia adelante (basado en rotaci贸n de c谩mara)
   - Velocidad de dodge: 20 celdas/segundo

5. **PlayerFactory** (`player-factory.js`):
   - Agregado (comentado) `WeaponComponent` por defecto con tipo 'sword' para que las acciones que requieren arma funcionen
   - Actualmente comentado por decisi贸n del usuario

### Consideraciones T茅cnicas
- **Performance**: Los cambios no afectan el rendimiento significativamente
- **Compatibilidad**: Compatible con el sistema ECS existente
- **Extensibilidad**: La estructura permite agregar m谩s acciones de combate f谩cilmente

### Dependencias
- Depende de: JDG-021 (Sistema de Combate y Animaciones)
- Relacionado con: JDG-027 (Sistema de Dodge Estilo Dark Souls - Refactor con configuraci贸n centralizada)

## Testing

### Escenarios de Prueba
1. **Teclas de Input**: Presionar Q, E, F, R y verificar que aparecen en consola
2. **Dodge con movimiento**: Presionar WASD + E y verificar que esquiva en direcci贸n de movimiento
3. **Dodge sin movimiento**: Presionar solo E y verificar que esquiva hacia adelante
4. **Animaci贸n de dodge**: Verificar que la animaci贸n `roll_dodge` se reproduce
5. **Special Attack**: Presionar R y verificar que solo se activa con R, no con click

### Casos Edge a Considerar
- Presionar E m煤ltiples veces r谩pidamente (actualmente no hay cooldown)
- Presionar E mientras se est谩 atacando (actualmente se puede interrumpir)
- Presionar E sin estar en el suelo (actualmente funciona en el aire tambi茅n)

## Estimaci贸n

- **Complejidad:** Media
- **Tiempo estimado:** 2 horas
- **Notas:** La mayor parte del tiempo fue debugging de inputs y pruebas

## Referencias

- **Relacionado con:** JDG-021 (Sistema de Combate y Animaciones), JDG-025 (Equipar Armas)
- **Documentaci贸n relevante:** `frontend/src/ecs/README.md`, `frontend/src/config/input-map-config.js`
- **Discusiones previas:** Correcci贸n de inputs detectados durante testing de combate

## Notas Adicionales

- El `WeaponComponent` fue agregado al jugador pero est谩 comentado. Se puede habilitar cuando se implemente el sistema de equipamiento de armas (JDG-025).
- El sistema de dodge actual es funcional pero b谩sico. El refactor completo con configuraci贸n centralizada, cooldowns y estado persistente est谩 planificado en JDG-027.
- Los logs de debug (`Tecla presionada:` y ` Animaci贸n:`) fueron agregados temporalmente para facilitar el troubleshooting. Se pueden remover en el futuro si no son necesarios.
- La velocidad de dodge (20 celdas/segundo) est谩 hardcodeada temporalmente. Se mover谩 a configuraci贸n centralizada en JDG-027.

