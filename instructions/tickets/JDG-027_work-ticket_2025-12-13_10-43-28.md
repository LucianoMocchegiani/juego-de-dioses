# JDG-027 - Sistema de Dodge Estilo Dark Souls - Refactor

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento
El sistema de dodge actual es funcional pero básico y no está preparado para escalar. Los valores están hardcodeados, no hay cooldown, el estado no persiste durante la animación, y agregar nuevas acciones de combate similares requiere modificar múltiples sistemas.

Se necesita refactorizar el sistema para:
1. Centralizar configuración de acciones de combate (cooldown, velocidad, animaciones)
2. Implementar cooldown para evitar spam de dodge
3. Mantener estado persistente durante la animación de dodge
4. Sincronizar correctamente el fin de animaciones con el reseteo de estado
5. Preparar el sistema para futuras mejoras (i-frames, diferentes tipos de movimiento)

### Comportamiento Actual
- La velocidad de dodge está hardcodeada en `physics-system.js` (20 celdas/segundo)
- No hay cooldown, permitiendo spam de dodge
- `defenseType: 'dodge'` se resetea cada frame en `combat.reset()`
- No hay forma de trackear si el jugador está actualmente haciendo dodge
- No hay sincronización entre cuando termina la animación y cuando se resetea el estado
- Agregar nuevas acciones similares requiere modificar código en múltiples sistemas

### Comportamiento Esperado
- Configuración centralizada de acciones de combate en `combat-actions-config.js`
- Cooldown configurable por acción (dodge: 0.5 segundos)
- Estado persistente durante animación (`activeAction`, `isDodging`)
- Sistema detecta cuando la animación termina y resetea el estado correctamente
- Protección contra interrupciones durante acciones con `preventInterruption: true`
- Fácil agregar nuevas acciones solo con configuración (sin modificar sistemas)

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js
- ECS (Entity Component System)
- AnimationMixerSystem

### Archivos/Componentes Principales

**Archivos Nuevos:**
- `frontend/src/config/combat-actions-config.js` - Configuración centralizada de acciones de combate

**Archivos a Modificar:**
- `frontend/src/ecs/components/combat.js` - Agregar `activeAction`, `actionStartTime`, `actionCooldowns`, `hasIFrames`, métodos `startAction()`, `endAction()`, `isOnCooldown()`, `updateCooldowns()`
- `frontend/src/ecs/systems/combat-system.js` - Refactorizar para usar configuración en lugar de código hardcodeado
- `frontend/src/ecs/systems/physics-system.js` - Refactorizar movimiento para usar configuración
- `frontend/src/ecs/systems/animation-mixer-system.js` - Detectar fin de animaciones y resetear estado

## Criterios de Aceptación

1. [ ] Existe archivo `combat-actions-config.js` con configuración de dodge (cooldown, velocidad, animación, etc.)
2. [ ] `CombatComponent` tiene propiedades para trackear acción activa y cooldowns
3. [ ] El dodge tiene cooldown de 0.5 segundos y no se puede spamear
4. [ ] El estado de dodge persiste durante toda la animación (no se resetea cada frame)
5. [ ] El sistema detecta cuando la animación de dodge termina y resetea el estado correctamente
6. [ ] El dodge no se puede interrumpir durante la animación (protección contra interrupciones)
7. [ ] Agregar una nueva acción similar (ej: dash) solo requiere agregar entrada en configuración
8. [ ] Todos los valores (cooldown, velocidad) están en configuración, no hardcodeados

## Detalles de Implementación

### Consideraciones Técnicas
- **Performance**: El sistema de cooldowns usa Map lookup (O(1)), eficiente
- **Compatibilidad**: Los cambios son compatibles con el sistema ECS existente
- **Extensibilidad**: La configuración permite agregar nuevas acciones sin modificar sistemas
- **Migración**: Se puede hacer de forma incremental, fase por fase

### Dependencias
- Depende de: JDG-026 (Corrección de Inputs y Dodge Básico)
- Bloquea: (ninguno)

## Testing

### Escenarios de Prueba
1. **Cooldown de Dodge**: Presionar E múltiples veces rápidamente y verificar que solo funciona después del cooldown
2. **Persistencia de Estado**: Verificar que `defenseType` no se resetea durante la animación
3. **Fin de Animación**: Verificar que el estado se resetea cuando la animación termina
4. **Protección contra Interrupciones**: Verificar que el dodge no se puede interrumpir con otras acciones
5. **Configuración**: Cambiar valores en `combat-actions-config.js` y verificar que se aplican sin modificar código

### Casos Edge a Considerar
- Presionar E durante un ataque (debe esperar a que termine o respetar cooldown)
- Presionar E justo antes de que termine el cooldown (edge timing)
- Múltiples acciones con diferentes cooldowns

## Estimación

- **Complejidad:** Alta
- **Tiempo estimado:** 4-6 horas
- **Notas:** Requiere cambios en múltiples sistemas y sincronización cuidadosa

## Referencias

- **Relacionado con:** JDG-026 (Corrección de Inputs y Dodge Básico)
- **Documentación relevante:** 
  - `frontend/src/ecs/README.md`
  - `instructions/analysis/JDG-027-architecture-analysis_2025-12-13_10-32-33.md` (Análisis de Arquitectura completo)
- **Discusiones previas:** Refactor planificado para mejorar escalabilidad del sistema de combate

## Notas Adicionales

- Este ticket implementa la arquitectura propuesta en el análisis de arquitectura JDG-027
- La migración se puede hacer incrementalmente, probando cada fase antes de continuar
- El sistema está preparado para futuras mejoras como i-frames (invencibilidad durante dodge)
- Los valores de configuración pueden ajustarse según feedback de gameplay

