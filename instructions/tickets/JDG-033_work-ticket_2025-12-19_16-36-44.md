# JDG-033 - Migración de Modelos y Animaciones a Estructura Biped

## Tipo
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Actualmente, los modelos de personajes y animaciones están organizados en estructuras inconsistentes:
- Modelos de personajes: `backend/static/models/characters/`
- Animaciones: `backend/static/models/animations/biped/` (ya parcialmente organizadas)

Existe una nueva estructura más organizada en `backend/static/models/biped/male/` que contiene:
- Modelos en `biped/male/characters/`
- Animaciones organizadas en `biped/male/animations/` por categorías

Necesitamos migrar todo el sistema para usar esta nueva estructura, que mejorará la organización y preparará el sistema para futuras expansiones (quadrupeds, flying, etc.).

### Comportamiento Actual

1. **Modelos de personajes**: 
   - Ubicación: `backend/static/models/characters/Character_output.glb`
   - Rutas en BD: `"ruta": "characters/Character_output.glb"`
   - Frontend carga desde: `/static/models/${modelo3d.ruta}`

2. **Animaciones** (estructura antigua):
   - Ubicación: `backend/static/models/animations/biped/{categoria}/Animation_...`
   - Categorías: `sword/`, `axe/`, `hammer/`, `two-hand-sword/`, `two-hand-hammer/`, `two-hand-axe/`, `two-swords/`, `shield/`, `cuffs/`, `spear/`, `idle/`, `movement/`, `hit-reactions/`, `interactions/`, `secondary-interactions/`, `skills/`
   - Frontend referencia en `animation-config.js`: `'animations/biped/sword/Animation_Left_Slash_withSkin.glb'`
   - Sistema de carga construye: `/static/models/${animationFile}`

3. **Nueva estructura existente**:
   - Modelos: `backend/static/models/biped/male/characters/Meshy_AI_Character_output.glb`
   - Animaciones: `backend/static/models/biped/male/animations/{categoria}/Meshy_AI_Animation_...`
   - **Nuevas categorías reorganizadas:**
     - `shield-and-one-hand-weapon/` (agrupa: sword, axe, shield, algunos hammers)
     - `two-hands-weapon/` (agrupa: two-hand-sword, two-hand-hammer)
     - `movement/` (expandido: incluye idle, spear, etc.)
     - `transitions/` (nuevo: animaciones de transición como stand_up)
     - `cuffs/`, `hit-reactions/`, `interactions/` (sin cambios)
   - **Archivos renombrados:** Prefijo cambia de `Animation_...` a `Meshy_AI_Animation_...`

### Comportamiento Esperado

1. **Modelos de personajes**:
   - Ubicación: `backend/static/models/biped/male/characters/Meshy_AI_Character_output.glb`
   - Rutas en BD: `"ruta": "biped/male/characters/Meshy_AI_Character_output.glb"`
   - Frontend carga desde: `/static/models/${modelo3d.ruta}` (mismo sistema, nueva ruta)

2. **Animaciones**:
   - Ubicación: `backend/static/models/biped/male/animations/{nueva_categoria}/Meshy_AI_Animation_...`
   - **Cambios principales:**
     - Ruta base: `animations/biped/` → `biped/male/animations/`
     - Categorías reorganizadas (ver mapeo en detalles de implementación)
     - Nombres de archivos: `Animation_...` → `Meshy_AI_Animation_...`
   - Frontend referencia actualizada en `animation-config.js` con nuevas rutas y categorías
   - Sistema de carga sigue funcionando igual (construye URL desde ruta)

3. **Sistema unificado**:
   - Estructura consistente entre modelos y animaciones
   - Preparado para agregar variantes (female, base, etc.)
   - Fácil extensión a otros tipos de entidades (quadrupeds)

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [x] Frontend (Three.js)
- [x] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [x] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Python 3.11, FastAPI, asyncpg
- Three.js, JavaScript ES6+
- PostgreSQL 16
- GLB/GLTF file formats

### Archivos/Componentes Principales

**Backend:**
- `backend/src/api/routes/characters.py` - Endpoint `/api/v1/dimensions/{id}/characters/{id}/model`
- `backend/src/database/seed_character_with_model.py` - Scripts de creación de personajes
- `backend/src/database/templates/bipedos/` - Templates de bipeds
- `backend/src/storage/local_file_storage.py` - Manejo de rutas de archivos
- `backend/static/models/` - Estructura de archivos (a reorganizar)

**Frontend:**
- `frontend/src/config/animation-config.js` - Configuración de animaciones (ya parcialmente actualizado)
- `frontend/src/ecs/systems/animation-mixer-system.js` - Sistema de carga de animaciones
- `frontend/src/renderers/models/model-utils.js` - Utilidades de carga de modelos
- `frontend/src/ecs/factories/player-factory.js` - Creación de jugadores

**Base de Datos:**
- Tabla `juego_dioses.agrupaciones` - Campo `modelo_3d` (JSONB) contiene rutas
- Scripts de migración de datos

## Criterios de Aceptación

1. [ ] Todos los modelos de personajes están en `backend/static/models/biped/male/characters/`
2. [ ] Todas las animaciones están en `backend/static/models/biped/male/animations/{category}/`
3. [ ] Las rutas en la base de datos apuntan a la nueva estructura (`biped/male/characters/...`)
4. [ ] El frontend carga correctamente modelos y animaciones desde las nuevas ubicaciones
5. [ ] El endpoint `/api/v1/dimensions/{id}/characters/{id}/model` retorna rutas actualizadas
6. [ ] Todos los personajes existentes funcionan correctamente después de la migración
7. [ ] El sistema de animaciones funciona correctamente con las nuevas rutas
8. [ ] La estructura antigua (`characters/`, `animations/biped/` desde raíz) se puede eliminar
9. [ ] La documentación refleja la nueva estructura
10. [ ] No hay regresiones en funcionalidad existente

## Detalles de Implementación

### Mapeo de Rutas de Animaciones

**Ejemplos de cambios necesarios en `animation-config.js`:**

```javascript
// ANTES (estructura antigua):
'left_slash': 'animations/biped/sword/Animation_Left_Slash_withSkin.glb',
'axe_spin_attack': 'animations/biped/axe/Animation_Axe_Spin_Attack_withSkin.glb',
'combat_stance': 'animations/biped/idle/Animation_Combat_Stance_withSkin.glb',
'attack': 'animations/biped/two-hand-sword/Animation_Attack_withSkin.glb',

// DESPUÉS (estructura nueva):
'left_slash': 'biped/male/animations/shield-and-one-hand-weapon/Meshy_AI_Animation_Left_Slash_withSkin.glb',
'axe_spin_attack': 'biped/male/animations/shield-and-one-hand-weapon/Meshy_AI_Animation_Axe_Spin_Attack_withSkin.glb',
'combat_stance': 'biped/male/animations/movement/Meshy_AI_Animation_Combat_Stance_withSkin.glb',
'attack': 'biped/male/animations/two-hands-weapon/Meshy_AI_Animation_Attack_withSkin.glb', // Verificar si existe
```

**Mapeo de categorías principales:**
- `sword/` → `shield-and-one-hand-weapon/`
- `axe/` → `shield-and-one-hand-weapon/`
- `shield/` → `shield-and-one-hand-weapon/`
- `two-hand-sword/` → `two-hands-weapon/`
- `two-hand-hammer/` → `two-hands-weapon/`
- `idle/` → `movement/`
- `spear/` → `movement/`
- `interactions/Animation_Stand_Up2_withSkin.glb` → `transitions/Meshy_AI_Animation_Stand_Up2_withSkin.glb`
- `cuffs/`, `hit-reactions/`, `interactions/` (otros) → sin cambio de categoría, solo prefijo

**Animaciones a verificar (pueden no existir en nueva estructura):**
- `hammer/Animation_Charged_Upward_Slash_withSkin.glb`
- `two-hand-axe/Animation_Charged_Axe_Chop_withSkin.glb`
- `two-swords/Animation_Double_Blade_Spin_withSkin.glb`
- `skills/Animation_Charged_Spell_Cast_withSkin.glb`
- `skills/Animation_Skill_01_withSkin.glb`
- `secondary-interactions/Animation_Talk_with_Hands_Open_withSkin.glb`

### Consideraciones Técnicas

**Performance:**
- La migración no afecta el rendimiento (solo cambia rutas)
- El sistema de cache del frontend seguirá funcionando igual

**Seguridad:**
- No hay cambios en seguridad, solo reorganización de archivos

**Compatibilidad:**
- Mantener compatibilidad temporal con rutas antiguas durante migración
- Crear sistema de resolución de rutas que pueda manejar ambas estructuras durante transición

**Escalabilidad:**
- Nueva estructura facilita agregar nuevos tipos de entidades
- Sistema de rutas más predecible y mantenible

### Dependencias

**Depende de:**
- Ninguna (ticket independiente)

**Bloquea:**
- Tickets futuros que agreguen nuevos tipos de entidades (quadrupeds, flying, etc.)
- Sistema de skins/variantes (requiere estructura organizada)

## Testing

### Escenarios de Prueba

1. **Escenario 1: Cargar personaje existente**
   - Precondición: Personaje creado antes de migración
   - Acción: Cargar personaje en el juego
   - Resultado esperado: Modelo carga correctamente desde nueva ubicación

2. **Escenario 2: Crear nuevo personaje**
   - Precondición: Estructura migrada
   - Acción: Crear nuevo personaje usando template de biped
   - Resultado esperado: Se usa nueva ruta en BD

3. **Escenario 3: Reproducir animaciones**
   - Precondición: Personaje cargado
   - Acción: Mover personaje (walk, run, attack)
   - Resultado esperado: Animaciones cargan y reproducen correctamente

4. **Escenario 4: Endpoint de modelo**
   - Precondición: Personaje con modelo en nueva estructura
   - Acción: GET `/api/v1/dimensions/{id}/characters/{id}/model`
   - Resultado esperado: Retorna ruta en nueva estructura

5. **Escenario 5: Migración de datos**
   - Precondición: Base de datos con personajes existentes
   - Acción: Ejecutar script de migración
   - Resultado esperado: Todas las rutas actualizadas correctamente

### Casos Edge a Considerar

- **Caso 1**: Personajes con rutas personalizadas en BD (no estándar)
  - Solución: Script de migración debe validar y reportar rutas no migrables

- **Caso 2**: Referencias a modelos en código hardcodeadas
  - Solución: Buscar y actualizar todas las referencias

- **Caso 3**: Archivos faltantes durante migración
  - Solución: Validar que todos los archivos existen antes de actualizar BD

- **Caso 4**: Cache del navegador con URLs antiguas
  - Solución: Agregar cache buster o invalidar cache

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 8-12 horas
- **Notas:** 
  - Depende de cantidad de personajes existentes en BD
  - Requiere testing exhaustivo para evitar regresiones
  - Puede requerir coordinación para evitar downtime

## Plan de Implementación

### Fase 1: Preparación (2-3 horas)
1. Verificar estructura actual y nueva
2. Crear script para validar archivos existentes
3. Documentar mapeo de rutas antiguas → nuevas

### Fase 2: Actualización de Backend (2-3 horas)
1. Crear sistema de resolución de rutas (opcional, para compatibilidad temporal)
2. Actualizar templates de bipeds para usar nuevas rutas
3. Crear script de migración de datos para BD

### Fase 3: Actualización de Frontend (3-4 horas)
1. **Mapear animaciones existentes a nueva estructura:**
   - Identificar qué animaciones existen en nueva estructura
   - Mapear categorías antiguas → nuevas
   - Verificar nombres de archivos (prefijo `Meshy_AI_Animation_...`)
2. **Actualizar `animation-config.js`:**
   - Cambiar ruta base: `animations/biped/` → `biped/male/animations/`
   - Actualizar categorías según mapeo (ej: `sword/` → `shield-and-one-hand-weapon/`)
   - Actualizar nombres de archivos (prefijo `Meshy_AI_Animation_...`)
   - Manejar animaciones faltantes (comentarlas o usar fallbacks)
3. Verificar que `animation-mixer-system.js` funciona con nuevas rutas
4. Actualizar referencias hardcodeadas si existen

### Fase 4: Migración de Datos (1-2 horas)
1. Ejecutar script de migración en entorno de desarrollo
2. Verificar que todos los registros se actualizaron correctamente
3. Ejecutar en producción con backup previo

### Fase 5: Limpieza y Validación (1-2 horas)
1. Verificar que todo funciona correctamente
2. Eliminar estructura antigua (opcional, puede mantener temporalmente)
3. Actualizar documentación

## Referencias

- **Relacionado con:** 
  - JDG-032 (Limpieza de animaciones duplicadas)
  - JDG-012 (Sistema de modelos 3D)
  - JDG-015 (Sistema de animaciones)
- **Documentación relevante:** 
  - `/instructions/analysis/JDG-033-architecture-analysis_*.md` (Análisis de arquitectura)
  - `backend/src/api/routes/README.md` (Documentación de endpoints)
- **Discusiones previas:** 
  - Decisión de migrar a estructura `biped/` para mejor organización

## Notas Adicionales

1. **Compatibilidad temporal**: Considerar mantener resolución de rutas antiguas durante período de transición
2. **Backup**: Hacer backup de BD antes de migración
3. **Testing**: Probar exhaustivamente en desarrollo antes de producción
4. **Documentación**: Actualizar READMEs y documentación inline
5. **Estructura futura**: La nueva estructura facilita agregar `female/`, `base/`, etc.

## Checklist de Implementación

### Backend
- [ ] Crear/verificar estructura `biped/male/characters/` y `biped/male/animations/`
- [ ] Mover archivos a nueva estructura
- [ ] Crear script de migración de datos
- [ ] Actualizar templates de bipeds
- [ ] Actualizar `seed_character_with_model.py` si es necesario
- [ ] Probar endpoint `/api/v1/dimensions/{id}/characters/{id}/model`

### Frontend
- [ ] Verificar qué animaciones existen en `biped/male/animations/`
- [ ] Crear mapeo completo de rutas antiguas → nuevas
- [ ] Actualizar `animation-config.js` con:
  - Nueva ruta base: `biped/male/animations/`
  - Nuevas categorías según mapeo
  - Prefijo `Meshy_AI_Animation_...` en nombres de archivos
- [ ] Comentar o manejar animaciones que no existen en nueva estructura
- [ ] Verificar `animation-mixer-system.js`
- [ ] Buscar y actualizar referencias hardcodeadas
- [ ] Probar carga de modelos
- [ ] Probar sistema de animaciones (verificar que todas las animaciones usadas cargan correctamente)

### Base de Datos
- [ ] Crear script de migración
- [ ] Ejecutar en desarrollo
- [ ] Verificar registros actualizados
- [ ] Ejecutar en producción (con backup)

### Validación
- [ ] Todos los personajes cargan correctamente
- [ ] Todas las animaciones funcionan
- [ ] No hay errores en consola
- [ ] Endpoints retornan rutas correctas
- [ ] Documentación actualizada

### Limpieza
- [ ] Eliminar estructura antigua (opcional)
- [ ] Actualizar documentación
- [ ] Commit y merge
