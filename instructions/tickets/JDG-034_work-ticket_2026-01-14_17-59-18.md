# JDG-034 - Bloquear Movimiento WASD Durante Animaciones de Habilidades

## Tipo
- [ ] Feature (nueva funcionalidad)
- [x] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Cuando el jugador lanza una habilidad (ataque, habilidad especial, etc.), puede seguir moviéndose con WASD durante la animación de la habilidad. Esto es incorrecto porque:

1. **Rompe la inmersión**: El jugador puede moverse libremente mientras ejecuta una habilidad, lo cual no tiene sentido visualmente
2. **Afecta el balance**: Permite al jugador reposicionarse durante habilidades que deberían tener compromiso (commitment)
3. **Inconsistencia con diseño**: Las habilidades con `preventInterruption` están diseñadas para no poder ser interrumpidas, pero el movimiento permite evadir o reposicionarse

El movimiento solo debería permitirse cuando la habilidad específicamente lo requiere (como en dodge que tiene `hasMovement: true`), pero no para habilidades de ataque o habilidades especiales que no tienen movimiento configurado.

### Comportamiento Actual

- El jugador puede presionar WASD durante cualquier animación de habilidad
- `InputSystem` siempre calcula `input.moveDirection` basado en teclas presionadas, independientemente de si hay una acción activa
- `PhysicsSystem` aplica aceleración basada en `input.moveDirection` incluso cuando `combat.activeAction` está activa
- No hay verificación para bloquear el movimiento normal cuando hay una acción de combate activa
- Solo las habilidades con `hasMovement: true` deberían permitir movimiento, pero el movimiento normal también se aplica

### Comportamiento Esperado

- Cuando `combat.activeAction` está activa y la acción NO tiene `hasMovement: true`, el movimiento con WASD debe estar bloqueado
- El jugador NO debe poder moverse con WASD durante animaciones de ataque, habilidades especiales, parry, etc.
- Solo las habilidades que específicamente requieren movimiento (como dodge con `hasMovement: true`) deben permitir movimiento
- El movimiento de la habilidad (si tiene `hasMovement: true`) debe funcionar correctamente según su configuración
- Una vez que la animación termina (`combat.activeAction` es null), el movimiento normal debe volver a funcionar

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js
- ECS (Entity Component System)
- Sistema de combate

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/input-system.js` - Bloquear cálculo de `moveDirection` cuando hay acción activa sin movimiento
- `frontend/src/ecs/systems/physics-system.js` - Bloquear aplicación de aceleración normal cuando hay acción activa sin movimiento
- `frontend/src/ecs/components/combat.js` - Verificar estado de `activeAction`
- `frontend/src/config/combat-actions-config.js` - Configuración de `hasMovement` para cada acción

## Criterios de Aceptación

1. [ ] Cuando `combat.activeAction` está activa y la acción NO tiene `hasMovement: true`, el jugador NO puede moverse con WASD
2. [ ] Cuando `combat.activeAction` está activa y la acción tiene `hasMovement: true` (como dodge), el movimiento funciona según configuración de la acción
3. [ ] Cuando `combat.activeAction` es null (animación terminó), el movimiento normal vuelve a funcionar
4. [ ] Los ataques básicos bloquean movimiento durante su animación
5. [ ] Las habilidades especiales bloquean movimiento durante su animación
6. [ ] Parry bloquea movimiento durante su animación
7. [ ] Dodge permite movimiento según su configuración (`hasMovement: true`)
8. [ ] No hay regresiones en otras funcionalidades de movimiento o combate

## Detalles de Implementación

### Consideraciones Técnicas

- **Verificación en InputSystem**: Antes de calcular `moveDirection`, verificar si hay `combat.activeAction` activa y si la acción NO tiene `hasMovement: true`
- **Verificación en PhysicsSystem**: Antes de aplicar aceleración normal basada en `input.moveDirection`, verificar si hay `combat.activeAction` activa y si la acción NO tiene `hasMovement: true`
- **Acciones con movimiento**: Las acciones con `hasMovement: true` (como dodge) deben seguir funcionando según su configuración
- **Compatibilidad**: No romper el movimiento de acciones que específicamente requieren movimiento
- **Performance**: La verificación debe ser eficiente y no afectar el rendimiento

### Lógica Propuesta

1. **En InputSystem**:
   - Verificar si `combat.activeAction` existe
   - Si existe, obtener `actionConfig` de `COMBAT_ACTIONS[combat.activeAction]`
   - Si `actionConfig.hasMovement === false` o no existe, no calcular `moveDirection` (dejarlo en 0)
   - Si `actionConfig.hasMovement === true`, permitir cálculo normal de `moveDirection` (para dodge, etc.)

2. **En PhysicsSystem**:
   - Verificar si `combat.activeAction` existe
   - Si existe y `actionConfig.hasMovement === false` o no existe, no aplicar aceleración normal basada en `input.moveDirection`
   - Si `actionConfig.hasMovement === true`, permitir movimiento según configuración de la acción (ya implementado)

### Dependencias
- Depende de: Ninguna
- Bloquea: Ninguna

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Ataque básico**: Presionar click izquierdo para atacar y presionar WASD, verificar que NO se mueve durante la animación
2. **Escenario 2 - Habilidad especial**: Activar habilidad especial y presionar WASD, verificar que NO se mueve durante la animación
3. **Escenario 3 - Parry**: Activar parry y presionar WASD, verificar que NO se mueve durante la animación
4. **Escenario 4 - Dodge**: Activar dodge y presionar WASD, verificar que SÍ se mueve según configuración de dodge
5. **Escenario 5 - Fin de animación**: Verificar que después de que la animación termina, el movimiento normal vuelve a funcionar
6. **Escenario 6 - Múltiples habilidades**: Probar con diferentes habilidades y verificar que todas bloquean movimiento correctamente
7. **Escenario 7 - Combos**: Verificar que durante combos, el movimiento también está bloqueado

### Casos Edge a Considerar
- **Transiciones entre acciones**: Asegurar que el bloqueo se aplica correctamente durante transiciones
- **Acciones con movimiento parcial**: Si hay acciones que requieren movimiento solo en ciertos momentos, verificar comportamiento
- **Cancelación de acciones**: Si una acción se cancela, el movimiento debe volver a funcionar inmediatamente
- **Acciones simultáneas**: Verificar comportamiento si hay múltiples sistemas intentando controlar movimiento

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 2-3 horas
- **Notas:** Cambios relativamente simples pero requieren verificación cuidadosa para no romper acciones que requieren movimiento

## Referencias

- **Relacionado con:** JDG-021 (Integración de Animaciones Avanzadas y Sistema de Combate con Combos), JDG-028 (Simplificación y Optimización del Sistema de Animaciones y Combate)
- **Documentación relevante:** `frontend/src/config/combat-actions-config.js`, `frontend/src/ecs/systems/combat-system.js`
- **Discusiones previas:** Sistema de combate implementado en JDG-021

## Notas Adicionales

- Este bug afecta la jugabilidad y el balance del combate, por lo que es importante corregirlo
- La solución debe ser cuidadosa para no romper acciones que específicamente requieren movimiento (como dodge)
- Se debe verificar que todas las acciones de combate tienen `hasMovement` configurado correctamente en `combat-actions-config.js`
- Si hay acciones que necesitan movimiento pero no lo tienen configurado, deben actualizarse en `combat-actions-config.js`
- El bloqueo debe ser inmediato cuando la acción se activa y debe liberarse inmediatamente cuando la acción termina
