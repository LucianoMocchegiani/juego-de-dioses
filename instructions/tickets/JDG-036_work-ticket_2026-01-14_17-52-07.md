# JDG-036 - Mejoras en Sistema de Armas y Consolidación de Tipos

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Durante el debugging del sistema de armas se identificaron dos problemas principales:
1. Falta de visibilidad sobre la estructura interna de los modelos GLB al cargar armas, dificultando identificar por qué algunas armas no se adjuntaban correctamente
2. Meshes desplazados dentro de Groups causaban que las armas se adjuntaran en posiciones incorrectas al bone

Adicionalmente, se encontró que el tipo `Dimension` estaba definido localmente en `viewport.js` aunque se usaba en múltiples módulos, y `Viewport` estaba duplicado.

### Comportamiento Actual

- No hay visibilidad sobre estructura interna de modelos GLB al cargar armas
- Meshes desplazados dentro de Groups causan posiciones incorrectas al adjuntar armas
- Tipo `Dimension` definido localmente aunque se usa en múltiples módulos
- Tipo `Viewport` duplicado en diferentes archivos
- Uso de `console.log` en lugar de sistema de logging estructurado

### Comportamiento Esperado

- Sistema de debug detallado para modelos de armas con inspección completa de jerarquía GLB
- Compensación automática de offsets para meshes desplazados
- Tipos compartidos consolidados en `types.js`
- Logs estructurados usando `debugLogger` en lugar de `console.log`
- Mejor visibilidad para debugging de problemas de adjuntado de armas

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js
- GLB/GLTF models
- ECS (Entity Component System)

### Archivos/Componentes Principales
- `frontend/src/types.js` - Consolidación de tipos compartidos
- `frontend/src/terrain/components/viewport.js` - Actualizado para usar tipos consolidados
- `frontend/src/ecs/systems/weapon-equip-system.js` - Sistema de debug y compensación de offsets
- `frontend/src/ecs/models/model-loader.js` - Logs estructurados
- `frontend/src/utils/weapon-attachment.js` - Logs estructurados

## Criterios de Aceptación

1. [ ] Tipos compartidos consolidados en `types.js`
2. [ ] Sistema de debug detallado para modelos de armas implementado
3. [ ] Inspección completa de jerarquía de modelos GLB funcionando
4. [ ] Compensación automática de offsets para meshes desplazados
5. [ ] Logs estructurados usando `debugLogger` en lugar de `console.log`
6. [ ] Sin errores de linter
7. [ ] Compensación automática funciona correctamente para diferentes armas
8. [ ] Logs muestran información útil para debugging

## Detalles de Implementación

### Consideraciones Técnicas

- **Consolidación de tipos**: Movido tipo `Dimension` desde `viewport.js` a `types.js`, eliminada duplicación de `Viewport`
- **Inspección de modelos**: Función `inspectWeaponModel()` analiza estructura completa del modelo (jerarquía, transformaciones, paths)
- **Compensación automática**: Detección automática de meshes desplazados y cálculo de offset necesario
- **Logging estructurado**: Reemplazo de `console.log` por `debugLogger` con niveles apropiados
- **Umbral de compensación**: Compensación solo se aplica cuando mesh está desplazado > 0.01 unidades

### Dependencias
- Depende de: JDG-030 (Sistema de Debugging) - para `debugLogger`
- Bloquea: Ninguna

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Consolidación de tipos**: Verificar que tipos consolidados funcionan correctamente en todos los módulos
2. **Escenario 2 - Inspección de modelos**: Verificar que inspección muestra información detallada de jerarquía
3. **Escenario 3 - Compensación automática**: Verificar que compensación funciona para axe (mesh desplazado en x: 0.91)
4. **Escenario 4 - Equipamiento de armas**: Probar equipamiento de diferentes armas (sword, axe, hammer, spear)
5. **Escenario 5 - Logs estructurados**: Verificar que logs se muestran correctamente en consola del navegador
6. **Escenario 6 - Estructura de jerarquía**: Verificar que estructura de jerarquía se muestra correctamente en logs

### Casos Edge a Considerar
- **Armas con offsets manuales**: La compensación automática podría afectar armas que ya tenían offsets configurados manualmente (pero solo se aplica si el mesh está desplazado > 0.01 unidades)
- **Modelos complejos**: La inspección debe manejar correctamente modelos con jerarquías complejas
- **Performance**: Los logs de debug no deben afectar significativamente el rendimiento

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 3-4 horas
- **Notas:** Cambios principalmente de logging y compensación automática, con consolidación de tipos

## Referencias

- **Relacionado con:** JDG-030 (Sistema de Debugging)
- **Documentación relevante:** Análisis de estructura de modelos GLB para debugging

## Notas Adicionales

- La compensación automática de offsets solo se aplica cuando el mesh está desplazado significativamente (> 0.01 unidades)
- Los logs de debug están configurados para nivel `debug` e `info`, asegurarse de que el debugger esté habilitado para ver toda la información
- La inspección de modelos muestra información detallada que puede ser útil para debugging futuro de modelos GLB
- Los tipos consolidados son retrocompatibles (solo cambian ubicación, no estructura)
- Corrección de error: Cambiado uso de `Quaternion.toEuler()` (inexistente) a `Euler.setFromQuaternion()` en inspección de modelos
