# JDG-039 - Sistema de Temperatura Ambiental y Sistema Sol/Luna Gleason

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Implementar el sistema de temperatura ambiental y el sistema de sol/luna con perspectiva Gleason para calcular la temperatura base de bloques espaciales. Este sistema es fundamental para que las partículas puedan ajustar su temperatura hacia la temperatura ambiental, y es requisito previo para sistemas de disipación de temperatura y transiciones por temperatura.

### Comportamiento Actual

- Los bloques espaciales (`WorldBloque`) existen pero no calculan temperatura ambiental
- No existe sistema de sol/luna para determinar posición solar y ciclo día/noche
- Las partículas tienen campo `temperatura` pero no hay sistema que calcule temperatura ambiental para ajustarlas
- No hay factores ambientales (altitud, agua, albedo) que afecten la temperatura

### Comportamiento Esperado

- Sistema de sol/luna implementado con proyección Gleason (centro = polo norte, borde = polo sur)
- Cálculo de temperatura solar según posición del sol y latitud (distancia del centro)
- Modificadores de temperatura ambiental: altitud, proximidad al agua, albedo (tipo de superficie)
- Integración con `WorldBloque` para calcular y almacenar temperatura base
- Funciones auxiliares para obtener temperatura ambiental en cualquier posición
- Ciclo día/noche funcional que afecta la temperatura

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [ ] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Python 3.11, FastAPI, asyncpg
- Cálculos matemáticos: NumPy (opcional, para operaciones vectoriales)
- Trigonometría para cálculos de posición solar y ángulos
- Sistema de coordenadas polares para proyección Gleason

### Archivos/Componentes Principales
- `backend/src/services/celestial_system.py` (nuevo) - Sistema de sol/luna
- `backend/src/services/temperature_service.py` (nuevo) - Cálculo de temperatura ambiental
- `backend/src/services/world_bloque.py` - Integrar cálculo de temperatura
- `backend/src/services/world_bloque_manager.py` - Gestionar temperatura de bloques
- `backend/src/services/particula_service.py` - Funciones auxiliares para temperatura

## Criterios de Aceptación

1. [ ] Sistema `SolSystem` implementado con movimiento circular alrededor del centro (proyección Gleason)
2. [ ] Sistema `LunaSystem` implementado con movimiento circular y fases lunares
3. [ ] Función `calculateSolarTemperature()` calcula temperatura según latitud (distancia del centro) y posición del sol
4. [ ] Función `getAltitudeModifier()` calcula modificador de temperatura por altitud (-6.5°C por cada 1000 unidades)
5. [ ] Función `getWaterModifier()` calcula modificador por proximidad al agua (efecto moderador)
6. [ ] Función `getAlbedoModifier()` calcula modificador por tipo de superficie (albedo)
7. [ ] Función `calculateCellTemperature()` integra todos los modificadores para calcular temperatura final
8. [ ] `WorldBloque.calcular_temperatura()` actualizado para usar sistema celestial y modificadores
9. [ ] Ciclo día/noche funcional (determina si es día o noche según posición del sol)
10. [ ] Funciones auxiliares documentadas y con ejemplos de uso

**Nota:** Cada criterio debe ser específico, medible y verificable.

## Detalles de Implementación

### Consideraciones Técnicas
- **Performance**: Los cálculos de temperatura deben ser eficientes. Considerar cache de temperaturas calculadas por bloque
- **Seguridad**: Validar entradas de coordenadas para evitar valores fuera de rango
- **Compatibilidad**: Integrar con sistema de bloques existente (JDG-038)
- **Escalabilidad**: El sistema debe funcionar con cualquier tamaño de mundo

### Dependencias
- Depende de: JDG-038 (Sistema de Bloques Unificado, Funciones Auxiliares Base)
- Bloquea: JDG-040 (Sistema de Disipación de Temperatura), JDG-041 (Sistema de Transiciones con Integridad)

## Testing

### Escenarios de Prueba
1. Escenario 1: Calcular temperatura en el centro (polo norte) - debe ser fría
2. Escenario 2: Calcular temperatura en el ecuador (anillo intermedio) - debe ser caliente
3. Escenario 3: Calcular temperatura en el borde (polo sur) - debe ser muy fría
4. Escenario 4: Verificar modificador de altitud - temperatura debe disminuir con altura
5. Escenario 5: Verificar modificador de agua - temperatura debe ser más estable cerca del agua
6. Escenario 6: Verificar modificador de albedo - nieve debe ser más fría que arena
7. Escenario 7: Verificar ciclo día/noche - temperatura debe variar según posición del sol
8. Escenario 8: Verificar fases lunares - luna debe cambiar de fase correctamente

### Casos Edge a Considerar
- Coordenadas fuera del rango del mundo (radio máximo)
- Altitud negativa (bajo el nivel del mar)
- Sin partículas de agua cercanas (modificador = 0)
- Superficie sin tipo definido (usar albedo por defecto)
- Sol en posición extrema (medianoche/mediodía)

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 5-7 días
- **Notas:** Requiere implementación de dos sistemas (celestial y temperatura) con integración compleja

## Referencias

- **Relacionado con:** JDG-038 (Sistema de Bloques Unificado)
- **Documentación relevante:** 
  - `Juego de Dioses/Ideas/31-Sistema-Temperatura-Ambiental.md`
  - `Juego de Dioses/Ideas/32-Sistema-Sol-Luna-Gleason.md`
  - `Juego de Dioses/Ideas/52-Orden-Prioridad-Desarrollo.md` (Fase 2.1 y 2.2)
- **Discusiones previas:** Ver documentos de diseño en carpeta `Ideas/`

## Notas Adicionales

- Este ticket implementa las fases 2.1 y 2.2 del plan de desarrollo del sistema de partículas
- El sistema de sol/luna usa proyección Gleason (mundo plano con centro = polo norte)
- Los modificadores de temperatura se implementan en orden de prioridad: MVP primero (altitud, albedo), luego intermedio (agua)
- El sistema debe ser extensible para futuros modificadores (viento, nubes, humedad)
- Considerar usar NumPy para cálculos vectoriales si se requiere optimización de performance

