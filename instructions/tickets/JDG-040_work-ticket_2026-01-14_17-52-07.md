# JDG-040 - Sistema de Vuelo del Personaje y Pointer Lock para Observación Celestial

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Para observar correctamente el sistema celestial (sol/luna) implementado en el backend, se necesitaba:
1. Sistema de vuelo que permita al personaje elevarse y alcanzar la altura del sol/luna
2. Control de vuelo intuitivo tipo avión (solo se mueve con WASD, frena cuando no hay input)
3. Pointer Lock para evitar que el mouse salga del canvas y cause bugs durante la rotación de cámara

### Comportamiento Actual

- El personaje no puede volar, solo puede saltar limitadamente
- No hay forma de alcanzar la altura del sol/luna (500m de altura)
- El mouse sale del canvas durante rotación de cámara, causando bugs
- No hay límite de altura configurado para permitir vuelo infinito

### Comportamiento Esperado

- El personaje puede activar vuelo con triple salto (espacio tres veces seguidas)
- El vuelo se controla con WASD basado en la dirección de la cámara
- El movimiento vertical en vuelo se controla con la orientación vertical de la cámara y W/S
- El personaje frena cuando no hay input (comportamiento tipo avión)
- No hay límite de altura para permitir alcanzar el sol/luna
- La animación de salto no se activa durante el vuelo
- El mouse queda bloqueado dentro del canvas cuando el cursor está oculto
- El pointer lock se activa automáticamente al hacer click en el canvas
- El pointer lock se desactiva cuando se abren interfaces (F4, F6)

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js
- Pointer Lock API
- ECS (Entity Component System)

### Archivos/Componentes Principales
- `frontend/src/ecs/components/physics.js` - Propiedades para triple salto y vuelo
- `frontend/src/ecs/components/input.js` - Propiedades para control de vuelo
- `frontend/src/ecs/systems/input-system.js` - Detección de triple salto y movimiento 3D en vuelo
- `frontend/src/ecs/systems/physics-system.js` - Lógica de vuelo y fricción
- `frontend/src/ecs/systems/collision-system.js` - Eliminación de límite máximo de altura
- `frontend/src/config/animation-config.js` - Estado `flying` y condiciones
- `frontend/src/config/animation-constants.js` - Velocidad vertical ilimitada
- `frontend/src/utils/cursor-manager.js` - Integración con Pointer Lock API

## Criterios de Aceptación

1. [ ] El personaje puede activar vuelo con triple salto (espacio tres veces seguidas)
2. [ ] El vuelo se controla con WASD basado en la dirección de la cámara
3. [ ] El movimiento vertical en vuelo se controla con la orientación vertical de la cámara y W/S
4. [ ] El personaje frena cuando no hay input (comportamiento tipo avión)
5. [ ] No hay límite de altura para permitir alcanzar el sol/luna
6. [ ] La animación de salto no se activa durante el vuelo
7. [ ] El mouse queda bloqueado dentro del canvas cuando el cursor está oculto
8. [ ] El pointer lock se activa automáticamente al hacer click en el canvas
9. [ ] El pointer lock se desactiva cuando se abren interfaces (F4, F6)
10. [ ] El personaje puede alcanzar la altura del sol/luna (500m)

## Detalles de Implementación

### Consideraciones Técnicas

- **Triple salto**: Detección de tres saltos consecutivos en un tiempo determinado
- **Movimiento 3D**: Cálculo de movimiento basado en dirección de cámara (adelante/atrás/lateral/vertical)
- **Fricción de vuelo**: Fricción más fuerte (0.85) en todas las direcciones para frenado tipo avión
- **Velocidad de vuelo**: 200 celdas/segundo configurada para alcanzar sol/luna en ~10 segundos
- **Pointer Lock**: Solo se activa cuando cursor está oculto (modo juego), no cuando hay interfaces abiertas
- **Gravedad**: Desactivada durante vuelo
- **Animación**: Estado `flying` con mayor prioridad que `jump` para prevenir animación de salto durante vuelo

### Dependencias
- Depende de: JDG-039 (Sistema de Temperatura Ambiental y Sistema Sol/Luna Gleason)
- Bloquea: Ninguna

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Triple salto**: Verificar que el triple salto activa vuelo correctamente
2. **Escenario 2 - Control de vuelo**: Verificar que el vuelo se controla con WASD basado en dirección de cámara
3. **Escenario 3 - Frenado**: Verificar que el personaje frena cuando no hay input
4. **Escenario 4 - Altura**: Verificar que el personaje puede alcanzar la altura del sol/luna
5. **Escenario 5 - Animación**: Verificar que la animación de salto no se activa durante vuelo
6. **Escenario 6 - Pointer lock**: Verificar que el pointer lock se activa al hacer click en el canvas
7. **Escenario 7 - Mouse bloqueado**: Verificar que el mouse no sale del canvas durante rotación
8. **Escenario 8 - Interfaces**: Verificar que el pointer lock se desactiva al abrir interfaces (F4, F6)

### Casos Edge a Considerar
- **Pointer lock no disponible**: Algunos navegadores pueden no soportar pointer lock o requerir interacción del usuario
- **Colisiones en vuelo**: El personaje puede volar dentro de objetos sólidos si no hay detección de colisión en vuelo
- **Velocidad de vuelo**: La velocidad puede ser demasiado rápida o lenta según el hardware
- **Múltiples saltos**: El sistema debe manejar correctamente saltos múltiples antes de activar vuelo

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 6-8 horas
- **Notas:** Sistema completo de vuelo con integración de Pointer Lock API

## Referencias

- **Relacionado con:** JDG-039 (Sistema de Temperatura Ambiental y Sistema Sol/Luna Gleason)
- **Documentación relevante:** `instructions/tasks/JDG-040-action-plan_2025-12-26_16-34-34.md`

## Notas Adicionales

- El sistema de vuelo está diseñado específicamente para observar el sistema celestial
- La velocidad de vuelo (200 celdas/segundo) está configurada para alcanzar el sol/luna a 500m de altura en aproximadamente 10 segundos
- El pointer lock solo se activa cuando el cursor está oculto (modo juego), no cuando hay interfaces abiertas
- El sistema de vuelo puede extenderse en el futuro para incluir más mecánicas (vuelo horizontal más rápido, efectos visuales, etc.)
- Plan de rollback: Revertir cambios en componentes de física e input para desactivar vuelo y pointer lock
- Los cambios son solo frontend, no afectan backend ni base de datos
