# JDG-041 - Sistema de Conservación de Calor para Partículas

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El sistema de temperatura actual solo consideraba proximidad al agua sin leer su temperatura real. Las partículas tienen `temperatura` en BD pero no se actualizaba dinámicamente. Se necesitaba un sistema que permitiera que partículas como agua, hielo y lava absorban temperatura del sol/ambiente y la conserven según sus propiedades físicas (`inercia_termica`), haciendo el sistema más realista y preparado para transiciones de estado (agua → hielo).

### Comportamiento Actual

- El sistema de temperatura solo considera proximidad al agua sin leer su temperatura real
- Las partículas tienen `temperatura` en BD pero no se actualiza dinámicamente
- No hay sistema de conservación de calor según propiedades físicas de partículas
- No hay background task que actualice temperaturas periódicamente

### Comportamiento Esperado

- El agua absorbe temperatura del ambiente periódicamente
- El agua conserva temperatura según su `inercia_termica`
- El hielo también funciona (sistema genérico)
- La temperatura del agua/hielo afecta la temperatura del bloque
- Sistema funciona para cualquier partícula con `inercia_termica > 0`
- Background task actualiza temperatura cada X minutos (configurable)
- No se rompe código existente (compatibilidad mantenida)

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [ ] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Python 3.11
- FastAPI
- asyncpg
- Background tasks

### Archivos/Componentes Principales
- `backend/src/services/temperature_service.py` - Nuevas funciones de actualización de temperatura
- `backend/src/services/particula_service.py` - Función para obtener partículas con inercia térmica
- `backend/src/api/routes/celestial.py` - Background task de actualización
- `backend/src/main.py` - Inicio del background task
- `backend/src/config/celestial_config.py` - Configuración del intervalo de actualización
- `backend/src/services/__init__.py` - Exportaciones de nuevas funciones
- `backend/src/services/README.md` - Documentación actualizada

## Criterios de Aceptación

1. [ ] El agua absorbe temperatura del ambiente periódicamente
2. [ ] El agua conserva temperatura según su `inercia_termica`
3. [ ] El hielo también funciona (sistema genérico)
4. [ ] La temperatura del agua/hielo afecta la temperatura del bloque
5. [ ] Sistema funciona para cualquier partícula con `inercia_termica > 0`
6. [ ] Background task actualiza temperatura cada X minutos (configurable)
7. [ ] No se rompe código existente (compatibilidad mantenida)
8. [ ] Funciones genéricas funcionan para cualquier tipo de partícula
9. [ ] Background task se inicia automáticamente al arrancar FastAPI
10. [ ] Manejo de errores en background task para no romper el sistema

## Detalles de Implementación

### Consideraciones Técnicas

- **Sistema genérico**: Funciona para cualquier partícula con `inercia_termica > 0` (agua, hielo, lava, etc.)
- **Inercia térmica**: Controla qué tan rápido cambia la temperatura (alta inercia = cambio lento)
- **Intervalo configurable**: Default 5 minutos, configurable en `celestial_config.py`
- **Compatibilidad**: Mantiene compatibilidad con código existente (parámetros opcionales)
- **Background task**: Se ejecuta en segundo plano sin bloquear requests
- **Manejo de errores**: Background task tiene manejo de errores para no romper el sistema

### Funciones Implementadas

- `update_particle_temperature()`: Actualiza temperatura de una partícula según temperatura ambiental e `inercia_termica`
- `get_particle_temperature_modifier()`: Función genérica que calcula modificador de temperatura para cualquier partícula
- `get_particulas_con_inercia()`: Obtiene partículas de un bloque que tienen `inercia_termica > 0`
- `update_particle_temperatures_periodically()`: Background task que actualiza temperatura periódicamente

### Dependencias
- Depende de: JDG-039 (Sistema de Temperatura Ambiental y Sistema Sol/Luna Gleason)
- Bloquea: Ninguna

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Background task**: Verificar que background task se inicia correctamente (logs)
2. **Escenario 2 - Agua**: Verificar que agua absorbe y conserva temperatura
3. **Escenario 3 - Hielo**: Verificar que hielo también funciona (sistema genérico)
4. **Escenario 4 - Temperatura del bloque**: Verificar que temperatura de partículas afecta temperatura del bloque
5. **Escenario 5 - Compatibilidad**: Verificar que código existente sigue funcionando
6. **Escenario 6 - Actualización en BD**: Verificar que temperatura se actualiza en BD después de intervalo
7. **Escenario 7 - Partículas sin inercia**: Verificar que partículas con `inercia_termica = 0` no se actualizan

### Casos Edge a Considerar
- **Muchas partículas**: Background task podría consumir recursos si hay muchas partículas (mitigado: actualiza cada 5 minutos, manejo de errores)
- **Todas las partículas**: Actualiza todas las partículas de todos los bloques (optimización futura: solo bloques activos)
- **Múltiples llamadas**: Múltiples llamadas a `get_tipo_particula_por_nombre()` sin cache (optimización futura)
- **Errores en task**: Background task debe manejar errores para no romper el sistema

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 6-8 horas
- **Notas:** Sistema completo con background task, funciones genéricas y compatibilidad mantenida

## Referencias

- **Relacionado con:** JDG-039 (Sistema de Temperatura Ambiental y Sistema Sol/Luna Gleason)
- **Documentación relevante:** `backend/src/services/README.md`
- **Plan de acción:** `instructions/tasks/JDG-041-action-plan_2025-12-28_11-48-02.md`
- **Análisis de arquitectura:** `instructions/analysis/JDG-041-architecture-analysis_2025-12-28_11-48-02.md`
- **Análisis de sistema de temperatura:** `instructions/analysis/temperature-system-analysis.md`
- **Deuda técnica relacionada:**
  - `instructions/technical debt/03-cache-tipos-particulas.md` (cache de tipos de partículas)
  - `instructions/technical debt/04-optimizacion-bloques-activos-temperatura.md` (optimización de bloques activos)

## Notas Adicionales

- El sistema es genérico: funciona para cualquier partícula con `inercia_termica > 0` (agua, hielo, lava, etc.)
- La `inercia_termica` controla qué tan rápido cambia la temperatura: alta inercia = cambio lento (agua conserva temperatura)
- El intervalo de actualización es configurable en `celestial_config.py` (default: 5 minutos)
- Sistema preparado para Fase 2: propagación de calor entre partículas, fuego, eventos dinámicos
- Compatible con sistema de transiciones existente (`transiciones_particulas` table)
- Plan de rollback: Revertir commits relacionados, rebuild y restart de contenedores Docker
- El background task se detiene automáticamente al reiniciar
