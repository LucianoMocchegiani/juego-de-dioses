# JDG-042 - Reflejo Realista de la Luna

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Actualmente el juego tiene un sistema básico de iluminación que ajusta la intensidad y color de las luces según el ciclo día/noche, pero la luna no refleja visualmente la luz del sol correctamente:

1. **La luna emite luz propia** en lugar de reflejar la luz del sol
2. **Las fases lunares no se visualizan correctamente** (solo cambia el brillo, no la forma visible)
3. **La luna no refleja la luz del sol** según las fases lunares (la luna debería verse más brillante cuando está llena y refleja más luz solar)

### Comportamiento Actual

- La luna tiene una intensidad emisiva que varía según la fase, pero no refleja visualmente la luz del sol
- Las fases lunares no se visualizan correctamente (solo cambia el brillo, no la forma visible)
- La luna siempre se ve como un círculo completo, sin mostrar la fase visual
- La luna emite luz propia (`emissive` alto), lo que no es realista

### Comportamiento Esperado

1. **Reflejo lunar realista:**
   - La luna refleja la luz del sol según su fase
   - Luna llena (fase 0.5): máxima visibilidad y brillo
   - Luna nueva (fase 0.0 o 1.0): mínima visibilidad
   - El brillo de la luna varía suavemente según la fase
   - La luna es visible principalmente por el reflejo de la luz solar, no por emisión propia

2. **Visualización de fases lunares:**
   - La luna muestra visualmente su fase (creciente, menguante, llena, nueva)
   - La parte iluminada de la luna corresponde a la luz del sol
   - Three.js calcula automáticamente qué parte está iluminada según la posición del sol

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Three.js (WebGLRenderer, MeshStandardMaterial)
- JavaScript ES6+

### Archivos/Componentes Principales
- `frontend/src/world/celestial-renderer.js` - Mejorar visualización de fases lunares y reflejo
- `frontend/src/world/celestial-system.js` - Ya tiene información de fases (no requiere cambios)

## Criterios de Aceptación

1. [ ] La luna NO emite luz propia (`emissive = 0x000000`, `emissiveIntensity = 0.0`)
2. [ ] La luna refleja la luz del sol automáticamente (usando `MeshStandardMaterial`)
3. [ ] La parte iluminada por el sol se ve brillante, la parte oscura se ve oscura
4. [ ] La fase visual coincide con la fase calculada por el modelo de Gleason
5. [ ] El sistema funciona sin degradar significativamente el rendimiento

**Nota:** Cada criterio debe ser específico, medible y verificable.

## Detalles de Implementación

### Consideraciones Técnicas

**Reflejo lunar:**
- La luna no debería tener `emissive` alto, sino reflejar la luz del sol
- Usar `MeshStandardMaterial` con `metalness` y `roughness` apropiados
- Three.js calculará automáticamente qué parte está iluminada según la dirección de la luz

**Visualización de fases lunares:**
- Three.js calcula automáticamente qué parte de la luna está iluminada según la posición del sol
- No se requiere textura, shader o geometría modificada
- La fase visual se verá automáticamente porque la luz viene del sol y se mueve según el modelo de Gleason

**Compatibilidad:**
- Asegurar que el sistema funcione con el sistema celestial existente
- No romper la iluminación actual
- Mantener compatibilidad con el sistema de partículas

### Dependencias
- Depende de: JDG-041 (Sistema de temperatura con ciclo día/noche) - Ya implementado
- Bloquea: Ninguno

## Testing

### Escenarios de Prueba
1. **Fases lunares:**
   - Verificar que la luna muestra visualmente su fase
   - Verificar que el brillo varía según la fase
   - Verificar transiciones suaves entre fases

2. **Reflejo solar:**
   - Verificar que la luna refleja la luz del sol
   - Verificar que la parte iluminada corresponde a la posición del sol
   - Verificar que la luna no emite luz propia

3. **Modelo de Gleason:**
   - Verificar que la fase visual coincide con la fase calculada por el backend
   - Verificar que la fase depende de la posición del observador relativa al sol y la luna

### Casos Edge a Considerar
- **Luna nueva:** La luna debería ser casi invisible pero aún detectable
- **Transiciones día/noche:** La luna debe reflejar correctamente la luz del sol en todas las condiciones
- **Posición del sol:** Verificar que la luna refleja correctamente cuando el sol está en diferentes posiciones

## Estimación

- **Complejidad:** Baja
- **Tiempo estimado:** 2-4 horas
- **Notas:** 
  - La implementación es simple (solo cambiar propiedades del material)
  - Three.js calcula automáticamente el reflejo y las fases
  - No se requiere shader ni texturas adicionales

## Referencias

- **Relacionado con:** JDG-041 (Sistema de temperatura con ciclo día/noche)
- **Documentación relevante:**
  - Three.js MeshStandardMaterial: https://threejs.org/docs/#api/en/materials/MeshStandardMaterial
  - Three.js Materials: https://threejs.org/docs/#api/en/materials/Material
- **Discusiones previas:** Sistema celestial implementado en tickets anteriores

## Notas Adicionales

- **Simplicidad:** La implementación es muy simple - solo cambiar propiedades del material
- **Realismo:** El reflejo automático de Three.js es más realista que la emisión propia
- **Testing visual:** Este feature requiere principalmente testing visual, asegurar que se puede verificar fácilmente en el juego
