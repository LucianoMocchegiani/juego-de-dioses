# JDG-043 - Sistema de Sombras Dinámicas

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Actualmente el juego tiene un sistema básico de iluminación que ajusta la intensidad y color de las luces según el ciclo día/noche, pero no implementa **sombras dinámicas** basadas en la posición del sol.

### Comportamiento Actual

- La luz direccional se mueve según la posición del sol, pero no genera sombras
- No hay sombras proyectadas por objetos en el mundo
- El renderizador no tiene sombras habilitadas
- Las partículas y objetos no reciben ni proyectan sombras

### Comportamiento Esperado

1. **Sombras dinámicas:**
   - Las partículas y objetos proyectan sombras según la posición del sol
   - Las sombras se mueven dinámicamente a lo largo del día
   - Las sombras son más largas al amanecer/atardecer y más cortas al mediodía
   - Las sombras desaparecen gradualmente durante la noche
   - Opción para activar/desactivar sombras desde F6

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Three.js (WebGLRenderer, ShadowMap, DirectionalLightShadow)
- JavaScript ES6+

### Archivos/Componentes Principales
- `frontend/src/core/renderer.js` - Habilitar sombras en WebGLRenderer
- `frontend/src/core/lights.js` - Configurar sombras en DirectionalLight
- `frontend/src/core/scene.js` - Asegurar que objetos reciban/proyecten sombras
- `frontend/src/terrain/renderers/particle-renderer.js` - Habilitar sombras en partículas
- `frontend/src/interfaces/test-interface.js` - Agregar toggle de sombras en F6
- `frontend/src/config/constants.js` - Configuración de sombras

## Criterios de Aceptación

1. [ ] El renderizador WebGL tiene sombras habilitadas (`renderer.shadowMap.enabled = true`)
2. [ ] La luz direccional proyecta sombras (`directionalLight.castShadow = true`)
3. [ ] Las partículas del terreno pueden recibir sombras (`receiveShadow = true`)
4. [ ] Las partículas del terreno pueden proyectar sombras (`castShadow = true`, opcional para performance)
5. [ ] Las sombras se mueven dinámicamente según la posición del sol a lo largo del día
6. [ ] Las sombras son más largas al amanecer/atardecer y más cortas al mediodía
7. [ ] Existe un toggle en F6 para activar/desactivar sombras
8. [ ] El sistema funciona sin degradar significativamente el rendimiento (< 5 FPS de pérdida)

**Nota:** Cada criterio debe ser específico, medible y verificable.

## Detalles de Implementación

### Consideraciones Técnicas

**Performance:**
- Las sombras pueden ser costosas en términos de rendimiento
- Considerar usar `shadowMap.type = THREE.PCFSoftShadowMap` para sombras suaves
- Ajustar `shadowMap.width` y `shadowMap.height` según rendimiento (512, 1024, 2048)
- Limitar qué objetos proyectan sombras (solo partículas cercanas o importantes)
- Usar `shadowCamera` para limitar el área donde se calculan sombras

**Configuración:**
- Centralizar configuración de sombras en `constants.js`
- Permitir ajustar calidad de sombras según hardware
- Opción de deshabilitar sombras para hardware limitado

**Compatibilidad:**
- Asegurar que el sistema funcione con el sistema celestial existente
- No romper la iluminación actual
- Mantener compatibilidad con el sistema de partículas

**Escalabilidad:**
- El sistema debe funcionar bien con miles de partículas
- Considerar opciones de optimización (LOD para sombras, frustum culling)

### Dependencias
- Depende de: JDG-041 (Sistema de temperatura con ciclo día/noche) - Ya implementado
- Bloquea: Ninguno

## Testing

### Escenarios de Prueba
1. **Sombras durante el día:**
   - Verificar que las sombras aparecen cuando el sol está visible
   - Verificar que las sombras se mueven a lo largo del día
   - Verificar que las sombras son más largas al amanecer/atardecer

2. **Sombras durante la noche:**
   - Verificar que las sombras desaparecen o son muy tenues durante la noche
   - Verificar que la iluminación lunar no genera sombras fuertes

3. **Toggle F6:**
   - Verificar que el toggle activa/desactiva sombras correctamente
   - Verificar que el estado se mantiene al abrir/cerrar F6

4. **Rendimiento:**
   - Medir FPS con sombras habilitadas vs deshabilitadas
   - Verificar que no hay degradación significativa (< 5 FPS)

### Casos Edge a Considerar
- **Sol bajo en el horizonte:** Las sombras pueden ser muy largas, verificar que no causan problemas de rendimiento
- **Transiciones día/noche:** Las sombras deben desaparecer/aparecer suavemente
- **Múltiples objetos:** Verificar que las sombras funcionan correctamente con muchas partículas
- **InstancedMesh:** Verificar compatibilidad con InstancedMesh (puede tener limitaciones)

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 6-10 horas
- **Notas:** 
  - La implementación de sombras es relativamente directa pero requiere ajustes de rendimiento
  - Puede haber problemas con InstancedMesh y sombras
  - Se recomienda implementar primero las sombras básicas y luego optimizar

## Referencias

- **Relacionado con:** JDG-041 (Sistema de temperatura con ciclo día/noche), JDG-042 (Reflejo Realista de la Luna)
- **Documentación relevante:**
  - Three.js Shadows: https://threejs.org/docs/#api/en/lights/shadows
  - Three.js DirectionalLightShadow: https://threejs.org/docs/#api/en/lights/shadows/DirectionalLightShadow
  - Three.js ShadowMap: https://threejs.org/docs/#api/en/renderers/WebGLRenderer#shadowMap
- **Discusiones previas:** Sistema celestial implementado en tickets anteriores

## Notas Adicionales

- **Optimización de sombras:** Se puede empezar con sombras simples y optimizar después según necesidad
- **Configuración:** Considerar hacer las sombras configurables (habilitar/deshabilitar) para usuarios con hardware limitado
- **Testing visual:** Este feature requiere principalmente testing visual, asegurar que se puede verificar fácilmente en el juego
- **InstancedMesh:** Puede haber limitaciones con InstancedMesh y sombras en Three.js

