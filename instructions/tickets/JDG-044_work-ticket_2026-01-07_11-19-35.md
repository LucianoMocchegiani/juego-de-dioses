# JDG-044 - Implementar Movimiento en Espiral del Sol y Luna (Modelo de Gleason)

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Actualmente el sistema celestial implementa un movimiento circular simple para el sol y la luna, donde ambos giran en círculos fijos alrededor del centro del mundo. Sin embargo, según el **Modelo de Gleason**, el sol debería moverse en una **espiral** que varía su radio entre el Trópico de Cáncer (radio mínimo) y el Trópico de Capricornio (radio máximo), creando las estaciones del año.

**⚠️ IMPORTANTE:** Este ticket está sujeto a modificaciones porque se está investigando cuál es la mejor opción para implementar el movimiento en espiral. La implementación puede ajustarse según los resultados de la investigación.

### Comportamiento Actual

- El sol gira en un **círculo fijo** con radio constante (1500m = 1.5x radio del mundo)
- La luna gira en un **círculo fijo** con radio constante (1500m = 1.5x radio del mundo)
- No hay variación estacional en el movimiento
- El radio no cambia durante el ciclo anual
- Fórmula actual: `x = cos(ángulo) × radio_fijo`, `y = sin(ángulo) × radio_fijo`

### Comportamiento Esperado

1. **Movimiento en espiral del sol:**
   - El sol se mueve en una espiral que varía su radio durante el año
   - Radio mínimo: Trópico de Cáncer (~1000m o 1x radio del mundo)
   - Radio máximo: Trópico de Capricornio (~2000m o 2x radio del mundo)
   - Espiral hacia afuera: Cáncer → Capricornio (6 meses de juego)
   - Espiral hacia adentro: Capricornio → Cáncer (6 meses de juego)
   - Ciclo completo: 365 días de juego = 1 año = 1 espiral completa

2. **Movimiento de la luna:**
   - La luna puede mantener movimiento circular o también implementar espiral (sujeto a investigación)
   - Si se implementa espiral para la luna, debe tener un ciclo diferente al del sol

3. **Estaciones del año:**
   - Sol cerca de Cáncer: Verano en hemisferio norte
   - Sol cerca de Capricornio: Invierno en hemisferio norte
   - Sol en Ecuador: Primavera u Otoño
   - El movimiento en espiral crea variación de temperatura y estaciones

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [x] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- Python 3.11, FastAPI
- JavaScript ES6+, Three.js
- Matemáticas: Trigonometría, funciones espirales

### Archivos/Componentes Principales
- `backend/src/services/celestial_time_service.py` - Agregar cálculo de radio variable
- `backend/src/config/celestial_config.py` - Agregar configuración de trópicos y espiral
- `frontend/src/world/celestial-system.js` - Actualizar para recibir radio variable
- `frontend/src/world/celestial-renderer.js` - Renderizar movimiento en espiral
- `docs/DIAGRAMAS-ORBITAS-CELESTIALES.md` - Documentación actualizada (ya existe)

## Criterios de Aceptación

1. [ ] El sol se mueve en espiral con radio variable entre Trópico de Cáncer y Capricornio
2. [ ] El radio del sol varía suavemente durante el ciclo anual (365 días de juego)
3. [ ] El sol completa una espiral completa cada año (365 días de juego)
4. [ ] La espiral va de adentro hacia afuera (6 meses) y luego de afuera hacia adentro (6 meses)
5. [ ] El movimiento en espiral es visible en el frontend (el sol se acerca y aleja del centro)
6. [ ] La luna mantiene movimiento funcional (circular o espiral, según investigación)
7. [ ] El sistema de temperatura se ajusta según la posición del sol (más cerca = más calor)
8. [ ] No se rompe funcionalidad existente del sistema celestial
9. [ ] Los diagramas en `docs/` reflejan el movimiento correcto

**Nota:** Cada criterio debe ser específico, medible y verificable. Algunos criterios pueden ajustarse según los resultados de la investigación.

## Detalles de Implementación

### Consideraciones Técnicas

**Investigación en Curso:**
- ⚠️ **Este ticket está sujeto a modificaciones** porque se está investigando:
  - La mejor función matemática para la espiral (seno, coseno, función personalizada)
  - Si la luna también debe tener movimiento en espiral o mantener círculo
  - Los valores exactos de radio mínimo y máximo
  - La velocidad de la espiral y cómo se sincroniza con la rotación diaria
  - Cómo afecta esto al sistema de temperatura existente

**Fórmula Sugerida (Preliminar):**
```python
# Radio variable según ciclo anual
def get_sun_radius(self) -> float:
    año_en_días = 365.0
    días_transcurridos = (self.tiempo_juego / (24 * 60 * 60)) % año_en_días
    
    radio_min = CELESTIAL_CONFIG['SOL_RADIO_MIN']  # ~1000m (Cáncer)
    radio_max = CELESTIAL_CONFIG['SOL_RADIO_MAX']  # ~2000m (Capricornio)
    
    # Función espiral: usar seno para variación suave
    fase_anual = (días_transcurridos / año_en_días) * 2 * math.pi
    variación = (math.sin(fase_anual) + 1) / 2  # Normalizar a 0-1
    
    return radio_min + (radio_max - radio_min) * variación

# Posición con radio variable
def get_sun_position(self) -> Dict[str, float]:
    angulo = self.get_sun_angle()  # Rotación diaria
    radio = self.get_sun_radius()   # Radio variable (espiral)
    altura = CELESTIAL_CONFIG['SOL_ALTURA']
    
    x = math.cos(angulo) * radio
    y = math.sin(angulo) * radio
    z = altura
    
    return {"x": x, "y": y, "z": z}
```

**Performance:**
- El cálculo del radio variable es simple (una función trigonométrica)
- No debería afectar significativamente el rendimiento
- El frontend solo recibe la posición calculada, no calcula la espiral

**Compatibilidad:**
- Debe mantener compatibilidad con el sistema de temperatura existente
- El sistema de temperatura puede necesitar ajustes para considerar el radio variable
- No debe romper el sistema de iluminación existente

**Configuración:**
- Agregar nuevas constantes en `celestial_config.py`:
  - `SOL_RADIO_MIN`: Radio mínimo (Trópico de Cáncer)
  - `SOL_RADIO_MAX`: Radio máximo (Trópico de Capricornio)
  - `SOL_CICLO_ANUAL_DIAS`: Días de juego en un año (365.0)

### Dependencias
- Depende de: JDG-041 (Sistema de temperatura con ciclo día/noche) - Ya implementado
- Bloquea: Posibles mejoras futuras al sistema de temperatura basadas en estaciones

## Testing

### Escenarios de Prueba

1. **Movimiento en espiral del sol:**
   - Verificar que el sol se mueve en espiral visible
   - Verificar que el radio varía entre mínimo y máximo
   - Verificar que completa un ciclo completo en 365 días de juego
   - Verificar que la espiral va de adentro hacia afuera y viceversa

2. **Ciclo anual:**
   - Verificar que el sol está en Trópico de Cáncer al inicio del año
   - Verificar que el sol alcanza Trópico de Capricornio a los 6 meses
   - Verificar que el sol regresa a Cáncer al completar el año

3. **Sistema de temperatura:**
   - Verificar que la temperatura varía según la posición del sol
   - Verificar que es más caliente cuando el sol está más cerca (Cáncer)
   - Verificar que es más frío cuando el sol está más lejos (Capricornio)

4. **Rendimiento:**
   - Verificar que no hay degradación de rendimiento
   - Verificar que el cálculo del radio variable es eficiente

5. **Compatibilidad:**
   - Verificar que no se rompe el sistema de iluminación
   - Verificar que el frontend renderiza correctamente el movimiento en espiral

### Casos Edge a Considerar

- **Transición de año:** Verificar que el ciclo se reinicia correctamente
- **Valores de radio:** Verificar que los radios mínimo y máximo son correctos
- **Sincronización:** Verificar que la rotación diaria y la espiral anual están sincronizadas
- **Luna:** Decidir si la luna también debe tener espiral o mantener círculo

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 8-12 horas
- **Notas:** 
  - La implementación requiere investigación previa sobre la mejor función espiral
  - Puede requerir ajustes al sistema de temperatura
  - El tiempo puede variar según los resultados de la investigación
  - Se recomienda implementar primero el movimiento del sol y luego evaluar la luna

## Referencias

- **Relacionado con:** JDG-041 (Sistema de temperatura con ciclo día/noche), JDG-042 (Reflejo Realista de la Luna)
- **Documentación relevante:**
  - `docs/DIAGRAMAS-ORBITAS-CELESTIALES.md` - Documentación completa del modelo de Gleason
  - `docs/diagrama-gleason-espiral.svg` - Diagrama del movimiento en espiral
  - `docs/diagrama-gleason-ciclo-completo.svg` - Diagrama del ciclo completo del año
  - Modelo de Gleason: Proyección cartográfica de la Tierra plana
- **Discusiones previas:** Investigación sobre el modelo de Gleason y movimiento en espiral

## Notas Adicionales

### ⚠️ Investigación en Curso

**Este ticket está sujeto a modificaciones** porque se está investigando:

1. **Función matemática para la espiral:**
   - ¿Usar seno simple o función más compleja?
   - ¿Cómo hacer que la espiral sea visualmente correcta?
   - ¿Qué función crea el mejor efecto de estaciones?

2. **Movimiento de la luna:**
   - ¿La luna también debe tener movimiento en espiral?
   - ¿O mantener movimiento circular pero con variación?
   - ¿Cómo afecta esto a las fases lunares?

3. **Valores de configuración:**
   - ¿Cuáles son los radios exactos de los trópicos?
   - ¿Cómo se relacionan con el radio del mundo?
   - ¿Qué valores crean el mejor efecto visual?

4. **Sistema de temperatura:**
   - ¿Cómo ajustar el sistema de temperatura para considerar el radio variable?
   - ¿El radio afecta directamente la temperatura o solo la posición angular?
   - ¿Cómo se combinan ambos factores?

### Recomendaciones

- **Fase 1:** Implementar movimiento en espiral básico del sol con función seno simple
- **Fase 2:** Ajustar valores y función según resultados visuales
- **Fase 3:** Evaluar si la luna también necesita espiral
- **Fase 4:** Ajustar sistema de temperatura si es necesario

### Documentación

- Los diagramas en `docs/` ya muestran el movimiento en espiral correcto
- La documentación incluye fórmulas sugeridas pero pueden ajustarse
- Se recomienda actualizar la documentación después de la implementación final
