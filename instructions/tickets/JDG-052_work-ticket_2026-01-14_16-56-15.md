# JDG-052 - Animaciones Direccionales de Agacharse y Caminar Agachado

## Tipo
- [x] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Actualmente, el sistema de agacharse tiene problemas:

1. **Agacharse sin movimiento**: Cuando el jugador presiona Ctrl sin moverse, muestra la animación de caminar agachado (`crouch_walk_forward`) en lugar de una animación de solo agacharse
2. **Caminar agachado sin direcciones**: Cuando el jugador se agacha y se mueve, siempre usa la animación de caminar agachado hacia adelante, independientemente de la dirección (adelante, atrás, izquierda, derecha)
3. **Falta de diferenciación**: No hay estados separados para agacharse en lugar vs caminar agachado en diferentes direcciones

### Comportamiento Actual

- Estado `crouch_idle` se activa con Ctrl sin movimiento, pero usa animación `crouch_walk_forward` (incorrecto)
- Estado `crouch_walk` se activa con Ctrl + movimiento, pero siempre usa `crouch_walk_forward` sin importar la dirección
- No hay diferenciación entre agacharse hacia adelante, atrás, izquierda o derecha
- El sistema no considera la dirección del movimiento al seleccionar la animación de caminar agachado

### Comportamiento Esperado

- **Agacharse sin movimiento (Ctrl sin WASD)**: Debe mostrar una animación de solo agacharse (idle agachado), NO caminar agachado
- **Caminar agachado hacia adelante (Ctrl + W)**: Debe usar animación `crouch_walk_forward`
- **Caminar agachado hacia atrás (Ctrl + S)**: Debe usar animación `crouch_walk_backward` o similar
- **Caminar agachado hacia la derecha (Ctrl + D)**: Debe usar animación `crouch_walk_right` o similar (ya existe `crouch_walk_right` según `ANIMATION_FILES`)
- **Caminar agachado hacia la izquierda (Ctrl + A)**: Debe usar animación `crouch_walk_left` o similar
- Si las animaciones direccionales no están disponibles, el sistema debe usar la animación disponible más cercana o mantener la lógica actual como fallback

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js AnimationMixer
- ECS (Entity Component System)
- Sistema de estados de animación declarativo

### Archivos/Componentes Principales
- `frontend/src/config/animation-config.js` - Modificar estados `crouch_idle` y `crouch_walk` para incluir direcciones
- `frontend/src/ecs/systems/animation-state-system.js` - Lógica para determinar dirección al agacharse
- `frontend/src/ecs/conditions/movement-condition.js` - Condiciones de movimiento direccional para agacharse
- `frontend/src/ecs/systems/animation-mixer-system.js` - Cargar y reproducir animaciones direccionales de agacharse
- `frontend/src/config/animation-config.js` - Verificar animaciones disponibles en `ANIMATION_FILES` (ya existe `crouch_walk_right`)

## Criterios de Aceptación

1. [ ] Cuando el jugador presiona Ctrl sin movimiento, se reproduce una animación de solo agacharse (idle agachado), NO caminar agachado
2. [ ] Cuando el jugador presiona Ctrl + W (adelante), se reproduce `crouch_walk_forward`
3. [ ] Cuando el jugador presiona Ctrl + S (atrás), se reproduce animación de caminar agachado hacia atrás (o fallback apropiado)
4. [ ] Cuando el jugador presiona Ctrl + D (derecha), se reproduce `crouch_walk_right` (ya existe según `ANIMATION_FILES`)
5. [ ] Cuando el jugador presiona Ctrl + A (izquierda), se reproduce animación de caminar agachado hacia la izquierda (o fallback apropiado)
6. [ ] El estado `crouch_idle` usa una animación apropiada de agacharse en lugar, no `crouch_walk_forward`
7. [ ] El sistema detecta correctamente la dirección del movimiento al agacharse basándose en `input.moveDirection` y la rotación del personaje
8. [ ] Si las animaciones direccionales no están disponibles, el sistema usa un fallback apropiado
9. [ ] No hay regresiones en otras animaciones existentes

## Detalles de Implementación

### Consideraciones Técnicas

- **Animación de idle agachado**: Si no existe una animación específica de "solo agacharse", se puede usar `crouch_walk_forward` con velocidad 0 o buscar una animación alternativa en `ANIMATION_FILES`
- **Dirección relativa**: La dirección debe calcularse relativa a la rotación del personaje/cámara, no en coordenadas absolutas
- **Fallback**: Si las animaciones direccionales no existen, usar `crouch_walk_forward` como fallback para mantener funcionalidad
- **Prioridades**: Los estados de agacharse deben mantener sus prioridades actuales (7 para `crouch_walk`, 6 para `crouch_idle`)
- **Transiciones**: Las transiciones entre estados de agacharse direccionales deben ser suaves

### Dependencias
- Depende de: JDG-051 (animaciones direccionales de caminar) - para reutilizar lógica de detección de dirección
- Bloquea: Ninguna

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Agacharse sin movimiento**: Presionar Ctrl sin WASD y verificar que se reproduce animación de agacharse (no caminar agachado)
2. **Escenario 2 - Caminar agachado hacia adelante**: Presionar Ctrl + W y verificar que se reproduce `crouch_walk_forward`
3. **Escenario 3 - Caminar agachado hacia atrás**: Presionar Ctrl + S y verificar que se reproduce animación de caminar agachado hacia atrás (o fallback)
4. **Escenario 4 - Caminar agachado lateral**: Presionar Ctrl + A o Ctrl + D y verificar que se reproduce animación lateral correspondiente
5. **Escenario 5 - Movimiento diagonal agachado**: Presionar Ctrl + W+D y verificar que se usa la animación más apropiada
6. **Escenario 6 - Rotación de cámara agachado**: Rotar la cámara mientras está agachado y verificar que las direcciones se mantienen correctas
7. **Escenario 7 - Transición agacharse/caminar agachado**: Verificar transiciones suaves entre `crouch_idle` y `crouch_walk` en diferentes direcciones

### Casos Edge a Considerar
- **Movimiento diagonal agachado**: ¿Qué animación usar cuando se mueve en diagonal agachado? (Ctrl+W+D, Ctrl+W+A, Ctrl+S+D, Ctrl+S+A)
- **Cambio rápido de dirección agachado**: Las transiciones deben ser suaves al cambiar rápidamente entre direcciones mientras está agachado
- **Animaciones faltantes**: Si no existen todas las animaciones direccionales de agacharse, el sistema debe funcionar con las disponibles
- **Animación de idle agachado**: Si no existe una animación específica, determinar el mejor fallback

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 4-6 horas
- **Notas:** Depende de si existe una animación de "solo agacharse" (idle agachado). Si no existe, puede requerir más tiempo para implementar una solución alternativa. Ya existe `crouch_walk_right` según `ANIMATION_FILES`.

## Referencias

- **Relacionado con:** JDG-051 (animaciones direccionales de caminar), JDG-022 (Reestructuración de Animaciones: Crouch Walk y Estados Contextuales)
- **Documentación relevante:** `frontend/src/config/animation-config.js`, `frontend/src/ecs/systems/animation-state-system.js`
- **Discusiones previas:** Sistema de agacharse implementado en JDG-022

## Notas Adicionales

- Según `ANIMATION_FILES`, ya existe `crouch_walk_right`: `'biped/male/animations/movement/Cautious_Crouch_Walk_Right_inplace_withSkin.glb'`
- Se debe verificar si existe una animación de "solo agacharse" (idle agachado) en los archivos GLB disponibles
- Si no existe animación de idle agachado, se puede considerar usar `crouch_walk_forward` con velocidad 0 o buscar alternativas en `ANIMATION_FILES`
- El cálculo de dirección debe considerar la rotación del personaje (`render.rotationY`) para determinar correctamente adelante/atrás/izquierda/derecha al agacharse
- Se debe verificar qué animaciones de agacharse están disponibles en `ANIMATION_FILES` antes de implementar
