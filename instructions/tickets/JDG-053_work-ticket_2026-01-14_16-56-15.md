# JDG-053 - Restricción de Movimiento en el Aire al Saltar e Inercia

## Tipo
- [x] Feature (nueva funcionalidad)
- [x] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (bloquea funcionalidad crítica)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Actualmente existen dos problemas principales:

1. **Movimiento en el aire al saltar**: El jugador puede moverse libremente en el aire después de saltar, lo cual choca con la lógica de vuelo y no es físicamente realista. Una vez que salta, el jugador debería moverse solo por inercia del movimiento previo o por fuerzas externas, no por input directo.

2. **Falta de inercia en el salto**: No hay sistema de inercia que preserve la velocidad horizontal del movimiento previo al saltar. El jugador debería mantener cierta velocidad horizontal cuando salta basándose en el movimiento que tenía antes del salto.

### Comportamiento Actual

- **Salto y movimiento**: El jugador puede presionar WASD mientras está en el aire después de saltar y se mueve normalmente, lo cual choca con la lógica de vuelo (`isFlying`)
- **Falta de inercia**: Cuando el jugador salta, no se preserva la velocidad horizontal previa. El salto solo aplica velocidad vertical (`velocity.z`)
- El sistema de física aplica movimiento basado en `input.moveDirection` incluso cuando el jugador está en el aire después de saltar

### Comportamiento Esperado

- **Restricción de movimiento en el aire**: Una vez que el jugador salta (no está en el suelo y no está volando), NO debe poder moverse con input directo (WASD). Solo debe moverse por:
  - Inercia del movimiento previo al saltar
  - Fuerzas externas (gravedad, viento, etc.)
  - El sistema de vuelo (si activa vuelo)
- **Sistema de inercia**: Cuando el jugador salta, debe preservar la velocidad horizontal (`velocity.x` y `velocity.y`) que tenía antes del salto

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js AnimationMixer
- ECS (Entity Component System)
- Sistema de física del jugador
- Sistema de estados de animación declarativo

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/physics-system.js` - Restringir movimiento en el aire y agregar sistema de inercia
- `frontend/src/ecs/systems/input-system.js` - Posiblemente necesite ajustes para no procesar input en el aire
- `frontend/src/ecs/components/physics.js` - Agregar propiedades para rastrear inercia (`velocityInertia`, `isInAir`)

## Criterios de Aceptación

1. [ ] Cuando el jugador salta (no está en el suelo y no está volando), NO puede moverse con input directo (WASD)
2. [ ] El jugador mantiene velocidad horizontal por inercia cuando salta, basándose en el movimiento previo
3. [ ] La inercia se aplica correctamente al momento del salto (preserva `velocity.x` y `velocity.y` previos)
4. [ ] El sistema de vuelo sigue funcionando correctamente (el jugador puede activar vuelo y moverse libremente)
5. [ ] La inercia disminuye gradualmente por fricción del aire
6. [ ] No hay regresiones en otras funcionalidades de física o animaciones

## Detalles de Implementación

### Consideraciones Técnicas

- **Detección de estado en el aire**: El jugador está en el aire cuando `!physics.isGrounded && !physics.isFlying` (se puede agregar flag `isInAir` para claridad)
- **Preservación de inercia**: Al momento del salto, guardar `velocity.x` y `velocity.y` actuales en `velocityInertia` y aplicarlas durante el salto
- **Fricción en el aire**: La inercia debe disminuir gradualmente por fricción del aire (`airFriction`)
- **Compatibilidad con vuelo**: El sistema de vuelo debe seguir funcionando normalmente (cuando `isFlying = true`, el jugador puede moverse libremente)
- **Restricción de input**: `InputSystem` debe verificar si está en el aire antes de aplicar aceleración basada en `moveDirection`

### Dependencias
- Depende de: Ninguna
- Bloquea: Ninguna

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Salto sin movimiento previo**: Saltar sin moverse antes y verificar que no se mueve horizontalmente en el aire
2. **Escenario 2 - Salto con movimiento previo**: Caminar hacia adelante, saltar, y verificar que mantiene velocidad horizontal por inercia
3. **Escenario 3 - Restricción de input en el aire**: Saltar y presionar WASD, verificar que NO se mueve con input directo
4. **Escenario 4 - Inercia disminuye**: Verificar que la inercia disminuye gradualmente por fricción del aire
5. **Escenario 5 - Vuelo sigue funcionando**: Activar vuelo y verificar que el movimiento libre sigue funcionando
6. **Escenario 6 - Transición salto/vuelo**: Verificar que las transiciones entre salto y vuelo funcionan correctamente
7. **Escenario 7 - Salto múltiple (doble salto)**: Verificar que el doble salto mantiene la inercia del primer salto o aplica nueva inercia

### Casos Edge a Considerar
- **Salto desde movimiento rápido**: Verificar que la inercia se preserva correctamente incluso con velocidades altas
- **Salto múltiple (doble salto)**: El doble salto debe mantener la inercia del primer salto o aplicar nueva inercia
- **Cambio de dirección en el aire**: Aunque no debería poder cambiar dirección con input, verificar que la inercia no causa comportamientos extraños
- **Transición entre salto y vuelo**: Verificar que al activar vuelo durante un salto, el movimiento se libera correctamente
- **Límites de velocidad horizontal**: Considerar límites máximos de velocidad horizontal para evitar comportamientos extraños

## Estimación

- **Complejidad:** Alta
- **Tiempo estimado:** 4-6 horas
- **Notas:** Requiere cambios en el sistema de física que pueden afectar otras funcionalidades. Necesita pruebas exhaustivas para asegurar que no rompe el sistema de vuelo u otras mecánicas. Las animaciones direccionales de nadar se movieron a JDG-056.

## Referencias

- **Relacionado con:** JDG-040 (Sistema de Vuelo del Personaje), JDG-056 (Animaciones Direccionales de Nadar - separado de este ticket)
- **Documentación relevante:** `frontend/src/ecs/systems/physics-system.js`, `frontend/src/config/animation-config.js`
- **Discusiones previas:** Sistema de vuelo implementado en JDG-040, sistema de física en JDG-010

## Notas Adicionales

- **Importante**: Este cambio afecta la física del juego y puede tener impacto en la jugabilidad. Se debe probar exhaustivamente para asegurar que no rompe otras mecánicas.
- El sistema de vuelo (`isFlying = true`) debe seguir permitiendo movimiento libre, ya que es una mecánica diferente al salto normal
- La inercia debe aplicarse solo al momento del salto inicial, no en saltos múltiples (doble salto) a menos que se decida lo contrario
- Las animaciones direccionales de nadar se movieron a un ticket separado (JDG-056) para mantener este ticket enfocado en física
