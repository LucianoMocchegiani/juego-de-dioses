# JDG-054 - Unificar Transiciones de Animación entre Gameplay Normal y F6

## Tipo
- [ ] Feature (nueva funcionalidad)
- [x] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (afecta jugabilidad y experiencia visual)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Las transiciones de animación en gameplay normal tienen un comportamiento diferente al de la herramienta de debugging (F6), causando inconsistencias visuales. La herramienta F6 muestra transiciones más suaves, mientras que el gameplay normal tiene transiciones menos consistentes.

### Comportamiento Actual

- `playAnimationByName()` (F6) siempre hace `fadeOut` de la animación anterior y usa `clampWhenFinished = true`
- `playAnimation()` (gameplay normal) hace `fadeOut` condicionalmente y usa `clampWhenFinished = false` para one-shot
- Esto causa diferencias visuales en las transiciones entre gameplay normal y F6

### Comportamiento Esperado

- Las transiciones en gameplay normal deben ser iguales a las de F6 (herramienta de debugging)
- Las transiciones deben ser visualmente suaves sin "saltos" de posición
- No debe haber diferencias visuales entre gameplay normal y F6

**Nota:** El problema de desplazamiento durante animaciones (root motion) se ha movido a un ticket separado (JDG-055) para ser abordado más adelante. Este ticket solo incluye la unificación de transiciones.

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js (AnimationMixer)
- ECS (Entity Component System)
- Sistema de animaciones (AnimationMixerSystem)
- Herramientas de debugging (F6 - TestInterface)

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/animation-mixer-system.js` - Sistema que reproduce animaciones
- `frontend/src/interfaces/test-interface.js` - Herramienta de debugging (F6)

## Criterios de Aceptación

1. [x] Las transiciones en gameplay normal son iguales a las de F6 (herramienta de debugging)
2. [x] Las transiciones entre todas las animaciones son visualmente suaves
3. [x] No hay regresiones en otras funcionalidades de animación o combate

## Detalles de Implementación

### Cambios Realizados

1. **FadeOut unificado:**
   - Modificado `playAnimation()` para siempre hacer `fadeOut` si hay animación anterior corriendo y el estado cambió
   - Esto unifica el comportamiento con `playAnimationByName()` (F6)

2. **clampWhenFinished = true:**
   - Cambiado `clampWhenFinished = false` a `clampWhenFinished = true` para animaciones one-shot
   - Esto mantiene la animación en el último frame, evitando saltos visuales
   - Unifica el comportamiento con `playAnimationByName()` (F6)

### Dependencias

- Depende de: Ninguna
- Bloquea: Ninguna

## Testing

### Escenarios de Prueba

1. **Escenario 1 - Transición de combat_stance a ataque**: Estar en `combat_stance`, presionar ataque, verificar que la transición es suave
2. **Escenario 2 - Comparación con F6**: Comparar visualmente las transiciones en gameplay normal con F6, verificar que son iguales
3. **Escenario 3 - Múltiples animaciones**: Probar transiciones entre diferentes animaciones, verificar que todas son suaves
4. **Escenario 4 - Regresiones**: Verificar que no hay regresiones en otras funcionalidades de animación o combate

### Casos Edge a Considerar

- **Transiciones rápidas**: Si el jugador cambia de animación rápidamente, verificar que las transiciones siguen siendo suaves
- **Animaciones de combate**: Verificar que las animaciones de combate mantienen su comportamiento correcto
- **Animaciones de movimiento**: Verificar que las animaciones de movimiento (walk, run, jump) no se ven afectadas

## Estimación

- **Complejidad:** Baja
- **Tiempo estimado:** 1 hora
- **Notas:** Cambios simples en lógica de transiciones, sin afectar otras funcionalidades

## Referencias

- **Relacionado con:** JDG-055 (Desplazamiento No Deseado Durante Animaciones - Root Motion)
- **Documentación relevante:** `frontend/src/ecs/systems/animation-mixer-system.js`, `frontend/src/interfaces/test-interface.js`
- **Análisis relacionado:** `instructions/analysis/JDG-054-architecture-analysis_2026-01-14_19-24-01.md`

## Notas Adicionales

- Este ticket solo incluye la unificación de transiciones
- El problema de desplazamiento durante animaciones (root motion) se ha movido a JDG-055 para ser abordado más adelante
- Los cambios son simples y no afectan otras funcionalidades del sistema de animaciones
