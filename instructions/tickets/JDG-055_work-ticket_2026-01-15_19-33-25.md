# JDG-055 - Desplazamiento No Deseado Durante Animaciones (Root Motion)

## Tipo
- [ ] Feature (nueva funcionalidad)
- [x] Bugfix (corrección de error)
- [ ] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [x] Alta (afecta jugabilidad y experiencia visual)
- [ ] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Cuando el personaje está en estado normal de combate (`combat_stance`) y hace la transición a un ataque (o parry), el personaje se desplaza de su posición original hacia la derecha durante la animación. Al terminar la animación, el personaje se "transporta" de vuelta a la posición original en la que estaba en `combat_stance`, creando un efecto visual antinatural y desorientador.

Este problema NO ocurre con otras animaciones como correr, caminar y saltar, solo afecta a:
- Ataques (attack, heavy_attack, charged_attack, special_attack, combo_attack)
- Parry

**Nota:** Este ticket fue separado de JDG-054 para ser abordado más adelante. JDG-054 solo incluyó la unificación de transiciones.

### Comportamiento Actual

- El personaje está en `combat_stance` (posición A)
- El jugador presiona ataque o parry
- Durante la animación de ataque/parry, el personaje se desplaza hacia la derecha (posición B)
- Al terminar la animación y volver a `combat_stance`, el personaje se "transporta" instantáneamente de vuelta a la posición A
- Esto crea un efecto visual de "teletransporte" o movimiento antinatural
- El problema NO ocurre con animaciones de movimiento (walk, run, jump)

### Comportamiento Esperado

- El personaje debe permanecer en la misma posición durante toda la secuencia: `combat_stance` → ataque/parry → `combat_stance`
- No debe haber desplazamiento lateral no deseado durante las animaciones de combate
- Las transiciones deben ser visualmente suaves sin "saltos" de posición
- El comportamiento debe ser consistente con otras animaciones (walk, run, jump) que no presentan este problema

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js (AnimationMixer, Bones, Skeleton)
- ECS (Entity Component System)
- Sistema de animaciones (AnimationMixerSystem)
- GLB/GLTF models con animaciones

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/animation-mixer-system.js` - Sistema que reproduce animaciones
- `frontend/src/config/animation-config.js` - Configuración de estados de animación (agregar configuración de root motion)
- `frontend/src/ecs/models/bones-utils.js` - Utilidades para trabajar con bones (ya tiene `getRootBone()` y `getSkeleton()`)
- `frontend/src/interfaces/test-interface.js` - Herramienta de debugging (F6) para verificar

## Criterios de Aceptación

1. [ ] El personaje NO se desplaza lateralmente durante animaciones de ataque desde `combat_stance`
2. [ ] El personaje NO se desplaza lateralmente durante animaciones de parry desde `combat_stance`
3. [ ] No hay "teletransporte" o salto de posición al terminar la animación y volver a `combat_stance`
4. [ ] Las transiciones entre `combat_stance` y ataques/parry son visualmente suaves
5. [ ] El comportamiento es consistente con otras animaciones (walk, run, jump) que no tienen este problema
6. [ ] No hay regresiones en otras funcionalidades de animación o combate
7. [ ] Solo animaciones explícitas (dodge, roll_dodge) permiten root motion (movimiento intencional)

## Detalles de Implementación

### Consideraciones Técnicas

**Causa raíz identificada:**
- El problema está confirmado que NO está en las animaciones GLB (verificado en Blender)
- El root bone se mueve significativamente en espacio del mundo (~0.2-0.5 unidades en X) durante animaciones de combate
- El desplazamiento visual proviene del root bone moviendo el esqueleto, pero el mesh Group y PositionComponent no cambian

**Enfoques posibles:**

1. **Compensación de Root Motion en Código (Recomendado):**
   - Implementar sistema de compensación de root motion en `AnimationMixerSystem`
   - Rastrear posición inicial del root bone en espacio del mundo
   - Aplicar compensación al `PositionComponent` para contrarrestar el movimiento del root bone
   - Solo aplicar a animaciones que requieren compensación (no a dodge, roll_dodge)

2. **Deshabilitar Root Motion en Blender:**
   - Corregir las animaciones en Blender para que el root bone no se mueva
   - Requiere re-exportar todas las animaciones de combate

3. **Híbrido:**
   - Combinar ambas: corregir animaciones problemáticas y agregar compensación de root motion como medida de seguridad

**Nota:** Se intentó implementar compensación de root motion pero causó efectos secundarios (el mundo se movía durante todas las animaciones). Se requiere una solución más refinada.

### Dependencias

- Depende de: JDG-054 (Unificar Transiciones de Animación) - Completado
- Bloquea: Ninguna

## Testing

### Escenarios de Prueba

1. **Escenario 1 - Ataque básico**: Estar en `combat_stance`, presionar ataque, verificar que NO hay desplazamiento lateral
2. **Escenario 2 - Parry**: Estar en `combat_stance`, presionar parry, verificar que NO hay desplazamiento lateral
3. **Escenario 3 - Ataques pesados**: Probar `heavy_attack`, `charged_attack`, `special_attack`, verificar que NO hay desplazamiento
4. **Escenario 4 - Transición de vuelta**: Verificar que al terminar la animación y volver a `combat_stance`, NO hay "teletransporte"
5. **Escenario 5 - Comparación con movimiento**: Comparar comportamiento con walk/run/jump que NO tienen este problema
6. **Escenario 6 - Múltiples ataques**: Hacer varios ataques seguidos, verificar que la posición se mantiene consistente
7. **Escenario 7 - Dodge (debe permitir movimiento)**: Activar dodge, verificar que SÍ se mueve según la animación (comportamiento intencional)

### Casos Edge a Considerar

- **Transiciones rápidas**: Si el jugador cancela un ataque rápidamente, verificar que no hay desplazamiento residual
- **Combos**: Verificar que durante combos no hay desplazamiento acumulado
- **Diferentes armas**: Si hay diferentes animaciones según el arma, verificar todas
- **Animaciones desde otros estados**: Verificar si el problema ocurre al atacar desde otros estados (no solo `combat_stance`)

## Estimación

- **Complejidad:** Alta (requiere investigación profunda y posiblemente trabajo en Blender)
- **Tiempo estimado:** 4-8 horas (depende del enfoque elegido)
- **Notas:** Requiere análisis detallado y posiblemente múltiples intentos de implementación. Se intentó previamente pero causó efectos secundarios que requieren una solución más refinada.

## Referencias

- **Relacionado con:** JDG-054 (Unificar Transiciones de Animación) - Completado
- **Documentación relevante:** 
  - `frontend/src/ecs/systems/animation-mixer-system.js`
  - `frontend/src/config/animation-config.js`
  - `frontend/src/ecs/models/bones-utils.js`
  - `frontend/src/interfaces/test-interface.js` (F6)
- **Análisis relevante:** `instructions/analysis/JDG-054-architecture-analysis_2026-01-14_19-24-01.md`
- **Notas técnicas:** `instructions/notes/root-motion-notes.md` (si existe)

## Notas Adicionales

- Este ticket fue separado de JDG-054 para ser abordado más adelante
- Se intentó implementar compensación de root motion pero causó efectos secundarios (el mundo se movía durante todas las animaciones)
- Se requiere una solución más refinada que no afecte otras animaciones
- El problema está confirmado que NO está en las animaciones GLB (verificado en Blender)
- El root bone se mueve significativamente en espacio del mundo durante animaciones de combate
- Posible solución: implementar compensación más precisa que solo afecte a animaciones de combate y se limpie correctamente al salir de combate
