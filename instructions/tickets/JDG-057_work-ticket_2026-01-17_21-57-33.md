# JDG-057 - Refactorizar AnimationMixerSystem con Helpers Externos

## Tipo
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El archivo `animation-mixer-system.js` tiene 799 líneas y múltiples responsabilidades mezcladas, lo que dificulta su mantenimiento, lectura y testing. Además, no sigue la misma estructura legible que otros sistemas más pequeños (como `animation-state-system.js` con 79 líneas o `combo-system.js` con 120 líneas).

### Comportamiento Actual

- `animation-mixer-system.js` tiene 799 líneas y maneja múltiples responsabilidades:
  - Carga de animaciones desde archivos GLB
  - Inicialización de AnimationMixer
  - Resolución de nombres de animación según estado/dirección
  - Reproducción de animaciones y transiciones
  - Gestión de combate (i-frames, cleanup de acciones)
  - Detección de cambios direccionales
  - Tracking de animaciones direccionales
- Es difícil de leer, mantener y testear
- No sigue una estructura consistente con otros sistemas más pequeños

### Comportamiento Esperado

- `animation-mixer-system.js` debe ser un sistema orquestador de ~200-300 líneas que delega a helpers especializados
- Crear carpeta `ecs/helpers/animation/` con helpers reutilizables:
  - `animation-loader.js` - Carga de animaciones desde archivos GLB
  - `animation-resolver.js` - Resolver nombres de animación según estado/dirección
  - `animation-player.js` - Reproducir animaciones y manejar transiciones
  - `combat-animation-handler.js` - Gestión de combate (i-frames, cleanup)
- Mantener funcionalidad exacta (sin cambios de comportamiento)
- Estructura clara y consistente con otros sistemas
- Helpers testables independientemente

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js AnimationMixer
- ECS (Entity Component System)
- Patrón de helpers/utilities para separación de responsabilidades

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/animation-mixer-system.js` - Refactorizar para usar helpers (reducir a ~200-300 líneas)
- `frontend/src/ecs/helpers/animation/` - Nueva carpeta con helpers (crear)
  - `animation-loader.js` - Extraer lógica de carga de GLB
  - `animation-resolver.js` - Extraer resolución de nombres de animación
  - `animation-player.js` - Extraer reproducción y transiciones
  - `combat-animation-handler.js` - Extraer gestión de combate

## Criterios de Aceptación

1. [ ] `animation-mixer-system.js` tiene entre 200-300 líneas (reducido de 799)
2. [ ] Se crea carpeta `ecs/helpers/animation/` con 4 helpers especializados
3. [ ] Cada helper tiene una responsabilidad única y clara
4. [ ] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
5. [ ] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
6. [ ] Los helpers son testables independientemente
7. [ ] No hay regresiones en animaciones existentes
8. [ ] El código es más legible y mantenible
9. [ ] La estructura sigue las mismas convenciones que otros sistemas pequeños

## Detalles de Implementación

### Consideraciones Técnicas

- **Separación de responsabilidades**: Cada helper maneja una responsabilidad específica
- **Sin cambios de comportamiento**: La refactorización debe mantener funcionalidad idéntica
- **Testabilidad**: Los helpers deben poder testearse sin necesidad del ECS completo
- **Independencia del ECS**: Los helpers reciben componentes como parámetros en lugar de buscar en el ECS
- **Compatibilidad**: Mantener misma interfaz pública del sistema para no romper otros sistemas

### Dependencias
- Depende de: Ninguna
- Bloquea: Ninguna (refactorización sin cambios funcionales)

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Funcionalidad idéntica**: Verificar que todas las animaciones funcionan exactamente igual que antes
2. **Escenario 2 - Carga de animaciones**: Verificar que las animaciones se cargan correctamente desde GLB
3. **Escenario 3 - Resolución de nombres**: Verificar que las animaciones direccionales (walk, crouch_walk, swim) funcionan correctamente
4. **Escenario 4 - Reproducción y transiciones**: Verificar que las transiciones entre animaciones son suaves
5. **Escenario 5 - Combate**: Verificar que i-frames y cleanup de combate funcionan correctamente
6. **Escenario 6 - Tracking direccional**: Verificar que los cambios direccionales se detectan correctamente
7. **Escenario 7 - No regresiones**: Verificar que todas las animaciones existentes (idle, walk, run, jump, attack, etc.) funcionan igual

### Casos Edge a Considerar
- **Animaciones faltantes**: Si un archivo GLB no existe, el sistema debe manejarlo correctamente
- **Sin input**: Si InputComponent no está disponible, el sistema debe usar fallbacks
- **Cambios rápidos de dirección**: Las transiciones deben ser suaves al cambiar rápidamente entre direcciones
- **Combate en progreso**: El sistema debe respetar preventInterruption durante acciones de combate

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 4-6 horas
- **Notas:** Refactorización cuidadosa que requiere extraer código sin cambiar comportamiento. Requiere testing exhaustivo para asegurar que no hay regresiones.

## Referencias

- **Relacionado con:** Análisis de estructura de sistemas ECS (discusión previa)
- **Documentación relevante:** 
  - `frontend/src/ecs/systems/animation-mixer-system.js`
  - `frontend/src/ecs/systems/animation-state-system.js` (ejemplo de sistema pequeño)
  - `frontend/src/ecs/systems/combo-system.js` (ejemplo de sistema pequeño)

## Notas Adicionales

- Esta refactorización es parte de un esfuerzo mayor para mantener sistemas ECS legibles y mantenibles
- El objetivo es establecer un patrón que pueda aplicarse a otros sistemas grandes en el futuro (ej: `weapon-equip-system.js` con 628 líneas)
- Después de esta refactorización, considerar refactorizar `weapon-equip-system.js` de manera similar
- Los helpers deben seguir las mismas convenciones de código que el resto del proyecto
