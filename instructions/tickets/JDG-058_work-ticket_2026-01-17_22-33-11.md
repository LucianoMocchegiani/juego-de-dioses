# JDG-058 - Refactorizar WeaponEquipSystem con Helpers Externos

## Tipo
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El archivo `weapon-equip-system.js` tiene 628 líneas y múltiples responsabilidades mezcladas, lo que dificulta su mantenimiento, lectura y testing. Similar al problema de `animation-mixer-system.js` (JDG-057), necesita refactorización para seguir el mismo patrón de helpers especializados.

### Comportamiento Actual

- `weapon-equip-system.js` tiene 628 líneas y maneja múltiples responsabilidades:
  - Inspección de estructura completa de modelos de armas GLB (~200 líneas en `inspectWeaponModel`)
  - Carga de modelos con gestión de cache y promesas (~160 líneas en `equipWeapon`)
  - Adjuntar armas al personaje con ajustes de offset (~135 líneas en `attachWeaponToEntity`)
  - Desequipar armas (~15 líneas en `unequipWeapon`)
  - Orquestación del sistema en `update()` (~35 líneas)
- Es difícil de leer, mantener y testear
- No sigue una estructura consistente con otros sistemas refactorizados (ej: `animation-mixer-system.js`)

### Comportamiento Esperado

- `weapon-equip-system.js` debe ser un sistema orquestador de ~200-250 líneas que delega a helpers especializados
- Crear carpeta `ecs/helpers/weapon/` con helpers reutilizables:
  - `weapon-model-inspector.js` - Inspección de estructura de modelos GLB
  - `weapon-model-loader.js` - Carga de modelos con cache y gestión de promesas
  - `weapon-attachment-manager.js` - Adjuntar y desequipar armas al personaje
- Mantener funcionalidad exacta (sin cambios de comportamiento)
- Estructura clara y consistente con otros sistemas refactorizados
- Helpers testables independientemente

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js (Object3D, Mesh, Group)
- ECS (Entity Component System)
- Patrón de helpers/utilities para separación de responsabilidades
- Object Pool (optimización JDG-047)

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/weapon-equip-system.js` - Refactorizar para usar helpers (reducir a ~200-250 líneas)
- `frontend/src/ecs/helpers/weapon/` - Nueva carpeta con helpers (crear)
  - `weapon-model-inspector.js` - Extraer lógica de inspección de modelos
  - `weapon-model-loader.js` - Extraer lógica de carga con cache y promesas
  - `weapon-attachment-manager.js` - Extraer lógica de adjuntar/desequipar armas

## Criterios de Aceptación

1. [ ] `weapon-equip-system.js` tiene entre 200-250 líneas (reducido de 628)
2. [ ] Se crea carpeta `ecs/helpers/weapon/` con 3 helpers especializados
3. [ ] Cada helper tiene una responsabilidad única y clara
4. [ ] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
5. [ ] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
6. [ ] Los helpers son testables independientemente
7. [ ] No hay regresiones en equipamiento/desequipamiento de armas
8. [ ] El código es más legible y mantenible
9. [ ] La estructura sigue las mismas convenciones que `animation-mixer-system.js` refactorizado

## Detalles de Implementación

### Consideraciones Técnicas

- **Separación de responsabilidades**: Cada helper maneja una responsabilidad específica
- **Sin cambios de comportamiento**: La refactorización debe mantener funcionalidad idéntica
- **Testabilidad**: Los helpers deben poder testearse sin necesidad del ECS completo
- **Independencia del ECS**: Los helpers reciben componentes como parámetros en lugar de buscar en el ECS
- **Compatibilidad**: Mantener misma interfaz pública del sistema para no romper otros sistemas
- **Object Pool**: Los helpers que usen Object Pool deben manejarlo correctamente (optimización JDG-047)

### Dependencias
- Depende de: JDG-057 (patrón de refactorización establecido)
- Bloquea: Ninguna (refactorización sin cambios funcionales)

## Testing

### Escenarios de Prueba
1. **Escenario 1 - Funcionalidad idéntica**: Verificar que equipamiento/desequipamiento funciona exactamente igual que antes
2. **Escenario 2 - Carga de modelos**: Verificar que las armas se cargan correctamente desde archivos GLB
3. **Escenario 3 - Cache de modelos**: Verificar que el cache funciona correctamente (no carga duplicados)
4. **Escenario 4 - Inspección de modelos**: Verificar que la inspección de estructura funciona correctamente
5. **Escenario 5 - Adjuntar armas**: Verificar que las armas se adjuntan correctamente al personaje
6. **Escenario 6 - Desequipar armas**: Verificar que las armas se desequipan correctamente
7. **Escenario 7 - Cambio de armas**: Verificar que al cambiar de arma, la anterior se desequipa correctamente
8. **Escenario 8 - No regresiones**: Verificar que todas las armas existentes funcionan igual

### Casos Edge a Considerar
- **Modelos faltantes**: Si un archivo GLB no existe, el sistema debe manejarlo correctamente
- **Cache de promesas**: Si múltiples entidades intentan cargar el mismo modelo simultáneamente
- **Arma ya equipada**: El sistema debe detectar si un arma ya está equipada y no volver a cargarla
- **Mesh desplazado**: Si el mesh del arma está desplazado dentro del Group, debe compensarse con offset
- **Object Pool**: Verificar que los objetos del pool se liberan correctamente después de usar

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 4-6 horas
- **Notas:** Refactorización cuidadosa que requiere extraer código sin cambiar comportamiento. Similar en complejidad a JDG-057. Requiere testing exhaustivo para asegurar que no hay regresiones.

## Referencias

- **Relacionado con:** JDG-057 (patrón de refactorización similar)
- **Documentación relevante:** 
  - `frontend/src/ecs/systems/weapon-equip-system.js`
  - `frontend/src/ecs/systems/animation-mixer-system.js` (referencia de sistema refactorizado)
  - `frontend/src/utils/weapon-attachment.js` (utilidades de adjuntar armas)

## Notas Adicionales

- Esta refactorización sigue el mismo patrón establecido en JDG-057 para mantener consistencia
- Los helpers deben seguir las mismas convenciones de código que el resto del proyecto
- El Object Pool debe manejarse correctamente en `WeaponModelInspector` (optimización JDG-047)
- La inspección de modelos genera logs extensos para debugging - mantener esta funcionalidad
