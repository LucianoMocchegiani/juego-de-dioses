# JDG-059 - Refactorizar InputSystem con Helpers Externos

## Tipo
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El archivo `input-system.js` tiene 385 líneas y múltiples responsabilidades mezcladas, lo que dificulta su mantenimiento, lectura y testing. Similar a los problemas de `animation-mixer-system.js` (JDG-057) y `weapon-equip-system.js` (JDG-058), necesita refactorización para seguir el mismo patrón de helpers especializados.

### Comportamiento Actual

- `input-system.js` tiene 385 líneas y maneja múltiples responsabilidades:
  - Verificación de acciones con lógica compleja de combinaciones (~50 líneas en `checkAction`)
  - Cálculo de dirección de movimiento 2D y 3D (~90 líneas en `update`)
  - Sistema de saltos y activación de vuelo (~35 líneas en `update`)
  - Procesamiento de inputs de combate (~35 líneas en `update`)
  - Aplicación de movimiento a física (~35 líneas en `update`)
- Es difícil de leer, mantener y testear
- No sigue una estructura consistente con otros sistemas refactorizados (ej: `animation-mixer-system.js`, `weapon-equip-system.js`)

### Comportamiento Esperado

- `input-system.js` debe ser un sistema orquestador de ~150-200 líneas que delega a helpers especializados
- Crear carpeta `ecs/helpers/input/` con helpers reutilizables:
  - `input-action-checker.js` - Verificación de acciones y combinaciones de teclas/mouse
  - `movement-direction-calculator.js` - Cálculo de dirección de movimiento 2D normal y 3D en vuelo
  - `jump-handler.js` - Sistema de saltos y activación de vuelo (triple salto)
  - `combat-input-processor.js` - Procesamiento de inputs de combate (ataques, defensas)
- Mantener funcionalidad exacta (sin cambios de comportamiento)
- Estructura clara y consistente con otros sistemas refactorizados
- Helpers testables independientemente

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- Three.js (cálculos de rotación de cámara)
- ECS (Entity Component System)
- InputManager (gestión de teclas y mouse)
- CameraController (rotación de cámara para movimiento 3D)
- Patrón de helpers/utilities para separación de responsabilidades

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/input-system.js` - Refactorizar para usar helpers (reducir a ~150-200 líneas)
- `frontend/src/ecs/helpers/input/` - Nueva carpeta con helpers (crear)
  - `input-action-checker.js` - Extraer lógica de `checkAction()` y verificación de combinaciones
  - `movement-direction-calculator.js` - Extraer cálculo de dirección 2D/3D con rotación de cámara
  - `jump-handler.js` - Extraer lógica de saltos y activación de vuelo (triple salto)
  - `combat-input-processor.js` - Extraer procesamiento de inputs de combate (wantsToAttack, wantsToParry, etc.)

## Criterios de Aceptación

1. [ ] `input-system.js` tiene entre 150-200 líneas (reducido de 385)
2. [ ] Se crea carpeta `ecs/helpers/input/` con 4 helpers especializados
3. [ ] Cada helper tiene una responsabilidad única y clara
4. [ ] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
5. [ ] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
6. [ ] Los helpers son testables independientemente
7. [ ] No hay regresiones en procesamiento de input (movimiento, saltos, combate)
8. [ ] El código es más legible y mantenible
9. [ ] La estructura sigue las mismas convenciones que `animation-mixer-system.js` y `weapon-equip-system.js` refactorizados

## Detalles de Implementación

### Consideraciones Técnicas
- Performance: Los helpers deben mantener la misma eficiencia que el código original
- Compatibilidad: Mantener compatibilidad con InputManager y CameraController
- Escalabilidad: Los helpers deben poder extenderse fácilmente para nuevas funcionalidades

### Dependencias
- No depende de otros tickets
- Relacionado con: JDG-057 (AnimationMixerSystem refactorizado), JDG-058 (WeaponEquipSystem refactorizado)

## Testing

### Escenarios de Prueba
1. Movimiento básico: Verificar que W/A/S/D mueven correctamente en 2D
2. Movimiento en vuelo: Verificar que W/A/S/D mueven correctamente en 3D basado en rotación de cámara
3. Sistema de saltos: Verificar que triple salto activa vuelo
4. Combate: Verificar que clicks y teclas procesan acciones de combate correctamente
5. Combinaciones de teclas: Verificar que combinaciones (Shift+Click, Ctrl+Click) funcionan correctamente

### Casos Edge a Considerar
- Cámara sin rotación (rotaciónY = 0)
- Cambio rápido entre movimiento normal y vuelo
- Múltiples combinaciones de teclas presionadas simultáneamente
- Input bloqueado durante acciones de combate

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 4-6 horas
- **Notas:** Similar complejidad a JDG-057 y JDG-058, requiere cuidado al extraer lógica de movimiento 3D

## Referencias

- **Relacionado con:** JDG-057 (AnimationMixerSystem refactorizado), JDG-058 (WeaponEquipSystem refactorizado)
- **Documentación relevante:** 
  - `frontend/src/ecs/helpers/animation/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/weapon/README.md` (patrón de referencia)
- **Archivos de referencia:**
  - `frontend/src/ecs/systems/animation-mixer-system.js` (ejemplo de sistema refactorizado)
  - `frontend/src/ecs/systems/weapon-equip-system.js` (ejemplo de sistema refactorizado)

## Notas Adicionales

- Este refactor sigue el mismo patrón establecido en JDG-057 y JDG-058
- El helper `movement-direction-calculator.js` será el más complejo debido a la lógica 3D con rotación de cámara
- Los helpers deben recibir InputManager y CameraController como dependencias (no buscarlos en el ECS)
- La interfaz pública de InputSystem debe mantenerse (métodos públicos como `checkAction` pueden moverse a helpers pero deben ser accesibles)
