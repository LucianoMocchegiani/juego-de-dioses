# JDG-060 - Refactorizar CollisionSystem con Helpers Externos

## Tipo
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El archivo `collision-system.js` tiene 269 líneas y múltiples responsabilidades mezcladas, lo que dificulta su mantenimiento, lectura y testing. Similar a los problemas de `animation-mixer-system.js` (JDG-057), `weapon-equip-system.js` (JDG-058) e `input-system.js` (JDG-059), necesita refactorización para seguir el mismo patrón de helpers especializados.

### Comportamiento Actual

- `collision-system.js` tiene 269 líneas y maneja múltiples responsabilidades:
  - Gestión de cache de colisiones por entidad (~30 líneas en constructor y métodos)
  - Actualización de celdas ocupadas desde partículas (~15 líneas en `updateLoadedCells`)
  - Detección de líquidos (~25 líneas en `detectLiquidAtPosition`)
  - Detección de colisiones laterales y suelo (~60 líneas en `update`)
  - Verificación de límites del terreno y respawn (~30 líneas en `update`)
  - Invalidación de cache basada en movimiento (~15 líneas en `update`)
- Es difícil de leer, mantener y testear
- No sigue una estructura consistente con otros sistemas refactorizados

### Comportamiento Esperado

- `collision-system.js` debe ser un sistema orquestador de ~120-150 líneas que delega a helpers especializados
- Crear carpeta `ecs/helpers/collision/` con helpers reutilizables:
  - `collision-cache-manager.js` - Gestión de cache de colisiones y invalidación basada en movimiento
  - `collision-detector-helper.js` - Detección de colisiones laterales y suelo
  - `liquid-detector.js` - Detección de líquidos en posición
  - `terrain-bounds-checker.js` - Verificación de límites del terreno y respawn
- Mantener funcionalidad exacta (sin cambios de comportamiento)
- Estructura clara y consistente con otros sistemas refactorizados
- Helpers testables independientemente

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- ECS (Entity Component System)
- CollisionDetector (detección de colisiones)
- SpatialGrid (optimización de queries espaciales)
- Patrón de helpers/utilities para separación de responsabilidades

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/collision-system.js` - Refactorizar para usar helpers (reducir a ~120-150 líneas)
- `frontend/src/ecs/helpers/collision/` - Nueva carpeta con helpers (crear)
  - `collision-cache-manager.js` - Extraer gestión de cache y invalidación
  - `collision-detector-helper.js` - Extraer detección de colisiones laterales y suelo
  - `liquid-detector.js` - Extraer detección de líquidos
  - `terrain-bounds-checker.js` - Extraer verificación de límites y respawn

## Criterios de Aceptación

1. [ ] `collision-system.js` tiene entre 120-150 líneas (reducido de 269)
2. [ ] Se crea carpeta `ecs/helpers/collision/` con 4 helpers especializados
3. [ ] Cada helper tiene una responsabilidad única y clara
4. [ ] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
5. [ ] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
6. [ ] Los helpers son testables independientemente
7. [ ] No hay regresiones en detección de colisiones (laterales, suelo, límites)
8. [ ] El código es más legible y mantenible
9. [ ] La estructura sigue las mismas convenciones que otros sistemas refactorizados (JDG-057, JDG-058, JDG-059)

## Detalles de Implementación

### Consideraciones Técnicas
- Performance: Los helpers deben mantener la misma eficiencia que el código original, especialmente el cache
- Compatibilidad: Mantener compatibilidad con CollisionDetector y SpatialGrid
- Escalabilidad: Los helpers deben poder extenderse fácilmente para nuevas funcionalidades

### Dependencias
- No depende de otros tickets
- Relacionado con: JDG-057 (AnimationMixerSystem refactorizado), JDG-058 (WeaponEquipSystem refactorizado), JDG-059 (InputSystem refactorizado)

## Testing

### Escenarios de Prueba
1. Colisiones laterales: Verificar que X/Y se bloquean correctamente al chocar con partículas sólidas
2. Colisión con suelo: Verificar que Z se ajusta y `isGrounded` se establece correctamente
3. Límites del terreno: Verificar que posición se limita correctamente y respawn funciona
4. Detección de líquidos: Verificar que `isInWater` se establece correctamente
5. Cache de colisiones: Verificar que cache funciona y se invalida correctamente
6. Actualización de spatial grid: Verificar que spatial grid se actualiza correctamente

### Casos Edge a Considerar
- Entidad dentro de partícula sólida (debe ajustar hacia arriba)
- Caída fuera de límites del terreno (debe respawnear)
- Sin partículas cargadas (debe usar cache o consultar)
- Sin dimension (debe manejar correctamente límites por defecto)

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 4-6 horas
- **Notas:** Similar complejidad a otros refactors, requiere cuidado al extraer lógica de cache y detección

## Referencias

- **Relacionado con:** JDG-057 (AnimationMixerSystem refactorizado), JDG-058 (WeaponEquipSystem refactorizado), JDG-059 (InputSystem refactorizado)
- **Documentación relevante:** 
  - `frontend/src/ecs/helpers/animation/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/weapon/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/input/README.md` (patrón de referencia)
- **Archivos de referencia:**
  - `frontend/src/ecs/systems/collision-system.js`
  - `frontend/src/utils/collision-detector.js` (posible referencia para lógica de detección)

## Notas Adicionales

- Este refactor sigue el mismo patrón establecido en JDG-057, JDG-058 y JDG-059
- El helper `collision-detector-helper.js` será importante para mantener la lógica de detección de colisiones
- El cache debe manejarse cuidadosamente para mantener el rendimiento
- La interfaz pública del sistema debe mantenerse (métodos públicos como `setParticles` deben seguir funcionando)
