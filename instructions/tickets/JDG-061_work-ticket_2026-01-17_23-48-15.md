# JDG-061 - Refactorizar CombatSystem con Helpers Externos

## Tipo
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El archivo `combat-system.js` tiene 217 líneas y múltiples responsabilidades mezcladas, lo que dificulta su mantenimiento, lectura y testing. Similar a los problemas de `animation-mixer-system.js` (JDG-057), `weapon-equip-system.js` (JDG-058), `input-system.js` (JDG-059) y `collision-system.js` (JDG-060), necesita refactorización para seguir el mismo patrón de helpers especializados.

### Comportamiento Actual

- `combat-system.js` tiene 217 líneas y maneja múltiples responsabilidades:
  - Cache de animation states (~10 líneas en constructor)
  - Procesamiento de acciones en loop principal (~40 líneas en `update()`)
  - Verificación de input de acción (~20 líneas en `checkActionInput()`)
  - Verificación de condiciones de ejecución (~15 líneas en `canExecuteAction()`)
  - Aplicación de configuración de acción (~45 líneas en `applyActionConfig()`)
  - Gestión de cooldowns, combo activo, tipo de arma (~30 líneas en `update()`)
  - Logging y eventos de debug (~15 líneas en `update()`)
- Es difícil de leer, mantener y testear
- No sigue una estructura consistente con otros sistemas refactorizados

### Comportamiento Esperado

- `combat-system.js` debe ser un sistema orquestador de ~100-130 líneas que delega a helpers especializados
- Crear carpeta `ecs/helpers/combat/` con helpers reutilizables:
  - `combat-action-input-checker.js` - Verificación de input de acción desde InputComponent
  - `combat-action-validator.js` - Verificación de condiciones de ejecución (arma, cooldowns, etc.)
  - `combat-action-config-applier.js` - Aplicación de configuración de acción y mapeo de animation states
  - `combat-animation-state-cache.js` - Cache de animation states para lookup O(1)
- Mantener funcionalidad exacta (sin cambios de comportamiento)
- Estructura clara y consistente con otros sistemas refactorizados
- Helpers testables independientemente

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- ECS (Entity Component System)
- COMBAT_ACTIONS (configuración centralizada de acciones)
- ANIMATION_STATES (configuración de estados de animación)
- Patrón de helpers/utilities para separación de responsabilidades

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/combat-system.js` - Refactorizar para usar helpers (reducir a ~100-130 líneas)
- `frontend/src/ecs/helpers/combat/` - Nueva carpeta con helpers (crear)
  - `combat-action-input-checker.js` - Extraer verificación de input de acción
  - `combat-action-validator.js` - Extraer verificación de condiciones de ejecución
  - `combat-action-config-applier.js` - Extraer aplicación de configuración de acción
  - `combat-animation-state-cache.js` - Extraer cache de animation states

## Criterios de Aceptación

1. [ ] `combat-system.js` tiene entre 100-130 líneas (reducido de 217)
2. [ ] Se crea carpeta `ecs/helpers/combat/` con 4 helpers especializados
3. [ ] Cada helper tiene una responsabilidad única y clara
4. [ ] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
5. [ ] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
6. [ ] Los helpers son testables independientemente
7. [ ] No hay regresiones en procesamiento de combate (ataques, defensas, cooldowns)
8. [ ] El código es más legible y mantenible
9. [ ] La estructura sigue las mismas convenciones que otros sistemas refactorizados (JDG-057, JDG-058, JDG-059, JDG-060)

## Detalles de Implementación

### Consideraciones Técnicas
- Performance: El cache de animation states debe mantenerse (O(1) lookup)
- Compatibilidad: Mantener compatibilidad con COMBAT_ACTIONS y ANIMATION_STATES
- Logging: Mantener logging y eventos de debug en el lugar apropiado (sistema o helpers)
- Escalabilidad: Los helpers deben poder extenderse fácilmente para nuevas acciones o validaciones

### Dependencias
- No depende de otros tickets
- Relacionado con: JDG-057 (AnimationMixerSystem refactorizado), JDG-058 (WeaponEquipSystem refactorizado), JDG-059 (InputSystem refactorizado), JDG-060 (CollisionSystem refactorizado)

## Testing

### Escenarios de Prueba
1. Ataques básicos: Verificar que los ataques se procesan correctamente según input
2. Defensas (parry/dodge): Verificar que las defensas se procesan correctamente
3. Cooldowns: Verificar que los cooldowns funcionan correctamente
4. Validación de arma: Verificar que las acciones que requieren arma funcionan correctamente
5. Aplicación de configuración: Verificar que las configuraciones de acción se aplican correctamente
6. Cache de animation states: Verificar que el cache funciona correctamente (O(1) lookup)
7. Combos activos: Verificar que si hay combo activo, se omite el procesamiento de acciones individuales

### Casos Edge a Considerar
- Acción activa ya en progreso (no procesar nuevos inputs)
- Combo activo (omitiendo procesamiento de acciones individuales)
- Arma requerida para ciertas acciones (parry, special_attack)
- Cooldowns expirados (permitir ejecución)
- Animation state no encontrado (manejo de error con logging)

## Estimación

- **Complejidad:** Media
- **Tiempo estimado:** 3-5 horas
- **Notas:** Similar complejidad a otros refactors, requiere cuidado al extraer lógica de validación y aplicación de configuración

## Referencias

- **Relacionado con:** JDG-057 (AnimationMixerSystem refactorizado), JDG-058 (WeaponEquipSystem refactorizado), JDG-059 (InputSystem refactorizado), JDG-060 (CollisionSystem refactorizado)
- **Documentación relevante:** 
  - `frontend/src/ecs/helpers/animation/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/weapon/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/input/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/collision/README.md` (patrón de referencia)
- **Archivos de referencia:**
  - `frontend/src/ecs/systems/combat-system.js`
  - `frontend/src/config/combat-actions-config.js` (configuración de acciones)
  - `frontend/src/config/animation-config.js` (ANIMATION_STATES)

## Notas Adicionales

- Este refactor sigue el mismo patrón establecido en JDG-057, JDG-058, JDG-059 y JDG-060
- El cache de animation states es crítico para rendimiento (O(1) lookup), debe mantenerse
- El método `applyActionConfig` es complejo y maneja validación, mapeo de animation states y configuración de combat component
- La lógica de resetear `wantsToDodge` debe mantenerse en el lugar correcto (después de procesar la acción)
