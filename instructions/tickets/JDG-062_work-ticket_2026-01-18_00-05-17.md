# JDG-062 - Refactorizar PhysicsSystem con Helpers Externos

## Tipo
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

El archivo `physics-system.js` tiene 220 líneas y múltiples responsabilidades mezcladas, lo que dificulta su mantenimiento, lectura y testing. Similar a los problemas de `animation-mixer-system.js` (JDG-057), `weapon-equip-system.js` (JDG-058), `input-system.js` (JDG-059), `collision-system.js` (JDG-060) y `combat-system.js` (JDG-061), necesita refactorización para seguir el mismo patrón de helpers especializados.

### Comportamiento Actual

- `physics-system.js` tiene 220 líneas y maneja múltiples responsabilidades:
  - Timestep fijo y acumulador (~15 líneas en `update()`)
  - Aplicar saltos (~15 líneas en `updatePhysics()`)
  - Gestión de vuelo (~5 líneas en `updatePhysics()`)
  - Movimiento de acciones de combate (~50 líneas en `updatePhysics()`)
  - Bloqueo de movimiento normal (~15 líneas en `updatePhysics()`)
  - Aplicar gravedad (~5 líneas en `updatePhysics()`)
  - Actualizar velocidad con aceleración (~5 líneas en `updatePhysics()`)
  - Aplicar fricción (~25 líneas en `updatePhysics()`)
  - Limitar velocidad máxima (~15 líneas en `updatePhysics()`)
  - Actualizar posición (~5 líneas en `updatePhysics()`)
- Es difícil de leer, mantener y testear
- No sigue una estructura consistente con otros sistemas refactorizados

### Comportamiento Esperado

- `physics-system.js` debe ser un sistema orquestador de ~100-130 líneas que delega a helpers especializados
- Crear carpeta `ecs/helpers/physics/` con helpers reutilizables:
  - `physics-timestep-manager.js` - Gestión de timestep fijo y acumulador
  - `combat-movement-applier.js` - Aplicación de movimiento de acciones de combate
  - `physics-friction-applier.js` - Aplicación de fricción (vuelo, normal, bloqueado)
  - `physics-velocity-limiter.js` - Limitación de velocidad máxima
- Mantener funcionalidad exacta (sin cambios de comportamiento)
- Estructura clara y consistente con otros sistemas refactorizados
- Helpers testables independientemente

## Contexto Técnico

### Componentes Afectados
- [ ] Backend (FastAPI)
- [x] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [ ] API Endpoints
- [ ] WebSockets

### Tecnologías Involucradas
- JavaScript ES6+
- ECS (Entity Component System)
- COMBAT_ACTIONS (configuración centralizada de acciones de combate)
- Patrón de helpers/utilities para separación de responsabilidades

### Archivos/Componentes Principales
- `frontend/src/ecs/systems/physics-system.js` - Refactorizar para usar helpers (reducir a ~100-130 líneas)
- `frontend/src/ecs/helpers/physics/` - Nueva carpeta con helpers (crear)
  - `physics-timestep-manager.js` - Extraer gestión de timestep fijo y acumulador
  - `combat-movement-applier.js` - Extraer aplicación de movimiento de acciones de combate
  - `physics-friction-applier.js` - Extraer aplicación de fricción
  - `physics-velocity-limiter.js` - Extraer limitación de velocidad máxima

## Criterios de Aceptación

1. [ ] `physics-system.js` tiene entre 100-130 líneas (reducido de 220)
2. [ ] Se crea carpeta `ecs/helpers/physics/` con 4 helpers especializados
3. [ ] Cada helper tiene una responsabilidad única y clara
4. [ ] El sistema mantiene exactamente la misma funcionalidad (sin cambios de comportamiento)
5. [ ] Los helpers no dependen del ECS directamente (reciben componentes como parámetros)
6. [ ] Los helpers son testables independientemente
7. [ ] No hay regresiones en física (gravedad, velocidad, aceleración, fricción, movimiento de combate)
8. [ ] El código es más legible y mantenible
9. [ ] La estructura sigue las mismas convenciones que otros sistemas refactorizados (JDG-057, JDG-058, JDG-059, JDG-060, JDG-061)

## Detalles de Implementación

### Consideraciones Técnicas
- Performance: El timestep fijo es crítico para física estable, debe mantenerse
- Compatibilidad: Mantener compatibilidad con COMBAT_ACTIONS y movimiento de acciones de combate
- Escalabilidad: Los helpers deben poder extenderse fácilmente para nuevas funcionalidades

### Dependencias
- No depende de otros tickets
- Relacionado con: JDG-057 (AnimationMixerSystem refactorizado), JDG-058 (WeaponEquipSystem refactorizado), JDG-059 (InputSystem refactorizado), JDG-060 (CollisionSystem refactorizado), JDG-061 (CombatSystem refactorizado)

## Testing

### Escenarios de Prueba
1. Gravedad: Verificar que la gravedad se aplica correctamente cuando no está volando
2. Velocidad y aceleración: Verificar que la velocidad se actualiza correctamente con aceleración
3. Fricción: Verificar que la fricción se aplica correctamente (vuelo, normal, bloqueado)
4. Límites de velocidad: Verificar que la velocidad máxima se limita correctamente
5. Movimiento de combate: Verificar que el movimiento de acciones de combate se aplica correctamente
6. Saltos: Verificar que los saltos se aplican correctamente
7. Vuelo: Verificar que el vuelo se desactiva cuando toca el suelo

### Casos Edge a Considerar
- Entidad volando y tocando el suelo (debe desactivar vuelo)
- Movimiento de combate bloqueado (debe aplicar fricción extra)
- Velocidad máxima en vuelo (no limitar velocidad vertical)
- Timestep fijo acumulado mayor que fixedTimestep (debe ejecutar múltiples pasos)

## Estimación

- **Complejidad:** Media-Alta
- **Tiempo estimado:** 4-6 horas
- **Notas:** Similar complejidad a otros refactors, requiere cuidado al extraer lógica de movimiento de combate y fricción

## Referencias

- **Relacionado con:** JDG-057 (AnimationMixerSystem refactorizado), JDG-058 (WeaponEquipSystem refactorizado), JDG-059 (InputSystem refactorizado), JDG-060 (CollisionSystem refactorizado), JDG-061 (CombatSystem refactorizado)
- **Documentación relevante:** 
  - `frontend/src/ecs/helpers/animation/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/weapon/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/input/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/collision/README.md` (patrón de referencia)
  - `frontend/src/ecs/helpers/combat/README.md` (patrón de referencia)
- **Archivos de referencia:**
  - `frontend/src/ecs/systems/physics-system.js`
  - `frontend/src/config/combat-actions-config.js` (COMBAT_ACTIONS)

## Notas Adicionales

- Este refactor sigue el mismo patrón establecido en JDG-057, JDG-058, JDG-059, JDG-060 y JDG-061
- El timestep fijo es crítico para física estable, debe mantenerse correctamente
- El helper `combat-movement-applier.js` será importante para mantener la lógica de movimiento de acciones de combate
- La lógica de fricción es compleja (vuelo, normal, bloqueado), debe manejarse cuidadosamente
- La aplicación de gravedad, actualización de velocidad y posición son operaciones simples que pueden mantenerse en el sistema o extraerse según sea apropiado
