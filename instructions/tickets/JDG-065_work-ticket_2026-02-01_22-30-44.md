# JDG-065 - Migrar Backend a Estructura por Dominio (estilo Nest)

## Tipo
- [ ] Feature (nueva funcionalidad)
- [ ] Bugfix (corrección de error)
- [x] Refactor (mejora de código sin cambiar funcionalidad)
- [ ] Performance (optimización)
- [ ] Documentation (documentación)
- [ ] Chore (tareas de mantenimiento)

## Prioridad
- [ ] Alta (bloquea funcionalidad crítica)
- [x] Media (importante pero no bloqueante)
- [ ] Baja (mejora o nice-to-have)

## Descripción

### Problema/Requerimiento

Organizar el backend (FastAPI) por **dominio/módulo**, de forma similar a NestJS: cada recurso (bloques, particles, characters, celestial, agrupaciones) tendría su propia carpeta con rutas, schemas (DTOs) y, si aplica, servicios. Hoy los schemas Pydantic están centralizados en `models/schemas.py` y `models/particula_schemas.py`, y las rutas en `api/routes/*.py` sin agrupar por dominio. El objetivo es mejorar mantenibilidad, descubribilidad y escalabilidad sin cambiar el comportamiento de la API.

### Comportamiento Actual

- **Schemas:** Todos los DTOs (DimensionResponse, ParticleResponse, CharacterResponse, CelestialStateResponse, etc.) viven en `backend/src/models/schemas.py`; los del sistema de partículas extendido en `particula_schemas.py`. Un solo archivo (o dos) para todo el API.
- **Rutas:** Cada recurso tiene un archivo en `api/routes/` (dimensions.py, particles.py, characters.py, celestial.py, agrupaciones.py) pero no hay carpeta "por dominio" que agrupe rutas + schemas del mismo recurso.
- **Imports:** Las rutas importan desde `src.models.schemas` de forma centralizada.

### Comportamiento Esperado

- Estructura por dominio, análoga a un módulo Nest (carpeta por recurso con sus DTOs y rutas):
  - Cada dominio (bloques, particles, characters, celestial, agrupaciones) tiene su carpeta bajo `api/` o bajo una carpeta `domains/`/`modules/`.
  - Cada dominio contiene al menos: **schemas** (DTOs de request/response de ese recurso) y **routes** (router FastAPI). Opcionalmente servicios si se extraen del route.
  - Los schemas compartidos (estilos de partícula, geometría visual, helpers) pueden quedar en `models/shared/` o en un dominio común.
- La API expuesta (URLs, contratos JSON) **no cambia**: mismos endpoints, mismos response models. Solo cambia la organización del código.
- `main.py` sigue registrando los routers; los routers pueden vivir en cada dominio y exportarse desde ahí.

## Contexto Técnico

### Componentes Afectados
- [x] Backend (FastAPI)
- [ ] Frontend (Three.js)
- [ ] Base de Datos (PostgreSQL)
- [ ] Cache (Redis)
- [ ] Docker/Infraestructura
- [x] API Endpoints (solo organización; contratos sin cambio)
- [ ] WebSockets

### Tecnologías Involucradas
- Python 3.11, FastAPI, Pydantic
- Estructura de carpetas por dominio (convención tipo Nest: módulo = carpeta con schemas + routes)

### Archivos/Componentes Principales

**Estructura objetivo sugerida (una de las opciones):**

```
backend/src/
├── api/
│   ├── domains/                    # o "modules/" según preferencia
│   │   ├── bloques/
│   │   │   ├── __init__.py
│   │   │   ├── schemas.py          # DimensionResponse, WorldSizeResponse, etc.
│   │   │   └── routes.py            # router con GET /bloques, /bloques/{id}, /bloques/world/size
│   │   ├── particles/
│   │   │   ├── __init__.py
│   │   │   ├── schemas.py          # ParticleResponse, ParticlesResponse, ParticleTypeResponse, etc.
│   │   │   └── routes.py            # router con GET particles, particle-types
│   │   ├── characters/
│   │   │   ├── __init__.py
│   │   │   ├── schemas.py          # CharacterResponse, CharacterCreate, BipedGeometry, Model3D, etc.
│   │   │   └── routes.py
│   │   ├── celestial/
│   │   │   ├── __init__.py
│   │   │   ├── schemas.py          # CelestialStateResponse, TemperatureRequest/Response
│   │   │   └── routes.py
│   │   ├── agrupaciones/
│   │   │   ├── __init__.py
│   │   │   ├── schemas.py          # AgrupacionResponse, AgrupacionWithParticles
│   │   │   └── routes.py
│   │   └── shared/                 # opcional: schemas compartidos entre dominios
│   │       ├── __init__.py
│   │       └── schemas.py          # GeometriaVisual, EstilosParticula, parse_jsonb_field, etc.
│   └── ...
├── models/                         # schemas.py y particula_schemas.py eliminados; solo README
│   └── README.md
├── main.py                         # include_router desde cada domain (e.g. domains.bloques.routes.router)
└── ...
```

- **Origen actual a migrar:** `backend/src/models/schemas.py`, `backend/src/models/particula_schemas.py`, `backend/src/api/routes/dimensions.py`, `particles.py`, `characters.py`, `celestial.py`, `agrupaciones.py`.
- **main.py:** Registrar routers desde `api/domains/*/routes`; eliminar imports de `api/routes/*`.

## Criterios de Aceptación

1. [ ] Existe una estructura por dominio (carpeta por recurso: bloques, particles, characters, celestial, agrupaciones) bajo `api/domains/` (o nombre acordado).
2. [ ] Cada dominio tiene su propio `schemas.py` con los DTOs (request/response) usados solo por ese recurso; no se exige mover `particula_schemas.py` entero de una vez si se decide mantenerlo como dominio "particles" extendido o fusionado.
3. [ ] Schemas compartidos (GeometriaVisual, EstilosParticula, MaterialProperties, parse_jsonb_field, etc.) viven en un módulo compartido (`shared/` o `models/shared/`) y son importados por los dominios que los necesiten.
4. [ ] Cada dominio expone su router FastAPI; `main.py` registra los mismos prefijos y rutas que hoy (no hay cambio de URLs ni de contratos JSON).
5. [ ] Todos los tests existentes que llamen a la API siguen pasando; no hay regresiones funcionales.
6. [ ] README de `backend/src/models/` (y si aplica `api/`) actualizado para describir la nueva estructura y dónde encontrar los DTOs de cada recurso.
7. [ ] No se introducen cambios en la base de datos ni en el frontend; el refactor es solo backend.

**Nota:** Se puede hacer la migración en pasos (por ejemplo: primero bloques + celestial, luego particles, luego characters, agrupaciones) si se documenta en el ticket o en un subticket.

## Detalles de Implementación

### Consideraciones Técnicas
- **Compatibilidad:** Imports en el resto del backend (services, database) que usen `src.models.schemas` deben actualizarse a los nuevos módulos (`api.domains.*.schemas`). Se eliminan `models/schemas.py` y `api/routes/*.py`; no re-exports ni deprecación.
- **Circular imports:** Evitar que `domains/bloques/schemas.py` importe de `domains/particles/schemas.py` si no es necesario; lo compartido va a `shared`.
- **particula_schemas.py:** Decidir si se integra en `domains/particles/schemas.py` o se deja como subdominio (ej. `particles/particula_schemas.py`) y se documenta.
- **Escalabilidad:** Facilita añadir nuevos dominios (ej. recetas) con sus DTOs y rutas en una sola carpeta.

### Dependencias
- Depende de: Ninguna.
- Bloquea: Ninguno (refactor opcional para mantenibilidad).

## Testing

### Escenarios de Prueba
1. Ejecutar tests E2E o de API existentes (si los hay) y verificar que todos los endpoints respondan igual (status codes, cuerpos de respuesta).
2. Verificar que la documentación OpenAPI (`/docs`) sigue mostrando los mismos esquemas y rutas.
3. Probar manualmente al menos: GET /bloques, GET /bloques/{id}/particles (con query), GET /bloques/{id}/characters, GET /celestial/state, POST /bloques/{id}/characters.

### Casos Edge a Considerar
- Imports circulares al extraer schemas compartidos: asegurar que `shared` no importe de dominios.
- Rutas que usan schemas de más de un dominio (ej. TemperatureRequest con bloque_id): ese DTO puede vivir en el dominio que posee el endpoint (celestial).

## Estimación

- **Complejidad:** Media (refactor de estructura, muchos archivos tocados; lógica sin cambio).
- **Tiempo estimado:** 1–2 días (según si se hace en un solo PR o por dominios).
- **Notas:** Puede dividirse en subtickets por dominio (JDG-065-1 bloques+celestial, JDG-065-2 particles, etc.) si se prefiere PRs más pequeños.

## Referencias

- **Relacionado con:** Estructura tipo Nest (DTOs por módulo); discusión sobre schemas centralizados vs por dominio en `backend/src/models/README.md`.
- **Documentación relevante:** `backend/src/models/README.md`, `docs/endpoints-flujo.md` (para listado de endpoints y schemas actuales).

## Notas Adicionales

- El nombre de la carpeta (`domains`, `modules`, `features`) es convención del equipo; se puede elegir el que mejor encaje con el resto del repo.
- Si el proyecto prefiere no crear `api/domains/` y en su lugar solo splitear `models/` en `models/bloques.py`, `models/particles.py`, etc., eso también cumple "estructura por dominio" para los DTOs; el ticket puede acotarse a "schemas por dominio" y dejar las rutas donde están. Ajustar criterios de aceptación según la decisión.
